

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon.ico">
  <link rel="icon" type="image/png" href="/images/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="When in doubt, use brute force.">
  <meta name="author" content="Rabbituzki">
  <meta name="keywords" content="">
  <title>ASP.NET Core 3.1 学习笔记（二） - Rabbituzki 的笔记们</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/gruvbox-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"blog.rabbituzki.com.cn","root":"/","version":"1.8.6","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"❡"},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":"a9b0666290f750544a1900dff36c0349","google":"UA-127726236-2","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"TMgxzCpM2zFnsClsMHJY2LLc-gzGzoHsz","app_key":"1kPLieLtoBQWf0w6iNxLqkMV","server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Rabbituzki 的笔记们</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/images/background1.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="ASP.NET Core 3.1 学习笔记（二）">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-04-10 00:00" pubdate>
        2021年4月10日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      11.7k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      148
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ASP.NET Core 3.1 学习笔记（二）</h1>
            
            <div class="markdown-body">
              <h1><a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 3.1 学习笔记（二）</h1>
<p><a href="http://www.zyiz.net/tutorial/xilie-293.html" target="_blank" rel="noopener">教程</a></p>
<hr>
<p>[TOC]</p>
<hr>
<h3 id="五、ASP-NET-Core-中间件"><a class="header-anchor" href="#五、ASP-NET-Core-中间件">¶</a>五、<a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 中间件</h3>
<p>中间件是一种装配到应用管道以处理请求和响应的软件。 每个组件：</p>
<ul>
<li>选择是否将请求传递到管道中的下一个组件。</li>
<li>可在管道中的下一个组件前后执行工作。</li>
<li>请求委托用于生成请求管道。 请求委托处理每个 HTTP 请求。</li>
</ul>
<p>使用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.mapextensions.map" target="_blank" rel="noopener"><code>RunMap</code></a> 和 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.useextensions.use" target="_blank" rel="noopener"><code>Use</code></a> 扩展方法来配置请求委托。 可将一个单独的请求委托并行指定为匿名方法（称为并行中间件），或在可重用的类中对其进行定义。 这些可重用的类和并行匿名方法即为中间件 ，也叫中间件组件 。 请求管道中的每个中间件组件负责调用管道中的下一个组件，或使管道短路。 当中间件短路时，它被称为“终端中间件” ，因为它阻止中间件进一步处理请求。</p>
<p>将 HTTP 处理程序和模块迁移到 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 中间件介绍了 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 和 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> 4.x 中请求管道之间的差异，并提供了更多的中间件示例。</p>
<h4 id="使用-IApplicationBuilder-创建中间件管道"><a class="header-anchor" href="#使用-IApplicationBuilder-创建中间件管道">¶</a>使用 <code>IApplicationBuilder</code> 创建中间件管道</h4>
<p><a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 请求管道包含一系列请求委托，依次调用。 下图演示了这一概念。 沿黑色箭头执行。</p>
<p><img src="https://blog-1255671825.cos.ap-beijing-fsi.myqcloud.com/%E5%8D%9A%E5%AE%A2%E5%9B%BE%E7%89%87/netcore/5.1.png" alt="5.1"></p>
<p>每个委托均可在下一个委托前后执行操作。 应尽早在管道中调用异常处理委托，这样它们就能捕获在管道的后期阶段发生的异常。</p>
<p>尽可能简单的 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 应用设置了处理所有请求的单个请求委托。 这种情况不包括实际请求管道。 调用单个匿名函数以响应每个 HTTP 请求。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Startup<br>&#123;<br>    public void Configure(IApplicationBuilder app)<br>    &#123;<br>        app.Run(async context &#x3D;&gt;<br>        &#123;<br>            await context.Response.WriteAsync(&quot;Hello, World!&quot;);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.useextensions.use" target="_blank" rel="noopener"><code>Use</code></a> 将多个请求委托链接在一起。 <code>next</code> 参数表示管道中的下一个委托。 可通过不 调用 <code>next</code> 参数使管道短路。 通常可在下一个委托前后执行操作，如以下示例所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Startup<br>&#123;<br>    public void Configure(IApplicationBuilder app)<br>    &#123;<br>        app.Use(async (context, next) &#x3D;&gt;<br>        &#123;<br>            &#x2F;&#x2F; Do work that doesn&#39;t write to the Response.<br>            await next.Invoke();<br>            &#x2F;&#x2F; Do logging or other work that doesn&#39;t write to the Response.<br>        &#125;);<br><br>        app.Run(async context &#x3D;&gt;<br>        &#123;<br>            await context.Response.WriteAsync(&quot;Hello from 2nd delegate.&quot;);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>当委托不将请求传递给下一个委托时，它被称为“让请求管道短路”。通常需要短路，因为这样可以避免不必要的工作。 例如，静态文件中间件可以处理对静态文件的请求，并让管道的其余部分短路，从而起到终端中间件 的作用。 如果中间件添加到管道中，且位于终止进一步处理的中间件前，它们仍处理 <code>next.Invoke</code> 语句后面的代码。 不过，请参阅下面有关尝试对已发送的响应执行写入操作的警告。</p>
<blockquote>
<h2 id="注意："><a class="header-anchor" href="#注意：">¶</a><strong>注意</strong>：</h2>
<p>在向客户端发送响应后，请勿调用 <code>next.Invoke</code>。 响应启动后，针对 <code>HttpResponse</code> 的更改将引发异常。 例如，设置标头和状态代码更改将引发异常。 调用 <code>next</code> 后写入响应正文：</p>
<ul>
<li>可能导致违反协议。 例如，写入的长度超过规定的 <code>Content-Length</code>。</li>
<li>可能损坏正文格式。 例如，向 CSS 文件中写入 HTML 页脚。</li>
<li><code>HasStarted</code> 是一个有用的提示，指示是否已发送标头或已写入正文。</li>
</ul>
</blockquote>
<p><strong><code>Run</code> 委托不会收到 <code>next</code> 参数。 第一个 <code>Run</code> 委托始终为终端，用于终止管道。</strong><code>Run</code> 是一种约定。 某些中间件组件可能会公开在管道末尾运行的 <code>Run[Middleware]</code> 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Startup<br>&#123;<br>    public void Configure(IApplicationBuilder app)<br>    &#123;<br>        app.Use(async (context, next) &#x3D;&gt;<br>        &#123;<br>            &#x2F;&#x2F; Do work that doesn&#39;t write to the Response.<br>            await next.Invoke();<br>            &#x2F;&#x2F; Do logging or other work that doesn&#39;t write to the Response.<br>        &#125;);<br><br>        app.Run(async context &#x3D;&gt;<br>        &#123;<br>            await context.Response.WriteAsync(&quot;Hello from 2nd delegate.&quot;);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在前面的示例中，<code>Run</code> 委托将 <code>&quot;Hello from 2nd delegate.&quot;</code> 写入响应，然后终止管道。 如果在 <code>Run</code> 委托之后添加了另一个 <code>Use</code> 或 <code>Run</code> 委托，则不会调用该委托。</p>
<h4 id="中间件顺序"><a class="header-anchor" href="#中间件顺序">¶</a>中间件顺序</h4>
<p>向 <code>Startup.Configure</code> 方法添加中间件组件的顺序定义了针对请求调用这些组件的顺序，以及响应的相反顺序。 <strong>此顺序对于安全性、性能和功能至关重要。</strong><br>
下面的 <code>Startup.Configure</code> 方法按照建议的顺序增加与安全相关的中间件组件：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public void Configure(IApplicationBuilder app, IWebHostEnvironment env)<br>&#123;<br>    if (env.IsDevelopment())<br>    &#123;<br>        app.UseDeveloperExceptionPage();<br>        app.UseDatabaseErrorPage();<br>    &#125;<br>    else<br>    &#123;<br>        app.UseExceptionHandler(&quot;&#x2F;Error&quot;);<br>        app.UseHsts();<br>    &#125;<br><br>    app.UseHttpsRedirection();<br>    app.UseStaticFiles();<br>    &#x2F;&#x2F; app.UseCookiePolicy();<br><br>    app.UseRouting();<br>    &#x2F;&#x2F; app.UseRequestLocalization();<br>    &#x2F;&#x2F; app.UseCors();<br><br>    app.UseAuthentication();<br>    app.UseAuthorization();<br>    &#x2F;&#x2F; app.UseSession();<br><br>    app.UseEndpoints(endpoints &#x3D;&gt;<br>    &#123;<br>        endpoints.MapRazorPages();<br>        endpoints.MapControllerRoute(<br>            name: &quot;default&quot;,<br>            pattern: &quot;&#123;controller&#x3D;Home&#125;&#x2F;&#123;action&#x3D;Index&#125;&#x2F;&#123;id?&#125;&quot;);<br>    &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上述代码中：</p>
<ul>
<li>在使用单个用户帐户创建新的 Web 应用时未添加的中间件已被注释掉。</li>
<li>并非所有中间件都需要准确按照此顺序运行，但许多中间件必须遵循这个顺序。例如，<code>UseCors</code>、<code>UseAuthentication</code> 和 <code>UseAuthorization</code> 必须按照上述顺序运行。</li>
</ul>
<p>以下 <code>Startup.Configure</code> 方法将为常见应用方案添加中间件组件：</p>
<ol>
<li>异常/错误处理
<ol>
<li>当应用在开发环境中运行时：
<ul>
<li>开发人员异常页中间件 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.developerexceptionpageextensions.usedeveloperexceptionpage" target="_blank" rel="noopener"><code>UseDeveloperExceptionPage</code></a>) 报告应用运行时错误。</li>
<li>数据库错误页中间件报告数据库运行时错误。</li>
</ul>
</li>
<li>当应用在生产环境中运行时：
<ul>
<li>异常处理程序中间件 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.exceptionhandlerextensions.useexceptionhandler" target="_blank" rel="noopener"><code>UseExceptionHandler</code></a>) 捕获以下中间件中引发的异常。</li>
<li>HTTP 严格传输安全协议 (HSTS) 中间件 (UseHsts) 添加 Strict-Transport-Security 标头。</li>
</ul>
</li>
</ol>
</li>
<li>HTTPS 重定向中间件 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.httpspolicybuilderextensions.usehttpsredirection" target="_blank" rel="noopener"><code>UseHttpsRedirection</code></a>) 将 HTTP 请求重定向到 HTTPS。</li>
<li>静态文件中间件 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.staticfileextensions.usestaticfiles" target="_blank" rel="noopener"><code>UseStaticFiles</code></a>) 返回静态文件，并简化进一步请求处理。</li>
<li>Cookie 策略中间件 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.cookiepolicyappbuilderextensions.usecookiepolicy" target="_blank" rel="noopener"><code>UseCookiePolicy</code></a>) 使应用符合欧盟一般数据保护条例 (GDPR) 规定。</li>
<li>用于路由请求的路由中间件 (<code>UseRouting</code>)。</li>
<li>身份验证中间件 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication" target="_blank" rel="noopener"><code>UseAuthentication</code></a>) 尝试对用户进行身份验证，然后才会允许用户访问安全资源。</li>
<li>用于授权用户访问安全资源的授权中间件 (<code>UseAuthorization</code>)。</li>
<li>会话中间件 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.sessionmiddlewareextensions.usesession" target="_blank" rel="noopener"><code>UseSession</code></a>) 建立和维护会话状态。 如果应用使用会话状态，请在 Cookie 策略中间件之后和 MVC 中间件之前调用会话中间件。</li>
<li>用于将 Razor Pages 终结点添加到请求管道的终结点路由中间件（带有 <code>MapRazorPages</code> 的 <code>UseEndpoints</code>）。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public void Configure(IApplicationBuilder app, IWebHostEnvironment env)<br>&#123;<br>    if (env.IsDevelopment())<br>    &#123;<br>        app.UseDeveloperExceptionPage();<br>        app.UseDatabaseErrorPage();<br>    &#125;<br>    else<br>    &#123;<br>        app.UseExceptionHandler(&quot;&#x2F;Error&quot;);<br>        app.UseHsts();<br>    &#125;<br><br>    app.UseHttpsRedirection();<br>    app.UseStaticFiles();<br>    app.UseCookiePolicy();<br>    app.UseRouting();<br>    app.UseAuthentication();<br>    app.UseAuthorization();<br>    app.UseSession();<br><br>    app.UseEndpoints(endpoints &#x3D;&gt;<br>    &#123;<br>        endpoints.MapRazorPages();<br>    &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在前面的示例代码中，每个中间件扩展方法都通过 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder" target="_blank" rel="noopener"><code>Microsoft.AspNetCore.Builder</code></a> 命名空间在 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder" target="_blank" rel="noopener"><code>IApplicationBuilder</code></a> 上公开。<br>
<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.exceptionhandlerextensions.useexceptionhandler" target="_blank" rel="noopener"><code>UseExceptionHandler</code></a> 是添加到管道的第一个中间件组件。 因此，异常处理程序中间件可捕获稍后调用中发生的任何异常。<br>
尽早在管道中调用静态文件中间件，以便它可以处理请求并使其短路，而无需通过剩余组件。 静态文件中间件不 提供授权检查。 可公开访问由静态文件中间件服务的任何文件，包括 <em>wwwroot</em> 下的文件。<br>
如果静态文件中间件未处理请求，则请求将被传递给执行身份验证的身份验证中间件 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.authappbuilderextensions.useauthentication" target="_blank" rel="noopener"><code>UseAuthentication</code></a>)。 身份验证不使未经身份验证的请求短路。 虽然身份验证中间件对请求进行身份验证，但仅在 MVC 选择特定 Razor 页或 MVC 控制器和操作后，才发生授权（和拒绝）。<br>
以下示例演示中间件排序，其中静态文件的请求在响应压缩中间件前由静态文件中间件进行处理。 使用此中间件顺序不压缩静态文件。 可以压缩 Razor Pages 响应。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public void Configure(IApplicationBuilder app)<br>&#123;<br>    &#x2F;&#x2F; Static files aren&#39;t compressed by Static File Middleware.<br>    app.UseStaticFiles();<br><br>    app.UseResponseCompression();<br><br>    app.UseEndpoints(endpoints &#x3D;&gt;<br>    &#123;<br>        endpoints.MapRazorPages();<br>    &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>对于单页应用程序，SPA 中间件 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.spastaticfilesextensions.usespastaticfiles" target="_blank" rel="noopener"><code>UseSpaStaticFiles</code></a> 通常是中间件管道中的最后一个。 SPA 中间件处于最后的作用是：</p>
<ul>
<li>允许所有其他中间件首先响应匹配的请求。</li>
<li>允许具有客户端侧路由的 SPA 针对服务器应用无法识别的所有路由运行。</li>
</ul>
<p>有关单页应用程序的详细信息，请参阅 React 和 Angular 项目模板的指南。</p>
<h4 id="对中间件管道进行分支"><a class="header-anchor" href="#对中间件管道进行分支">¶</a>对中间件管道进行分支</h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.mapextensions.map" target="_blank" rel="noopener"><code>Map</code></a> 扩展用作约定来创建管道分支。 <code>Map</code> 基于给定请求路径的匹配项来创建请求管道分支。 如果请求路径以给定路径开头，则执行分支。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Startup<br>&#123;<br>    private static void HandleMapTest1(IApplicationBuilder app)<br>    &#123;<br>        app.Run(async context &#x3D;&gt;<br>        &#123;<br>            await context.Response.WriteAsync(&quot;Map Test 1&quot;);<br>        &#125;);<br>    &#125;<br><br>    private static void HandleMapTest2(IApplicationBuilder app)<br>    &#123;<br>        app.Run(async context &#x3D;&gt;<br>        &#123;<br>            await context.Response.WriteAsync(&quot;Map Test 2&quot;);<br>        &#125;);<br>    &#125;<br><br>    public void Configure(IApplicationBuilder app)<br>    &#123;<br>        app.Map(&quot;&#x2F;map1&quot;, HandleMapTest1);<br><br>        app.Map(&quot;&#x2F;map2&quot;, HandleMapTest2);<br><br>        app.Run(async context &#x3D;&gt;<br>        &#123;<br>            await context.Response.WriteAsync(&quot;Hello from non-Map delegate. &lt;p&gt;&quot;);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>下表使用前面的代码显示来自 <em><a href="http://localhost:1234" target="_blank" rel="noopener">http://localhost:1234</a></em> 的请求和响应。</p>
<table>
<thead>
<tr>
<th style="text-align:center">请求</th>
<th style="text-align:center">响应</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><em>localhost:1234</em></td>
<td style="text-align:center">Hello from non-Map delegate.</td>
</tr>
<tr>
<td style="text-align:center"><em>localhost:1234/map1</em></td>
<td style="text-align:center">Map Test 1</td>
</tr>
<tr>
<td style="text-align:center"><em>localhost:1234/map2</em></td>
<td style="text-align:center">Map Test 2</td>
</tr>
<tr>
<td style="text-align:center"><em>localhost:1234/map3</em></td>
<td style="text-align:center">Hello from non-Map delegate.</td>
</tr>
</tbody>
</table>
<p>使用 <code>Map</code> 时，将从 <code>HttpRequest.Path</code> 中删除匹配的路径段，并针对每个请求将该路径段追加到 <code>HttpRequest.PathBase</code>。<br>
<code>Map</code> 支持嵌套，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">app.Map(&quot;&#x2F;level1&quot;, level1App &#x3D;&gt; &#123;<br>    level1App.Map(&quot;&#x2F;level2a&quot;, level2AApp &#x3D;&gt; &#123;<br>        &#x2F;&#x2F; &quot;&#x2F;level1&#x2F;level2a&quot; processing<br>    &#125;);<br>    level1App.Map(&quot;&#x2F;level2b&quot;, level2BApp &#x3D;&gt; &#123;<br>        &#x2F;&#x2F; &quot;&#x2F;level1&#x2F;level2b&quot; processing<br>    &#125;);<br>&#125;);<br></code></pre></div></td></tr></table></figure>
<p>此外，<code>Map</code> 还可同时匹配多个段：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Startup<br>&#123;<br>    private static void HandleMultiSeg(IApplicationBuilder app)<br>    &#123;<br>        app.Run(async context &#x3D;&gt;<br>        &#123;<br>            await context.Response.WriteAsync(&quot;Map multiple segments.&quot;);<br>        &#125;);<br>    &#125;<br><br>    public void Configure(IApplicationBuilder app)<br>    &#123;<br>        app.Map(&quot;&#x2F;map1&#x2F;seg1&quot;, HandleMultiSeg);<br><br>        app.Run(async context &#x3D;&gt;<br>        &#123;<br>            await context.Response.WriteAsync(&quot;Hello from non-Map delegate.&quot;);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.mapwhenextensions.mapwhen" target="_blank" rel="noopener"><code>MapWhen</code></a> 基于给定谓词的结果创建请求管道分支。 <code>Func&lt;HttpContext, bool&gt;</code> 类型的任何谓词均可用于将请求映射到管道的新分支。 在以下示例中，谓词用于检测查询字符串变量 <code>branch</code> 是否存在：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Startup<br>&#123;<br>    private static void HandleBranch(IApplicationBuilder app)<br>    &#123;<br>        app.Run(async context &#x3D;&gt;<br>        &#123;<br>            var branchVer &#x3D; context.Request.Query[&quot;branch&quot;];<br>            await context.Response.WriteAsync($&quot;Branch used &#x3D; &#123;branchVer&#125;&quot;);<br>        &#125;);<br>    &#125;<br><br>    public void Configure(IApplicationBuilder app)<br>    &#123;<br>        app.MapWhen(context &#x3D;&gt; context.Request.Query.ContainsKey(&quot;branch&quot;),<br>                               HandleBranch);<br><br>        app.Run(async context &#x3D;&gt;<br>        &#123;<br>            await context.Response.WriteAsync(&quot;Hello from non-Map delegate. &lt;p&gt;&quot;);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>下表使用前面的代码显示来自 <em><a href="http://localhost:1234" target="_blank" rel="noopener">http://localhost:1234</a></em> 的请求和响应：</p>
<table>
<thead>
<tr>
<th style="text-align:center">请求</th>
<th style="text-align:center">响应</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><em>localhost:1234</em></td>
<td style="text-align:center">Hello from non-Map delegate.</td>
</tr>
<tr>
<td style="text-align:center"><em>localhost:1234/?branch=master</em></td>
<td style="text-align:center">Branch used = master</td>
</tr>
</tbody>
</table>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.usewhenextensions.usewhen" target="_blank" rel="noopener"><code>UseWhen</code></a> 也基于给定谓词的结果创建请求管道分支。 与 <code>MapWhen</code> 不同的是，如果这个分支发生短路或包含终端中间件，则会重新加入主管道：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Startup<br>&#123;<br>    private readonly ILogger&lt;Startup&gt; _logger;<br><br>    public Startup(ILogger&lt;Startup&gt; logger)<br>    &#123;<br>        _logger &#x3D; logger;<br>    &#125;<br><br>    private void HandleBranchAndRejoin(IApplicationBuilder app)<br>    &#123;<br>        app.Use(async (context, next) &#x3D;&gt;<br>        &#123;<br>            var branchVer &#x3D; context.Request.Query[&quot;branch&quot;];<br>            _logger.LogInformation(&quot;Branch used &#x3D; &#123;branchVer&#125;&quot;, branchVer);<br><br>            &#x2F;&#x2F; Do work that doesn&#39;t write to the Response.<br>            await next();<br>            &#x2F;&#x2F; Do other work that doesn&#39;t write to the Response.<br>        &#125;);<br>    &#125;<br><br>    public void Configure(IApplicationBuilder app)<br>    &#123;<br>        app.UseWhen(context &#x3D;&gt; context.Request.Query.ContainsKey(&quot;branch&quot;),<br>                               HandleBranchAndRejoin);<br><br>        app.Run(async context &#x3D;&gt;<br>        &#123;<br>            await context.Response.WriteAsync(&quot;Hello from main pipeline.&quot;);<br>        &#125;);<br>    &#125;<br></code></pre></div></td></tr></table></figure>
<p>在前面的示例中，响应 “Hello from main pipeline.” 是为所有请求编写的。 如果请求中包含查询字符串变量 <code>branch</code>，则在重新加入主管道之前会记录其值。</p>
<h4 id="内置中间件"><a class="header-anchor" href="#内置中间件">¶</a>内置中间件</h4>
<p><a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 附带以下中间件组件。 “顺序” 列提供备注，以说明中间件在请求处理管道中的放置，以及中间件可能会终止请求处理的条件。 如果中间件让请求处理管道短路，并阻止下游中间件进一步处理请求，它被称为“终端中间件” 。</p>
<table>
<thead>
<tr>
<th style="text-align:center">中间件</th>
<th style="text-align:center">描述</th>
<th style="text-align:center">顺序</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">身份验证</td>
<td style="text-align:center">提供身份验证支持。</td>
<td style="text-align:center">在需要 <code>HttpContext.User</code> 之前。 OAuth 回叫的终端。</td>
</tr>
<tr>
<td style="text-align:center">授权</td>
<td style="text-align:center">提供身份验证支持。</td>
<td style="text-align:center">紧接在身份验证中间件之后。</td>
</tr>
<tr>
<td style="text-align:center">Cookie 策略</td>
<td style="text-align:center">跟踪用户是否同意存储个人信息，并强制实施 cookie 字段（如 <code>secure</code> 和 <code>SameSite</code>）的最低标准。</td>
<td style="text-align:center">在发出 cookie 的中间件之前。 示例：身份验证、会话、MVC (TempData)。</td>
</tr>
<tr>
<td style="text-align:center">CORS</td>
<td style="text-align:center">配置跨域资源共享。</td>
<td style="text-align:center">在使用 CORS 的组件之前。</td>
</tr>
<tr>
<td style="text-align:center">诊断</td>
<td style="text-align:center">提供新应用的开发人员异常页、异常处理、状态代码页和默认网页的几个单独的中间件。</td>
<td style="text-align:center">在生成错误的组件之前。 异常终端或为新应用提供默认网页的终端。</td>
</tr>
<tr>
<td style="text-align:center">转发头</td>
<td style="text-align:center">将代理标头转发到当前请求。</td>
<td style="text-align:center">在使用已更新字段的组件之前。 示例：方案、主机、客户端 IP、方法。</td>
</tr>
<tr>
<td style="text-align:center">运行状况检查</td>
<td style="text-align:center">检查 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 应用及其依赖项的运行状况，如检查数据库可用性。</td>
<td style="text-align:center">如果请求与运行状况检查终结点匹配，则为终端。</td>
</tr>
<tr>
<td style="text-align:center">标头传播</td>
<td style="text-align:center">将 HTTP 标头从传入的请求传播到传出的 HTTP 客户端请求中。</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">HTTP 方法重写</td>
<td style="text-align:center">允许传入 POST 请求重写方法。</td>
<td style="text-align:center">在使用已更新方法的组件之前。</td>
</tr>
<tr>
<td style="text-align:center">HTTPS 重定向</td>
<td style="text-align:center">将所有 HTTP 请求重定向到 HTTPS。</td>
<td style="text-align:center">在使用 URL 的组件之前。</td>
</tr>
<tr>
<td style="text-align:center">HTTP 严格传输安全性 (HSTS)</td>
<td style="text-align:center">添加特殊响应标头的安全增强中间件。</td>
<td style="text-align:center">在发送响应之前，修改请求的组件之后。 示例：转接头、URL 重写。</td>
</tr>
<tr>
<td style="text-align:center">MVC</td>
<td style="text-align:center">用 MVC/Razor Pages 处理请求。</td>
<td style="text-align:center">如果请求与路由匹配，则为终端。</td>
</tr>
<tr>
<td style="text-align:center">OWIN</td>
<td style="text-align:center">与基于 OWIN 的应用、服务器和中间件进行互操作。</td>
<td style="text-align:center">如果 OWIN 中间件处理完请求，则为终端。</td>
</tr>
<tr>
<td style="text-align:center">响应缓存</td>
<td style="text-align:center">提供对缓存响应的支持。</td>
<td style="text-align:center">在需要缓存的组件之前。</td>
</tr>
<tr>
<td style="text-align:center">响应压缩</td>
<td style="text-align:center">提供对压缩响应的支持。</td>
<td style="text-align:center">在需要压缩的组件之前。</td>
</tr>
<tr>
<td style="text-align:center">请求本地化</td>
<td style="text-align:center">提供本地化支持。</td>
<td style="text-align:center">在对本地化敏感的组件之前。</td>
</tr>
<tr>
<td style="text-align:center">终结点路由</td>
<td style="text-align:center">定义和约束请求路由。</td>
<td style="text-align:center">用于匹配路由的终端。</td>
</tr>
<tr>
<td style="text-align:center">SPA</td>
<td style="text-align:center">通过返回单页应用程序 (SPA) 的默认页面，在中间件链中处理来自这个点的所有请求</td>
<td style="text-align:center">在链中处于靠后位置，因此其他服务于静态文件、MVC 操作等内容的中间件占据优先位置。</td>
</tr>
<tr>
<td style="text-align:center">会话</td>
<td style="text-align:center">提供对管理用户会话的支持。</td>
<td style="text-align:center">在需要会话的组件之前。</td>
</tr>
<tr>
<td style="text-align:center">静态文件</td>
<td style="text-align:center">为提供静态文件和目录浏览提供支持。</td>
<td style="text-align:center">如果请求与文件匹配，则为终端。</td>
</tr>
<tr>
<td style="text-align:center">URL 重写</td>
<td style="text-align:center">提供对重写 URL 和重定向请求的支持。</td>
<td style="text-align:center">在使用 URL 的组件之前。</td>
</tr>
<tr>
<td style="text-align:center">WebSockets</td>
<td style="text-align:center">启用 WebSockets 协议。</td>
<td style="text-align:center">在接受 WebSocket 请求所需的组件之前。</td>
</tr>
</tbody>
</table>
<h3 id="六、ASP-NET-Core-中的配置"><a class="header-anchor" href="#六、ASP-NET-Core-中的配置">¶</a>六、<a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 中的配置</h3>
<p><a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 中的应用配置基于配置提供程序 建立的键值对。 配置提供程序将配置数据从各种配置源读取到键值对：</p>
<ul>
<li>Azure Key Vault</li>
<li>Azure 应用程序配置</li>
<li>命令行参数</li>
<li>（已安装或已创建的）自定义提供程序</li>
<li>目录文件</li>
<li>环境变量</li>
<li>内存中的 .NET 对象</li>
<li>设置文件</li>
</ul>
<p>框架隐式包含通用配置提供程序方案的配置包 (<a href="https://www.nuget.org/packages/Microsoft.Extensions.Configuration/" target="_blank" rel="noopener">Microsoft Extensions.Configuration</a>)。</p>
<p>后面的代码示例和示例应用中的代码示例使用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration" target="_blank" rel="noopener"><code>Microsoft.Extensions.Configuration</code></a> 命名空间：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">using Microsoft.Extensions.Configuration;<br></code></pre></div></td></tr></table></figure>
<p>选项模式 是本主题中描述的配置概念的扩展。 选项使用类来表示相关设置的组。<br>
<a href="https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/configuration/index/samples" target="_blank" rel="noopener">查看或下载实例代码</a></p>
<h4 id="主机与应用配置"><a class="header-anchor" href="#主机与应用配置">¶</a>主机与应用配置</h4>
<p>在配置并启动应用之前，配置并启动主机。主机负责应用程序启动和生存期管理。应用和主机均使用本主题中所述的配置提供程序进行配置。 应用的配置中也包含主机配置键值对。</p>
<h4 id="其它配置"><a class="header-anchor" href="#其它配置">¶</a>其它配置</h4>
<ul>
<li><em>launch.json</em>/<em>launchSettings.json</em> 是用于开发环境的工具配置文件，如
<ul>
<li>在 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 中使用多个环境中所述。</li>
<li>整个文档集中的文件用于为开发方案配置 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 应用。</li>
</ul>
</li>
<li><em>web.config</em> 是服务器配置文件，如以下主题中所述：
<ul>
<li>使用 IIS 在 Windows 上托管 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core</li>
<li><a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 模块</li>
</ul>
</li>
</ul>
<h4 id="默认配置"><a class="header-anchor" href="#默认配置">¶</a>默认配置</h4>
<p>基于 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core <a href="https://docs.microsoft.com/zh-cn/dotnet/core/tools/dotnet-new" target="_blank" rel="noopener">dotnet new</a> 模板的 Web 应用在生成主机时会调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.host.createdefaultbuilder" target="_blank" rel="noopener"><code>CreateDefaultBuilder</code></a>。<code>CreateDefaultBuilder</code> 按照以下顺序为应用提供默认配置，以下内容适用于使用通用主机的应用。</p>
<ul>
<li>主机配置通过以下方式提供：
<ul>
<li>使用环境变量配置提供程序，通过前缀为 <code>DOTNET_</code>（例如，<code>DOTNET_ENVIRONMENT</code>）的环境变量提供。在配置键值对加载后，前缀（<code>DOTNET_</code>）会遭去除。 ‎</li>
<li>使用命令行配置提供程序，通过命令行参数提供。</li>
</ul>
</li>
<li>已建立 Web 主机默认配置 (<code>ConfigureWebHostDefaults</code>)：
<ul>
<li>Kestrel 用作 Web 服务器，并使用应用的配置提供程序对其进行配置。</li>
<li>添加主机筛选中间件。</li>
<li>如果 <code>ASPNETCORE_FORWARDEDHEADERS_ENABLED</code> 环境变量设置为 <code>true</code>，则添加转发的标头中间件。</li>
<li>启用 IIS 集成。</li>
</ul>
</li>
<li>应用配置通过以下方式提供：
<ul>
<li>使用文件配置提供程序，通过 <em>appsettings.json</em> 提供。</li>
<li>使用文件配置提供程序，通过 <em>appsettings.{Environment}.json</em> 提供。‎</li>
<li>应用在使用入口程序集的 Development 环境中运行时的机密管理器。</li>
<li>使用环境变量配置提供程序，通过环境变量提供。</li>
<li>使用命令行配置提供程序，通过命令行参数提供。</li>
</ul>
</li>
</ul>
<h4 id="安全性"><a class="header-anchor" href="#安全性">¶</a>安全性</h4>
<p>采用以下做法来保护敏感配置数据：</p>
<ul>
<li>请勿在配置提供程序代码或纯文本配置文件中存储密码或其他敏感数据。</li>
<li>不要在开发或测试环境中使用生产机密。</li>
<li>请在项目外部指定机密，避免将其意外提交到源代码存储库。</li>
</ul>
<p><a href="https://azure.microsoft.com/services/key-vault/" target="_blank" rel="noopener">Azure Key Vault</a> 安全存储 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 应用的应用机密。</p>
<h4 id="分层配置数据"><a class="header-anchor" href="#分层配置数据">¶</a>分层配置数据</h4>
<p>配置 API 能够通过在配置键中使用分隔符来展平分层数据以保持分层配置数据。<br>
在以下 JSON 文件中，两个节的结构化层次结构中存在四个键：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs JSON">&#123;<br>  <span class="hljs-attr">"section0"</span>: &#123;<br>    <span class="hljs-attr">"key0"</span>: <span class="hljs-string">"value"</span>,<br>    <span class="hljs-attr">"key1"</span>: <span class="hljs-string">"value"</span><br>  &#125;,<br>  <span class="hljs-attr">"section1"</span>: &#123;<br>    <span class="hljs-attr">"key0"</span>: <span class="hljs-string">"value"</span>,<br>    <span class="hljs-attr">"key1"</span>: <span class="hljs-string">"value"</span><br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>将文件读入配置时，将创建唯一键以保持配置源的原始分层数据结构。 使用冒号 (<code>:</code>) 展平节和键以保持原始结构：</p>
<ul>
<li><code>section0:key0</code></li>
<li><code>section0:key1</code></li>
<li><code>section1:key0</code></li>
<li><code>section1:key1</code></li>
</ul>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationsection.getsection" target="_blank" rel="noopener"><code>GetSection</code></a> 和 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfiguration.getchildren" target="_blank" rel="noopener"><code>GetChildren</code></a> 方法可用于隔离各个节和配置数据中某节的子节。</p>
<h4 id="约定"><a class="header-anchor" href="#约定">¶</a>约定</h4>
<h5 id="源和提供程序"><a class="header-anchor" href="#源和提供程序">¶</a>源和提供程序</h5>
<p>在应用启动时，将按照指定的配置提供程序的顺序读取配置源。<br>
实现更改检测的配置提供程序能够在基础设置更改时重新加载配置。 例如，文件配置提供程序（本主题后面将对此进行介绍）和 Azure Key Vault 配置提供程序实现更改检测。<br>
应用的依赖关系注入 (DI) 容器中提供了 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfiguration" target="_blank" rel="noopener"><code>IConfiguration</code></a>。<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfiguration" target="_blank" rel="noopener"><code>IConfiguration</code></a> 可注入到 Razor Pages <code>PageModel</code> 或 MVC <code>Controller</code> 来获取以下类的配置。<br>
在下面的示例中，使用 <code>_config</code> 字段来访问配置值：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class IndexModel : PageModel<br>&#123;<br>    private readonly IConfiguration _config;<br><br>    public IndexModel(IConfiguration config)<br>    &#123;<br>        _config &#x3D; config;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<blockquote>
<h2 id="注意：-v2"><a class="header-anchor" href="#注意：-v2">¶</a><strong>注意</strong>：</h2>
<p>配置提供程序不能使用 DI，因为主机在设置这些提供程序时 DI 不可用。</p>
</blockquote>
<h5 id="键"><a class="header-anchor" href="#键">¶</a>键</h5>
<p>配置键采用以下约定：</p>
<ul>
<li>键不区分大小写。 例如，<code>ConnectionString</code> 和 <code>connectionstring</code> 被视为等效键。</li>
<li>如果由相同或不同的配置提供程序设置相同键的值，则键上设置的最后一个值就是所使用的值。</li>
<li>分层键
<ul>
<li>在配置 API 中，冒号分隔符 (<code>:</code>) 适用于所有平台。</li>
<li>在环境变量中，冒号分隔符可能无法适用于所有平台。 所有平台均支持采用双下划线 (<code>__</code>)，并可以将其自动转换为冒号。</li>
<li>在 Azure Key Vault 中，分层键使用 <code>--</code>（两个破折号）作为分隔符。 将机密加载到应用的配置中时，用冒号替换破折号。</li>
</ul>
</li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbinder" target="_blank" rel="noopener"><code>ConfigurationBinder</code></a> 支持使用配置键中的数组索引将数组绑定到对象。</li>
</ul>
<h5 id="值"><a class="header-anchor" href="#值">¶</a>值</h5>
<p>配置值采用以下约定：</p>
<ul>
<li>值是字符串。</li>
<li>NULL 值不能存储在配置中或绑定到对象。</li>
</ul>
<h4 id="提供程序"><a class="header-anchor" href="#提供程序">¶</a>提供程序</h4>
<p>下表显示了 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 应用可用的配置提供程序。</p>
<table>
<thead>
<tr>
<th style="text-align:center">提供程序</th>
<th style="text-align:center">通过以下对象提供配置</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Azure Key Vault 配置提供程序（安全 主题）</td>
<td style="text-align:center">Azure Key Vault</td>
</tr>
<tr>
<td style="text-align:center">Azure 应用程序配置提供程序（Azure 文档）</td>
<td style="text-align:center">Azure 应用程序配置</td>
</tr>
<tr>
<td style="text-align:center">命令行配置提供程序</td>
<td style="text-align:center">命令行参数</td>
</tr>
<tr>
<td style="text-align:center">自定义配置提供程序</td>
<td style="text-align:center">自定义源</td>
</tr>
<tr>
<td style="text-align:center">环境变量配置提供程序</td>
<td style="text-align:center">环境变量</td>
</tr>
<tr>
<td style="text-align:center">文件配置提供程序</td>
<td style="text-align:center">文件（INI、JSON、XML）</td>
</tr>
<tr>
<td style="text-align:center">Key-per-file 配置提供程序</td>
<td style="text-align:center">目录文件</td>
</tr>
<tr>
<td style="text-align:center">内存配置提供程序</td>
<td style="text-align:center">内存中集合</td>
</tr>
<tr>
<td style="text-align:center">用户机密 (Secret Manager)（安全 主题）</td>
<td style="text-align:center">用户配置文件目录中的文件</td>
</tr>
</tbody>
</table>
<p>按照启动时指定的配置提供程序的顺序读取配置源。 本主题中所述的配置提供程序按字母顺序进行介绍，而不是按代码排列顺序进行介绍。代码中的配置提供程序应以特定顺序排列，从而满足应用所需的基础配置源的优先级。</p>
<p>配置提供程序的典型顺序为：</p>
<ol>
<li>文件（<em>appsettings.json</em>、<em>appsettings.{Environment}.json</em>，其中 <code>{Environment}</code> 是应用的当前托管环境）</li>
<li>Azure 密钥保管库</li>
<li>用户机密 (Secret Manager)（仅限开发环境中）</li>
<li>环境变量</li>
<li>命令行参数</li>
</ol>
<p>通常的做法是将命令行配置提供程序置于一系列提供程序的末尾，以允许命令行参数替代由其他提供程序设置的配置。<br>
使用 <code>CreateDefaultBuilder</code> 初始化新的主机生成器时，将使用上述提供程序序列。</p>
<h4 id="用-ConfigureHostConfiguration-配置主机生成器"><a class="header-anchor" href="#用-ConfigureHostConfiguration-配置主机生成器">¶</a>用 <code>ConfigureHostConfiguration</code> 配置主机生成器</h4>
<p>若要配置主机生成器，请调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostbuilder.configurehostconfiguration" target="_blank" rel="noopener"><code>ConfigureHostConfiguration</code></a> 并提供配置。 用 <code>ConfigureHostConfiguration</code> 初始化 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihostenvironment" target="_blank" rel="noopener"><code>IHostEnvironment</code></a>，以便稍后在生成过程中使用。 可多次调用 <code>ConfigureHostConfiguration</code>，并得到累计结果。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;<br>    Host.CreateDefaultBuilder(args)<br>        .ConfigureHostConfiguration(config &#x3D;&gt;<br>        &#123;<br>            var dict &#x3D; new Dictionary&lt;string, string&gt;<br>            &#123;<br>                &#123;&quot;MemoryCollectionKey1&quot;, &quot;value1&quot;&#125;,<br>                &#123;&quot;MemoryCollectionKey2&quot;, &quot;value2&quot;&#125;<br>            &#125;;<br><br>            config.AddInMemoryCollection(dict);<br>        &#125;)<br>        .ConfigureWebHostDefaults(webBuilder &#x3D;&gt;<br>        &#123;<br>            webBuilder.UseStartup&lt;Startup&gt;();<br>        &#125;);<br></code></pre></div></td></tr></table></figure>
<h5 id="ConfigureAppConfiguration"><a class="header-anchor" href="#ConfigureAppConfiguration">¶</a><code>ConfigureAppConfiguration</code></h5>
<p>构建主机时调用 <code>ConfigureAppConfiguration</code> 以指定应用的配置提供程序以及 <code>CreateDefaultBuilder</code> 自动添加的配置提供程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Program<br>&#123;<br>    public static Dictionary&lt;string, string&gt; arrayDict &#x3D;<br>        new Dictionary&lt;string, string&gt;<br>        &#123;<br>            &#123;&quot;array:entries:0&quot;, &quot;value0&quot;&#125;,<br>            &#123;&quot;array:entries:1&quot;, &quot;value1&quot;&#125;,<br>            &#123;&quot;array:entries:2&quot;, &quot;value2&quot;&#125;,<br>            &#123;&quot;array:entries:4&quot;, &quot;value4&quot;&#125;,<br>            &#123;&quot;array:entries:5&quot;, &quot;value5&quot;&#125;<br>        &#125;;<br><br>    public static void Main(string[] args)<br>    &#123;<br>        CreateHostBuilder(args).Build().Run();<br>    &#125;<br><br>    public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;<br>        Host.CreateDefaultBuilder(args)<br>            .ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>            &#123;<br>                config.AddInMemoryCollection(arrayDict);<br>                config.AddJsonFile(<br>                    &quot;json_array.json&quot;, optional: false, reloadOnChange: false);<br>                config.AddJsonFile(<br>                    &quot;starship.json&quot;, optional: false, reloadOnChange: false);<br>                config.AddXmlFile(<br>                    &quot;tvshow.xml&quot;, optional: false, reloadOnChange: false);<br>                config.AddEFConfiguration(<br>                    options &#x3D;&gt; options.UseInMemoryDatabase(&quot;InMemoryDb&quot;));<br>                config.AddCommandLine(args);<br>            &#125;)<br>            .ConfigureWebHostDefaults(webBuilder &#x3D;&gt;<br>            &#123;<br>                webBuilder.UseStartup&lt;Startup&gt;();<br>            &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h5 id="用命令行参数替代以前的配置"><a class="header-anchor" href="#用命令行参数替代以前的配置">¶</a>用命令行参数替代以前的配置</h5>
<p>若要提供命令行参数可替代的应用配置，最后请调用 <code>AddCommandLine</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">.ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>&#123;<br>    &#x2F;&#x2F; Call other providers here<br>    config.AddCommandLine(args);<br>&#125;)<br></code></pre></div></td></tr></table></figure>
<h5 id="删除-CreateDefaultBuilder-添加的提供程序"><a class="header-anchor" href="#删除-CreateDefaultBuilder-添加的提供程序">¶</a>删除 <code>CreateDefaultBuilder</code> 添加的提供程序</h5>
<p>要删除 <code>CreateDefaultBuilder</code> 添加的提供程序，请先对 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfigurationbuilder.sources#Microsoft_Extensions_Configuration_IConfigurationBuilder_Sources" target="_blank" rel="noopener"><code>IConfigurationBuilder.Sources</code></a> 调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.collections.generic.icollection-1.clear" target="_blank" rel="noopener"><code>Clear</code></a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">.ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>&#123;<br>    config.Sources.Clear();<br>    &#x2F;&#x2F; Add providers here<br>&#125;)<br></code></pre></div></td></tr></table></figure>
<h5 id="在应用启动期间使用配置"><a class="header-anchor" href="#在应用启动期间使用配置">¶</a>在应用启动期间使用配置</h5>
<p>在应用启动期间，可以使用 <code>ConfigureAppConfiguration</code> 中提供给应用的配置，包括 <code>Startup.ConfigureServices</code>。</p>
<h4 id="命令行配置提供程序"><a class="header-anchor" href="#命令行配置提供程序">¶</a>命令行配置提供程序</h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.commandline.commandlineconfigurationprovider" target="_blank" rel="noopener"><code>CommandLineConfigurationProvider</code></a> 在运行时从命令行参数键值对加载配置。</p>
<p>要激活命令行配置，请在 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbuilder" target="_blank" rel="noopener"><code>ConfigurationBuilder</code></a> 的实例上调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.commandlineconfigurationextensions.addcommandline" target="_blank" rel="noopener"><code>AddCommandLine</code></a> 扩展方法。</p>
<p>调用 <code>CreateDefaultBuilder(string [])</code> 时会自动调用 <code>AddCommandLine</code>。</p>
<p>此外，<code>CreateDefaultBuilder</code> 也会加载：</p>
<ul>
<li><em>appsettings.json</em> 和 <em>appsettings.{Environment}.json</em> 文件中的可选配置 。</li>
<li>用户机密 (Secret Manager)（在开发环境中）。</li>
<li>环境变量。</li>
</ul>
<p><code>CreateDefaultBuilder</code> 最后添加命令行配置提供程序。 在运行时传递的命令行参数会替代由其他提供程序设置的配置。</p>
<p><code>CreateDefaultBuilder</code> 在构造主机时起作用。 因此，<code>CreateDefaultBuilder</code> 激活的命令行配置可能会影响主机的配置方式。</p>
<p>对于基于 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 模板的应用，<code>CreateDefaultBuilder</code> 已调用 <code>AddCommandLine</code>。 若要添加其他配置提供程序并保持能够用命令行参数替代这些提供程序的配置，请在 <code>ConfigureAppConfiguration</code> 中调用应用的其他提供程序，并最后调用 <code>AddCommandLine</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">.ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>&#123;<br>    &#x2F;&#x2F; Call other providers here<br>    config.AddCommandLine(args);<br>&#125;)<br></code></pre></div></td></tr></table></figure>
<h5 id="示例"><a class="header-anchor" href="#示例">¶</a>示例</h5>
<p>示例应用利用静态便捷方法 <code>CreateDefaultBuilder</code> 来生成主机，其中包括一个对 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.commandlineconfigurationextensions.addcommandline" target="_blank" rel="noopener"><code>AddCommandLine</code></a> 的调用。</p>
<ol>
<li>在项目的目录中打开命令提示符。</li>
<li>为 <code>dotnet run</code> 命令提供命令行参数 <code>dotnet run CommandLineKey=CommandLineValue</code>。</li>
<li>应用运行后，在 <code>http://localhost:5000</code> 打开应用的浏览器。</li>
<li>观察输出是否包含提供给 <code>dotnet run</code> 的配置命令行参数的键值对。</li>
</ol>
<h5 id="自变量"><a class="header-anchor" href="#自变量">¶</a>自变量</h5>
<p>该值必须后跟一个等号 (<code>=</code>)，否则当值后跟一个空格时，键必须具有前缀（<code>--</code> 或 <code>/</code>）。 如果使用等号（例如 <code>CommandLineKey=</code>），则不需要该值。</p>
<table>
<thead>
<tr>
<th>键前缀</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>无前缀</td>
<td><code>CommandLineKey1=value1</code></td>
</tr>
<tr>
<td>双划线 (<code>--</code>)</td>
<td><code>--CommandLineKey2=value2</code>，<code>--CommandLineKey2 value2</code></td>
</tr>
<tr>
<td>正斜杠 (<code>/</code>)</td>
<td><code>/CommandLineKey3=value3</code>，<code>/CommandLineKey3 value3</code></td>
</tr>
</tbody>
</table>
<p>在同一命令中，不要将使用等号的命令行参数键值对与使用空格的键值对混合使用。</p>
<p>示例命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">dotnet run CommandLineKey1=value1 --CommandLineKey2=value2 /CommandLineKey3=value3<br>dotnet run --CommandLineKey1 value1 /CommandLineKey2 value2<br>dotnet run CommandLineKey1= CommandLineKey2=value2<br></code></pre></div></td></tr></table></figure>
<h5 id="交换映射"><a class="header-anchor" href="#交换映射">¶</a>交换映射</h5>
<p>交换映射支持键名替换逻辑。 使用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbuilder" target="_blank" rel="noopener"><code>ConfigurationBuilder</code></a> 手动构建配置时，需要为 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.commandlineconfigurationextensions.addcommandline" target="_blank" rel="noopener"><code>AddCommandLine</code></a> 方法提供交换替换字典。</p>
<p>当使用交换映射字典时，会检查字典中是否有与命令行参数提供的键匹配的键。 如果在字典中找到命令行键，则传回字典值（键替换）以将键值对设置为应用的配置。 对任何具有单划线 (<code>-</code>) 前缀的命令行键而言，交换映射都是必需的。</p>
<p>交换映射字典键规则：</p>
<ul>
<li>交换必须以单划线 (<code>-</code>) 或双划线 (<code>--</code>) 开头。</li>
<li>交换映射字典不得包含重复键。</li>
</ul>
<p>创建交换映射字典。 在以下示例中，创建了两个交换映射：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public static readonly Dictionary&lt;string, string&gt; _switchMappings &#x3D;<br>    new Dictionary&lt;string, string&gt;<br>    &#123;<br>        &#123; &quot;-CLKey1&quot;, &quot;CommandLineKey1&quot; &#125;,<br>        &#123; &quot;-CLKey2&quot;, &quot;CommandLineKey2&quot; &#125;<br></code></pre></div></td></tr></table></figure>
<p>生成主机后，使用交换映射字典来调用 <code>AddCommandLine</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">.ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>&#123;<br>    config.AddCommandLine(args, _switchMappings);<br>&#125;)<br></code></pre></div></td></tr></table></figure>
<p>对于使用交换映射的应用，调用 <code>CreateDefaultBuilder</code> 不应传递参数。 <code>CreateDefaultBuilder</code> 方法的 <code>AddCommandLine</code> 调用不包括映射的交换，并且无法将交换映射字典传递给 <code>CreateDefaultBuilder</code>。 解决方案不是将参数传递给 <code>CreateDefaultBuilder</code>，而是允许 <code>ConfigurationBuilder</code> 方法的 <code>AddCommandLine</code> 方法处理参数和交换映射字典。</p>
<p>创建交换映射字典后，它将包含下表所示的数据。</p>
<table>
<thead>
<tr>
<th>键</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>-CLKey1</code></td>
<td><code>CommandLineKey1</code></td>
</tr>
<tr>
<td><code>-CLKey2</code></td>
<td><code>CommandLineKey2</code></td>
</tr>
</tbody>
</table>
<p>如果在启动应用时使用了交换映射的键，则配置将接收字典提供的密钥上的配置值：</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">dotnet run -CLKey1=value1 -CLKey2=value2<br></code></pre></div></td></tr></table></figure>
<p>运行上述命令后，配置包含下表中显示的值。</p>
<table>
<thead>
<tr>
<th>键</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CommandLineKey1</code></td>
<td><code>value1</code></td>
</tr>
<tr>
<td><code>CommandLineKey2</code></td>
<td><code>value2</code></td>
</tr>
</tbody>
</table>
<h4 id="环境变量配置提供程序"><a class="header-anchor" href="#环境变量配置提供程序">¶</a>环境变量配置提供程序</h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.environmentvariables.environmentvariablesconfigurationprovider" target="_blank" rel="noopener"><code>EnvironmentVariablesConfigurationProvider</code></a> 在运行时从环境变量键值对加载配置。</p>
<p>要激活环境变量配置，请在 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbuilder" target="_blank" rel="noopener"><code>ConfigurationBuilder</code></a> 的实例上调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.environmentvariablesextensions.addenvironmentvariables" target="_blank" rel="noopener"><code>AddEnvironmentVariables</code></a> 扩展方法。</p>
<p>在环境变量中使用分层键时，冒号分隔符 (<code>:</code>) 可能无法适用于所有平台（例如 Bash）。 所有平台均支持采用双下划线 (<code>__</code>)，并可以用冒号自动替换。</p>
<p>借助 Azure 应用服务，可在 Azure 门户中设置使用环境变量配置提供程序替代应用配置的环境变量。 有关详细信息。</p>
<p>如果使用通用主机初始化新的主机生成器，且调用了 <code>CreateDefaultBuilder</code>，则使用 <code>AddEnvironmentVariables</code> 为主机配置加载前缀为 <code>DOTNET_</code> 的环境变量。</p>
<p>此外，<code>CreateDefaultBuilder</code> 也会加载：</p>
<ul>
<li>来自没有前缀的环境变量的应用配置，方法是通过调用不带前缀的 <code>AddEnvironmentVariables</code>。</li>
<li><em>appsettings.json</em> 和 <em>appsettings.{Environment}.json</em> 文件中的可选配置   。</li>
<li>用户机密 (Secret Manager)（在开发环境中）。</li>
<li>命令行参数。</li>
</ul>
<p>环境变量配置提供程序是在配置已根据用户机密和 appsettings  文件建立后调用。 在此位置调用提供程序允许在运行时读取的环境变量替代由用户机密和 appsettings  文件设置的配置。</p>
<p>要从其他环境变量提供应用配置，请在 <code>ConfigureAppConfiguration</code> 中调用应用的其他提供程序，并使用前缀调用 <code>AddEnvironmentVariables</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">.ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>&#123;<br>    config.AddEnvironmentVariables(prefix: &quot;PREFIX_&quot;);<br>&#125;)<br></code></pre></div></td></tr></table></figure>
<p>最后调用 <code>AddEnvironmentVariables</code>让带给定前缀的环境变量可替代其他提供程序中的值。</p>
<h5 id="示例-v2"><a class="header-anchor" href="#示例-v2">¶</a>示例</h5>
<p>示例应用利用静态便捷方法 <code>CreateDefaultBuilder</code> 来生成主机，其中包括一个对 <code>AddEnvironmentVariables</code> 的调用。</p>
<ol>
<li>运行示例应用。 在 <code>http://localhost:5000</code> 打开应用的浏览器。</li>
<li>观察输出是否包含环境变量 <code>ENVIRONMENT</code> 的键值对。 该值反映了应用运行的环境，在本地运行时通常为 <code>Development</code>。</li>
</ol>
<p>为了缩短应用呈现的环境变量列表，应用会筛选环境变量。 请参阅示例应用的“Pages/Index.cshtml.cs”文件  。</p>
<p>要公开应用可用的所有环境变量，请将 Pages/Index.cshtml.cs 中的 <code>FilteredConfiguration</code> 更改为以下内容  ：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">FilteredConfiguration &#x3D; _config.AsEnumerable();<br></code></pre></div></td></tr></table></figure>
<h5 id="前缀"><a class="header-anchor" href="#前缀">¶</a>前缀</h5>
<p>为 <code>AddEnvironmentVariables</code> 方法提供前缀时，将筛选加载到应用的配置中的环境变量。 例如，要筛选前缀 <code>CUSTOM_</code> 上的环境变量，请将前缀提供给配置提供程序：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">var config &#x3D; new ConfigurationBuilder()<br>    .AddEnvironmentVariables(&quot;CUSTOM_&quot;)<br>    .Build();<br></code></pre></div></td></tr></table></figure>
<p>创建配置键值对时，将去除前缀。</p>
<p>若已创建主机生成器，则主机配置由环境变量提供。</p>
<h6 id="连接字符串前缀"><a class="header-anchor" href="#连接字符串前缀">¶</a><strong>连接字符串前缀</strong></h6>
<p>针对为应用环境配置 Azure 连接字符串所涉及的四个连接字符串环境变量，配置 API 具有特殊的处理规则。 如果没有向 <code>AddEnvironmentVariables</code> 提供前缀，则具有表中所示前缀的环境变量将加载到应用中。</p>
<table>
<thead>
<tr>
<th>连接字符串前缀</th>
<th>提供程序</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CUSTOMCONNSTR_</code></td>
<td>自定义提供程序</td>
</tr>
<tr>
<td><code>MYSQLCONNSTR_</code></td>
<td><a href="https://www.mysql.com/" target="_blank" rel="noopener">MySQL</a></td>
</tr>
<tr>
<td><code>SQLAZURECONNSTR_</code></td>
<td><a href="https://azure.microsoft.com/services/sql-database/" target="_blank" rel="noopener">Azure SQL 数据库</a></td>
</tr>
<tr>
<td><code>SQLCONNSTR_</code></td>
<td><a href="https://www.microsoft.com/sql-server/" target="_blank" rel="noopener">SQL Server</a></td>
</tr>
</tbody>
</table>
<p>当发现环境变量并使用表中所示的四个前缀中的任何一个加载到配置中时：</p>
<ul>
<li>通过删除环境变量前缀并添加配置键节 (<code>ConnectionStrings</code>) 来创建配置键。</li>
<li>创建一个新的配置键值对，表示数据库连接提供程序（<code>CUSTOMCONNSTR_</code> 除外，它没有声明的提供程序）。</li>
</ul>
<table>
<thead>
<tr>
<th>环境变量键</th>
<th>转换的配置键</th>
<th>提供程序配置条目</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>CUSTOMCONNSTR_{KEY}</code></td>
<td><code>ConnectionStrings:{KEY}</code></td>
<td>配置条目未创建。</td>
</tr>
<tr>
<td><code>MYSQLCONNSTR_{KEY}</code></td>
<td><code>ConnectionStrings:{KEY}</code></td>
<td>键：<code>ConnectionStrings:{KEY}_ProviderName</code>： 值：<code>MySql.Data.MySqlClient</code></td>
</tr>
<tr>
<td><code>SQLAZURECONNSTR_{KEY}</code></td>
<td><code>ConnectionStrings:{KEY}</code></td>
<td>键：<code>ConnectionStrings:{KEY}_ProviderName</code>： 值：<code>System.Data.SqlClient</code></td>
</tr>
<tr>
<td><code>SQLCONNSTR_{KEY}</code></td>
<td><code>ConnectionStrings:{KEY}</code></td>
<td>键：<code>ConnectionStrings:{KEY}_ProviderName</code>： 值：<code>System.Data.SqlClient</code></td>
</tr>
</tbody>
</table>
<p>示例</p>
<p>在服务器上创建了一个自定义连接字符串环境变量：</p>
<ul>
<li>名称 – <code>CUSTOMCONNSTR_ReleaseDB</code></li>
<li>值 – <code>Data Source=ReleaseSQLServer;Initial Catalog=MyReleaseDB;Integrated Security=True</code></li>
</ul>
<p>如果 <code>IConfiguration</code> 已引入并分配给名为 <code>_config</code> 的字段，请读取值：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">_config[&quot;ConnectionStrings:ReleaseDB&quot;]<br></code></pre></div></td></tr></table></figure>
<h4 id="文件配置提供程序"><a class="header-anchor" href="#文件配置提供程序">¶</a>文件配置提供程序</h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.fileconfigurationprovider" target="_blank" rel="noopener"><code>FileConfigurationProvider</code></a> 是从文件系统加载配置的基类。 以下配置提供程序专用于特定文件类型：</p>
<ul>
<li>INI 配置提供程序</li>
<li>JSON 配置提供程序</li>
<li>XML 配置提供程序</li>
</ul>
<h5 id="INI-配置提供程序"><a class="header-anchor" href="#INI-配置提供程序">¶</a>INI 配置提供程序</h5>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.ini.iniconfigurationprovider" target="_blank" rel="noopener"><code>IniConfigurationProvider</code></a> 在运行时从 INI 文件键值对加载配置。</p>
<p>若要激活 INI 文件配置，请在 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbuilder" target="_blank" rel="noopener"><code>ConfigurationBuilder</code></a> 的实例上调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iniconfigurationextensions.addinifile" target="_blank" rel="noopener"><code>AddIniFile</code></a> 扩展方法。</p>
<p>冒号可用作 INI 文件配置中的节分隔符。</p>
<p>重载允许指定：</p>
<ul>
<li>文件是否可选。</li>
<li>如果文件更改，是否重载配置。</li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.fileproviders.ifileprovider" target="_blank" rel="noopener"><code>IFileProvider</code></a> 用于访问该文件。</li>
</ul>
<p>构建主机时调用 <code>ConfigureAppConfiguration</code> 以指定应用的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">.ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>&#123;<br>    config.AddIniFile(<br>        &quot;config.ini&quot;, optional: true, reloadOnChange: true);<br>&#125;)<br></code></pre></div></td></tr></table></figure>
<p>INI 配置文件的通用示例：</p>
<figure class="highlight ini"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs ini"><span class="hljs-section">[section0]</span><br><span class="hljs-attr">key0</span>=value<br><span class="hljs-attr">key1</span>=value<br><br><span class="hljs-section">[section1]</span><br>subsection:key=value<br><br><span class="hljs-section">[section2:subsection0]</span><br><span class="hljs-attr">key</span>=value<br><br><span class="hljs-section">[section2:subsection1]</span><br><span class="hljs-attr">key</span>=value<br></code></pre></div></td></tr></table></figure>
<p>以上的配置文件使用 <code>value</code> 加载以下键：</p>
<ul>
<li><code>section0:key0</code></li>
<li><code>section0:key1</code></li>
<li><code>section1:subsection:key</code></li>
<li><code>section2:subsection0:key</code></li>
<li><code>section2:subsection1:key</code></li>
</ul>
<h5 id="JSON-配置提供程序"><a class="header-anchor" href="#JSON-配置提供程序">¶</a>JSON 配置提供程序</h5>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.json.jsonconfigurationprovider" target="_blank" rel="noopener"><code>JsonConfigurationProvider</code></a> 在运行时期间从 JSON 文件键值对加载配置。</p>
<p>若要激活 JSON 文件配置，请在 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbuilder" target="_blank" rel="noopener"><code>ConfigurationBuilder</code></a> 的实例上调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.jsonconfigurationextensions.addjsonfile" target="_blank" rel="noopener"><code>AddJsonFile</code></a> 扩展方法。</p>
<p>重载允许指定：</p>
<ul>
<li>文件是否可选。</li>
<li>如果文件更改，是否重载配置。</li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.fileproviders.ifileprovider" target="_blank" rel="noopener"><code>IFileProvider</code></a> 用于访问该文件。</li>
</ul>
<p>使用 <code>CreateDefaultBuilder</code> 初始化新的主机生成器时，会自动调用两次 <code>AddJsonFile</code>。 调用该方法来从以下文件加载配置：</p>
<ul>
<li><em>appsettings.json</em> – 首先读取此文件  。 该文件的环境版本可以替代 <em>appsettings.json</em>  文件提供的值。</li>
<li><em>appsettings.{Environment}.json</em> – 根据 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihostingenvironment.environmentname" target="_blank" rel="noopener"><code>IHostingEnvironment.EnvironmentName</code></a> 加载文件的环境版本  。</li>
</ul>
<p>此外，<code>CreateDefaultBuilder</code> 也会加载：</p>
<ul>
<li>环境变量。</li>
<li>用户机密 (Secret Manager)（在开发环境中）。</li>
<li>命令行参数。</li>
</ul>
<p>首先建立 JSON 配置提供程序。 因此，用户机密、环境变量和命令行参数会替代由 appsettings  文件设置的配置。</p>
<p>构建主机时调用 <code>ConfigureAppConfiguration</code> 以指定除 <em>appsettings.json</em> 和 <em>appsettings.{Environment}.json</em> 以外的文件的应用配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">.ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>&#123;<br>    config.AddJsonFile(<br>        &quot;config.json&quot;, optional: true, reloadOnChange: true);<br>&#125;)<br></code></pre></div></td></tr></table></figure>
<h6 id="示例-v3"><a class="header-anchor" href="#示例-v3">¶</a><strong>示例</strong></h6>
<p>示例应用利用静态便捷方法 <code>CreateDefaultBuilder</code> 来生成主机，其中包括两个对 <code>AddJsonFile</code> 的调用：</p>
<ul>
<li>
<p>第一次调用 <code>AddJsonFile</code> 会从 appsettings 加载配置  ：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">"Logging"</span>: &#123;<br>    <span class="hljs-attr">"LogLevel"</span>: &#123;<br>      <span class="hljs-attr">"Default"</span>: <span class="hljs-string">"Information"</span>,<br>      <span class="hljs-attr">"Microsoft"</span>: <span class="hljs-string">"Warning"</span>,<br>      <span class="hljs-attr">"Microsoft.Hosting.Lifetime"</span>: <span class="hljs-string">"Information"</span><br>    &#125;<br>  &#125;,<br>  <span class="hljs-attr">"AllowedHosts"</span>: <span class="hljs-string">"*"</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>第二次调用 <code>AddJsonFile</code> 会从 <em>appsettings.{Environment}.json</em> 加载配置  。 对于示例应用中的 <em>appsettings.Development.json</em>，将加载以下文件  ：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">&#123;<br>  &quot;Logging&quot;: &#123;<br>    &quot;LogLevel&quot;: &#123;<br>      &quot;Default&quot;: &quot;Debug&quot;,<br>      &quot;System&quot;: &quot;Information&quot;,<br>      &quot;Microsoft&quot;: &quot;Information&quot;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
</li>
</ul>
<ol>
<li>
<p>运行示例应用。 在 <code>http://localhost:5000</code> 打开应用的浏览器。</p>
</li>
<li>
<p>输出包含配置的键值对（由应用的环境而定）。 在开发环境中运行应用时，键 <code>Logging:LogLevel:Default</code> 的日志级别为 <code>Debug</code>。</p>
</li>
<li>
<p>再次在生产环境中运行示例应用：</p>
<ol>
<li>打开 <em>Properties/launchSettings.json</em> 文件  。</li>
<li>在 <code>ConfigurationSample</code> 配置文件中，将 <code>ASPNETCORE_ENVIRONMENT</code> 环境变量的值更改为 <code>Production</code>。</li>
<li>保存文件，然后在命令外壳中使用 <code>dotnet run</code> 运行应用。</li>
</ol>
</li>
<li>
<p><em>appsettings.Development.json</em> 中的设置不再替代 <em>appsettings.json</em> 中的设置 。键 <code>Logging:LogLevel:Default</code> 的日志级别为 <code>Information</code>。</p>
</li>
</ol>
<h4 id="XML-配置提供程序"><a class="header-anchor" href="#XML-配置提供程序">¶</a>XML 配置提供程序</h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.xml.xmlconfigurationprovider" target="_blank" rel="noopener"><code>XmlConfigurationProvider</code></a> 在运行时从 XML 文件键值对加载配置。</p>
<p>若要激活 XML 文件配置，请在 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbuilder" target="_blank" rel="noopener"><code>ConfigurationBuilder</code></a> 的实例上调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.xmlconfigurationextensions.addxmlfile" target="_blank" rel="noopener"><code>AddXmlFile</code></a> 扩展方法。</p>
<p>重载允许指定：</p>
<ul>
<li>文件是否可选。</li>
<li>如果文件更改，是否重载配置。</li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.fileproviders.ifileprovider" target="_blank" rel="noopener"><code>IFileProvider</code></a> 用于访问该文件。</li>
</ul>
<p>创建配置键值对时，将忽略配置文件的根节点。 不要在文件中指定文档类型定义 (DTD) 或命名空间。</p>
<p>构建主机时调用 <code>ConfigureAppConfiguration</code> 以指定应用的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">.ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>&#123;<br>    config.AddXmlFile(<br>        &quot;config.xml&quot;, optional: true, reloadOnChange: true);<br>&#125;)<br></code></pre></div></td></tr></table></figure>
<p>XML 配置文件可以为重复节使用不同的元素名称：</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">section0</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">key0</span>&gt;</span>value<span class="hljs-tag">&lt;/<span class="hljs-name">key0</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">key1</span>&gt;</span>value<span class="hljs-tag">&lt;/<span class="hljs-name">key1</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">section0</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">section1</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">key0</span>&gt;</span>value<span class="hljs-tag">&lt;/<span class="hljs-name">key0</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">key1</span>&gt;</span>value<span class="hljs-tag">&lt;/<span class="hljs-name">key1</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">section1</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></div></td></tr></table></figure>
<p>以上的配置文件使用 <code>value</code> 加载以下键：</p>
<ul>
<li><code>section0:key0</code></li>
<li><code>section0:key1</code></li>
<li><code>section1:key0</code></li>
<li><code>section1:key1</code></li>
</ul>
<p>如果使用 <code>name</code> 属性来区分元素，则使用相同元素名称的重复元素可以正常工作：</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"section0"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">key</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"key0"</span>&gt;</span>value<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">key</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"key1"</span>&gt;</span>value<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">section</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"section1"</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">key</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"key0"</span>&gt;</span>value<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">key</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"key1"</span>&gt;</span>value<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></div></td></tr></table></figure>
<p>以上的配置文件使用 <code>value</code> 加载以下键：</p>
<ul>
<li><code>section:section0:key:key0</code></li>
<li><code>section:section0:key:key1</code></li>
<li><code>section:section1:key:key0</code></li>
<li><code>section:section1:key:key1</code></li>
</ul>
<p>属性可用于提供值：</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">key</span> <span class="hljs-attr">attribute</span>=<span class="hljs-string">"value"</span> /&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">section</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">key</span> <span class="hljs-attr">attribute</span>=<span class="hljs-string">"value"</span> /&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">section</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></div></td></tr></table></figure>
<p>以前的配置文件使用 <code>value</code> 加载以下键：</p>
<ul>
<li><code>key:attribute</code></li>
<li><code>section:key:attribute</code></li>
</ul>
<h4 id="Key-per-file-配置提供程序"><a class="header-anchor" href="#Key-per-file-配置提供程序">¶</a>Key-per-file 配置提供程序</h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.keyperfile.keyperfileconfigurationprovider" target="_blank" rel="noopener"><code>KeyPerFileConfigurationProvider</code></a> 使用目录的文件作为配置键值对。 该键是文件名。 该值包含文件的内容。</p>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>Key-per-file 配置提供程序用于 Docker 托管方案。</p>
</blockquote>
<p>若要激活 Key-per-file 配置，请在 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbuilder" target="_blank" rel="noopener"><code>ConfigurationBuilder</code></a> 的实例上调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.keyperfileconfigurationbuilderextensions.addkeyperfile" target="_blank" rel="noopener">AddKeyPerFile</a> 扩展方法。 文件的 <code>directoryPath</code> 必须是绝对路径。</p>
<p>重载允许指定：</p>
<ul>
<li>配置源的 <code>Action&lt;KeyPerFileConfigurationSource&gt;</code> 委托。</li>
<li>目录是否可选以及目录的路径。</li>
</ul>
<p>双下划线字符 (<code>__</code>) 用作文件名中的配置键分隔符。 例如，文件名 <code>Logging__LogLevel__System</code> 生成配置键 <code>Logging:LogLevel:System</code>。</p>
<p>构建主机时调用 <code>ConfigureAppConfiguration</code> 以指定应用的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">.ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>&#123;<br>    var path &#x3D; Path.Combine(<br>        Directory.GetCurrentDirectory(), &quot;path&#x2F;to&#x2F;files&quot;);<br>    config.AddKeyPerFile(directoryPath: path, optional: true);<br>&#125;)<br></code></pre></div></td></tr></table></figure>
<h4 id="内存配置提供程序"><a class="header-anchor" href="#内存配置提供程序">¶</a>内存配置提供程序</h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.memory.memoryconfigurationprovider" target="_blank" rel="noopener"><code>MemoryConfigurationProvider</code></a> 使用内存中集合作为配置键值对。</p>
<p>若要激活内存中集合配置，请在 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbuilder" target="_blank" rel="noopener"><code>ConfigurationBuilder</code></a> 的实例上调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.memoryconfigurationbuilderextensions.addinmemorycollection" target="_blank" rel="noopener"><code>AddInMemoryCollection</code></a> 扩展方法。</p>
<p>可以使用 <code>IEnumerable&lt;KeyValuePair&lt;String,String&gt;&gt;</code> 初始化配置提供程序。</p>
<p>构建主机时调用 <code>ConfigureAppConfiguration</code> 以指定应用的配置。</p>
<p>在下面的示例中，创建了配置字典：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public static readonly Dictionary&lt;string, string&gt; _dict &#x3D;<br>    new Dictionary&lt;string, string&gt;<br>    &#123;<br>        &#123;&quot;MemoryCollectionKey1&quot;, &quot;value1&quot;&#125;,<br>        &#123;&quot;MemoryCollectionKey2&quot;, &quot;value2&quot;&#125;<br>    &#125;;<br></code></pre></div></td></tr></table></figure>
<p>通过 <code>AddInMemoryCollection</code> 的调用使用字典，以提供配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">.ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>&#123;<br>    config.AddInMemoryCollection(_dict);<br>&#125;)<br></code></pre></div></td></tr></table></figure>
<h4 id="GetValue"><a class="header-anchor" href="#GetValue">¶</a><code>GetValue</code></h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbinder.getvalue" target="_blank" rel="noopener"><code>ConfigurationBinder.GetValueT&lt;&gt;</code></a> 从配置中提取一个具有指定键的值，并将其转换为指定的非集合类型。 重载接受默认值。</p>
<p>如下示例中：</p>
<ul>
<li>使用键 <code>NumberKey</code> 从配置中提取字符串值。 如果在配置键中找不到 <code>NumberKey</code>，则使用默认值 <code>99</code>。</li>
<li>键入值作为 <code>int</code>。</li>
<li>存储 <code>NumberConfig</code> 属性中的值，以供页面使用。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class IndexModel : PageModel<br>&#123;<br>    public IndexModel(IConfiguration config)<br>    &#123;<br>        _config &#x3D; config;<br>    &#125;<br><br>    public int NumberConfig &#123; get; private set; &#125;<br><br>    public void OnGet()<br>    &#123;<br>        NumberConfig &#x3D; _config.GetValue&lt;int&gt;(&quot;NumberKey&quot;, 99);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="GetSection、GetChildren-和-Exists"><a class="header-anchor" href="#GetSection、GetChildren-和-Exists">¶</a><code>GetSection</code>、<code>GetChildren</code> 和 <code>Exists</code></h4>
<p>对于下面的示例，请考虑以下 JSON 文件。 在两个节中找到四个键，其中一个包含一对子节：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">"section0"</span>: &#123;<br>    <span class="hljs-attr">"key0"</span>: <span class="hljs-string">"value"</span>,<br>    <span class="hljs-attr">"key1"</span>: <span class="hljs-string">"value"</span><br>  &#125;,<br>  <span class="hljs-attr">"section1"</span>: &#123;<br>    <span class="hljs-attr">"key0"</span>: <span class="hljs-string">"value"</span>,<br>    <span class="hljs-attr">"key1"</span>: <span class="hljs-string">"value"</span><br>  &#125;,<br>  <span class="hljs-attr">"section2"</span>: &#123;<br>    <span class="hljs-attr">"subsection0"</span> : &#123;<br>      <span class="hljs-attr">"key0"</span>: <span class="hljs-string">"value"</span>,<br>      <span class="hljs-attr">"key1"</span>: <span class="hljs-string">"value"</span><br>    &#125;,<br>    <span class="hljs-attr">"subsection1"</span> : &#123;<br>      <span class="hljs-attr">"key0"</span>: <span class="hljs-string">"value"</span>,<br>      <span class="hljs-attr">"key1"</span>: <span class="hljs-string">"value"</span><br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>将文件读入配置时，会创建以下唯一的分层键来保存配置值：</p>
<ul>
<li><code>section0:key0</code></li>
<li><code>section0:key1</code></li>
<li><code>section1:key0</code></li>
<li><code>section1:key1</code></li>
<li><code>section2:subsection0:key0</code></li>
<li><code>section2:subsection0:key1</code></li>
<li><code>section2:subsection1:key0</code></li>
<li><code>section2:subsection1:key1</code></li>
</ul>
<h5 id="GetSection"><a class="header-anchor" href="#GetSection">¶</a><code>GetSection</code></h5>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfiguration.getsection" target="_blank" rel="noopener"><code>IConfiguration.GetSection</code></a> 使用指定的子节键提取配置子节。</p>
<p>若要返回仅包含 <code>section1</code> 中键值对的 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfigurationsection" target="_blank" rel="noopener"><code>IConfigurationSection</code></a>，请调用 <code>GetSection</code> 并提供节名称：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">var configSection &#x3D; _config.GetSection(&quot;section1&quot;);<br></code></pre></div></td></tr></table></figure>
<p><code>configSection</code> 不具有值，只有密钥和路径。</p>
<p>同样，若要获取 <code>section2:subsection0</code> 中键的值，请调用 <code>GetSection</code> 并提供节路径：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">var configSection &#x3D; _config.GetSection(&quot;section2:subsection0&quot;);<br></code></pre></div></td></tr></table></figure>
<p><code>GetSection</code> 永远不会返回 <code>null</code>。 如果找不到匹配的节，则返回空 <code>IConfigurationSection</code>。</p>
<p>当 <code>GetSection</code> 返回匹配的部分时，<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfigurationsection.value#Microsoft_Extensions_Configuration_IConfigurationSection_Value" target="_blank" rel="noopener"><code>Value</code></a> 未填充。 存在该部分时，返回一个 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfigurationsection.key#Microsoft_Extensions_Configuration_IConfigurationSection_Key" target="_blank" rel="noopener"><code>Key</code></a> 和 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfigurationsection.path#Microsoft_Extensions_Configuration_IConfigurationSection_Path" target="_blank" rel="noopener"><code>Path</code></a> 部分。</p>
<h5 id="GetChildren"><a class="header-anchor" href="#GetChildren">¶</a><code>GetChildren</code></h5>
<p>在 <code>section2</code> 上调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfiguration.getchildren" target="_blank" rel="noopener">IConfiguration.GetChildren</a> 会获得 <code>IEnumerable&lt;IConfigurationSection&gt;</code>，其中包括：</p>
<ul>
<li><code>subsection0</code></li>
<li><code>subsection1</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">var configSection &#x3D; _config.GetSection(&quot;section2&quot;);<br><br>var children &#x3D; configSection.GetChildren();<br></code></pre></div></td></tr></table></figure>
<h5 id="Exists"><a class="header-anchor" href="#Exists">¶</a><code>Exists</code></h5>
<p>使用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationextensions.exists" target="_blank" rel="noopener"><code>ConfigurationExtensions.Exists</code></a> 确定配置节是否存在：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">var sectionExists &#x3D; _config.GetSection(&quot;section2:subsection2&quot;).Exists();<br></code></pre></div></td></tr></table></figure>
<p>给定示例数据，<code>sectionExists</code> 为 <code>false</code>，因为配置数据中没有 <code>section2:subsection2</code> 节。</p>
<h4 id="绑定至类"><a class="header-anchor" href="#绑定至类">¶</a>绑定至类</h4>
<p>可以使用选项模式  将配置绑定到表示相关设置组的类。</p>
<p>配置值作为字符串返回，但调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbinder.bind" target="_blank" rel="noopener"><code>Bind</code></a> 可以构造 <a href="https://wikipedia.org/wiki/Plain_Old_CLR_Object" target="_blank" rel="noopener"><code>POCO</code></a> 对象。 绑定器将值绑定到所提供类型的所有公共读取/写入属性。 不会绑定字段  。</p>
<p>示例应用包含 <code>Starship</code> 模型 (<em>Models/Starship.cs</em>)：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Starship<br>&#123;<br>    public string Name &#123; get; set; &#125;<br>    public string Registry &#123; get; set; &#125;<br>    public string Class &#123; get; set; &#125;<br>    public decimal Length &#123; get; set; &#125;<br>    public bool Commissioned &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>当示例应用使用 JSON 配置提供程序加载配置时，<em>starship.json</em>  文件的 <code>starship</code> 节会创建配置：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">"starship"</span>: &#123;<br>    <span class="hljs-attr">"name"</span>: <span class="hljs-string">"USS Enterprise"</span>,<br>    <span class="hljs-attr">"registry"</span>: <span class="hljs-string">"NCC-1701"</span>,<br>    <span class="hljs-attr">"class"</span>: <span class="hljs-string">"Constitution"</span>,<br>    <span class="hljs-attr">"length"</span>: <span class="hljs-number">304.8</span>,<br>    <span class="hljs-attr">"commissioned"</span>: <span class="hljs-literal">false</span><br>  &#125;,<br>  <span class="hljs-attr">"trademark"</span>: <span class="hljs-string">"Paramount Pictures Corp. http://www.paramount.com"</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>创建以下配置键值对：</p>
<table>
<thead>
<tr>
<th>键</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr>
<td>starship:name</td>
<td>USS Enterprise</td>
</tr>
<tr>
<td>starship:registry</td>
<td>NCC-1701</td>
</tr>
<tr>
<td>starship:class</td>
<td>Constitution</td>
</tr>
<tr>
<td>starship:length</td>
<td>304.8</td>
</tr>
<tr>
<td>starship:commissioned</td>
<td>False</td>
</tr>
<tr>
<td>trademark</td>
<td>Paramount Pictures Corp. <a href="https://www.paramount.com" target="_blank" rel="noopener">https://www.paramount.com</a></td>
</tr>
</tbody>
</table>
<p>示例应用使用 <code>starship</code> 键调用 <code>GetSection</code>。 <code>starship</code> 键值对是独立的。 在子节传入 <code>Starship</code> 类的实例时调用 <code>Bind</code> 方法。 绑定实例值后，将实例分配给用于呈现的属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">var starship &#x3D; new Starship();<br>_config.GetSection(&quot;starship&quot;).Bind(starship);<br>Starship &#x3D; starship;<br></code></pre></div></td></tr></table></figure>
<h4 id="绑定至对象图"><a class="header-anchor" href="#绑定至对象图">¶</a>绑定至对象图</h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbinder.bind" target="_blank" rel="noopener"><code>Bind</code></a> 能够绑定整个 POCO 对象图。 与绑定简单对象一样，只绑定公共读取/写入属性。</p>
<p>该示例包含 <code>TvShow</code> 模型，其对象图包含 <code>Metadata</code> 和 <code>Actors</code> 类 (<em>Models/TvShow.cs</em>)：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class TvShow<br>&#123;<br>    public Metadata Metadata &#123; get; set; &#125;<br>    public Actors Actors &#123; get; set; &#125;<br>    public string Legal &#123; get; set; &#125;<br>&#125;<br><br>public class Metadata<br>&#123;<br>    public string Series &#123; get; set; &#125;<br>    public string Title &#123; get; set; &#125;<br>    public DateTime AirDate &#123; get; set; &#125;<br>    public int Episodes &#123; get; set; &#125;<br>&#125;<br><br>public class Actors<br>&#123;<br>    public string Names &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>示例应用有一个包含配置数据的 <em>tvshow.xml</em>  文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">tvshow</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">metadata</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">series</span>&gt;</span>Dr. Who<span class="hljs-tag">&lt;/<span class="hljs-name">series</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>The Sun Makers<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">airdate</span>&gt;</span>11/26/1977<span class="hljs-tag">&lt;/<span class="hljs-name">airdate</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">episodes</span>&gt;</span>4<span class="hljs-tag">&lt;/<span class="hljs-name">episodes</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">metadata</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">actors</span>&gt;</span><br>      <span class="hljs-tag">&lt;<span class="hljs-name">names</span>&gt;</span>Tom Baker, Louise Jameson, John Leeson<span class="hljs-tag">&lt;/<span class="hljs-name">names</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">actors</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">legal</span>&gt;</span>(c)1977 BBC https://www.bbc.co.uk/programmes/b006q2x0<span class="hljs-tag">&lt;/<span class="hljs-name">legal</span>&gt;</span><br>  <span class="hljs-tag">&lt;/<span class="hljs-name">tvshow</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></div></td></tr></table></figure>
<p>使用 <code>Bind</code> 方法将配置绑定到整个 <code>TvShow</code> 对象图。 将绑定实例分配给用于呈现的属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">var tvShow &#x3D; new TvShow();<br>_config.GetSection(&quot;tvshow&quot;).Bind(tvShow);<br>TvShow &#x3D; tvShow;<br></code></pre></div></td></tr></table></figure>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbinder.get" target="_blank" rel="noopener"><code>ConfigurationBinder.Get</code></a> 绑定并返回指定类型。 <code>Get&lt;T&gt;</code> 比使用 <code>Bind</code> 更方便。 以下代码显示如何将 <code>Get&lt;T&gt;</code> 与前面的示例一起使用，该示例允许将绑定实例直接分配给用于呈现的属性：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">TvShow &#x3D; _config.GetSection(&quot;tvshow&quot;).Get&lt;TvShow&gt;();<br></code></pre></div></td></tr></table></figure>
<h4 id="将数组绑定至类"><a class="header-anchor" href="#将数组绑定至类">¶</a>将数组绑定至类</h4>
<p>示例应用演示了本部分中介绍的概念。</p>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbinder.bind" target="_blank" rel="noopener"><code>Bind</code></a> 支持使用配置键中的数组索引将数组绑定到对象。 公开数字键段（<code>:0:</code>、<code>:1:</code>、… <code>:{n}:</code>）的任何数组格式都能够与 POCO 类数组进行数组绑定。</p>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>绑定是按约定提供的。 不需要自定义配置提供程序实现数组绑定。</p>
</blockquote>
<h5 id="内存中数组处理"><a class="header-anchor" href="#内存中数组处理">¶</a>内存中数组处理</h5>
<p>请考虑下表中所示的配置键和值。</p>
<table>
<thead>
<tr>
<th style="text-align:center">键</th>
<th style="text-align:center">值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">array:entries:0</td>
<td style="text-align:center">value0</td>
</tr>
<tr>
<td style="text-align:center">array:entries:1</td>
<td style="text-align:center">value1</td>
</tr>
<tr>
<td style="text-align:center">array:entries:2</td>
<td style="text-align:center">value2</td>
</tr>
<tr>
<td style="text-align:center">array:entries:4</td>
<td style="text-align:center">value4</td>
</tr>
<tr>
<td style="text-align:center">array:entries:5</td>
<td style="text-align:center">value5</td>
</tr>
</tbody>
</table>
<p>使用内存配置提供程序在示例应用中加载这些键和值：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Program<br>&#123;<br>    public static Dictionary&lt;string, string&gt; arrayDict &#x3D;<br>        new Dictionary&lt;string, string&gt;<br>        &#123;<br>            &#123;&quot;array:entries:0&quot;, &quot;value0&quot;&#125;,<br>            &#123;&quot;array:entries:1&quot;, &quot;value1&quot;&#125;,<br>            &#123;&quot;array:entries:2&quot;, &quot;value2&quot;&#125;,<br>            &#123;&quot;array:entries:4&quot;, &quot;value4&quot;&#125;,<br>            &#123;&quot;array:entries:5&quot;, &quot;value5&quot;&#125;<br>        &#125;;<br><br>    public static void Main(string[] args)<br>    &#123;<br>        CreateHostBuilder(args).Build().Run();<br>    &#125;<br><br>    public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;<br>        Host.CreateDefaultBuilder(args)<br>            .ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>            &#123;<br>                config.AddInMemoryCollection(arrayDict);<br>                config.AddJsonFile(<br>                    &quot;json_array.json&quot;, optional: false, reloadOnChange: false);<br>                config.AddJsonFile(<br>                    &quot;starship.json&quot;, optional: false, reloadOnChange: false);<br>                config.AddXmlFile(<br>                    &quot;tvshow.xml&quot;, optional: false, reloadOnChange: false);<br>                config.AddEFConfiguration(<br>                    options &#x3D;&gt; options.UseInMemoryDatabase(&quot;InMemoryDb&quot;));<br>                config.AddCommandLine(args);<br>            &#125;)<br>            .ConfigureWebHostDefaults(webBuilder &#x3D;&gt;<br>            &#123;<br>                webBuilder.UseStartup&lt;Startup&gt;();<br>            &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>该数组跳过索引 #3 的值。 配置绑定程序无法绑定 <code>null</code> 值，也无法在绑定对象中创建 <code>null</code> 条目，这在演示将此数组绑定到对象的结果时变得清晰。</p>
<p>在示例应用中，POCO 类可用于保存绑定的配置数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class ArrayExample<br>&#123;<br>    public string[] Entries &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>将配置数据绑定至对象：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">var arrayExample &#x3D; new ArrayExample();<br>_config.GetSection(&quot;array&quot;).Bind(arrayExample);<br></code></pre></div></td></tr></table></figure>
<p>还可以使用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.configurationbinder.get" target="_blank" rel="noopener"><code>ConfigurationBinder.Get</code></a> 语法，这样会得到更精简的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">ArrayExample &#x3D; _config.GetSection(&quot;array&quot;).Get&lt;ArrayExample&gt;();<br></code></pre></div></td></tr></table></figure>
<p>绑定对象（<code>ArrayExample</code> 的实例）从配置接收数组数据。</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>ArrayExample.Entries</code> 索引</th>
<th style="text-align:center"><code>ArrayExample.Entries</code> 值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">value0</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">value1</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">value2</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">value4</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">value5</td>
</tr>
</tbody>
</table>
<p>绑定对象中的索引 #3 保留 <code>array:4</code> 配置键的配置数据及其值 <code>value4</code>。 当绑定包含数组的配置数据时，配置键中的数组索引仅用于在创建对象时迭代配置数据。 无法在配置数据中保留 <code>null</code> 值，并且当配置键中的数组跳过一个或多个索引时，不会在绑定对象中创建 <code>null</code> 值条目。</p>
<p>可以在由任何在配置中生成正确键值对的配置提供程序绑定到 <code>ArrayExample</code> 实例之前提供索引 #3 的缺失配置项。 如果示例包含具有缺失键值对的其他 JSON 配置提供程序，则 <code>ArrayExample.Entries</code> 与完整配置数组相匹配：</p>
<p><em>missing_value.json</em>:</p>
<figure class="highlight json"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">"array:entries:3"</span>: <span class="hljs-string">"value3"</span><br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在 <code>ConfigureAppConfiguration</code>中：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">config.AddJsonFile(<br>    &quot;missing_value.json&quot;, optional: false, reloadOnChange: false);<br></code></pre></div></td></tr></table></figure>
<p>将表中所示的键值对加载到配置中。</p>
<table>
<thead>
<tr>
<th style="text-align:center">键</th>
<th style="text-align:center">“值”</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">array:entries:3</td>
<td style="text-align:center">value3</td>
</tr>
</tbody>
</table>
<p>如果在 JSON 配置提供程序包含索引 #3 的条目之后绑定 <code>ArrayExample</code> 类实例，则 <code>ArrayExample.Entries</code> 数组包含该值。</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>ArrayExample.Entries</code> 索引</th>
<th style="text-align:center"><code>ArrayExample.Entries</code> 值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">value0</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">value1</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">value2</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">value3</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">value4</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">value5</td>
</tr>
</tbody>
</table>
<h5 id="JSON-数组处理"><a class="header-anchor" href="#JSON-数组处理">¶</a>JSON 数组处理</h5>
<p>如果 JSON 文件包含数组，则会为具有从零开始的节索引的数组元素创建配置键。 在以下配置文件中，<code>subsection</code> 是一个数组：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">"json_array"</span>: &#123;<br>    <span class="hljs-attr">"key"</span>: <span class="hljs-string">"valueA"</span>,<br>    <span class="hljs-attr">"subsection"</span>: [<br>      <span class="hljs-string">"valueB"</span>,<br>      <span class="hljs-string">"valueC"</span>,<br>      <span class="hljs-string">"valueD"</span><br>    ]<br>  &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>JSON 配置提供程序将配置数据读入以下键值对：</p>
<table>
<thead>
<tr>
<th>键</th>
<th style="text-align:center">值</th>
</tr>
</thead>
<tbody>
<tr>
<td>json_array:key</td>
<td style="text-align:center">valueA</td>
</tr>
<tr>
<td>json_array:subsection:0</td>
<td style="text-align:center">valueB</td>
</tr>
<tr>
<td>json_array:subsection:1</td>
<td style="text-align:center">valueC</td>
</tr>
<tr>
<td>json_array:subsection:2</td>
<td style="text-align:center">valueD</td>
</tr>
</tbody>
</table>
<p>在示例应用中，以下 POCO 类可用于绑定配置键值对：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class JsonArrayExample<br>&#123;<br>    public string Key &#123; get; set; &#125;<br>    public string[] Subsection &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>绑定后，<code>JsonArrayExample.Key</code> 保存值 <code>valueA</code>。 子节值存储在 POCO 数组属性 <code>Subsection</code> 中。</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>JsonArrayExample.Subsection</code> 索引</th>
<th style="text-align:center"><code>JsonArrayExample.Subsection</code> 值</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:center">valueB</td>
</tr>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">valueC</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">valueD</td>
</tr>
</tbody>
</table>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/NET/">.NET</a>
                    
                      <a class="hover-with-bg" href="/tags/NETCore/">.NETCore</a>
                    
                      <a class="hover-with-bg" href="/tags/Microsoft/">Microsoft</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/04/10/Linux-IO/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Linux I/O 模式及 select、poll 和 epoll 详解</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/04/10/ASP.NET-Core-3.1-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%80%EF%BC%89/">
                        <span class="hidden-mobile">ASP.NET Core 3.1 学习笔记（一）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    Fluid.utils.waitElementVisible('vcomments', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "TMgxzCpM2zFnsClsMHJY2LLc-gzGzoHsz",
          app_key: "1kPLieLtoBQWf0w6iNxLqkMV",
          placeholder: "说点什么....",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: true,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="https://valine.js.org" target="_blank" rel="nofollow noopener noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> &nbsp;and&nbsp; <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a9b0666290f750544a1900dff36c0349";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-127726236-2', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>

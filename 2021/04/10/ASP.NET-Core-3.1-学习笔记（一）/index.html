

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon.ico">
  <link rel="icon" type="image/png" href="/images/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="When in doubt, use brute force.">
  <meta name="author" content="Rabbituzki">
  <meta name="keywords" content="">
  <title>ASP.NET Core 3.1 学习笔记（一） - Rabbituzki 的笔记们</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/gruvbox-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"blog.rabbituzki.com.cn","root":"/","version":"1.8.6","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"❡"},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":"a9b0666290f750544a1900dff36c0349","google":"UA-127726236-2","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"TMgxzCpM2zFnsClsMHJY2LLc-gzGzoHsz","app_key":"1kPLieLtoBQWf0w6iNxLqkMV","server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Rabbituzki 的笔记们</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/images/background1.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="ASP.NET Core 3.1 学习笔记（一）">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-04-10 00:00" pubdate>
        2021年4月10日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      10.8k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      138
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ASP.NET Core 3.1 学习笔记（一）</h1>
            
            <div class="markdown-body">
              <h1><a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 3.1 学习笔记（一）</h1>
<p><a href="http://www.zyiz.net/tutorial/xilie-293.html" target="_blank" rel="noopener">教程</a></p>
<hr>
<p>[TOC]</p>
<hr>
<h2 id="ASP-NET-Core-3-1-入门"><a class="header-anchor" href="#ASP-NET-Core-3-1-入门">¶</a><a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 3.1 入门</h2>
<h3 id="一、-NET-通用主机"><a class="header-anchor" href="#一、-NET-通用主机">¶</a>一、.NET 通用主机</h3>
<h4 id="什么是主机？"><a class="header-anchor" href="#什么是主机？">¶</a>什么是主机？</h4>
<p>主机是封装应用资源的对象，例如 ：</p>
<ul>
<li>依赖关系注入 (DI)</li>
<li>Logging</li>
<li>配置</li>
<li><code>IHostedService</code><sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup> 实现</li>
</ul>
<blockquote></blockquote>
<p>主机启动：</p>
<ol>
<li>通用主机启动时，它对它在 DI 容器中找到的 <code>IHostedService</code> 的每个实现调用 <code>IHostedService.StartAsync</code>。</li>
<li>承载 HTTP 工作负荷的主机中，其中一个 <code>IHostedService</code> 实现是启动 HTTP 服务器实现的 Web 服务。</li>
</ol>
<h4 id="设置主机"><a class="header-anchor" href="#设置主机">¶</a>设置主机</h4>
<p>主机通常由 <code>Program</code> 类中的代码配置、生成和运行。 <code>Main</code> 方法：</p>
<ul>
<li>调用 <code>CreateHostBuilder</code> 方法以创建和配置生成器对象。</li>
<li>对生成器对象调用 <code>Build</code> 和 <code>Run</code> 方法。</li>
</ul>
<p>以下是用于非 HTTP 工作负荷的 <em>Program.cs</em> 代码，其中单个 <code>IHostedService</code> 实现添加到 DI 容器。</p>
<div name="IHostedServiceExample"></div>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Program<br>&#123;<br>    public static void Main(string[] args)<br>    &#123;<br>        CreateHostBuilder(args).Build().Run();<br>    &#125;<br><br>    public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;<br>        Host.CreateDefaultBuilder(args)<br>            .ConfigureServices((hostContext, services) &#x3D;&gt;<br>            &#123;<br>               services.AddHostedService&lt;Worker&gt;();<br>            &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>对于 HTTP 工作负荷，<code>Main</code> 方法相同，但 <code>CreateHostBuilder</code> 调用 <code>ConfigureWebHostDefaults</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;<br>    Host.CreateDefaultBuilder(args)<br>        .ConfigureWebHostDefaults(webBuilder &#x3D;&gt;<br>        &#123;<br>            webBuilder.UseStartup&lt;Startup&gt;();<br>        &#125;);<br></code></pre></div></td></tr></table></figure>
<p>如果应用使用 Entity Framework Core，不要更改 <code>CreateHostBuilder</code> 方法的名称或签名。Entity Framework Core 工具应查找一个无需运行应用即可配置主机的 <code>CreateHostBuilder</code> 方法。 有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/ef/core/miscellaneous/cli/dbcontext-creation" target="_blank" rel="noopener">设计时 DbContext 创建</a>。</p>
<h4 id="默认生成器设置"><a class="header-anchor" href="#默认生成器设置">¶</a>默认生成器设置</h4>
<ol>
<li>
<p><code>CreateDefaultBuilder</code> 方法：</p>
<ul>
<li>将<a href="http://www.zyiz.net/tutorial/detail-4541.html#content-root" target="_blank" rel="noopener">内容根目录</a>设置为由 <code>GetCurrentDirectory</code> 返回的路径。</li>
<li>通过以下项加载<strong>主机配置</strong>：
<ul>
<li>前缀为 <code>DOTNET_</code> 的环境变量。</li>
<li>命令行参数。</li>
</ul>
</li>
<li>通过以下对象加载<strong>应用配置</strong>：
<ul>
<li><em>appsettings.json</em> 。</li>
<li><em>appsettings.{Environment}.json</em> 。</li>
<li><a href="http://www.zyiz.net/tutorial/detail-4865.html" target="_blank" rel="noopener">密钥管理器</a> 当应用在 <code>Development</code> 环境中运行时。</li>
<li>环境变量。</li>
<li>命令行参数。</li>
</ul>
</li>
<li>添加以下<a href="http://www.zyiz.net/tutorial/detail-4550.html" target="_blank" rel="noopener">日志记录</a>提供程序：
<ul>
<li>控制台</li>
<li>调试</li>
<li>EventSource</li>
<li>EventLog（仅当在 Windows 上运行时）</li>
</ul>
</li>
<li>当环境为 <code>Development</code> 时，启用<a href="http://www.zyiz.net/tutorial/detail-4542.html#scope-validation" target="_blank" rel="noopener">范围验证</a>和<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.serviceprovideroptions.validateonbuild#Microsoft_Extensions_DependencyInjection_ServiceProviderOptions_ValidateOnBuild" target="_blank" rel="noopener">依赖关系验证</a>。</li>
</ul>
</li>
<li>
<p><code>ConfigureWebHostDefaults</code> 方法：</p>
<ul>
<li>
<p>从前缀为 <code>ASPNETCORE_</code> 的环境变量加载主机配置。</p>
</li>
<li>
<p>使用应用的托管配置提供程序将 <a href="http://www.zyiz.net/tutorial/detail-4761.html" target="_blank" rel="noopener">Kestrel</a> 服务器设置为 Web 服务器并对其进行配置。 有关 Kestrel 服务器默认选项，请参阅 <a href="http://www.zyiz.net/tutorial/detail-4761.html#kestrel-options" target="_blank" rel="noopener">ASP.NET Core 中的 Kestrel Web 服务器实现</a>。</p>
</li>
<li>
<p>添加<a href="http://www.zyiz.net/tutorial/detail-4761.html#host-filtering" target="_blank" rel="noopener">主机筛选中间件</a>。</p>
</li>
<li>
<p>如果 <code>ASPNETCORE_FORWARDEDHEADERS_ENABLED=true</code>，请添加<a href="http://www.zyiz.net/tutorial/detail-4766.html#forwarded-headers" target="_blank" rel="noopener">转发标头中间件</a>。</p>
</li>
<li>
<p>支持 IIS 集成。 有关 IIS 默认选项，请参阅 <a href="http://www.zyiz.net/tutorial/detail-4772.html#iis-options" target="_blank" rel="noopener">使用 IIS 在 Windows 上托管 ASP.NET Core</a>。</p>
<p>本文中后面的<a href="http://www.zyiz.net/tutorial/detail-4544.html#settings-for-all-app-types" target="_blank" rel="noopener">所有应用类型的设置</a>和<a href="http://www.zyiz.net/tutorial/detail-4544.html#settings-for-web-apps" target="_blank" rel="noopener"> web 应用的设置</a>部分介绍如何替代默认生成器设置。</p>
</li>
</ul>
</li>
</ol>
<h4 id="框架提供的服务"><a class="header-anchor" href="#框架提供的服务">¶</a>框架提供的服务</h4>
<p>自动注册的服务包括：</p>
<ul>
<li><a href="#IHostApplicationLifetime_1_1"><code>IHostApplicationLifetime</code></a></li>
<li><a href="#IHostLifetime_1_2"><code>IHostLifetime</code></a></li>
<li><a href="#IHostEnvironment_1_3"><code>IHostEnvironment</code> / <code>IWebHostEnvironment</code></a></li>
</ul>
<p>有关框架提供的服务的详细信息，请参阅 <a href="http://www.zyiz.net/tutorial/detail-4542.html#framework-provided-services" target="_blank" rel="noopener">在 ASP.NET Core 依赖注入</a>。</p>
<h4 id="span-name-IHostApplicationLifetime-1-1-IHostApplicationLifetime-span"><a class="header-anchor" href="#span-name-IHostApplicationLifetime-1-1-IHostApplicationLifetime-span">¶</a><span name="IHostApplicationLifetime_1_1"><code>IHostApplicationLifetime</code></span></h4>
<p>将 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihostapplicationlifetime" target="_blank" rel="noopener"><code>IHostApplicationLifetime</code></a>（以前称为 <code>IApplicationLifetime</code>）服务注入任何类<strong>以处理启动后和正常关闭任务</strong>。 接口上的三个属性是用于注册应用启动和应用停止事件处理程序方法的取消令牌。</p>
<p>以下示例是注册 <code>IHostApplicationLifetime</code> 事件的 <code>IHostedService</code> 实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">internal class LifetimeEventsHostedService : IHostedService<br>&#123;<br>    private readonly ILogger _logger;<br>    private readonly IHostApplicationLifetime _appLifetime;<br><br>    public LifetimeEventsHostedService(<br>        ILogger&lt;LifetimeEventsHostedService&gt; logger,<br>        IHostApplicationLifetime appLifetime)<br>    &#123;<br>        _logger &#x3D; logger;<br>        _appLifetime &#x3D; appLifetime;<br>    &#125;<br><br>    public Task StartAsync(CancellationToken cancellationToken)<br>    &#123;<br>        _appLifetime.ApplicationStarted.Register(OnStarted);<br>        _appLifetime.ApplicationStopping.Register(OnStopping);<br>        _appLifetime.ApplicationStopped.Register(OnStopped);<br><br>        return Task.CompletedTask;<br>    &#125;<br><br>    public Task StopAsync(CancellationToken cancellationToken)<br>    &#123;<br>        return Task.CompletedTask;<br>    &#125;<br><br>    private void OnStarted()<br>    &#123;<br>        _logger.LogInformation(&quot;OnStarted has been called.&quot;);<br><br>        &#x2F;&#x2F; Perform post-startup activities here<br>    &#125;<br><br>    private void OnStopping()<br>    &#123;<br>        _logger.LogInformation(&quot;OnStopping has been called.&quot;);<br><br>        &#x2F;&#x2F; Perform on-stopping activities here<br>    &#125;<br><br>    private void OnStopped()<br>    &#123;<br>        _logger.LogInformation(&quot;OnStopped has been called.&quot;);<br><br>        &#x2F;&#x2F; Perform post-stopped activities here<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="span-name-IHostLifetime-1-2-IHostLifetime-span"><a class="header-anchor" href="#span-name-IHostLifetime-1-2-IHostLifetime-span">¶</a><span name="IHostLifetime_1_2"><code>IHostLifetime</code></span></h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihostlifetime" target="_blank" rel="noopener"><code>IHostLifetime</code></a> <strong>实现控制主机何时启动和何时停止</strong>。 使用了已注册的最后一个实现。</p>
<p><code>Microsoft.Extensions.Hosting.Internal.ConsoleLifetime</code> 是默认的 <code>IHostLifetime</code> 实现。 <code>ConsoleLifetime</code>：</p>
<ul>
<li>侦听 Ctrl+C/SIGINT 或 SIGTERM 并调用 <code>StopApplication</code><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup> 来启动关闭进程。</li>
<li>解除阻止 <a href="http://www.zyiz.net/tutorial/detail-4544.html#runasync" target="_blank" rel="noopener"><code>RunAsync</code></a> 和 <a href="http://www.zyiz.net/tutorial/detail-4544.html#waitforshutdownasync" target="_blank" rel="noopener"><code>WaitForShutdownAsync</code></a> 等扩展。</li>
</ul>
<blockquote></blockquote>
<h4 id="span-name-IHostEnvironment-1-3-IHostEnvironment-span"><a class="header-anchor" href="#span-name-IHostEnvironment-1-3-IHostEnvironment-span">¶</a><span name="IHostEnvironment_1_3"><code>IHostEnvironment</code></span></h4>
<p>将 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihostenvironment" target="_blank" rel="noopener"><code>IHostEnvironment</code></a> 服务注册到一个类，获取关于以下项的信息：</p>
<ul>
<li><a href="http://www.zyiz.net/tutorial/detail-4544.html#applicationname" target="_blank" rel="noopener"><code>ApplicationName</code></a></li>
<li><a href="http://www.zyiz.net/tutorial/detail-4544.html#environmentname" target="_blank" rel="noopener"><code>EnvironmentName</code></a></li>
<li><a href="http://www.zyiz.net/tutorial/detail-4544.html#contentrootpath" target="_blank" rel="noopener"><code>ContentRootPath</code></a></li>
</ul>
<p>Web 应用实现 <code>IWebHostEnvironment</code> 接口，该接口继承 <code>IHostEnvironment</code> 并添加 <a href="http://www.zyiz.net/tutorial/detail-4544.html#webroot" target="_blank" rel="noopener"><code>WebRootPath</code></a>。</p>
<h4 id="主机配置"><a class="header-anchor" href="#主机配置">¶</a>主机配置</h4>
<p>主机配置用于 <a href="#IHostEnvironment_1_3"><code>IHostEnvironment</code></a> 实现的属性。</p>
<p>主机配置可以从 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostbuilder.configureappconfiguration" target="_blank" rel="noopener"><code>ConfigureAppConfiguration</code></a> 内的 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostbuildercontext.configuration#Microsoft_Extensions_Hosting_HostBuilderContext_Configuration" target="_blank" rel="noopener"><code>HostBuilderContext.Configuration</code></a> 获取。 在 <code>ConfigureAppConfiguration</code> 后，<code>HostBuilderContext.Configuration</code> 被替换为应用配置。</p>
<p>若要添加主机配置，请对 <code>IHostBuilder</code> 调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostbuilder.configurehostconfiguration" target="_blank" rel="noopener"><code>ConfigureHostConfiguration</code></a>。 可多次调用 <code>ConfigureHostConfiguration</code>，并得到累计结果。 主机使用上一次在一个给定键上设置值的选项。</p>
<blockquote>
<p><strong>注意</strong></p>
<hr>
<ul>
<li>在 <code>ConfigureHostConfiguration</code> 中可以<strong>添加</strong>主机配置、<strong>设置配置文件基目录</strong>，如内存配置、JSON 文件配置、XML 文件配置等。<strong>并且可以多次调用累积结果</strong>。</li>
<li>在 <code>ConfigureAppConfiguration</code> 中可以<strong>获取</strong> <code>ConfigureHostConfiguration</code> 添加的主机配置内容。</li>
<li>由于 <code>ConfigureHostConfiguration</code> 中添加的配置会与 <code>ConfigureAppConfiguration</code> 中的配置合并，所以也可以使用 <code>HostBuilderContext.Configuration</code> 对象获取，但可能会被 <code>ConfigureAppConfiguration</code> 中的配置覆盖。</li>
</ul>
</blockquote>
<p><code>CreateDefaultBuilder</code> 包含前缀为 <code>DOTNET_</code> 的环境变量提供程序和命令行参数。 对于 Web 应用程序，添加前缀为 <code>ASPNETCORE_</code> 的环境变量提供程序。 当系统读取环境变量时，便会删除前缀。 例如，<code>ASPNETCORE_ENVIRONMENT</code> 的环境变量值就变成 <code>environment</code> 密钥<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>的主机配置值。</p>
<p>以下示例创建主机配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">&#x2F;&#x2F; using Microsoft.Extensions.Configuration;<br><br>Host.CreateDefaultBuilder(args)<br>    .ConfigureHostConfiguration(configHost &#x3D;&gt;<br>    &#123;<br>        configHost.SetBasePath(Directory.GetCurrentDirectory());<br>        configHost.AddJsonFile(&quot;hostsettings.json&quot;, optional: true);<br>        configHost.AddEnvironmentVariables(prefix: &quot;PREFIX_&quot;);<br>        configHost.AddCommandLine(args);<br>    &#125;);<br></code></pre></div></td></tr></table></figure>
<blockquote></blockquote>
<h4 id="应用配置"><a class="header-anchor" href="#应用配置">¶</a>应用配置</h4>
<p>通过对 <code>IHostBuilder</code> 调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostbuilder.configureappconfiguration" target="_blank" rel="noopener"><code>ConfigureAppConfiguration</code></a> 创建应用配置。 可多次调用 <code>ConfigureAppConfiguration</code>，并得到累计结果。 应用使用上一次在一个给定键上设置值的选项。</p>
<p>由 <code>ConfigureAppConfiguration</code> 创建的配置可以通过 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostbuildercontext.configuration" target="_blank" rel="noopener"><code>HostBuilderContext.Configuration</code></a> 获取以用于后续操作，<strong>也可以通过 DI 作为服务获取</strong>。 主机配置也会添加到应用配置。</p>
<blockquote>
<p><strong>注意</strong></p>
<hr>
<ul>
<li>同 <code>ConfigureHostConfiguration</code>，<code>ConfigureAppConfiguration</code> 可以多次调用并累积结果。</li>
<li><code>ConfigureAppConfiguration</code> 包含着 <code>ConfigureHostConfiguration</code> 添加的配置。</li>
<li><code>ConfigurationAppConfiguration</code> 添加的配置可以使用 <code>HostBuilderContext.Configuration</code> 获取。</li>
</ul>
</blockquote>
<p>有关详细信息，请参阅 <a href="http://www.zyiz.net/tutorial/detail-4547.html#configureappconfiguration" target="_blank" rel="noopener">ASP.NET Core 中的配置</a>。</p>
<h4 id="适用于所有应用类型的设置"><a class="header-anchor" href="#适用于所有应用类型的设置">¶</a>适用于所有应用类型的设置</h4>
<p>本部分列出了适用于 HTTP 和非 HTTP 工作负荷的主机设置。</p>
<p><strong>默认情况下，用来配置这些设置的环境变量可以具有 <code>DOTNET_</code> 或 <code>ASPNETCORE_</code> 前缀。</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">命令行键名</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">默认值</th>
<th style="text-align:left">描述</th>
<th style="text-align:center">对应的环境变量</th>
<th style="text-align:center">使用方法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>contentRoot</code></td>
<td style="text-align:center">string</td>
<td style="text-align:center">应用程序集所在的文件夹</td>
<td style="text-align:left"><code>IHostEnvironment.ContentRootPath</code> 属性决定主机从什么位置开始搜索内容文件。 如果路径不存在，主机将无法启动。</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;CONTENTROOT</code></td>
<td style="text-align:center"><a href="#Set_contentRoot_Example_1_4">若要设置此值，请使用环境变量或对 <code>IHostBuilder</code> 调用 <code>UseContentRoot</code></a></td>
</tr>
<tr>
<td style="text-align:center"><code>applicationName</code></td>
<td style="text-align:center">string</td>
<td style="text-align:center">包含应用入口点的程序集的名称</td>
<td style="text-align:left"><code>IHostEnvironment.ApplicationName</code> 属性是在主机构造期间通过主机配置设定的。</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;APPLICATIONNAME</code></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center"><code>environment</code></td>
<td style="text-align:center">string</td>
<td style="text-align:center"><code>Production</code></td>
<td style="text-align:left"><code>IHostEnvironment.EnvironmentName</code> 属性可以设置为任何值。 框架定义的值包括 <code>Development</code>、<code>Staging</code> 和 <code>Production</code>。 值不区分大小写。</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;ENVIRONMENT</code></td>
<td style="text-align:center"><a href="#Set_EnvironmentName_Example_1_5">若要设置此值，请使用环境变量或对 <code>IHostBuilder</code> 调用 <code>UseEnvironment</code></a></td>
</tr>
<tr>
<td style="text-align:center"><code>shutdownTimeoutSeconds</code></td>
<td style="text-align:center">int</td>
<td style="text-align:center"><code>5</code></td>
<td style="text-align:left"><code>HostOptions.ShutdownTimeout</code> 设置 <code>StopAsync</code> 的超时。 默认值为 5 秒。 在超时时间段中，主机：<br />(1) 触发 <code>IHostApplicationLifetime.ApplicationStopping</code>。<br />(2) 尝试停止托管服务，对服务停止失败的错误进行日志记录。<br />如果在所有托管服务停止之前就达到了超时时间，则会在应用关闭时会终止剩余的所有活动的服务。 即使没有完成处理工作，服务也会停止。 如果停止服务需要额外的时间，请增加超时时间。</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;SHUTDOWNTIMEOUTSECONDS</code></td>
<td style="text-align:center"><a href="#Set_ShutdownTimeoutSeconds_Example_1_6">若要设置此值，请使用环境变量或配置 <code>HostOptions</code></a></td>
</tr>
</tbody>
</table>
<p>通用主机设置使用示例：</p>
<ol>
<li>
<p><span name="Set_contentRoot_Example_1_4">ContentRoot 设置示例</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">Host.CreateDefaultBuilder(args)<br>    .UseContentRoot(&quot;c:\\content-root&quot;)<br>    &#x2F;&#x2F;...<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p><span name="Set_EnvironmentName_Example_1_5">EnvironmentName 设置示例</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">Host.CreateDefaultBuilder(args)<br>    .UseEnvironment(&quot;Development&quot;)<br>    &#x2F;&#x2F;...<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p><span name="Set_ShutdownTimeoutSeconds_Example_1_6">ShutdownTimeoutSeconds 设置示例</span>，以下示例将超时设置为 20 秒：</p>
<figure class="highlight csharp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs csharp">Host.CreateDefaultBuilder(args)<br> .ConfigureServices((hostContext, services) =&gt;<br> &#123;<br>     services.Configure&lt;HostOptions&gt;(option =&gt;<br>     &#123;<br>         option.ShutdownTimeout = System.TimeSpan.FromSeconds(<span class="hljs-number">20</span>);<br>     &#125;);<br> &#125;);<br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<h4 id="适用于-Web-应用的设置"><a class="header-anchor" href="#适用于-Web-应用的设置">¶</a>适用于 Web 应用的设置</h4>
<p>一些主机设置仅适用于 HTTP 工作负荷。 默认情况下，用来配置这些设置的环境变量可以具有 <code>DOTNET_</code> 或 <code>ASPNETCORE_</code> 前缀。</p>
<p><strong><code>IWebHostBuilder</code> 上的扩展方法适用于这些设置</strong>。 显示如何调用扩展方法的示例代码假定 <code>webBuilder</code> 是 <code>IWebHostBuilder</code> 的实例，如以下示例所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;<br>    Host.CreateDefaultBuilder(args)<br>        .ConfigureWebHostDefaults(webBuilder &#x3D;&gt;<br>        &#123;<br>            webBuilder.CaptureStartupErrors(true);<br>            webBuilder.UseStartup&lt;Startup&gt;();<br>        &#125;);<br></code></pre></div></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">命令行键名</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">默认值</th>
<th style="text-align:left">描述</th>
<th style="text-align:center">对应的环境变量</th>
<th style="text-align:center">使用方法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>captureStartupErrors</code></td>
<td style="text-align:center">bool（<code>true</code>、<code>false</code> 或 <code>1</code>、<code>0</code>）</td>
<td style="text-align:center">默认为 <code>false</code>，除非应用使用 Kestrel 在 IIS 后方运行，其中默认值是 <code>true</code></td>
<td style="text-align:left">当 <code>false</code> 时，启动期间出错导致主机退出。 当 <code>true</code> 时，主机在启动期间捕获异常并尝试启动服务器。</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;CAPTURESTARTUPERRORS</code></td>
<td style="text-align:center"><a href="#Set_CaptureStartupErrors_Example_1_7">若要设置此值，使用配置或调用 <code>CaptureStartupErrors</code></a></td>
</tr>
<tr>
<td style="text-align:center"><code>detailedErrors</code></td>
<td style="text-align:center">bool（<code>true</code>、<code>false</code> 或 <code>1</code>、<code>0</code>）</td>
<td style="text-align:center"><code>false</code></td>
<td style="text-align:left">如果启用，<strong>或</strong>环境为 Development，应用会捕获详细错误。</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;_DETAILEDERRORS</code></td>
<td style="text-align:center"><a href="#Set_DetailedErrors_Example_1_8">要设置此值，使用配置或调用 <code>UseSetting</code></a></td>
</tr>
<tr>
<td style="text-align:center"><code>hostingStartupAssemblies</code></td>
<td style="text-align:center">string</td>
<td style="text-align:center">空字符串</td>
<td style="text-align:left">承载启动程序集的以分号分隔的字符串在启动时加载。**虽然配置值默认为空字符串，但是承载启动程序集会始终包含应用的程序集。**提供承载启动程序集时，当应用在启动过程中生成其公用服务时将它们添加到应用的程序集加载。</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;_HOSTINGSTARTUPASSEMBLIE</code></td>
<td style="text-align:center"><a href="#Set_HostingStartupAssemblies_Example_1_9">要设置此值，使用配置或调用 <code>UseSetting</code></a></td>
</tr>
<tr>
<td style="text-align:center"><code>hostingStartupExcludeAssemblies</code></td>
<td style="text-align:center">string</td>
<td style="text-align:center">空字符串</td>
<td style="text-align:left">承载启动程序集的以分号分隔的字符串在启动时排除。</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;_HOSTINGSTARTUPEXCLUDEASSEMBLIES</code></td>
<td style="text-align:center"><a href="#Set_HostingStartupExcludeAssemblies_Example_1_10">要设置此值，使用配置或调用 <code>UseSetting</code></a></td>
</tr>
<tr>
<td style="text-align:center"><code>https_port</code></td>
<td style="text-align:center">string</td>
<td style="text-align:center">未设置默认值</td>
<td style="text-align:left">HTTPS 重定向端口。 用于强制实施 HTTPS</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;HTTPS_PORT</code></td>
<td style="text-align:center"><a href="#Set_HTTPS_PORT_Example_1_11">要设置此值，使用配置或调用 <code>UseSetting</code></a></td>
</tr>
<tr>
<td style="text-align:center"><code>preferHostingUrls</code></td>
<td style="text-align:center">bool（<code>true</code>、<code>false</code> 或 <code>1</code>、<code>0</code>）</td>
<td style="text-align:center"><code>true</code></td>
<td style="text-align:left">指示主机是否应该侦听使用 <code>IWebHostBuilder</code> 配置的 URL，而不是使用 <code>IServer</code> 实现配置的 URL</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;_PREFERHOSTINGURLS</code></td>
<td style="text-align:center"><a href="#Set_PreferHostingUrls_Example_1_12">若要设置此值，请使用环境变量或调用 <code>PreferHostingUrls</code></a></td>
</tr>
<tr>
<td style="text-align:center"><code>preventHostingStartup</code></td>
<td style="text-align:center">bool（<code>true</code>、<code>false</code> 或 <code>1</code>、<code>0</code>）</td>
<td style="text-align:center"><code>false</code></td>
<td style="text-align:left">阻止承载启动程序集自动加载，包括应用的程序集所配置的承载启动程序集</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;_PREVENTHOSTINGSTARTUP</code></td>
<td style="text-align:center"><a href="#Set_Prevent_Hosting_Startup_Example_1_13">若要设置此值，请使用环境变量或调用 <code>UseSetting</code></a></td>
</tr>
<tr>
<td style="text-align:center"><code>startupAssembly</code></td>
<td style="text-align:center">string</td>
<td style="text-align:center">应用的程序集</td>
<td style="text-align:left">要搜索 <code>Startup</code> 类的程序集</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;STARTUPASSEMBLY</code></td>
<td style="text-align:center"><a href="#Set_StartupAssembly_Example_1_14">若要设置此值，请使用环境变量或调用 <code>UseStartup</code>。 <code>UseStartup</code> 可以采用程序集名称 (string) 或类型 (<code>TStartup</code>)。 如果调用多个 <code>UseStartup</code> 方法，优先选择最后一个方法。</a></td>
</tr>
<tr>
<td style="text-align:center"><code>urls</code></td>
<td style="text-align:center">string</td>
<td style="text-align:center"><em><a href="http://localhost:5000" target="_blank" rel="noopener">http://localhost:5000</a></em> 和 <em><a href="https://localhost:5001" target="_blank" rel="noopener">https://localhost:5001</a></em></td>
<td style="text-align:left">IP 地址或主机地址的分号分隔列表，其中包含服务器应针对请求侦听的端口和协议。 例如 <em><a href="http://localhost:123" target="_blank" rel="noopener">http://localhost:123</a></em>。 使用“*”指示服务器应针对请求侦听的使用特定端口和协议（例如 <em>http://*:5000</em>）的 IP 地址或主机名。 协议（http:// 或 https://）必须包含每个 URL。 不同的服务器支持的格式有所不同。</td>
<td style="text-align:center"><code>&lt;PREFIX_&gt;URLS</code></td>
<td style="text-align:center"><a href="#Set_URLS_Example_1_15">若要设置此值，请使用环境变量或调用 <code>UseUrls</code></a></td>
</tr>
<tr>
<td style="text-align:center"><code>webroot</code></td>
<td style="text-align:center">string</td>
<td style="text-align:center">默认值为 <em>wwwroot</em>。 <em>{content root}/wwwroot</em> 的路径必须存在。<strong>如果该路径不存在，则使用无操作文件提供程序</strong>。</td>
<td style="text-align:left"><code>&lt;PREFIX_&gt;WEBROOT</code></td>
<td style="text-align:center">应用的静态资产的相对路径。</td>
<td style="text-align:center"><a href="#Set_WebRoot_Example_1_16">若要设置此值，请使用环境变量或调用 <code>UseWebRoot</code></a></td>
</tr>
</tbody>
</table>
<p>用于 HTTP 工作负载的主机设置使用示例：</p>
<ol>
<li>
<p><span name="Set_CaptureStartupErrors_Example_1_7">CaptureStartupErrors 设置示例：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">webBuilder.CaptureStartupErrors(true);<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p><span name="Set_DetailedErrors_Example_1_8">DetailedErrors 设置示例：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">webBuilder.UseSetting(WebHostDefaults.DetailedErrorsKey, &quot;true&quot;);<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p><span name="Set_HostingStartupAssemblies_Example_1_9">HostingStartupAssemblies 使用示例：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">webBuilder.UseSetting(WebHostDefaults.HostingStartupAssembliesKey, &quot;assembly1;assembly2&quot;);<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p><span name="Set_HostingStartupExcludeAssemblies_Example_1_10">HostingStartupExcludeAssemblies 使用示例：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">webBuilder.UseSetting(WebHostDefaults.HostingStartupExcludeAssembliesKey, &quot;assembly1;assembly2&quot;);<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p><span name="Set_HTTPS_PORT_Example_1_11">HTTPS_Port 使用示例：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">webBuilder.UseSetting(&quot;https_port&quot;, &quot;8080&quot;);<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p><span name="Set_PreferHostingUrls_Example_1_12">PreferHostingUrls 使用示例：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">webBuilder.PreferHostingUrls(true);<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p><span name="Set_Prevent_Hosting_Startup_Example_1_13">PreventHostingStartup 使用示例：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">webBuilder.UseSetting(WebHostDefaults.PreventHostingStartupKey, &quot;true&quot;);<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p><span name="Set_StartupAssembly_Example_1_14">StartupAssembly 使用示例：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">webBuilder.UseStartup(&quot;StartupAssemblyName&quot;);<br></code></pre></div></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">webBuilder.UseStartup&lt;Startup&gt;();<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p><span name="Set_URLS_Example_1_15">URLS 使用示例：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">webBuilder.UseUrls(&quot;http:&#x2F;&#x2F;*:5000;http:&#x2F;&#x2F;localhost:5001;https:&#x2F;&#x2F;hostname:5002&quot;);<br></code></pre></div></td></tr></table></figure>
<blockquote>
<p>Kestrel 具有自己的终结点配置 API。 有关详细信息，请参阅 <a href="http://www.zyiz.net/tutorial/detail-4761.html#endpoint-configuration" target="_blank" rel="noopener">ASP.NET Core 中的 Kestrel Web 服务器实现</a>。</p>
</blockquote>
</li>
<li>
<p><span name="Set_WebRoot_Example_1_16">URLS 使用示例：</span></p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">webBuilder.UseWebRoot(&quot;public&quot;);<br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<h4 id="管理主机生存期"><a class="header-anchor" href="#管理主机生存期">¶</a>管理主机生存期</h4>
<p>对生成的 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihost" target="_blank" rel="noopener"><code>IHost</code></a> 实现调用方法，以启动和停止应用。 <strong>这些方法会影响所有在服务容器中注册的 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihostedservice" target="_blank" rel="noopener"><code>IHostedService</code></a> 实现</strong>。</p>
<ol>
<li>
<p><code>Run</code>：<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostingabstractionshostextensions.run" target="_blank" rel="noopener"><code>Run</code></a> 运行应用并阻止调用线程，直到关闭主机。</p>
</li>
<li>
<p><code>RunAsync</code>：<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostingabstractionshostextensions.runasync" target="_blank" rel="noopener"><code>RunAsync</code></a> 运行应用并返回在触发取消令牌或关闭时完成的 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.tasks.task" target="_blank" rel="noopener"><code>Task</code></a>。</p>
</li>
<li>
<p><code>RunConsoleAsync</code>：<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostinghostbuilderextensions.runconsoleasync" target="_blank" rel="noopener"><code>RunConsoleAsync</code></a> 启用控制台支持、生成和启动主机，以及等待 Ctrl+C/SIGINT 或 SIGTERM 关闭。</p>
</li>
<li>
<p><code>Start</code>：<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostingabstractionshostextensions.start" target="_blank" rel="noopener"><code>Start</code></a> 同步启动主机。</p>
</li>
<li>
<p><code>StartAsync</code>：<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihost.startasync" target="_blank" rel="noopener"><code>StartAsync</code></a> 启动主机并返回在触发取消令牌或关闭时完成的 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.tasks.task" target="_blank" rel="noopener"><code>Task</code></a>。在 <code>StartAsync</code> 开始时调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihostlifetime.waitforstartasync" target="_blank" rel="noopener"><code>WaitForStartAsync</code></a>，在继续之前，会一直等待该操作完成。 它可用于延迟启动，直到外部事件发出信号。</p>
</li>
<li>
<p><code>StopAsync</code>：<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostingabstractionshostextensions.stopasync" target="_blank" rel="noopener"><code>StopAsync</code></a> 尝试在提供的超时时间内停止主机。</p>
</li>
<li>
<p><code>WaitForShutdown</code>：<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostingabstractionshostextensions.waitforshutdown" target="_blank" rel="noopener"><code>WaitForShutdown</code></a> 阻止调用线程，直到 <code>IHostLifetime</code> 触发关闭，例如通过 Ctrl+C/SIGINT 或 SIGTERM。</p>
</li>
<li>
<p><code>WaitForShutdownAsync</code>：<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.hostingabstractionshostextensions.waitforshutdownasync" target="_blank" rel="noopener"><code>WaitForShutdownAsync</code></a> 返回在通过给定的令牌和调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihost.stopasync" target="_blank" rel="noopener"><code>StopAsync</code></a> 来触发关闭时完成的 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.threading.tasks.task" target="_blank" rel="noopener"><code>Task</code></a>。</p>
</li>
<li>
<p>外部控件：使用可从外部调用的方法，能够实现对主机生存期的直接控制：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Program<br>&#123;<br>    private IHost _host;<br><br>    public Program()<br>    &#123;<br>        _host &#x3D; new HostBuilder()<br>            .Build();<br>    &#125;<br><br>    public async Task StartAsync()<br>    &#123;<br>        _host.StartAsync();<br>    &#125;<br><br>    public async Task StopAsync()<br>    &#123;<br>        using (_host)<br>        &#123;<br>            await _host.StopAsync(TimeSpan.FromSeconds(5));<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<h3 id="二、Web-主机"><a class="header-anchor" href="#二、Web-主机">¶</a>二、Web 主机</h3>
<p>在低于 3.0 的 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 版本中，Web 主机用于 HTTP 工作负载。 不再建议将 Web 主机用于 Web 应用，但该主机仍可仅用于后向兼容性。故本节略。</p>
<h3 id="三、依赖注入服务"><a class="header-anchor" href="#三、依赖注入服务">¶</a>三、依赖注入服务</h3>
<p>**一个对象中包含所有应用的相互依赖资源的主要原因是生存期管理：控制应用启动和正常关闭。**<a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 支持依赖关系注入 (DI) 软件设计模式，这是一种在类及其依赖关系之间实现<a href="https://docs.microsoft.com/zh-cn/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#dependency-inversion" target="_blank" rel="noopener">控制反转 (IoC)</a> 的技术。</p>
<h4 id="依赖关系注入概述"><a class="header-anchor" href="#依赖关系注入概述">¶</a>依赖关系注入概述</h4>
<p><strong>依赖项</strong>是另一个对象所需的任何对象。 使用应用中其他类所依赖的 <code>WriteMessage</code> 方法检查以下 <code>MyDependency</code> 类：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class MyDependency<br>&#123;<br>    public MyDependency()<br>    &#123;<br>    &#125;<br><br>    public Task WriteMessage(string message)<br>    &#123;<br>        Console.WriteLine(<br>            $&quot;MyDependency.WriteMessage called. Message: &#123;message&#125;&quot;);<br><br>        return Task.FromResult(0);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>可以创建 <code>MyDependency</code> 类的实例以使 <code>WriteMessage</code> 方法可用于类。 <code>MyDependency</code> 类是 <code>IndexModel</code> 类的依赖项：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class IndexModel : PageModel<br>&#123;<br>    MyDependency _dependency &#x3D; new MyDependency();<br><br>    public async Task OnGetAsync()<br>    &#123;<br>        await _dependency.WriteMessage(<br>            &quot;IndexModel.OnGetAsync created this message.&quot;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>该类创建并直接依赖于 <code>MyDependency</code> 实例。 代码依赖关系（如前面的示例）存在问题，应该避免使用，原因如下：</p>
<ul>
<li>要用不同的实现替换 <code>MyDependency</code>，必须修改类。</li>
<li>如果 <code>MyDependency</code> 具有依赖关系，则必须由类对其进行配置。 在具有多个依赖于 <code>MyDependency</code> 的类的大型项目中，配置代码在整个应用中会变得分散。</li>
<li>这种实现很难进行单元测试。 应用应使用模拟或存根 <code>MyDependency</code> 类，该类不能使用此方法。</li>
</ul>
<p>依赖关系注入通过以下方式解决了这些问题：</p>
<ul>
<li>使用接口或基类抽象化依赖关系实现。</li>
<li>注册服务容器中的依赖关系。<a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 提供了一个内置的服务容器 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.iserviceprovider" target="_blank" rel="noopener"><code>IServiceProvider</code></a>。 服务已在应用的 <code>Startup.ConfigureServices</code> 方法中注册。</li>
<li>将服务注入 到使用它的类的构造函数中。 框架负责创建依赖关系的实例，并在不再需要时对其进行处理。</li>
</ul>
<p>在<a href="https://github.com/aspnet/AspNetCore.Docs/tree/master/aspnetcore/fundamentals/dependency-injection/samples" target="_blank" rel="noopener">示例应用</a>中，<code>IMyDependency</code> 接口定义了服务为应用提供的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public interface IMyDependency<br>&#123;<br>    Task WriteMessage(string message);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>此接口由具体类型 <code>MyDependency</code> 实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class MyDependency : IMyDependency<br>&#123;<br>    private readonly ILogger&lt;MyDependency&gt; _logger;<br><br>    public MyDependency(ILogger&lt;MyDependency&gt; logger)<br>    &#123;<br>        _logger &#x3D; logger;<br>    &#125;<br><br>    public Task WriteMessage(string message)<br>    &#123;<br>        _logger.LogInformation(<br>            &quot;MyDependency.WriteMessage called. Message: &#123;MESSAGE&#125;&quot;,<br>            message);<br><br>        return Task.FromResult(0);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><code>MyDependency</code> 在其构造函数中请求一个 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.logging.ilogger-1" target="_blank" rel="noopener"><code>ILogger</code></a>。 以链式方式使用依赖关系注入并不罕见。 每个请求的依赖关系相应地请求其自己的依赖关系。 容器解析图中的依赖关系并返回完全解析的服务。 必须被解析的依赖关系的集合通常被称为“依赖关系树” 、“依赖关系图” 或“对象图” 。</p>
<p>必须在服务容器中注册 <code>IMyDependency</code> 和 <code>ILogger&lt;TCategoryName&gt;</code>。 <code>IMyDependency</code> 已在 <code>Startup.ConfigureServices</code> 中注册。 <code>ILogger&lt;TCategoryName&gt;</code> 由日志记录抽象基础结构注册，因此它是框架默认注册的<a href="http://www.zyiz.net/tutorial/detail-4542.html#framework-provided-services" target="_blank" rel="noopener">框架提供的服务</a>。</p>
<p>容器通过利用<a href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/language-specification/types#open-and-closed-types" target="_blank" rel="noopener">（泛型）开放类型</a>解析 <code>ILogger&lt;TCategoryName&gt;</code>，而无需注册每个<a href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/language-specification/types#constructed-types" target="_blank" rel="noopener">（泛型）构造类型</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">services.AddSingleton(typeof(ILogger&lt;&gt;), typeof(Logger&lt;&gt;));<br></code></pre></div></td></tr></table></figure>
<p>在示例应用中，使用具体类型 <code>MyDependency</code> 注册 <code>IMyDependency</code> 服务。 注册将服务生存期的范围限定为单个请求的生存期。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public void ConfigureServices(IServiceCollection services)<br>&#123;<br>    services.AddRazorPages();<br><br>    services.AddScoped&lt;IMyDependency, MyDependency&gt;();<br>    services.AddTransient&lt;IOperationTransient, Operation&gt;();<br>    services.AddScoped&lt;IOperationScoped, Operation&gt;();<br>    services.AddSingleton&lt;IOperationSingleton, Operation&gt;();<br>    services.AddSingleton&lt;IOperationSingletonInstance&gt;(new Operation(Guid.Empty));<br><br>    &#x2F;&#x2F; OperationService depends on each of the other Operation types.<br>    services.AddTransient&lt;OperationService, OperationService&gt;();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public void ConfigureServices(IServiceCollection services)<br>&#123;<br>    services.AddMvc().SetCompatibilityVersion(CompatibilityVersion.Version_2_2);<br><br>    services.AddScoped&lt;IMyDependency, MyDependency&gt;();<br>    services.AddTransient&lt;IOperationTransient, Operation&gt;();<br>    services.AddScoped&lt;IOperationScoped, Operation&gt;();<br>    services.AddSingleton&lt;IOperationSingleton, Operation&gt;();<br>    services.AddSingleton&lt;IOperationSingletonInstance&gt;(new Operation(Guid.Empty));<br><br>    &#x2F;&#x2F; OperationService depends on each of the other Operation types.<br>    services.AddTransient&lt;OperationService, OperationService&gt;();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<blockquote>
<p>每个 <code>services.Add{SERVICE_NAME}</code> 扩展方法添加（并可能配置）服务。 例如，<code>services.AddMvc()</code> 添加 Razor Pages 和 MVC 需要的服务。 我们建议应用遵循此约定。 将扩展方法置于 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection" target="_blank" rel="noopener"><code>Microsoft.Extensions.DependencyInjection</code></a> 命名空间中以封装服务注册的组。</p>
</blockquote>
<p>如果服务的构造函数需要<a href="https://docs.microsoft.com/zh-cn/dotnet/csharp/language-reference/keywords/built-in-types-table" target="_blank" rel="noopener">内置类型</a>（如 <code>string</code>），则可以使用配置或选项模式注入该类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class MyDependency : IMyDependency<br>&#123;<br>    public MyDependency(IConfiguration config)<br>    &#123;<br>        var myStringValue &#x3D; config[&quot;MyStringKey&quot;];<br><br>        &#x2F;&#x2F; Use myStringValue<br>    &#125;<br><br>    ...<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>通过使用服务并分配给私有字段的类的构造函数请求服务的实例。 该字段用于在整个类中根据需要访问服务。</p>
<p>在示例应用中，请求 <code>IMyDependency</code> 实例并用于调用服务的 <code>WriteMessage</code> 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class IndexModel : PageModel<br>&#123;<br>    private readonly IMyDependency _myDependency;<br><br>    public IndexModel(<br>        IMyDependency myDependency,<br>        OperationService operationService,<br>        IOperationTransient transientOperation,<br>        IOperationScoped scopedOperation,<br>        IOperationSingleton singletonOperation,<br>        IOperationSingletonInstance singletonInstanceOperation)<br>    &#123;<br>        _myDependency &#x3D; myDependency;<br>        OperationService &#x3D; operationService;<br>        TransientOperation &#x3D; transientOperation;<br>        ScopedOperation &#x3D; scopedOperation;<br>        SingletonOperation &#x3D; singletonOperation;<br>        SingletonInstanceOperation &#x3D; singletonInstanceOperation;<br>    &#125;<br><br>    public OperationService OperationService &#123; get; &#125;<br>    public IOperationTransient TransientOperation &#123; get; &#125;<br>    public IOperationScoped ScopedOperation &#123; get; &#125;<br>    public IOperationSingleton SingletonOperation &#123; get; &#125;<br>    public IOperationSingletonInstance SingletonInstanceOperation &#123; get; &#125;<br><br>    public async Task OnGetAsync()<br>    &#123;<br>        await _myDependency.WriteMessage(<br>            &quot;IndexModel.OnGetAsync created this message.&quot;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="注入启动的服务"><a class="header-anchor" href="#注入启动的服务">¶</a>注入启动的服务</h4>
<p>使用通用主机 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihostbuilder" target="_blank" rel="noopener"><code>IHostBuilder</code></a>) 时，<strong>只能</strong>将以下服务类型注入 <code>Startup</code> 构造函数：</p>
<ul>
<li><code>IWebHostEnvironment</code></li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihostenvironment" target="_blank" rel="noopener"><code>IHostEnvironment</code></a></li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfiguration" target="_blank" rel="noopener"><code>IConfiguration</code></a></li>
</ul>
<p>服务可以注入 <code>Startup.Configure</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public void Configure(IApplicationBuilder app, IOptions&lt;MyOptions&gt; options)<br>&#123;<br>    ...<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="框架提供的服务-v2"><a class="header-anchor" href="#框架提供的服务-v2">¶</a>框架提供的服务</h4>
<p><code>Startup.ConfigureServices</code> 方法负责定义应用使用的服务，包括 Entity Framework Core 和 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core MVC 等平台功能。 最初，提供给 <code>ConfigureServices</code> 的 <code>IServiceCollection</code> 具有框架定义的服务（具体取决于主机配置方式）。 基于 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 模板的应用程序具有框架注册的数百个服务的情况并不少见。 下表列出了框架注册的服务的一个小示例。</p>
<table>
<thead>
<tr>
<th style="text-align:left">服务类型</th>
<th style="text-align:left">生存期</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.builder.iapplicationbuilderfactory" target="_blank" rel="noopener"><code>Microsoft.AspNetCore.Hosting.Builder.IApplicationBuilderFactory</code></a></td>
<td style="text-align:left">暂时性</td>
</tr>
<tr>
<td style="text-align:left"><code>IHostApplicationLifetime</code></td>
<td style="text-align:left">单例</td>
</tr>
<tr>
<td style="text-align:left"><code>IWebHostEnvironment</code></td>
<td style="text-align:left">单例</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.istartup" target="_blank" rel="noopener"><code>Microsoft.AspNetCore.Hosting.IStartup</code></a></td>
<td style="text-align:left">单例</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.istartupfilter" target="_blank" rel="noopener"><code>Microsoft.AspNetCore.Hosting.IStartupFilter</code></a></td>
<td style="text-align:left">暂时性</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.server.iserver" target="_blank" rel="noopener"><code>Microsoft.AspNetCore.Hosting.Server.IServer</code></a></td>
<td style="text-align:left">单例</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.http.ihttpcontextfactory" target="_blank" rel="noopener"><code>Microsoft.AspNetCore.Http.IHttpContextFactory</code></a></td>
<td style="text-align:left">暂时性</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.logging.ilogger-1" target="_blank" rel="noopener"><code>Microsoft.Extensions.Logging.ILogger</code></a></td>
<td style="text-align:left">单例</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.logging.iloggerfactory" target="_blank" rel="noopener"><code>Microsoft.Extensions.Logging.ILoggerFactory</code></a></td>
<td style="text-align:left">单例</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.objectpool.objectpoolprovider" target="_blank" rel="noopener"><code>Microsoft.Extensions.ObjectPool.ObjectPoolProvider</code></a></td>
<td style="text-align:left">单例</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.options.iconfigureoptions-1" target="_blank" rel="noopener"><code>Microsoft.Extensions.Options.IConfigureOptions</code></a></td>
<td style="text-align:left">暂时性</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.options.ioptions-1" target="_blank" rel="noopener"><code>Microsoft.Extensions.Options.IOptions</code></a></td>
<td style="text-align:left">单例</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.diagnostics.diagnosticsource" target="_blank" rel="noopener"><code>System.Diagnostics.DiagnosticSource</code></a></td>
<td style="text-align:left">单例</td>
</tr>
<tr>
<td style="text-align:left"><a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.diagnostics.diagnosticlistener" target="_blank" rel="noopener"><code>System.Diagnostics.DiagnosticListener</code></a></td>
<td style="text-align:left">单例</td>
</tr>
</tbody>
</table>
<h4 id="使用扩展方法注册附加服务"><a class="header-anchor" href="#使用扩展方法注册附加服务">¶</a>使用扩展方法注册附加服务</h4>
<p>当服务集合扩展方法可用于注册服务（及其依赖服务，如果需要）时，约定使用单个 <code>Add{SERVICE_NAME}</code> 扩展方法来注册该服务所需的所有服务。 以下代码是如何使用扩展方法 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.entityframeworkservicecollectionextensions.adddbcontext" target="_blank" rel="noopener"><code>AddDbContext</code></a> 和 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.identityservicecollectionextensions.addidentitycore" target="_blank" rel="noopener"><code>AddIdentityCore</code></a> 向容器添加附加服务的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public void ConfigureServices(IServiceCollection services)<br>&#123;<br>    ...<br><br>    services.AddDbContext&lt;ApplicationDbContext&gt;(options &#x3D;&gt;<br>        options.UseSqlServer(Configuration.GetConnectionString(&quot;DefaultConnection&quot;)));<br><br>    services.AddIdentity&lt;ApplicationUser, IdentityRole&gt;()<br>        .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;()<br>        .AddDefaultTokenProviders();<br><br>    ...<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="服务生存期"><a class="header-anchor" href="#服务生存期">¶</a>服务生存期</h4>
<p>为每个注册的服务选择适当的生存期。 可以使用以下生存期配置 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 服务：</p>
<ol>
<li>
<p><strong>暂时性生存期（Transient）</strong>：暂时生存期服务 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.servicecollectionserviceextensions.addtransient" target="_blank" rel="noopener"><code>AddTransient</code></a>) 是每次从服务容器进行请求时创建的。 这种生存期适合轻量级、 无状态的服务。</p>
</li>
<li>
<p><strong>作用域生存期（Scoped）</strong>：作用域生存期服务 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.servicecollectionserviceextensions.addscoped" target="_blank" rel="noopener"><code>AddScoped</code></a>) 以每个客户端请求（连接）一次的方式创建。</p>
<blockquote>
<p><strong>注意</strong></p>
<hr>
<p>在中间件内使用有作用域的服务时，请将该服务注入至 <code>Invoke</code> 或 <code>InvokeAsync</code> 方法。 请不要通过构造函数注入进行注入，因为它会强制服务的行为与单一实例类似。</p>
</blockquote>
</li>
<li>
<p><strong>单例生存期（Singleton）</strong>：单例实例生存期服务 (<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.servicecollectionserviceextensions.addsingleton" target="_blank" rel="noopener"><code>AddSingleton</code></a>) 是在第一次请求时（或者在运行 <code>Startup.ConfigureServices</code> 并且使用服务注册指定实例时）创建的。 每个后续请求都使用相同的实例。 如果应用需要单一实例行为，建议允许服务容器管理服务的生存期。 不要实现单一实例设计模式并提供用户代码来管理对象在类中的生存期。</p>
<blockquote>
<p><strong>注意</strong></p>
<hr>
<p>从单一实例解析有作用域的服务很危险。 当处理后续请求时，它可能会导致服务处于不正确的状态。</p>
</blockquote>
</li>
</ol>
<h4 id="服务注册方法"><a class="header-anchor" href="#服务注册方法">¶</a>服务注册方法</h4>
<p><span name="Methods_of_Registering_Services_3_1">服务注册扩展方法提供适用于特定场景的重载。</span></p>
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:center">自动 对象 (object) 处置</th>
<th style="text-align:center">多个 实现</th>
<th style="text-align:center">传递参数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>Add{LIFETIME}&lt;{SERVICE}, {IMPLEMENTATION}&gt;()</code> 示例： <code>services.AddSingleton&lt;IMyDep, MyDep&gt;();</code></td>
<td style="text-align:center">是</td>
<td style="text-align:center">是</td>
<td style="text-align:center">否</td>
</tr>
<tr>
<td style="text-align:left"><code>Add{LIFETIME}&lt;{SERVICE}&gt;(sp =&gt; new {IMPLEMENTATION})</code> 示例： <code>services.AddSingleton&lt;IMyDep&gt;(sp =&gt; new MyDep());</code> <code>services.AddSingleton&lt;IMyDep&gt;(sp =&gt; new MyDep(&quot;A string!&quot;));</code></td>
<td style="text-align:center">是</td>
<td style="text-align:center">是</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:left"><code>Add{LIFETIME}&lt;{IMPLEMENTATION}&gt;()</code> 示例： <code>services.AddSingleton&lt;MyDep&gt;();</code></td>
<td style="text-align:center">是</td>
<td style="text-align:center">否</td>
<td style="text-align:center">否</td>
</tr>
<tr>
<td style="text-align:left"><code>AddSingleton&lt;{SERVICE}&gt;(new {IMPLEMENTATION})</code> 示例： <code>services.AddSingleton&lt;IMyDep&gt;(new MyDep());</code> <code>services.AddSingleton&lt;IMyDep&gt;(new MyDep(&quot;A string!&quot;));</code></td>
<td style="text-align:center">否</td>
<td style="text-align:center">是</td>
<td style="text-align:center">是</td>
</tr>
<tr>
<td style="text-align:left"><code>AddSingleton(new {IMPLEMENTATION})</code> 示例： <code>services.AddSingleton(new MyDep());</code> <code>services.AddSingleton(new MyDep(&quot;A string!&quot;));</code></td>
<td style="text-align:center">否</td>
<td style="text-align:center">否</td>
<td style="text-align:center">是</td>
</tr>
</tbody>
</table>
<p><code>TryAdd{LIFETIME}</code> 方法仅当尚未注册实现时，注册该服务。</p>
<p>在以下示例中，第一行向 <code>IMyDependency</code> 注册 <code>MyDependency</code>。 第二行没有任何作用，因为 <code>IMyDependency</code> 已有一个已注册的实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">services.AddSingleton&lt;IMyDependency, MyDependency&gt;();<br>&#x2F;&#x2F; The following line has no effect:<br>services.TryAddSingleton&lt;IMyDependency, DifferentDependency&gt;();<br></code></pre></div></td></tr></table></figure>
<p>有关详细信息，请参阅：</p>
<ul>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.extensions.servicecollectiondescriptorextensions.tryadd" target="_blank" rel="noopener"><code>TryAdd</code></a></li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.extensions.servicecollectiondescriptorextensions.tryaddtransient" target="_blank" rel="noopener"><code>TryAddTransient</code></a></li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.extensions.servicecollectiondescriptorextensions.tryaddscoped" target="_blank" rel="noopener"><code>TryAddScoped</code></a></li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.extensions.servicecollectiondescriptorextensions.tryaddsingleton" target="_blank" rel="noopener"><code>TryAddSingleton</code></a></li>
</ul>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.extensions.servicecollectiondescriptorextensions.tryaddenumerable" target="_blank" rel="noopener"><code>TryAddEnumerable(ServiceDescriptor)</code></a> 方法仅当没有同一类型的实现时，注册该服务。 多个服务通过 <code>IEnumerable&lt;{SERVICE}&gt;</code> 解析。 注册服务时，开发人员只希望在尚未添加一个相同类型时添加实例。 通常情况下，库创建者使用此方法来避免在容器中注册一个实例的两个副本。</p>
<p>在以下示例中，第一行向 <code>IMyDep1</code> 注册 <code>MyDep</code>。 第二行向 <code>IMyDep2</code> 注册 <code>MyDep</code>。 第三行没有任何作用，因为 <code>IMyDep1</code> 已有一个 <code>MyDep</code> 的已注册的实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public interface IMyDep1 &#123;&#125;<br>public interface IMyDep2 &#123;&#125;<br><br>public class MyDep : IMyDep1, IMyDep2 &#123;&#125;<br><br>services.TryAddEnumerable(ServiceDescriptor.Singleton&lt;IMyDep1, MyDep&gt;());<br>services.TryAddEnumerable(ServiceDescriptor.Singleton&lt;IMyDep2, MyDep&gt;());<br>&#x2F;&#x2F; Two registrations of MyDep for IMyDep1 is avoided by the following line:<br>services.TryAddEnumerable(ServiceDescriptor.Singleton&lt;IMyDep1, MyDep&gt;());<br></code></pre></div></td></tr></table></figure>
<h4 id="构造函数注入行为"><a class="header-anchor" href="#构造函数注入行为">¶</a>构造函数注入行为</h4>
<p>服务可以通过两种机制来解析：</p>
<ul>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.iserviceprovider" target="_blank" rel="noopener"><code>IServiceProvider</code></a></li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.activatorutilities" target="_blank" rel="noopener"><code>ActivatorUtilities</code></a> – 允许在依赖关系注入容器中创建没有服务注册的对象。 <code>ActivatorUtilities</code> 用于面向用户的抽象，例如标记帮助器、MVC 控制器和模型绑定器。</li>
</ul>
<p><a href="#Methods_of_Registering_Services_3_1">构造函数可以接受依赖关系注入不提供的参数</a>，但参数必须分配默认值。</p>
<p>当服务由 <code>IServiceProvider</code> 或 <code>ActivatorUtilities</code> 解析时，构造函数注入需要 <strong>public</strong> 构造函数。</p>
<p>当服务由 <code>ActivatorUtilities</code> 解析时，构造函数注入要求只存在一个适用的构造函数，即<strong>支持构造函数重载，但其参数可以全部通过依赖注入来实现的重载只能存在一个</strong>。</p>
<h4 id="实体框架上下文"><a class="header-anchor" href="#实体框架上下文">¶</a>实体框架上下文</h4>
<p>通常使用设置了<strong>作用域生存期</strong>将实体框架上下文添加到服务容器中，因为 Web 应用数据库操作通常将范围设置为客户端请求。 如果在注册数据库上下文时，<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.entityframeworkservicecollectionextensions.adddbcontext" target="_blank" rel="noopener"><code>AddDbContext</code></a> 重载未指定生存期，则设置默认生存期范围。</p>
<blockquote>
<p><strong>注意</strong></p>
<hr>
<p>给定生存期的服务不应使用生存期比服务短的数据库上下文。</p>
</blockquote>
<h4 id="生存期和注册选项"><a class="header-anchor" href="#生存期和注册选项">¶</a>生存期和注册选项</h4>
<p>为了演示生存期和注册选项之间的差异，请考虑以下接口，将任务表示为具有唯一标识符 <code>OperationId</code> 的操作。 根据为以下接口配置操作服务的生存期的方式，容器在类请求时提供相同或不同的服务实例：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public interface IOperation<br>&#123;<br>    Guid OperationId &#123; get; &#125;<br>&#125;<br><br>public interface IOperationTransient : IOperation<br>&#123;<br>&#125;<br><br>public interface IOperationScoped : IOperation<br>&#123;<br>&#125;<br><br>public interface IOperationSingleton : IOperation<br>&#123;<br>&#125;<br><br>public interface IOperationSingletonInstance : IOperation<br>&#123;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>接口在 <code>Operation</code> 类中实现。 <code>Operation</code> 构造函数将生成一个 GUID（如果未提供）：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Operation : IOperationTransient,<br>    IOperationScoped,<br>    IOperationSingleton,<br>    IOperationSingletonInstance<br>&#123;<br>    public Operation() : this(Guid.NewGuid())<br>    &#123;<br>    &#125;<br><br>    public Operation(Guid id)<br>    &#123;<br>        OperationId &#x3D; id;<br>    &#125;<br><br>    public Guid OperationId &#123; get; private set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>注册 <code>OperationService</code> 取决于，每个其他 <code>Operation</code> 类型。 当通过依赖关系注入请求 <code>OperationService</code> 时，它将接收每个服务的新实例或基于从属服务的生存期的现有实例。</p>
<ul>
<li>如果从容器请求时创建了临时服务，则 <code>IOperationTransient</code> 服务的 <code>OperationId</code> 与 <code>OperationService</code> 的 <code>OperationId</code> 不同。 <code>OperationService</code> 将接收 <code>IOperationTransient</code> 类的新实例。 新实例将生成一个不同的 <code>OperationId</code>。</li>
<li>如果按客户端请求创建有作用域的服务，则 <code>IOperationScoped</code> 服务的 <code>OperationId</code> 与客户端请求中 <code>OperationService</code> 的该 ID 相同。 在客户端请求中，两个服务共享不同的 <code>OperationId</code> 值。</li>
<li>如果单一数据库和单一实例服务只创建一次并在所有客户端请求和所有服务中使用，则 <code>OperationId</code> 在所有服务请求中保持不变。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class OperationService<br>&#123;<br>    public OperationService(<br>        IOperationTransient transientOperation,<br>        IOperationScoped scopedOperation,<br>        IOperationSingleton singletonOperation,<br>        IOperationSingletonInstance instanceOperation)<br>    &#123;<br>        TransientOperation &#x3D; transientOperation;<br>        ScopedOperation &#x3D; scopedOperation;<br>        SingletonOperation &#x3D; singletonOperation;<br>        SingletonInstanceOperation &#x3D; instanceOperation;<br>    &#125;<br><br>    public IOperationTransient TransientOperation &#123; get; &#125;<br>    public IOperationScoped ScopedOperation &#123; get; &#125;<br>    public IOperationSingleton SingletonOperation &#123; get; &#125;<br>    public IOperationSingletonInstance SingletonInstanceOperation &#123; get; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在 <code>Startup.ConfigureServices</code> 中，根据其指定的生存期，将每个类型添加到容器中：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public void ConfigureServices(IServiceCollection services)<br>&#123;<br>    services.AddRazorPages();<br><br>    services.AddScoped&lt;IMyDependency, MyDependency&gt;();<br>    services.AddTransient&lt;IOperationTransient, Operation&gt;();<br>    services.AddScoped&lt;IOperationScoped, Operation&gt;();<br>    services.AddSingleton&lt;IOperationSingleton, Operation&gt;();<br>    services.AddSingleton&lt;IOperationSingletonInstance&gt;(new Operation(Guid.Empty));<br><br>    &#x2F;&#x2F; OperationService depends on each of the other Operation types.<br>    services.AddTransient&lt;OperationService, OperationService&gt;();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><code>IOperationSingletonInstance</code> 服务正在使用已知 ID 为 <code>Guid.Empty</code> 的特定实例。 此类型在使用时很明显（其 GUID 全部为零）。</p>
<p>示例应用演示了各个请求中和之间的对象生存期。 示例应用的 <code>IndexModel</code> 请求每种 <code>IOperation</code> 类型和 <code>OperationService</code>。 然后，页面通过属性分配显示所有页面模型类和服务的 <code>OperationId</code> 值：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class IndexModel : PageModel<br>&#123;<br>    private readonly IMyDependency _myDependency;<br><br>    public IndexModel(<br>        IMyDependency myDependency,<br>        OperationService operationService,<br>        IOperationTransient transientOperation,<br>        IOperationScoped scopedOperation,<br>        IOperationSingleton singletonOperation,<br>        IOperationSingletonInstance singletonInstanceOperation)<br>    &#123;<br>        _myDependency &#x3D; myDependency;<br>        OperationService &#x3D; operationService;<br>        TransientOperation &#x3D; transientOperation;<br>        ScopedOperation &#x3D; scopedOperation;<br>        SingletonOperation &#x3D; singletonOperation;<br>        SingletonInstanceOperation &#x3D; singletonInstanceOperation;<br>    &#125;<br><br>    public OperationService OperationService &#123; get; &#125;<br>    public IOperationTransient TransientOperation &#123; get; &#125;<br>    public IOperationScoped ScopedOperation &#123; get; &#125;<br>    public IOperationSingleton SingletonOperation &#123; get; &#125;<br>    public IOperationSingletonInstance SingletonInstanceOperation &#123; get; &#125;<br><br>    public async Task OnGetAsync()<br>    &#123;<br>        await _myDependency.WriteMessage(<br>            &quot;IndexModel.OnGetAsync created this message.&quot;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>以下两个输出显示了两个请求的结果：</p>
<ol>
<li>
<p>第一个请求：</p>
<ul>
<li>控制器操作：
<ul>
<li>暂时性：d233e165-f417-469b-a866-1cf1935d2518</li>
<li>作用域：5d997e2d-55f5-4a64-8388-51c4e3a1ad19</li>
<li>单一实例：01271bc1-9e31-48e7-8f7c-7261b040ded9</li>
<li>实例：00000000-0000-0000-0000-000000000000</li>
</ul>
</li>
<li><code>OperationService</code> 操作：
<ul>
<li>暂时性：c6b049eb-1318-4e31-90f1-eb2dd849ff64</li>
<li>作用域：5d997e2d-55f5-4a64-8388-51c4e3a1ad19</li>
<li>单一实例：01271bc1-9e31-48e7-8f7c-7261b040ded9</li>
<li>实例：00000000-0000-0000-0000-000000000000</li>
</ul>
</li>
</ul>
</li>
<li>
<p>第二个请示：</p>
<ul>
<li>
<p>控制器操作：</p>
<ul>
<li>暂时性：b63bd538-0a37-4ff1-90ba-081c5138dda0</li>
<li>作用域：31e820c5-4834-4d22-83fc-a60118acb9f4</li>
<li>单一实例：01271bc1-9e31-48e7-8f7c-7261b040ded9</li>
<li>实例：00000000-0000-0000-0000-000000000000</li>
</ul>
</li>
<li>
<p><code>OperationService</code> 操作：</p>
<ul>
<li>暂时性：c4cbacb8-36a2-436d-81c8-8c1b78808aaf</li>
<li>作用域：31e820c5-4834-4d22-83fc-a60118acb9f4</li>
<li>单一实例：01271bc1-9e31-48e7-8f7c-7261b040ded9</li>
<li>实例：00000000-0000-0000-0000-000000000000</li>
</ul>
</li>
</ul>
</li>
</ol>
<p>观察哪个 <code>OperationId</code> 值会在一个请求之内和不同请求之间变化：</p>
<ul>
<li>暂时性 对象始终不同。 第一个和第二个客户端请求的暂时性 <code>OperationId</code> 值对于 <code>OperationService</code> 操作和在客户端请求内都是不同的。 为每个服务请求和客户端请求提供了一个新实例。</li>
<li>作用域 对象在一个客户端请求中是相同的，但在多个客户端请求中是不同的。</li>
<li>单一实例 对象对每个对象和每个请求都是相同的（不管 <code>Startup.ConfigureServices</code> 中是否提供 <code>Operation</code> 实例）。</li>
</ul>
<h4 id="从-main-调用服务"><a class="header-anchor" href="#从-main-调用服务">¶</a>从 main 调用服务</h4>
<p>使用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.iservicescopefactory.createscope" target="_blank" rel="noopener"><code>IServiceScopeFactory.CreateScope</code></a> 创建 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.iservicescope" target="_blank" rel="noopener"><code>IServiceScope</code></a> 以解析应用范围内的已设置范围的服务。 此方法可以用于在启动时访问有作用域的服务以便运行初始化任务。 以下示例演示如何在 <code>Program.Main</code> 中获取 <code>MyScopedService</code> 的上下文：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">using System;<br>using System.Threading.Tasks;<br>using Microsoft.Extensions.DependencyInjection;<br>using Microsoft.AspNetCore.Hosting;<br>using Microsoft.Extensions.Hosting;<br><br>public class Program<br>&#123;<br>    public static async Task Main(string[] args)<br>    &#123;<br>        var host &#x3D; CreateHostBuilder(args).Build();<br><br>        using (var serviceScope &#x3D; host.Services.CreateScope())<br>        &#123;<br>            var services &#x3D; serviceScope.ServiceProvider;<br><br>            try<br>            &#123;<br>                var serviceContext &#x3D; services.GetRequiredService&lt;MyScopedService&gt;();<br>                &#x2F;&#x2F; Use the context here<br>            &#125;<br>            catch (Exception ex)<br>            &#123;<br>                var logger &#x3D; services.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;();<br>                logger.LogError(ex, &quot;An error occurred.&quot;);<br>            &#125;<br>        &#125;<br><br>        await host.RunAsync();<br>    &#125;<br><br>    public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;<br>        Host.CreateDefaultBuilder(args)<br>            .ConfigureWebHostDefaults(webBuilder &#x3D;&gt;<br>            &#123;<br>                webBuilder.UseStartup&lt;Startup&gt;();<br>            &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="作用域验证"><a class="header-anchor" href="#作用域验证">¶</a>作用域验证</h4>
<p>如果应用正在开发环境中运行，并调用 <a href="http://www.zyiz.net/tutorial/detail-4544.html#default-builder-settings" target="_blank" rel="noopener"><code>CreateDefaultBuilder</code></a> 生成主机，默认服务提供程序会执行检查，以确认以下内容：</p>
<ul>
<li>没有从根服务提供程序直接或间接解析到有作用域的服务。</li>
<li>未将有作用域的服务直接或间接注入到单一实例。</li>
</ul>
<p>调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.servicecollectioncontainerbuilderextensions.buildserviceprovider" target="_blank" rel="noopener"><code>BuildServiceProvider</code></a> 时创建根服务提供程序。 在启动提供程序和应用时，根服务提供程序的生存期对应于应用/服务的生存期，并在关闭应用时释放。</p>
<p>有作用域的服务由创建它们的容器释放。 如果作用域创建于根容器，则该服务的生存会有效地提升至单一实例，因为根容器只会在应用/服务关闭时将其释放。 验证服务作用域，将在调用 <code>BuildServiceProvider</code> 时收集这类情况。</p>
<h4 id="请求服务"><a class="header-anchor" href="#请求服务">¶</a>请求服务</h4>
<p>来自 <code>HttpContext</code> 的 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 请求中可用的服务通过 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.http.httpcontext.requestservices#Microsoft_AspNetCore_Http_HttpContext_RequestServices" target="_blank" rel="noopener"><code>HttpContext.RequestServices</code></a> 集合公开。</p>
<p>请求服务表示作为应用的一部分配置和请求的服务。 当对象指定依赖关系时，<code>RequestServices</code>（而不是 <code>ApplicationServices</code>）中的类型将满足这些要求。</p>
<blockquote>
<p><strong>注意</strong></p>
<hr>
<p>通常，应用不应直接使用这些属性。 相反，通过类构造函数请求类所需的类型，并允许框架注入依赖关系。 这样生成的类更易于测试。</p>
</blockquote>
<blockquote>
<p>与访问 <code>RequestServices</code> 集合相比，以构造函数参数的形式请求依赖项是更优先的选择。</p>
</blockquote>
<h4 id="设计能够进行依赖关系注入的服务"><a class="header-anchor" href="#设计能够进行依赖关系注入的服务">¶</a>设计能够进行依赖关系注入的服务</h4>
<p>最佳做法是：</p>
<ul>
<li>设计服务以使用依赖关系注入来获取其依赖关系。</li>
<li>避免有状态的、静态类和成员。 将应用设计为改用单一实例服务，可避免创建全局状态。</li>
<li>避免在服务中直接实例化依赖类。 直接实例化将代码耦合到特定实现。</li>
<li>不在应用类中包含过多内容，确保设计规范，并易于测试。</li>
</ul>
<p>如果一个类似乎有过多的注入依赖关系，这通常表明该类拥有过多的责任并且违反了<a href="https://docs.microsoft.com/zh-cn/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#single-responsibility" target="_blank" rel="noopener">单一责任原则 (SRP)</a>。 尝试通过将某些职责移动到一个新类来重构类。 请记住，Razor Pages 页模型类和 MVC 控制器类应关注用户界面问题。 业务规则和数据访问实现细节应保留在适用于这些<a href="https://docs.microsoft.com/zh-cn/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#separation-of-concerns" target="_blank" rel="noopener">分离的关注点</a>的类中。</p>
<h4 id="服务处理"><a class="header-anchor" href="#服务处理">¶</a>服务处理</h4>
<p>容器为其创建的 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.idisposable" target="_blank" rel="noopener"><code>IDisposable</code></a> 类型调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.idisposable.dispose" target="_blank" rel="noopener"><code>Dispose</code></a>。 如果通过<strong>用户代码直接</strong>将实例添加到容器中，则不会自动处理该实例。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">&#x2F;&#x2F; Services that implement IDisposable:<br>public class Service1 : IDisposable &#123;&#125;<br>public class Service2 : IDisposable &#123;&#125;<br>public class Service3 : IDisposable &#123;&#125;<br><br>public interface ISomeService &#123;&#125;<br>public class SomeServiceImplementation : ISomeService, IDisposable &#123;&#125;<br><br>public void ConfigureServices(IServiceCollection services)<br>&#123;<br>    &#x2F;&#x2F; The container creates the following instances and disposes them automatically:<br>    services.AddScoped&lt;Service1&gt;();<br>    services.AddSingleton&lt;Service2&gt;();<br>    services.AddSingleton&lt;ISomeService&gt;(sp &#x3D;&gt; new SomeServiceImplementation());<br><br>    &#x2F;&#x2F; The container doesn&#39;t create the following instances, so it doesn&#39;t dispose of<br>    &#x2F;&#x2F; the instances automatically:<br>    services.AddSingleton&lt;Service3&gt;(new Service3());<br>    services.AddSingleton(new Service3());<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="默认服务容器替换"><a class="header-anchor" href="#默认服务容器替换">¶</a>默认服务容器替换</h4>
<p>内置的服务容器旨在满足框架和大多数消费者应用的需求。 我们建议使用内置容器，除非你需要的特定功能不受内置容器支持，例如：</p>
<ul>
<li>属性注入</li>
<li>基于名称的注入</li>
<li>子容器</li>
<li>自定义生存期管理</li>
<li>对迟缓初始化的 <code>Func&lt;T&gt;</code> 支持</li>
<li>基于约定的注册</li>
</ul>
<p>以下第三方容器可用于 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 应用：</p>
<ul>
<li><a href="https://autofac.readthedocs.io/en/latest/integration/aspnetcore.html" target="_blank" rel="noopener">Autofac</a></li>
<li><a href="https://www.nuget.org/packages/DryIoc.Microsoft.DependencyInjection" target="_blank" rel="noopener">DryIoc</a></li>
<li><a href="https://www.nuget.org/packages/Grace.DependencyInjection.Extensions" target="_blank" rel="noopener">Grace</a></li>
<li><a href="https://github.com/seesharper/LightInject.Microsoft.DependencyInjection" target="_blank" rel="noopener">LightInject</a></li>
<li><a href="https://jasperfx.github.io/lamar/" target="_blank" rel="noopener">Lamar</a></li>
<li><a href="https://github.com/z4kn4fein/stashbox-extensions-dependencyinjection" target="_blank" rel="noopener">Stashbox</a></li>
<li><a href="https://www.nuget.org/packages/Unity.Microsoft.DependencyInjection" target="_blank" rel="noopener">Unity</a></li>
</ul>
<h4 id="线程安全性"><a class="header-anchor" href="#线程安全性">¶</a>线程安全性</h4>
<p>创建线程安全的单一实例服务。 如果单例服务依赖于一个瞬时服务，那么瞬时服务可能也需要线程安全，具体取决于单例使用它的方式。</p>
<p>单个服务的工厂方法（例如 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.servicecollectionserviceextensions.addsingleton" target="_blank" rel="noopener"><code>AddSingleton(IServiceCollection, Func)</code></a> 的第二个参数）不必是线程安全的。 像类型 (<code>static</code>) 构造函数一样，它保证由单个线程调用一次。</p>
<h4 id="建议"><a class="header-anchor" href="#建议">¶</a>建议</h4>
<ul>
<li>
<p>不支持基于 <code>async/await</code> 和 <code>Task</code> 的服务解析。 C# 不支持异步构造函数；因此建议模式是在同步解析服务后使用异步方法。</p>
</li>
<li>
<p>避免在服务容器中直接存储数据和配置。 例如，用户的购物车通常不应添加到服务容器中。 配置应使用选项模型。 同样，避免&quot;数据持有者&quot;对象，也就是仅仅为实现对某些其他对象的访问而存在的对象。 最好通过 DI 请求实际项目。</p>
</li>
<li>
<p>避免静态访问服务（例如，静态键入 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder.applicationservices#Microsoft_AspNetCore_Builder_IApplicationBuilder_ApplicationServices" target="_blank" rel="noopener"><code>IApplicationBuilder.ApplicationServices</code></a> 以便在其他地方使用）。</p>
</li>
<li>
<p>避免使用服务定位器模式 。 例如，可以改用 DI 时，不要调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/system.iserviceprovider.getservice" target="_blank" rel="noopener"><code>GetService</code></a> 来获取服务实例：</p>
<p>不正确：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">  public class MyClass()<br>&#123;<br>    public void MyMethod()<br>    &#123;<br>        var optionsMonitor &#x3D;<br>            _services.GetService&lt;IOptionsMonitor&lt;MyOptions&gt;&gt;();<br>        var option &#x3D; optionsMonitor.CurrentValue.Option;<br><br>        ...<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>更正：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class MyClass<br>&#123;<br>    private readonly IOptionsMonitor&lt;MyOptions&gt; _optionsMonitor;<br><br>    public MyClass(IOptionsMonitor&lt;MyOptions&gt; optionsMonitor)<br>    &#123;<br>        _optionsMonitor &#x3D; optionsMonitor;<br>    &#125;<br><br>    public void MyMethod()<br>    &#123;<br>        var option &#x3D; _optionsMonitor.CurrentValue.Option;<br><br>        ...<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>要避免的另一个服务定位器变体是注入可在运行时解析依赖项的工厂。 这两种做法混合了<a href="https://docs.microsoft.com/zh-cn/dotnet/standard/modern-web-apps-azure-architecture/architectural-principles#dependency-inversion" target="_blank" rel="noopener">控制反转</a>策略。</p>
</li>
<li>
<p>避免静态访问 <code>HttpContext</code>（例如，<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.http.ihttpcontextaccessor.httpcontext#Microsoft_AspNetCore_Http_IHttpContextAccessor_HttpContext" target="_blank" rel="noopener"><code>IHttpContextAccessor.HttpContext</code></a>）。</p>
</li>
</ul>
<blockquote>
<p>像任何一组建议一样，你可能会遇到需要忽略某建议的情况。 例外情况很少见 — 主要是框架本身内部的特殊情况。</p>
<p>DI 是静态/全局对象访问模式的替代方法 。 如果将其与静态对象访问混合使用，则可能无法实现 DI 的优点。</p>
</blockquote>
<h3 id="四、Startup-类"><a class="header-anchor" href="#四、Startup-类">¶</a>四、<code>Startup</code> 类</h3>
<p><a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 应用使用 <code>Startup</code> 类，按照约定命名为 <code>Startup</code>。 <code>Startup</code> 类：</p>
<ul>
<li><strong>可选择性地</strong>包括  <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.startupbase.configureservices" target="_blank" rel="noopener"><code>ConfigureServices</code></a> 方法以配置应用的服务<sup class="footnote-ref"><a href="#fn4" id="fnref4">[4]</a></sup> 。在 <code>ConfigureServices</code> 中注册服务，并通过依赖关系注入 （DI）或 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder.applicationservices" target="_blank" rel="noopener"><code>ApplicationServices</code></a> 在整个应用中使用服务 。</li>
<li>包括  <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.startupbase.configure" target="_blank" rel="noopener"><code>Configure</code></a> 方法以创建应用的请求处理管道。</li>
</ul>
<blockquote></blockquote>
<p>在应用启动时，<a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 运行时会调用 <code>ConfigureServices</code> 和 <code>Configure</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Startup<br>&#123;<br>    public Startup(IConfiguration configuration)<br>    &#123;<br>        Configuration &#x3D; configuration;<br>    &#125;<br><br>    public IConfiguration Configuration &#123; get; &#125;<br><br>    public void ConfigureServices(IServiceCollection services)<br>    &#123;<br>        services.AddRazorPages();<br>    &#125;<br><br>    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)<br>    &#123;<br>        if (env.IsDevelopment())<br>        &#123;<br>            app.UseDeveloperExceptionPage();<br>        &#125;<br>        else<br>        &#123;<br>            app.UseExceptionHandler(&quot;&#x2F;Error&quot;);<br>            app.UseHsts();<br>        &#125;<br><br>        app.UseHttpsRedirection();<br>        app.UseStaticFiles();<br><br>        app.UseRouting();<br><br>        app.UseAuthorization();<br><br>        app.UseEndpoints(endpoints &#x3D;&gt;<br>        &#123;<br>            endpoints.MapRazorPages();<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<blockquote>
<p>前面的示例适用于 Razor Pages，MVC 版本类似。</p>
</blockquote>
<p>在构建应用<a href="http://www.zyiz.net/tutorial/detail-4541.html#host" target="_blank" rel="noopener">主机</a>时指定 <code>Startup</code> 类。 通常通过在主机生成器上调用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.webhostbuilderextensions.usestartup" target="_blank" rel="noopener"><code>WebHostBuilderExtensions.UseStartup</code></a> 方法来指定 <code>Startup</code> 类：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Program<br>&#123;<br>    public static void Main(string[] args)<br>    &#123;<br>        CreateHostBuilder(args).Build().Run();<br>    &#125;<br><br>    public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;<br>        Host.CreateDefaultBuilder(args)<br>        .ConfigureWebHostDefaults(webBuilder &#x3D;&gt;<br>        &#123;<br>            webBuilder.UseStartup&lt;Startup&gt;();<br>        &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>主机提供 <code>Startup</code> 类构造函数可用的<strong>某些</strong>服务；应用通过 <code>ConfigureServices</code> 添加<strong>其他</strong>服务。<strong>服务都可以在 <code>Configure</code> 和整个应用中使用</strong>。</p>
<p>使用泛型主机（<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihostbuilder" target="_blank" rel="noopener"><code>IHostBuilder</code></a>）时，只能将以下服务类型注入 <code>Startup</code> 构造函数：</p>
<ul>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.iwebhostenvironment" target="_blank" rel="noopener"><code>IWebHostEnvironment</code></a></li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.hosting.ihostenvironment" target="_blank" rel="noopener"><code>IHostEnvironment</code></a></li>
<li><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.configuration.iconfiguration" target="_blank" rel="noopener"><code>IConfiguration</code></a></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class Startup<br>&#123;<br>    private readonly IWebHostEnvironment _env;<br><br>    public Startup(IConfiguration configuration, IWebHostEnvironment env)<br>    &#123;<br>        Configuration &#x3D; configuration;<br>        _env &#x3D; env;<br>    &#125;<br><br>    public IConfiguration Configuration &#123; get; &#125;<br><br>    public void ConfigureServices(IServiceCollection services)<br>    &#123;<br>        if (_env.IsDevelopment())<br>        &#123;<br>        &#125;<br>        else<br>        &#123;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>在调用 <code>Configure</code> 方法之前，大多数服务都不可用。</p>
</blockquote>
<h4 id="多个-Startup-类"><a class="header-anchor" href="#多个-Startup-类">¶</a>多个 <code>Startup</code> 类</h4>
<p>应用为不同的环境（例如，<code>StartupDevelopment</code>）单独定义 <code>Startup</code> 类时，相应的 <code>Startup</code> 类会在运行时被选中。 优先考虑名称后缀与当前环境相匹配的类。 如果应用在开发环境中运行并包含 <code>Startup</code> 类和 <code>StartupDevelopment</code> 类，则使用 <code>StartupDevelopment</code> 类。</p>
<h4 id="ConfigureServices-方法"><a class="header-anchor" href="#ConfigureServices-方法">¶</a><code>ConfigureServices</code> 方法</h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.startupbase.configureservices" target="_blank" rel="noopener"><code>ConfigureServices</code></a> 方法：</p>
<ul>
<li>可选。</li>
<li>在 <code>Configure</code> 方法配置应用服务之前，由主机调用。</li>
<li>其中按常规设置配置选项。</li>
</ul>
<p>主机可能会在调用 <code>Startup</code> 方法之前配置某些服务。</p>
<p>对于需要大量设置的功能，<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.extensions.dependencyinjection.iservicecollection" target="_blank" rel="noopener"><code>IServiceCollection</code></a> 上有 <code>Add{Service}</code> 扩展方法。 例如，<code>AddDbContext</code>、<code>AddDefaultIdentity</code>、<code>AddEntityFrameworkStores</code> 和 <code>AddRazorPages</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Startup<br>&#123;<br>    public Startup(IConfiguration configuration)<br>    &#123;<br>        Configuration &#x3D; configuration;<br>    &#125;<br><br>    public IConfiguration Configuration &#123; get; &#125;<br><br>    public void ConfigureServices(IServiceCollection services)<br>    &#123;<br><br>        services.AddDbContext&lt;ApplicationDbContext&gt;(options &#x3D;&gt;<br>            options.UseSqlServer(<br>                Configuration.GetConnectionString(&quot;DefaultConnection&quot;)));<br>        services.AddDefaultIdentity&lt;IdentityUser&gt;(<br>            options &#x3D;&gt; options.SignIn.RequireConfirmedAccount &#x3D; true)<br>            .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;();<br><br>        services.AddRazorPages();<br>    &#125;<br></code></pre></div></td></tr></table></figure>
<p>将服务添加到服务容器，使其在应用和 <code>Configure</code> 方法中可用。 服务通过依赖关系注入或 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder.applicationservices" target="_blank" rel="noopener"><code>ApplicationServices</code></a> 进行解析。</p>
<h4 id="Configure-方法"><a class="header-anchor" href="#Configure-方法">¶</a><code>Configure</code> 方法</h4>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.startupbase.configure" target="_blank" rel="noopener"><code>Configure</code></a> 方法用于指定应用响应 HTTP 请求的方式。 可通过将中间件组件添加到 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder" target="_blank" rel="noopener"><code>IApplicationBuilder</code></a> 实例来配置请求管道。 <code>Configure</code> 方法可使用 <code>IApplicationBuilder</code>，而无需在服务容器中注册。 托管创建 <code>IApplicationBuilder</code> 并将其直接传递到 <code>Configure</code>。</p>
<p><a href="https://docs.microsoft.com/zh-cn/dotnet/core/tools/dotnet-new" target="_blank" rel="noopener">ASP.NET Core 模板</a>配置的管道支持：</p>
<ul>
<li>开发人员异常页</li>
<li>异常处理程序</li>
<li>HTTP 严格传输安全性 (HSTS)</li>
<li>HTTPS 重定向</li>
<li>静态文件</li>
<li><a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core MVC 和 Razor Pages</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Startup<br>&#123;<br>    public Startup(IConfiguration configuration)<br>    &#123;<br>        Configuration &#x3D; configuration;<br>    &#125;<br><br>    public IConfiguration Configuration &#123; get; &#125;<br><br>    public void ConfigureServices(IServiceCollection services)<br>    &#123;<br>        services.AddRazorPages();<br>    &#125;<br><br>    public void Configure(IApplicationBuilder app, IWebHostEnvironment env)<br>    &#123;<br>        if (env.IsDevelopment())<br>        &#123;<br>            app.UseDeveloperExceptionPage();<br>        &#125;<br>        else<br>        &#123;<br>            app.UseExceptionHandler(&quot;&#x2F;Error&quot;);<br>            app.UseHsts();<br>        &#125;<br><br>        app.UseHttpsRedirection();<br>        app.UseStaticFiles();<br><br>        app.UseRouting();<br><br>        app.UseAuthorization();<br><br>        app.UseEndpoints(endpoints &#x3D;&gt;<br>        &#123;<br>            endpoints.MapRazorPages();<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<blockquote>
<p>前面的示例适用于 Razor Pages；MVC 版本类似。</p>
</blockquote>
<p>每个 <code>Use</code> 扩展方法将一个或多个中间件组件添加到请求管道。 例如，<a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.staticfileextensions.usestaticfiles" target="_blank" rel="noopener"><code>UseStaticFiles</code></a> 配置中间件提供静态文件。</p>
<p>请求管道中的每个中间件组件负责调用管道中的下一个组件，或在适当情况下使链发生短路。</p>
<p>可以在 <code>Configure</code> 方法签名中指定其他服务，如 <code>IWebHostEnvironment</code>、<code>ILoggerFactory</code> 或 <code>ConfigureServices</code> 中定义的任何内容。 如果这些服务可用，则会被注入。</p>
<h4 id="在不使用-Startup-类的情况下配置服务"><a class="header-anchor" href="#在不使用-Startup-类的情况下配置服务">¶</a>在不使用 <code>Startup</code> 类的情况下配置服务</h4>
<p>若要配置服务和请求处理管道，而不使用 <code>Startup</code> 类，请在主机生成器上调用 <code>ConfigureServices</code> 和 <code>Configure</code> 便捷方法。 多次调用 <code>ConfigureServices</code> 将追加到另一个。</p>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>如果存在多个 <code>Configure</code> 方法调用，则使用最后一个 <code>Configure</code> 调用。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Program<br>&#123;<br>    public static void Main(string[] args)<br>    &#123;<br>        CreateHostBuilder(args).Build().Run();<br>    &#125;<br><br>    public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;<br>        Host.CreateDefaultBuilder(args)<br>            .ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>            &#123;<br>            &#125;)<br>            .ConfigureWebHostDefaults(webBuilder &#x3D;&gt;<br>            &#123;<br>                webBuilder.ConfigureServices(services &#x3D;&gt;<br>                &#123;<br>                    services.AddControllersWithViews();<br>                &#125;)<br>                .Configure(app &#x3D;&gt;<br>                &#123;<br>                    var loggerFactory &#x3D; app.ApplicationServices<br>                        .GetRequiredService&lt;ILoggerFactory&gt;();<br>                    var logger &#x3D; loggerFactory.CreateLogger&lt;Program&gt;();<br>                    var env &#x3D; app.ApplicationServices.GetRequiredService&lt;IWebHostEnvironment&gt;();<br>                    var config &#x3D; app.ApplicationServices.GetRequiredService&lt;IConfiguration&gt;();<br><br>                    logger.LogInformation(&quot;Logged in Configure&quot;);<br><br>                    if (env.IsDevelopment())<br>                    &#123;<br>                        app.UseDeveloperExceptionPage();<br>                    &#125;<br>                    else<br>                    &#123;<br>                        app.UseExceptionHandler(&quot;&#x2F;Home&#x2F;Error&quot;);<br>                        app.UseHsts();<br>                    &#125;<br><br>                    var configValue &#x3D; config[&quot;MyConfigKey&quot;];<br>                &#125;);<br>            &#125;);<br>        &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="使用-Startup-筛选器扩展-Startup"><a class="header-anchor" href="#使用-Startup-筛选器扩展-Startup">¶</a>使用 <code>Startup</code> 筛选器扩展 <code>Startup</code></h4>
<p>使用 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.istartupfilter" target="_blank" rel="noopener"><code>IStartupFilter</code></a>：</p>
<ul>
<li>在应用的 <code>Configure</code> 中间件管道的开头或末尾配置中间件，而无需显式调用 <code>Use{Middleware}</code>。 <code>IStartupFilter</code> 由 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 用于将默认值添加到管道的开头，而无需使应用作者显式注册默认中间件。 <code>IStartupFilter</code> 允许代表应用作者使用不同的组件调用 <code>Use{Middleware}</code>。</li>
<li>创建 <code>Configure</code> 方法的管道。 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.istartupfilter.configure" target="_blank" rel="noopener"><code>IStartupFilter.Configure</code></a> 可以将中间件设置为在库添加的中间件之前或之后运行。</li>
</ul>
<p><code>IStartupFilter</code> 实现了抽象方法 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.startupbase.configure" target="_blank" rel="noopener"><code>Configure</code></a>，即接收并返回 <code>Action&lt;IApplicationBuilder&gt;</code>。 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.builder.iapplicationbuilder" target="_blank" rel="noopener"><code>IApplicationBuilder</code></a> 定义用于配置应用请求管道的类。</p>
<p>每个 <code>IStartupFilter</code> 可以在请求管道中添加一个或多个中间件。 筛选器按照添加到服务容器的顺序调用。 筛选器可在将控件传递给下一个筛选器之前或之后添加中间件，从而附加到应用管道的开头或末尾。</p>
<p>下面的示例演示如何使用 <code>IStartupFilter</code> 注册中间件。 <code>RequestSetOptionsMiddleware</code> 中间件从查询字符串参数中设置选项值：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class RequestSetOptionsMiddleware<br>&#123;<br>    private readonly RequestDelegate _next;<br><br>    public RequestSetOptionsMiddleware( RequestDelegate next )<br>    &#123;<br>        _next &#x3D; next;<br>    &#125;<br><br>    &#x2F;&#x2F; Test with https:&#x2F;&#x2F;localhost:5001&#x2F;Privacy&#x2F;?option&#x3D;Hello<br>    public async Task Invoke(HttpContext httpContext)<br>    &#123;<br>        var option &#x3D; httpContext.Request.Query[&quot;option&quot;];<br><br>        if (!string.IsNullOrWhiteSpace(option))<br>        &#123;<br>            httpContext.Items[&quot;option&quot;] &#x3D; WebUtility.HtmlEncode(option);<br>        &#125;<br><br>        await _next(httpContext);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在 <code>RequestSetOptionsStartupFilter</code> 类中配置 <code>RequestSetOptionsMiddleware</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class RequestSetOptionsStartupFilter : IStartupFilter<br>&#123;<br>    public Action&lt;IApplicationBuilder&gt; Configure(Action&lt;IApplicationBuilder&gt; next)<br>    &#123;<br>        return builder &#x3D;&gt;<br>        &#123;<br>            builder.UseMiddleware&lt;RequestSetOptionsMiddleware&gt;();<br>            next(builder);<br>        &#125;;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.startupbase.configureservices" target="_blank" rel="noopener"><code>ConfigureServices</code></a> 中的服务容器中注册 <code>IStartupFilter</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Program<br>&#123;<br>    public static void Main(string[] args)<br>    &#123;<br>        CreateHostBuilder(args).Build().Run();<br>    &#125;<br><br>    public static IHostBuilder CreateHostBuilder(string[] args) &#x3D;&gt;<br>        Host.CreateDefaultBuilder(args)<br>           .ConfigureAppConfiguration((hostingContext, config) &#x3D;&gt;<br>           &#123;<br>           &#125;)<br>         .ConfigureWebHostDefaults(webBuilder &#x3D;&gt;<br>         &#123;<br>             webBuilder.UseStartup&lt;Startup&gt;();<br>         &#125;)<br>        .ConfigureServices(services &#x3D;&gt;<br>        &#123;<br>            services.AddTransient&lt;IStartupFilter,<br>                      RequestSetOptionsStartupFilter&gt;();<br>        &#125;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>当提供 <code>option</code> 的查询字符串参数时，中间件在 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> Core 中间件呈现响应之前处理分配值。</p>
<p>中间件执行顺序由 <code>IStartupFilter</code> 注册顺序设置：</p>
<ul>
<li>多个 <code>IStartupFilter</code> 实现可能与相同的对象进行交互。 如果顺序很重要，请将它们的 <code>IStartupFilter</code> 服务注册进行排序，以匹配其中间件应有的运行顺序。</li>
<li>库可能添加包含一个或多个 <code>IStartupFilter</code> 实现的中间件，这些实现在向 <code>IStartupFilter</code> 注册的其他应用中间件之前或之后运行。 若要在库的 <code>IStartupFilter</code> 添加的中间件之前调用 <code>IStartupFilter</code> 中间件，请执行以下操作：
<ul>
<li>在库添加到服务容器之前定位服务注册。</li>
<li>要在此后调用，请在添加库之后定位服务注册。</li>
</ul>
</li>
</ul>
<h4 id="在启动时从外部程序集添加配置"><a class="header-anchor" href="#在启动时从外部程序集添加配置">¶</a>在启动时从外部程序集添加配置</h4>
<p>通过 <a href="https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.aspnetcore.hosting.ihostingstartup" target="_blank" rel="noopener"><code>IHostingStartup</code></a> 实现，可在启动时从应用 <code>Startup</code> 类之外的外部程序集向应用添加增强功能。</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><code>IHostedService</code> 服务是一种后台运行的，单例（Singleton）的服务。参考<a href="#IHostedServiceExample">“设置主机”小节示例</a>，其中 Worker 类为 Worker 工程主类，它继承自 <code>BackgroundService</code>，<code>BackgroundService</code> 实现了 <code>IHostedService</code>。<code>IHostedService</code> 接口包含两个关键方法：<code>public Task StartAsync(CancellationToken cancellationToke)</code> 和 <code>public Task StopAsync(CancellationToken cancellationToken)</code>。 <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><code>StopApplication</code> 方法是 <a href="#IHostApplicationLifetime_1_1"><code>IHostApplictionLifetime</code></a> 接口唯一方法。 <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>此处可能翻译有误，猜测原文为“key”，本句应翻译为“例如，<code>ASPNETCORE_ENVIRONMENT</code> 的环境变量值就变成键为 <code>environment</code> 的主机配置值。”。 <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn4" class="footnote-item"><p>服务是一个提供应用功能的可重用组件。 <a href="#fnref4" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/NET/">.NET</a>
                    
                      <a class="hover-with-bg" href="/tags/NETCore/">.NETCore</a>
                    
                      <a class="hover-with-bg" href="/tags/Microsoft/">Microsoft</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/04/10/Linux-IO/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Linux I/O 模式及 select、poll 和 epoll 详解</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/04/10/ASP.NET-Core-3.1-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%BA%8C%EF%BC%89/">
                        <span class="hidden-mobile">ASP.NET Core 3.1 学习笔记（二）</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    Fluid.utils.waitElementVisible('vcomments', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "TMgxzCpM2zFnsClsMHJY2LLc-gzGzoHsz",
          app_key: "1kPLieLtoBQWf0w6iNxLqkMV",
          placeholder: "说点什么....",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: true,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="https://valine.js.org" target="_blank" rel="nofollow noopener noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> &nbsp;and&nbsp; <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a9b0666290f750544a1900dff36c0349";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-127726236-2', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>



<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon.ico">
  <link rel="icon" type="image/png" href="/images/favicon.ico">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="When in doubt, use brute force.">
  <meta name="author" content="Rabbituzki">
  <meta name="keywords" content="">
  <title>Entity Framework Core 3.1 教程 - Rabbituzki 的笔记们</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/gruvbox-dark.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"blog.rabbituzki.com.cn","root":"/","version":"1.8.6","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"❡"},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":"a9b0666290f750544a1900dff36c0349","google":"UA-127726236-2","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"TMgxzCpM2zFnsClsMHJY2LLc-gzGzoHsz","app_key":"1kPLieLtoBQWf0w6iNxLqkMV","server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.1"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Rabbituzki 的笔记们</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/images/background1.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Entity Framework Core 3.1 教程">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-04-18 00:00" pubdate>
        2020年4月18日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      25.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      360
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Entity Framework Core 3.1 教程</h1>
            
            <div class="markdown-body">
              <h1>Entity Framework Core 3.1 教程</h1>
<h2 id="一、Entity-Framework-Core-简介"><a class="header-anchor" href="#一、Entity-Framework-Core-简介">¶</a>一、Entity Framework Core 简介</h2>
<h3 id="EF-Core-开发方法"><a class="header-anchor" href="#EF-Core-开发方法">¶</a>EF Core 开发方法</h3>
<p>EF Core 支持两种开发方法：</p>
<ul>
<li>
<p>Code-First (代码优先)：在 Code-First 方法中，EF Core API 会根据你的代码中的领域模型中提供的约定和配置，使用迁移来创建数据库和表。此方法在领域驱动设计 (DDD) 中很有用。</p>
</li>
<li>
<p>Database-First (数据库优先)：在 Database-First 方法中，EF Core API 使用 EF Core 命令基于现有数据库创建领域模型和数据库上下文 (DbContext) 类。由于它不支持可视设计器或向导，因此在 EF Core 中的支持有限。</p>
</li>
</ul>
<p>EF  Core 主要针对 Code-First 方法，很少提供对 Database-First 方法的支持，因为从 EF Core  2.0 开始不支持可视化的 DB 模型设计器或向导。</p>
<h2 id="二、安装-Entity-Framework-Core"><a class="header-anchor" href="#二、安装-Entity-Framework-Core">¶</a>二、安装 Entity Framework Core</h2>
<p>EF Core 不是 .NET Core 和标准 .NET 框架的一部分。它以 NuGet 软件包的形式提供。您需要在应用程序中安装两个 NuGet 软件包，才能在应用程序中使用 EF Core：</p>
<ul>
<li>EF Core DB Provider</li>
<li>EF Core Tools</li>
</ul>
<p>EF Core 的安装步骤：</p>
<ol>
<li>
<p>新建新项目，如空控制台项目：</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; mkdir EFCoreTutorials<br>PM&gt; cd EFCoreTutorials<br>PM&gt; dotnet new console<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>安装 EF Core DB Provider，以 SQL Server 为例，其它 Provider 参考 <a href="https://docs.microsoft.com/zh-cn/ef/core/providers/?tabs=dotnet-core-cli" target="_blank" rel="noopener">EF Core Provider 列表</a>：</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet add package Microsoft.EntityFrameworkCore.SqlServer<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>安装 EF Core Tools：</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet add package Microsoft.EntityFrameworkCore.Tools<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>安装 EF Core CLI 工具。具体安装和使用方法参考 <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/cli/dotnet" target="_blank" rel="noopener">Entity Framework Core 工具参考-.NET CLI</a>：</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet add package Microsoft.EntityFrameworkCore.Design<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>为项目生成 <em>.config\dotnet-tools.json</em> 文件，没有此文件无法 <strong>为项目</strong> 安装 dotnet-ef  工具。参考上一步中的链接中 <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/cli/dotnet" target="_blank" rel="noopener">tool manifest file</a> 说明：</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet new tool<span class="hljs-literal">-manifest</span><br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>安装 dotnet-ef 工具：</p>
 <figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powshell">PM&gt; dotnet tool install dotnet-ef<br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<h2 id="三、在-Entity-Framework-Core-中为现有数据库创建模型-即-Database-First-方法"><a class="header-anchor" href="#三、在-Entity-Framework-Core-中为现有数据库创建模型-即-Database-First-方法">¶</a>三、在 Entity Framework Core 中为现有数据库创建模型 (即 Database-First 方法)</h2>
<p>EF Core 不支持用于可视化设计器的 DB 模型和向导来创建类似于 EF 6 的实体和上下文类。</p>
<p>让我们在下面显示的本地 MS SQL Server 中为以下 SchoolDB 数据库创建实体和上下文类。因此，我们需要使用 <code>Scaffold-DbContext</code> 或 <code>dotnet ef dbcontext scaffold</code> 命令进行 <a href="https://docs.microsoft.com/zh-cn/ef/core/managing-schemas/scaffolding" target="_blank" rel="noopener">反向工程</a>。此反向工程命令基于现有数据库的架构创建实体和上下文类 (通过派生 <code>DbContext</code>)。</p>
<p><img src="/images/efcore/20200207210923466.png" alt="图3-1"></p>
<h3 id="dotnet-ef-dbcontext-scaffold-命令"><a class="header-anchor" href="#dotnet-ef-dbcontext-scaffold-命令">¶</a><code>dotnet ef dbcontext scaffold</code> 命令</h3>
<p>使用 <code>dotnet ef dbcontext scaffold</code> 基于现有数据库创建模型：</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">dotnet ef dbcontext scaffold [-<span class="hljs-type">Connection</span>] [-<span class="hljs-type">Provider</span>] [-<span class="hljs-type">OutputDir</span>] [-<span class="hljs-type">Context</span>] [-<span class="hljs-type">Schemas</span>&gt;] [-<span class="hljs-type">Tables</span>&gt;] <br>                    [-<span class="hljs-type">DataAnnotations</span>] [-<span class="hljs-type">Force</span>] [-<span class="hljs-type">Project</span>] [-<span class="hljs-type">StartupProject</span>] [&lt;<span class="hljs-type">CommonParameters</span>&gt;]<br></code></pre></div></td></tr></table></figure>
<p>反向本例中的数据库：</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">dotnet ef dbcontext scaffold <span class="hljs-string">"Server=.\SQLExpress;Database=SchoolDB;Trusted_Connection=True;"</span> Microsoft.EntityFrameworkCore.SqlServer <span class="hljs-literal">-OutputDir</span> Models<br></code></pre></div></td></tr></table></figure>
<p>在上面的命令中：</p>
<ul>
<li>第一个参数是一个连接字符串，它包括三个部分：
<ul>
<li>数据库服务器, 数据库名称和安全信息。在这里，<code>Server=.\SQLExpress;</code> 指本地 SQL Server Express 数据库服务器。</li>
<li><code>Database=SchoolDB;</code>  指定我们要为其创建类的数据库名称 “SchoolDB”。</li>
<li><code>Trusted_Connection=True;</code> 指定 Windows 身份验证。<br>
它将使用 Windows 凭据连接到 SQL Server。</li>
</ul>
</li>
<li>第二个参数是提供程序名称。我们将提供程序用于 SQL Server，因此它是 <code>Microsoft.EntityFrameworkCore.SqlServer</code>。</li>
<li><code>-OutputDir</code> 参数指定我们要在其中生成所有类的目录，在本例中为_Models_ 文件夹。</li>
</ul>
<p>上面的 <code>dotnet ef dbcontext scaffold</code> 命令使用为 <em>Models</em> 文件夹中所有实体的 Fluent API 配置为SchoolDB 数据库中的每个表创建实体类，并通过派生 DbContext 创建数据库上下文类。<br>
以下是为 Student 表生成的 <code>Student</code> 实体类：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">using System;<br>using System.Collections.Generic;<br><br>namespace EFCoreTutorials.Models &#123;<br>    public partial class Student &#123;<br>        public Student() &#123;<br>            StudentCourse &#x3D; new HashSet&lt;StudentCourse&gt;();<br>        &#125;<br><br>        public int StudentId &#123; get; set; &#125;<br>        public string FirstName &#123; get; set; &#125;<br>        public string LastName &#123; get; set; &#125;<br>        public int? StandardId &#123; get; set; &#125;<br><br>        public Standard Standard &#123; get; set; &#125;<br>        public StudentAddress StudentAddress &#123; get; set; &#125;<br>        public ICollection&lt;StudentCourse&gt; StudentCourse &#123; get; set; &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>以下是 <code>SchoolDBContext</code> 类，可用于保存或检索数据：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">using System;<br>using Microsoft.EntityFrameworkCore;<br>using Microsoft.EntityFrameworkCore.Metadata;<br><br>namespace EFCoreTutorials.Models &#123;<br>    public partial class SchoolDBContext : DbContext &#123;<br>        public virtual DbSet&lt;Course&gt; Course &#123; get; set; &#125;<br>        public virtual DbSet&lt;Standard&gt; Standard &#123; get; set; &#125;<br>        public virtual DbSet&lt;Student&gt; Student &#123; get; set; &#125;<br>        public virtual DbSet&lt;StudentAddress&gt; StudentAddress &#123; get; set; &#125;<br>        public virtual DbSet&lt;StudentCourse&gt; StudentCourse &#123; get; set; &#125;<br>        public virtual DbSet&lt;Teacher&gt; Teacher &#123; get; set; &#125;<br><br>        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) &#123;<br>            if (!optionsBuilder.IsConfigured) &#123;<br>#warning To protect potentially sensitive information in your connection string, you should move it out of source code. See http:&#x2F;&#x2F;go.microsoft.com&#x2F;fwlink&#x2F;?LinkId&#x3D;723263 for guidance on storing connection strings.<br>                optionsBuilder.UseSqlServer(@&quot;Server&#x3D;.\SQLExpress;Database&#x3D;SchoolDB;Trusted_Connection&#x3D;True;&quot;);<br>            &#125;<br>        &#125;<br><br>        protected override void OnModelCreating(ModelBuilder modelBuilder) &#123;<br>            modelBuilder.Entity&lt;Course&gt;(entity &#x3D;&gt; &#123;<br>                entity.Property(e &#x3D;&gt; e.CourseName)<br>                    .HasMaxLength(50)<br>                    .IsUnicode(false);<br><br>                entity.HasOne(d &#x3D;&gt; d.Teacher)<br>                    .WithMany(p &#x3D;&gt; p.Course)<br>                    .HasForeignKey(d &#x3D;&gt; d.TeacherId)<br>                    .OnDelete(DeleteBehavior.Cascade)<br>                    .HasConstraintName(&quot;FK_Course_Teacher&quot;);<br>            &#125;);<br><br>            modelBuilder.Entity&lt;Standard&gt;(entity &#x3D;&gt; &#123;<br>                entity.Property(e &#x3D;&gt; e.Description)<br>                    .HasMaxLength(50)<br>                    .IsUnicode(false);<br><br>                entity.Property(e &#x3D;&gt; e.StandardName)<br>                    .HasMaxLength(50)<br>                    .IsUnicode(false);<br>            &#125;);<br><br>            modelBuilder.Entity&lt;Student&gt;(entity &#x3D;&gt; &#123;<br>                entity.Property(e &#x3D;&gt; e.StudentId).HasColumnName(&quot;StudentID&quot;);<br><br>                entity.Property(e &#x3D;&gt; e.FirstName)<br>                    .HasMaxLength(50)<br>                    .IsUnicode(false);<br><br>                entity.Property(e &#x3D;&gt; e.LastName)<br>                    .HasMaxLength(50)<br>                    .IsUnicode(false);<br><br>                entity.HasOne(d &#x3D;&gt; d.Standard)<br>                    .WithMany(p &#x3D;&gt; p.Student)<br>                    .HasForeignKey(d &#x3D;&gt; d.StandardId)<br>                    .OnDelete(DeleteBehavior.Cascade)<br>                    .HasConstraintName(&quot;FK_Student_Standard&quot;);<br>            &#125;);<br><br>            modelBuilder.Entity&lt;StudentAddress&gt;(entity &#x3D;&gt; &#123;<br>                entity.HasKey(e &#x3D;&gt; e.StudentId);<br><br>                entity.Property(e &#x3D;&gt; e.StudentId)<br>                    .HasColumnName(&quot;StudentID&quot;)<br>                    .ValueGeneratedNever();<br><br>                entity.Property(e &#x3D;&gt; e.Address1)<br>                    .IsRequired()<br>                    .HasMaxLength(50)<br>                    .IsUnicode(false);<br><br>                entity.Property(e &#x3D;&gt; e.Address2)<br>                    .HasMaxLength(50)<br>                    .IsUnicode(false);<br><br>                entity.Property(e &#x3D;&gt; e.City)<br>                    .IsRequired()<br>                    .HasMaxLength(50)<br>                    .IsUnicode(false);<br><br>                entity.Property(e &#x3D;&gt; e.State)<br>                    .IsRequired()<br>                    .HasMaxLength(50)<br>                    .IsUnicode(false);<br><br>                entity.HasOne(d &#x3D;&gt; d.Student)<br>                    .WithOne(p &#x3D;&gt; p.StudentAddress)<br>                    .HasForeignKey&lt;StudentAddress&gt;(d &#x3D;&gt; d.StudentId)<br>                    .HasConstraintName(&quot;FK_StudentAddress_Student&quot;);<br>            &#125;);<br><br>            modelBuilder.Entity&lt;StudentCourse&gt;(entity &#x3D;&gt; &#123;<br>                entity.HasKey(e &#x3D;&gt; new &#123; e.StudentId, e.CourseId &#125;);<br><br>                entity.HasOne(d &#x3D;&gt; d.Course)<br>                    .WithMany(p &#x3D;&gt; p.StudentCourse)<br>                    .HasForeignKey(d &#x3D;&gt; d.CourseId)<br>                    .OnDelete(DeleteBehavior.ClientSetNull)<br>                    .HasConstraintName(&quot;FK_StudentCourse_Course&quot;);<br><br>                entity.HasOne(d &#x3D;&gt; d.Student)<br>                    .WithMany(p &#x3D;&gt; p.StudentCourse)<br>                    .HasForeignKey(d &#x3D;&gt; d.StudentId)<br>                    .HasConstraintName(&quot;FK_StudentCourse_Student&quot;);<br>            &#125;);<br><br>            modelBuilder.Entity&lt;Teacher&gt;(entity &#x3D;&gt; &#123;<br>                entity.Property(e &#x3D;&gt; e.StandardId).HasDefaultValueSql(&quot;((0))&quot;);<br><br>                entity.Property(e &#x3D;&gt; e.TeacherName)<br>                    .HasMaxLength(50)<br>                    .IsUnicode(false);<br><br>                entity.HasOne(d &#x3D;&gt; d.Standard)<br>                    .WithMany(p &#x3D;&gt; p.Teacher)<br>                    .HasForeignKey(d &#x3D;&gt; d.StandardId)<br>                    .OnDelete(DeleteBehavior.Cascade)<br>                    .HasConstraintName(&quot;FK_Teacher_Standard&quot;);<br>            &#125;);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p><strong>创建模型后，无论何时更改模型，都必须使用“迁移”命令，以使数据库与模型保持最新。</strong></p>
</blockquote>
<h2 id="四、Entity-Framework-Core：DbContext"><a class="header-anchor" href="#四、Entity-Framework-Core：DbContext">¶</a>四、Entity Framework Core：<code>DbContext</code></h2>
<p><code>DbContext</code> 类是 Entity Framework Core 的组成部分。<code>DbContext</code> 实例代表与数据库的会话，可用于查询实体实例并将其保存到数据库。<strong><code>DbContext</code> 是工作单元和存储库模式的组合。</strong></p>
<p>EF Core 中的 <code>DbContext</code> 允许我们执行以下任务：</p>
<ul>
<li>管理数据库连接</li>
<li>配置模型和关系</li>
<li>查询数据库</li>
<li>将数据保存到数据库</li>
<li>配置变更跟踪</li>
<li>缓存</li>
<li>事务管理</li>
</ul>
<p>要在我们的应用程序中使用 <code>DbContext</code>，我们需要创建从 <code>DbContext</code> 派生的类，也称为上下文类。**该上下文类通常包括模型中每个实体的 <code>DbSet&lt;TEntity&gt;</code> 属性。**以下为 EF Core 中 <code>DbContext</code> 类的示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class SchoolContext : DbContext &#123;<br>    public SchoolContext() &#123;<br>    &#125;<br><br>    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) &#123;<br>    &#125;<br><br>    protected override void OnModelCreating(ModelBuilder modelBuilder) &#123;<br>    &#125;<br>    &#x2F;&#x2F;实体<br>    public DbSet&lt;Student&gt; Students &#123; get; set; &#125;<br>    public DbSet&lt;Course&gt; Courses &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>SchoolContext</code> 类派生自 <code>DbContext</code> 类。</p>
<ul>
<li><code>OnConfiguring()</code> 方法允许我们使用 <code>DbContextOptionsBuilder</code> 选择和配置要与上下文一起使用的 <strong>数据源</strong>。在此处了解如何配置 <code>DbContext</code> 类。</li>
<li><code>OnModelCreating()</code> 方法允许我们使用 ModelBuilder Fluent API 配置 <strong>模型</strong>。</li>
</ul>
<h3 id="DbContext-的方法"><a class="header-anchor" href="#DbContext-的方法">¶</a><code>DbContext</code> 的方法</h3>
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:center">用法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>Add</code></td>
<td style="text-align:center">将一个新实体添加到具有添加状态的 <code>DbContext</code> 中，并开始对其进行跟踪。调用 <code>SaveChanges()</code> 时，会将新的实体数据插入数据库。</td>
</tr>
<tr>
<td style="text-align:center"><code>AddAsync</code></td>
<td style="text-align:center">用于向状态为“已添加”的 <code>DbContext</code> 添加新实体并开始对其进行跟踪的异步方法。调用 <code>SaveChangesAsync()</code> 时，会将新的实体数据插入数据库。</td>
</tr>
<tr>
<td style="text-align:center"><code>AddRange</code></td>
<td style="text-align:center">将具有添加状态的新实体集合添加到 <code>DbContext</code> 并开始对其进行跟踪。调用 <code>SaveChanges()</code> 时，会将新的实体数据插入数据库。</td>
</tr>
<tr>
<td style="text-align:center"><code>AddRangeAsync</code></td>
<td style="text-align:center">用于添加将保存在 <code>SaveChangesAsync()</code> 上的新实体集合的异步方法。</td>
</tr>
<tr>
<td style="text-align:center"><code>Attach</code></td>
<td style="text-align:center">将新的或现有的实体附加到状态不变的 <code>DbContext</code> 并开始跟踪它。</td>
</tr>
<tr>
<td style="text-align:center"><code>AttachRange</code></td>
<td style="text-align:center">将新实体或现有实体的集合以未更改的状态附加到 <code>DbContext</code> 并开始对其进行跟踪。</td>
</tr>
<tr>
<td style="text-align:center"><code>Entry</code></td>
<td style="text-align:center">获取给定实体的 <code>EntityEntry</code>。该条目提供对实体的更改跟踪信息和操作的访问。</td>
</tr>
<tr>
<td style="text-align:center"><code>Find</code></td>
<td style="text-align:center">查找具有给定主键值的实体。</td>
</tr>
<tr>
<td style="text-align:center"><code>FindAsync</code></td>
<td style="text-align:center">用于查找具有给定主键值的实体的异步方法。</td>
</tr>
<tr>
<td style="text-align:center"><code>Remove</code></td>
<td style="text-align:center">移除将删除状态设置为指定的实体，当调用 <code>SaveChanges()</code> 时，该实体将删除数据。</td>
</tr>
<tr>
<td style="text-align:center"><code>RemoveRange</code></td>
<td style="text-align:center">将 <code>Deleted</code> 状态设置为一组实体，这些实体将在调用 <code>SaveChanges()</code> 时在一次数据库往返中删除数据。</td>
</tr>
<tr>
<td style="text-align:center"><code>SaveChanges</code></td>
<td style="text-align:center">对状态为 <code>Added</code>，<code>Modified</code> 或 <code>Removed</code> 的实体执行 <code>INSERT</code>，<code>UPDATE</code> 或 <code>DELETE</code> 命令到数据库。</td>
</tr>
<tr>
<td style="text-align:center"><code>SaveChangesAsync</code></td>
<td style="text-align:center"><code>SaveChanges()</code> 的异步方法</td>
</tr>
<tr>
<td style="text-align:center"><code>Set</code></td>
<td style="text-align:center">创建一个 <code>DbSet&lt;TEntity&gt;</code>，可用于查询和保存 <code>TEntity</code> 的实例。</td>
</tr>
<tr>
<td style="text-align:center"><code>Update</code></td>
<td style="text-align:center">附加状态为 <code>Modified</code> 的断开连接的实体，并开始对其进行跟踪。调用 <code>SaveChagnes()</code> 时将保存数据。</td>
</tr>
<tr>
<td style="text-align:center"><code>UpdateRange</code></td>
<td style="text-align:center">附加状态为 <code>Modified</code> 的断开连接的实体的集合，并开始对其进行跟踪。调用 <code>SaveChagnes()</code> 时将保存数据。</td>
</tr>
<tr>
<td style="text-align:center"><code>OnConfiguring</code></td>
<td style="text-align:center">重写此方法，以配置要用于此上下文的数据库 (和其他选项)。创建的上下文的每个实例都会调用此方法。</td>
</tr>
<tr>
<td style="text-align:center"><code>OnModelCreating</code></td>
<td style="text-align:center">重写此方法，以进一步配置根据约定从派生上下文的 <code>DbSet&lt;TEntity&gt;</code> 属性中公开的实体类型发现的模型。</td>
</tr>
</tbody>
</table>
<h3 id="DbContext-属性"><a class="header-anchor" href="#DbContext-属性">¶</a><code>DbContext</code> 属性</h3>
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:center">用法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>ChangeTracker</code></td>
<td style="text-align:center">提供对该上下文正在跟踪的实体实例的信息和操作的访问。</td>
</tr>
<tr>
<td style="text-align:center"><code>Database</code></td>
<td style="text-align:center">提供对此上下文的数据库相关信息和操作的访问。</td>
</tr>
<tr>
<td style="text-align:center"><code>Model</code></td>
<td style="text-align:center">返回有关实体的形状，它们之间的关系以及它们如何映射到数据库的元数据。</td>
</tr>
</tbody>
</table>
<h2 id="五、第一个-EF-Core-控制台应用程序"><a class="header-anchor" href="#五、第一个-EF-Core-控制台应用程序">¶</a>五、第一个 EF Core 控制台应用程序</h2>
<h3 id="创建模型"><a class="header-anchor" href="#创建模型">¶</a>创建模型</h3>
<p>EF 模型包括三个部分：</p>
<ul>
<li>概念模型</li>
<li>存储模型</li>
<li>概念模型和存储模型之间的映射。</li>
</ul>
<p>Code-First 方法中，EF 根据您的领域类 (实体类)，上下文类和配置来构建概念模型。 EF Core <strong>根据您使用的提供程序</strong> 构建存储模型和映射。例如，与 DB2 相比，SQL Server 的存储模型将有所不同。</p>
<p>我们需要首先创建实体类和上下文类。以下是学生和课程的简单实体类：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class Student &#123;<br>    public int StudentId &#123; get; set; &#125;<br>    public string Name &#123; get; set; &#125;<br>&#125;<br><br>public class Course &#123;<br>    public int CourseId &#123; get; set; &#125;<br>    public string CourseName &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>现在，我们需要通过派生 <code>DbContext</code> 来创建上下文类，如上一章所示。以下 <code>SchoolContext</code> 类也称为上下文类。</p>
<h4 id="在上下文类内配置数据库连接"><a class="header-anchor" href="#在上下文类内配置数据库连接">¶</a>在上下文类内配置数据库连接</h4>
<p><code>SchoolContext</code> 类：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">namespace EFCoreTutorials &#123;<br>    public class SchoolContext : DbContext &#123;<br>        &#x2F;&#x2F; 映射到 Student 表<br>        public DbSet&lt;Student&gt; Students &#123; get; set; &#125;<br>        <br>        &#x2F;&#x2F; 映射到 Course 表<br>        public DbSet&lt;Course&gt; Courses &#123; get; set; &#125;<br><br>        &#x2F;&#x2F; DbContextOptionsBuilder 的实例用于指定要使用的数据库<br>        protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) &#123;<br>            optionsBuilder.UseSqlServer(@&quot;Server&#x3D;.\SQLEXPRESS;Database&#x3D;SchoolDB;Trusted_Connection&#x3D;True;&quot;);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h4 id="用依赖注入的方式配置数据库连接"><a class="header-anchor" href="#用依赖注入的方式配置数据库连接">¶</a>用依赖注入的方式配置数据库连接</h4>
<p><code>SchoolContext</code> 类：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">namespace EFCoreTutorials &#123;<br>    public class SchoolContext : DbContext &#123;<br>        &#x2F;&#x2F; 映射到 Student 表<br>        public DbSet&lt;Student&gt; Students &#123; get; set; &#125;<br>        <br>        &#x2F;&#x2F; 映射到 Course 表<br>        public DbSet&lt;Course&gt; Courses &#123; get; set; &#125;<br>        <br>        public readonly DbContextOptions _dbContextOptions;<br>        <br>        public SchoolContext(DbContextOptions&lt;SchoolContext&gt; options): base(options) &#123;<br>            _dbContextOptions &#x3D; options;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><code>Startup</code> 类中：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">namespace EFCoreTutorials &#123;<br>    public class Startup &#123;<br>        private readonly IConfiguration _configuration;<br><br>        public Startup(IConfiguration configuration) &#123;<br>            _configuration &#x3D; configuration;<br>        &#125;<br>        <br>        public void ConfigureServices(IServiceCollection services) &#123;<br>            ...<br>            services.AddDbContextPool&lt;SchoolContext&gt;(options &#x3D;&gt; options.UseSqlServer(_configuration.GetConnectionString(&quot;SchoolDBConnection&quot;)));<br>            ...<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在 <em>appsettings.json</em> 中：</p>
<figure class="highlight"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">&#123;<br>    ...<br>    "ConnectionStrings": &#123;<br>        <span class="hljs-comment">// Trusted_Connection=True、Integrated Security=SSPI、Integrated Security=True 都代表使用 Windows 身份认证</span><br>        "SchoolDBConnection": "Server=.\SQLEXPRESS;Database=SchoolDB;Trusted_Connection=True;"<br>    &#125;<br>    ...<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>本项目为 Console 项目，无法使用依赖注入。</p>
<h3 id="添加迁移"><a class="header-anchor" href="#添加迁移">¶</a>添加迁移</h3>
<p>此时，尚无 SchoolDB 数据库。因此，我们需要通过添加迁移从模型 (实体和上下文) 创建数据库。</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">dotnet ef migrations add CreateSchoolDB<br></code></pre></div></td></tr></table></figure>
<p>这将在项目中创建一个名为 <em>Migrations</em> 的新文件夹，并创建 ModelSnapshot_ (<strong>迁移脚本文件</strong>，此时并未写入数据库) 文件。</p>
<p>创建迁移脚本后，我们需要将更改更新至数据库：</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">dotnet ef database update<br></code></pre></div></td></tr></table></figure>
<p>这将使用 <code>UseSqlServer()</code> 方法中的连接字符串中指定的名称和位置创建数据库。它将为每个 <code>DbSet</code> 属性 (学生和课程) 创建一个表。</p>
<p>现在，<strong>无论何时添加或更新域类或配置，我们都需要使用 <code>dotnet ef migrations add</code> 和 <code>dotnet ef database update</code> 命令将数据库与模型同步。</strong></p>
<h3 id="读取或写入数据"><a class="header-anchor" href="#读取或写入数据">¶</a>读取或写入数据</h3>
<p>现在，我们可以使用上下文类来保存和检索数据，如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">namespace EFCoreTutorials &#123;<br>    class Program &#123;<br>        static void Main(string[] args) &#123;<br>            using (var context &#x3D; new SchoolContext()) &#123;<br><br>                var std &#x3D; new Student() &#123;<br>                     Name &#x3D; &quot;Bill&quot;<br>                &#125;;<br><br>                context.Students.Add(std);<br>                context.SaveChanges();<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h2 id="六、Entity-Framework-Core-中的查询"><a class="header-anchor" href="#六、Entity-Framework-Core-中的查询">¶</a>六、Entity Framework Core 中的查询</h2>
<p>Entity Framework Core 允许你在模型中使用导航属性来加载相关实体。有三种常见的 ORM 模式可用于加载关联数据:</p>
<ul>
<li>Eager loading (预先加载)：表示从数据库中加载关联数据，作为初始查询的一部分。</li>
<li>Explicit loading (显式加载)：表示稍后从数据库中显式加载关联数据。</li>
<li>Lazy loading (延迟加载)：表示在访问导航属性时，从数据库中以透明方式加载关联数据。</li>
</ul>
<p>访问 <a href="https://www.entityframeworktutorial.net/querying-entity-graph-in-entity-framework.aspx" target="_blank" rel="noopener">LINQ-to-Entities</a> 一章，以了解有关 Entity Framework 中查询基础的更多信息。</p>
<h3 id="查询中的-C-VB-NET-函数"><a class="header-anchor" href="#查询中的-C-VB-NET-函数">¶</a>查询中的 C# / <a href="http://VB.NET" target="_blank" rel="noopener">VB.NET</a> 函数</h3>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">private static void Main(string[] args) &#123;<br>    var context &#x3D; new SchoolContext();<br>    var studentsWithSameName &#x3D; context.Students<br>                                      .Where(s &#x3D;&gt; s.FirstName &#x3D;&#x3D; GetName())<br>                                      .ToList();<br>&#125;<br><br>public static string GetName() &#123;<br>    return &quot;Bill&quot;;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>这将在数据库中执行以下查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec sp_executesql N&#39;SELECT [s].[StudentId], [s].[DoB], [s].[FirstName], <br>    [s].[GradeId], [s].[LastName], [s].[MiddleName]<br>FROM [Students] AS [s]<br>WHERE [s].[FirstName] &#x3D; @__GetName_0&#39;,N&#39;@__GetName_0 nvarchar(4000)&#39;,<br>    @__GetName_0&#x3D;N&#39;Bill&#39;<br>Go<br></code></pre></div></td></tr></table></figure>
<h3 id="Eager-Loading-预先加载"><a class="header-anchor" href="#Eager-Loading-预先加载">¶</a>Eager Loading 预先加载</h3>
<p>Entity Framework Core 支持使用 <code>Include()</code> 扩展方法和投影查询来快速加载相关实体。除此之外，它还提供了 <code>ThenInclude()</code> 扩展方法来加载多个级别的相关实体。</p>
<h4 id="Include"><a class="header-anchor" href="#Include">¶</a><code>Include</code></h4>
<p>我们可以在 <code>Include()</code> 方法中将 lambda 表达式指定为参数，以指定导航属性，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext();<br>var studentWithGrade &#x3D; context.Students<br>                           .Where(s &#x3D;&gt; s.FirstName &#x3D;&#x3D; &quot;Bill&quot;)<br>                           .Include(s &#x3D;&gt; s.Grade)<br>                           .FirstOrDefault();<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>.Include(s =&gt; s.Grade)</code> 传递 lambda 表达式 <code>s =&gt; s.Grade</code>，以指定引用属性，该属性将在单个 SQL 查询中与来自数据库的 <code>Student</code> 实体数据一起加载。上面的查询在数据库中执行以下 SQL 查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">SELECT TOP(1) [s].[StudentId], [s].[DoB], [s].[FirstName], [s].[GradeId],[s].[LastName], <br>        [s].[MiddleName], [s.Grade].[GradeId], [s.Grade].[GradeName], [s.Grade].[Section]<br>FROM [Students] AS [s]<br>LEFT JOIN [Grades] AS [s.Grade] ON [s].[GradeId] &#x3D; [s.Grade].[GradeId]<br>WHERE [s].[FirstName] &#x3D; N&#39;Bill&#39;<br></code></pre></div></td></tr></table></figure>
<p>我们还可以在 <code>Include()</code> 方法中将属性名称指定为字符串。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext();<br>var studentWithGrade &#x3D; context.Students<br>                        .Where(s &#x3D;&gt; s.FirstName &#x3D;&#x3D; &quot;Bill&quot;)<br>                        .Include(&quot;Grade&quot;)<br>                        .FirstOrDefault();<br></code></pre></div></td></tr></table></figure>
<p><strong>不建议使用上面的示例，因为如果属性名称拼写错误或不存在，则会抛出运行时异常。</strong> 始终对 lambda 表达式使用 <code>Include()</code> 方法，以便可以在编译时检测到错误。</p>
<p><code>Include()</code> 扩展方法也可以在 <code>FromSql()</code> 方法之后使用，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext();<br>var studentWithGrade &#x3D; context.Students<br>                        .FromSql(&quot;Select * from Students where FirstName &#x3D;&#39;Bill&#39;&quot;)<br>                        .Include(s &#x3D;&gt; s.Grade)<br>                        .FirstOrDefault();<br></code></pre></div></td></tr></table></figure>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p><code>DbSet.Find()</code>方法之后不能使用 <code>Include()</code> 扩展方法。例如。在 EF Core 2.0 中无法使用 <code>context.Students.Find(1).Include()</code>。在将来的版本中这可能是可能的。</p>
</blockquote>
<p>多次使用 <code>Include()</code> 方法来加载同一实体的多个导航属性。例如，以下代码加载与 <code>Student</code> 的 <code>Grade</code> 和 <code>StudentCourses</code> 相关的实体。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext();<br>var studentWithGrade &#x3D; context.Students.Where(s &#x3D;&gt; s.FirstName &#x3D;&#x3D; &quot;Bill&quot;)<br>                        .Include(s &#x3D;&gt; s.Grade)<br>                        .Include(s &#x3D;&gt; s.StudentCourses)<br>                        .FirstOrDefault();<br></code></pre></div></td></tr></table></figure>
<p>上面的查询将在单个数据库往返中执行两个 SQL 查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">SELECT TOP(1) [s].[StudentId], [s].[DoB], [s].[FirstName], [s].[GradeId], [s].[LastName], <br>        [s].[MiddleName], [s.Grade].[GradeId], [s.Grade].[GradeName], [s.Grade].[Section]<br>FROM [Students] AS [s]<br>LEFT JOIN [Grades] AS [s.Grade] ON [s].[GradeId] &#x3D; [s.Grade].[GradeId]<br>WHERE [s].[FirstName] &#x3D; N&#39;Bill&#39;<br>ORDER BY [s].[StudentId]<br>Go<br><br>SELECT [s.StudentCourses].[StudentId], [s.StudentCourses].[CourseId]<br>FROM [StudentCourses] AS [s.StudentCourses]<br>INNER JOIN (<br>    SELECT DISTINCT [t].*<br>    FROM (<br>        SELECT TOP(1) [s0].[StudentId]<br>        FROM [Students] AS [s0]<br>        LEFT JOIN [Grades] AS [s.Grade0] ON [s0].[GradeId] &#x3D; [s.Grade0].[GradeId]<br>        WHERE [s0].[FirstName] &#x3D; N&#39;Bill&#39;<br>        ORDER BY [s0].[StudentId]<br>    ) AS [t]<br>) AS [t0] ON [s.StudentCourses].[StudentId] &#x3D; [t0].[StudentId]<br>ORDER BY [t0].[StudentId]<br>Go<br></code></pre></div></td></tr></table></figure>
<h4 id="ThenInclude"><a class="header-anchor" href="#ThenInclude">¶</a><code>ThenInclude</code></h4>
<p>EF Core 引入了新的 <code>ThenInclude()</code> 扩展方法，以加载多个级别的相关实体。考虑以下示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext();<br>var student &#x3D; context.Students.Where(s &#x3D;&gt; s.FirstName &#x3D;&#x3D; &quot;Bill&quot;)<br>                        .Include(s &#x3D;&gt; s.Grade)<br>                        .ThenInclude(g &#x3D;&gt; g.Teachers)<br>                        .FirstOrDefault();<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>.Include(s =&gt; s.Grade)</code> 将加载 <code>Student</code> 实体的 <code>Grade</code> 导航属性。 <code>.ThenInclude(g =&gt; g.Teachers)</code> 将加载 <code>Grade</code> 实体的<code> Teacher</code> 集合属性。必须在 <code>Include</code> 方法之后调用<code> ThenInclude</code> 方法。上面的代码将在数据库中执行以下 SQL 查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">SELECT TOP(1) [s].[StudentId], [s].[DoB], [s].[FirstName], [s].[GradeId], [s].[LastName],<br>         [s].[MiddleName], [s.Grade].[GradeId], [s.Grade].[GradeName], [s.Grade].[Section]<br>FROM [Students] AS [s]<br>LEFT JOIN [Grades] AS [s.Grade] ON [s].[GradeId] &#x3D; [s.Grade].[GradeId]<br>WHERE [s].[FirstName] &#x3D; N&#39;Bill&#39;<br>ORDER BY [s.Grade].[GradeId]<br>Go<br><br>SELECT [s.Grade.Teachers].[TeacherId], [s.Grade.Teachers].[GradeId], [s.Grade.Teachers].[Name]<br>FROM [Teachers] AS [s.Grade.Teachers]<br>INNER JOIN (<br>    SELECT DISTINCT [t].*<br>    FROM (<br>        SELECT TOP(1) [s.Grade0].[GradeId]<br>        FROM [Students] AS [s0]<br>        LEFT JOIN [Grades] AS [s.Grade0] ON [s0].[GradeId] &#x3D; [s.Grade0].[GradeId]<br>        WHERE [s0].[FirstName] &#x3D; N&#39;Bill&#39;<br>        ORDER BY [s.Grade0].[GradeId]<br>    ) AS [t]<br>) AS [t0] ON [s.Grade.Teachers].[GradeId] &#x3D; [t0].[GradeId]<br>ORDER BY [t0].[GradeId]<br>Go<br></code></pre></div></td></tr></table></figure>
<h4 id="Projection-Query-投影查询"><a class="header-anchor" href="#Projection-Query-投影查询">¶</a>Projection Query (投影查询)</h4>
<p>我们还可以通过使用投影查询而不是 <code>Include()</code> 或 <code>ThenInclude()</code> 方法来加载多个相关实体。以下示例演示了用于加载 <code>Student</code>，<code>Grade</code> 和 <code>Teacher</code> 实体的投影查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext();<br>var stud &#x3D; context.Students.Where(s &#x3D;&gt; s.FirstName &#x3D;&#x3D; &quot;Bill&quot;)<br>                        .Select(s &#x3D;&gt; new<br>                        &#123;<br>                            Student &#x3D; s,<br>                            Grade &#x3D; s.Grade,<br>                            GradeTeachers &#x3D; s.Grade.Teachers<br>                        &#125;)<br>                        .FirstOrDefault();<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>.Select</code> 扩展方法用于在结果中包括 <code>Student</code>、 <code>Grade</code> 和 <code>Teacher</code> 实体。这将执行与上述 <code>ThenInclude()</code>  方法相同的 SQL 查询。</p>
<h2 id="七、Entity-Framework-Core-在连接模式下保存数据"><a class="header-anchor" href="#七、Entity-Framework-Core-在连接模式下保存数据">¶</a>七、Entity Framework Core 在连接模式下保存数据</h2>
<p>Entity Framework Core 提供了不同的方法来添加，更新或删除基础数据库中的数据。一个实体的标量属性中包含的数据将根据其 <code>EntityState</code> 插入，更新或删除。<br>
保存实体数据有两种方案：</p>
<ul>
<li>连接模式</li>
<li>断开模式</li>
</ul>
<p>在本章中仅学习有关在连接的场景中保存数据的知识。下图说明了所连接场景中的CUD (创建，更新，删除) 操作。<br>
<img src="/images/efcore/save-data-in-connected-scenario.png" alt="图7-1"><br>
如上图所示，当调用 <code>DbContext.SaveChanges()</code> 方法时，Entity Framework 为其 <code>EntityState</code> 被添加，修改或删除的实体生成并执行 <code>INSERT</code>，<code>UPDATE</code> 或 <code>DELETE</code> 语句。在连接的场景中，<strong><code>DbContext</code> 实例跟踪所有实体，因此每当创建，修改或删除实体时，它都会自动为每个实体设置适当的 <code>EntityState</code>。</strong></p>
<h3 id="插入数据"><a class="header-anchor" href="#插入数据">¶</a>插入数据</h3>
<p><code>DbSet.Add</code> 和 <code>DbContext.Add</code> 方法将新实体添加到上下文 (<code>DbContext</code> 的实例)，当您调用 <code>SaveChanges()</code> 方法时，该实体将在数据库中插入新记录。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">using (var context &#x3D; new SchoolContext()) &#123;<br>    var std &#x3D; new Student() &#123;<br>        FirstName &#x3D; &quot;Bill&quot;,<br>        LastName &#x3D; &quot;Gates&quot;<br>    &#125;;<br>    context.Students.Add(std);<br>    &#x2F;&#x2F; or<br>    &#x2F;&#x2F; context.Add&lt;Student&gt;(std);<br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>context.Students.Add(std)</code> 将一个新创建的 <code>Student</code> 实体实例添加到具有 <code>EntityState.Added</code> 的上下文中。 EF Core 引入了新的<code>DbContext.Add</code> 方法，该方法与 <code>DbSet.Add</code> 方法具有相同的作用。此后，<code>SaveChanges()</code> 方法将生成并执行以下对数据库的 <code>INSERT</code> 语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec sp_executesql N&#39;SET NOCOUNT ON;<br>INSERT INTO [Students] ( [FirstName], [LastName])<br>VALUES (@p0, @p1);<br>SELECT [StudentId]<br>FROM [Students]<br>WHERE @@ROWCOUNT &#x3D; 1 AND [StudentId] &#x3D; scope_identity();&#39;,N<br>&#39;@p0 nvarchar(4000), @p1 nvarchar(4000) &#39;,@p0&#x3D;N&#39;Bill&#39;,@p1&#x3D;N&#39;Gates&#39;<br>Go<br></code></pre></div></td></tr></table></figure>
<h3 id="更新数据"><a class="header-anchor" href="#更新数据">¶</a>更新数据</h3>
<p>在连接的场景中，EF Core API 跟踪使用上下文检索的所有实体。因此，当您编辑实体数据时，EF 会自动将 <code>EntityState</code> 标记为 <code>Modified</code>，这将在您调用 <code>SaveChanges()</code> 方法时在数据库中产生更新的语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">using (var context &#x3D; new SchoolContext()) &#123;<br>    var std &#x3D; context.Students.First&lt;Student&gt;(); <br>    std.FirstName &#x3D; &quot;Steve&quot;;<br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，我们使用 <code>context.Students.First&lt;Student&gt;()</code> 从数据库中检索第一个学生。一旦修改了 <code>FirstName</code>，由于在 <code>DbContext</code> 实例 (上下文) 的范围内执行了修改，因此上下文将其 <code>EntityState</code> 设置为 <code>Modified</code>。因此，当我们调用 <code>SaveChanges()</code> 方法时，它将在数据库中生成并执行以下 <code>Update</code> 语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec sp_executesql N&#39;SET NOCOUNT ON;<br>UPDATE [Students] SET [FirstName] &#x3D; @p0<br>WHERE [StudentId] &#x3D; @p1;<br>SELECT @@ROWCOUNT;<br>&#39;,N&#39;@p1 int,@p0 nvarchar(4000)&#39;,@p1&#x3D;1,@p0&#x3D;N&#39;Steve&#39;<br>Go<br></code></pre></div></td></tr></table></figure>
<p>在更新语句中，EF Core API 包括具有修改后值的属性，其余部分将被忽略。在上面的示例中，仅 <code>FirstName</code> 属性被编辑，因此 <code>update</code> 语句仅包含 <code>FirstName</code> 列。</p>
<h3 id="删除数据"><a class="header-anchor" href="#删除数据">¶</a>删除数据</h3>
<p>使用 <code>DbSet.Remove()</code> 或 <code>DbContext.Remove</code> 方法删除数据库表中的记录。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">using (var context &#x3D; new SchoolContext()) &#123;<br>    var std &#x3D; context.Students.First&lt;Student&gt;();<br>    context.Students.Remove(std);<br>    &#x2F;&#x2F; or<br>    &#x2F;&#x2F; context.Remove&lt;Student&gt;(std);<br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>context.Students.Remove(std)</code>  或者 <code>context.Remove&lt;Students&gt;(std)</code> 将 <code>std</code> 实体对象标记为 <code>Deleted</code>。因此，EF Core 将在数据库中生成并执行以下 <code>DELETE</code> 语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec sp_executesql N&#39;SET NOCOUNT ON;<br>DELETE FROM [Students]<br>WHERE [StudentId] &#x3D; @p0;<br>SELECT @@ROWCOUNT;<br>&#39;,N&#39;@p0 int&#39;,@p0&#x3D;1<br>Go<br></code></pre></div></td></tr></table></figure>
<h2 id="八、Entity-Framework-Core-中的约定"><a class="header-anchor" href="#八、Entity-Framework-Core-中的约定">¶</a>八、Entity Framework Core 中的约定</h2>
<p>约定是，使用 Entity Framework 根据您的领域模型 (实体) 类构建模型时的默认规则。</p>
<p>以下示例为应用程序的领域模型 (实体) 和数据库上下文类，它遵循默认约定，无需配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Student &#123;<br>    public int StudentId &#123; get; set; &#125;<br>    public string FirstName &#123; get; set; &#125;<br>    public string LastName &#123; get; set; &#125;<br>    public DateTime DateOfBirth &#123; get; set; &#125;<br>    public byte[] Photo &#123; get; set; &#125;<br>    public decimal Height &#123; get; set; &#125;<br>    public float Weight &#123; get; set; &#125;<br>    public int GradeId &#123; get; set; &#125;<br>    public Grade Grade &#123; get; set; &#125;<br>&#125;<br><br>public class Grade &#123;<br>    public int Id &#123; get; set; &#125;<br>    public string GradeName &#123; get; set; &#125;<br>    public string Section &#123; get; set; &#125;<br>    public IList&lt;Student&gt; Students &#123; get; set; &#125;<br>&#125;<br><br>public class SchoolContext : DbContext &#123;<br>    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)<br>    &#123; <br>        optionsBuilder.UseSqlServer(@&quot;Server&#x3D;.\SQLEXPRESS;Database&#x3D;SchoolDB;Trusted_Connection&#x3D;True;&quot;);<br>    &#125;<br><br>    public DbSet&lt;Student&gt; Students &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h3 id="Table-表"><a class="header-anchor" href="#Table-表">¶</a>Table (表)</h3>
<p>EF Core 将为上下文类中与属性名称相同的所有 <code>DbSet&lt;TEntity&gt;</code> 属性创建数据库表。<strong>它还将为实体创建表，这些表不包含在 <code>DbSet</code> 属性中，但可以通过其他 <code>DbSet</code> 实体中的引用属性访问。</strong> 对于上面的示例，即使 <code>SchoolContext</code> 类不包含<code>DbSet&lt;Grade&gt;</code> 属性，EF Core 也会在 <code>SchoolContext</code> 类中为 <code>DbSet&lt;Student&gt;</code> 属性创建 <code>Students</code> 表，在 <code>Student</code> 实体类中为 <code>Grade</code> 属性创建 <code>Grade</code> 表。</p>
<p><img src="/images/efcore/20200207213507370.png" alt="图8-1"></p>
<h3 id="Column-列"><a class="header-anchor" href="#Column-列">¶</a>Column (列)</h3>
<p>默认情况下，EF Core 将为实体类的所有基本类型的属性创建与该属性同名的列。它使用引用类属性和集合属性在数据库中相应表之间建立关系。</p>
<p><img src="/images/efcore/20200207213522900.png" alt="图8-2"></p>
<h3 id="列数据类型-Column-Data-Type"><a class="header-anchor" href="#列数据类型-Column-Data-Type">¶</a>列数据类型 (Column Data Type)</h3>
<p>数据库表中列的数据类型取决于数据库提供程序如何将 C# 数据类型映射到所选数据库的数据类型。下表列出了 C# 数据类型到 SQL Server 列数据类型之间的映射。</p>
<table>
<thead>
<tr>
<th style="text-align:center"><strong>C# 数据类型</strong></th>
<th style="text-align:center"><strong>SQL Server数据类型</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>int</code></td>
<td style="text-align:center"><code>int</code></td>
</tr>
<tr>
<td style="text-align:center"><code>string</code></td>
<td style="text-align:center"><code>nvarchar(Max)</code></td>
</tr>
<tr>
<td style="text-align:center"><code>decimal</code></td>
<td style="text-align:center"><code>decimal(18,2)</code></td>
</tr>
<tr>
<td style="text-align:center"><code>float</code></td>
<td style="text-align:center"><code>real</code></td>
</tr>
<tr>
<td style="text-align:center"><code>byte[]</code></td>
<td style="text-align:center"><code>varbinary(Max)</code></td>
</tr>
<tr>
<td style="text-align:center"><code>datetime</code></td>
<td style="text-align:center"><code>datetime</code></td>
</tr>
<tr>
<td style="text-align:center"><code>bool</code></td>
<td style="text-align:center"><code>bit</code></td>
</tr>
<tr>
<td style="text-align:center"><code>byte</code></td>
<td style="text-align:center"><code>tinyint</code></td>
</tr>
<tr>
<td style="text-align:center"><code>short</code></td>
<td style="text-align:center"><code>smallint</code></td>
</tr>
<tr>
<td style="text-align:center"><code>long</code></td>
<td style="text-align:center"><code>bigint</code></td>
</tr>
<tr>
<td style="text-align:center"><code>double</code></td>
<td style="text-align:center"><code>float</code></td>
</tr>
<tr>
<td style="text-align:center"><code>char</code></td>
<td style="text-align:center">无</td>
</tr>
<tr>
<td style="text-align:center"><code>sbyte</code></td>
<td style="text-align:center">无 (会抛异常)</td>
</tr>
<tr>
<td style="text-align:center"><code>object</code></td>
<td style="text-align:center">无</td>
</tr>
</tbody>
</table>
<h3 id="Nullable-Column-可空列"><a class="header-anchor" href="#Nullable-Column-可空列">¶</a>Nullable Column (可空列)</h3>
<p>EF Core 为所有引用数据类型和可为空的原始类型属性创建可空列，例如 <code>string</code>、<code>Nullable&lt;int&gt;</code>、<code>decimal?</code> 等</p>
<h3 id="NotNull-Column-非空列"><a class="header-anchor" href="#NotNull-Column-非空列">¶</a>NotNull Column (非空列)</h3>
<p>EF Core 在数据库中为所有主键属性和原始类型属性创建 NotNull 列，例如 <code>int</code>、<code>float</code>、<code>decimal</code>、<code>DateTime</code> 等。</p>
<h3 id="Primary-Key-主键"><a class="header-anchor" href="#Primary-Key-主键">¶</a>Primary Key (主键)</h3>
<p>EF Core 将为名为 <code>Id</code> 或 <code>&lt;实体类名称&gt;Id</code> (不区分大小写) 的属性创建主键列。例如，如果 <code>Student</code> 类包含名为 <code>id</code>、<code>ID</code>、<code>iD</code>、<code>Id</code>、<code>studentid</code>、<code>StudentId</code>、<code>STUDENTID</code> 或 <code>sTUdentID</code> 的属性，则 EF Core 将在 <code>Student</code> 表中创建一列作为 PrimaryKey (主键)。</p>
<p><img src="/images/efcore/20200207213539655.png" alt="图8-3"></p>
<h3 id="Foreign-Key-外键"><a class="header-anchor" href="#Foreign-Key-外键">¶</a>Foreign Key (外键)</h3>
<p>根据外键约定，EF Core API 将使用以下命名模式之一为实体中的每个引用导航属性创建一个外键列：</p>
<ul>
<li>
<p><code>&lt;Reference Navigation Property Name&gt;Id</code></p>
</li>
<li>
<p><code>&lt;Reference Navigation Property Name&gt;</code></p>
</li>
<li>
<p><code>&lt;Principal Primary Key Property Name&gt;</code></p>
</li>
</ul>
<p>在我们的示例 (学生和成绩实体) 中，EF Core 将在 <code>Student</code> 表中创建一个外键列 <code>GradeId</code>，如下图所示。</p>
<p><img src="/images/efcore/20200207213556349.png" alt="图8-4"></p>
<p>下表列出了不同引用属性名称和主键属性名称的外键列名称:</p>
<table>
<thead>
<tr>
<th style="text-align:center">从属实体中的引用属性名称</th>
<th style="text-align:center">从属实体中的外键属性名称</th>
<th style="text-align:center">主体主键属性名称</th>
<th style="text-align:center">数据库中的外键列名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Grade</td>
<td style="text-align:center">GradeId</td>
<td style="text-align:center">GradeId</td>
<td style="text-align:center">GradeId</td>
</tr>
<tr>
<td style="text-align:center">Grade</td>
<td style="text-align:center">-</td>
<td style="text-align:center">GradeId</td>
<td style="text-align:center">GradeId</td>
</tr>
<tr>
<td style="text-align:center">Grade</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Id</td>
<td style="text-align:center">GradeId</td>
</tr>
<tr>
<td style="text-align:center">CurrentGrade</td>
<td style="text-align:center">CurrentGradeId</td>
<td style="text-align:center">GradeId</td>
<td style="text-align:center">CurrentGradeId</td>
</tr>
<tr>
<td style="text-align:center">CurrentGrade</td>
<td style="text-align:center">-</td>
<td style="text-align:center">GradeId</td>
<td style="text-align:center">CurrentGradeGradeId</td>
</tr>
<tr>
<td style="text-align:center">CurrentGrade</td>
<td style="text-align:center">-</td>
<td style="text-align:center">Id</td>
<td style="text-align:center">CurrentGradeId</td>
</tr>
<tr>
<td style="text-align:center">CurrentGrade</td>
<td style="text-align:center">GradeId</td>
<td style="text-align:center">Id</td>
<td style="text-align:center">GradeId</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>笔记</strong>：</p>
<hr>
<p>即：</p>
<ul>
<li>从属实体有外键属性 (即符合上述外键列名称生成条件的属性) 时使用从属实体中的外键属性名称。</li>
<li>从属实体没有外键属性时：
<ul>
<li>第一步，按上述外键列名称生成条件生成一个列名。</li>
<li>第二步，判断主体主键属性名称是否是 <code>Id</code>、<code>ID</code>、<code>iD</code> 或 <code>id</code>。</li>
<li>第三步，如果主体主键是上一步的四个中之一，那么使用生成的外键名；如果不是那么列名 = 生成的外键列名 + 主体主键属性名。</li>
</ul>
</li>
</ul>
</blockquote>
<h3 id="索引"><a class="header-anchor" href="#索引">¶</a>索引</h3>
<p>默认情况下，EF Core 在主键列上创建聚簇索引，在外键列上创建非聚簇索引。</p>
<h2 id="九、Entity-Framework-Core-中的一对多关系约定"><a class="header-anchor" href="#九、Entity-Framework-Core-中的一对多关系约定">¶</a>九、Entity Framework Core 中的一对多关系约定</h2>
<p>对于一对多关系，Entity Framework Core 遵循与 Entity Framework6.x 相同的约定。唯一的区别是 EF Core 创建的外键列的名称与导航属性名称相同，而不是与<code>&lt;NavigationPropertyName&gt;_&lt;PrimaryKeyPropertyName&gt;</code>。<br>
让我们看一下不同的约定，这些约定会自动在以下 <code>Student</code> 和 <code>Grade</code> 实体之间配置一对多关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class Student &#123;<br>    public int StudentId &#123; get; set; &#125;<br>    public string StudentName &#123; get; set; &#125;<br>&#125;<br>       <br>public class Grade &#123;<br>    public int GradeId &#123; get; set; &#125;<br>    public string GradeName &#123; get; set; &#125;<br>    public string Section &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的实体中应用了一对多关系的约定后，<code>Student</code> 和 <code>Grade</code> 实体的数据库表将如下所示，其中 <code>Student</code> 表包括外键 <code>GradeId</code>。</p>
<p><img src="/images/efcore/20200207214603619.png" alt="图9-1"></p>
<h3 id="约定一"><a class="header-anchor" href="#约定一">¶</a>约定一</h3>
<p>我们希望建立一对多的关系，其中许多学生与一个年级相关。可以通过在从属实体中包含引用导航属性来实现此目的，如下所示 (此处，学生实体是从属实体，而成绩实体是主要实体)：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Student &#123;<br>    public int Id &#123; get; set; &#125;<br>    public string Name &#123; get; set; &#125;<br>   <br>    public Grade Grade &#123; get; set; &#125;<br>&#125;<br><br>public class Grade &#123;<br>    public int GradeId &#123; get; set; &#125;<br>    public string GradeName &#123; get; set; &#125;<br>    public string Section &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，学生实体类包括班级类型的引用导航属性。这使我们可以将同一年级链接到许多不同的学生实体，从而在它们之间建立一对多的关系。这将在数据库的“学生”和“成绩”表之间产生一对多关系，其中“学生”表包含可为空的外键 <code>GradeId</code>，如下所示。 EF Core 将为概念模型中名为 <code>GradeId</code> 的外键创建一个阴影属性，该属性将映射到 <code>Students</code> 表中的 <code>GradeId</code> 外键列。</p>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>引用属性 <code>Grade</code> 是可为空的，因此它将在 <code>Student</code> 表中创建可为空的ForeignKey <code>GradeId</code>。您可以使用 fluent API 配置 NotNull 外键。</p>
</blockquote>
<p><img src="/images/efcore/20200207214616638.png" alt="图9-2"></p>
<h3 id="约定二"><a class="header-anchor" href="#约定二">¶</a>约定二</h3>
<p>另一个约定是在主体实体中包括集合导航属性，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class Student &#123;<br>    public int StudentId &#123; get; set; &#125;<br>    public string StudentName &#123; get; set; &#125;<br>&#125;<br><br>public class Grade &#123;<br>    public int GradeId &#123; get; set; &#125;<br>    public string GradeName &#123; get; set; &#125;<br>    public string Section &#123; get; set; &#125;<br>	&#x2F;&#x2F;集合导航属性<br>    public ICollection&lt;Student&gt; Students &#123; get; set; &#125; <br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>Grade</code> 实体包括类型为 <code>ICollection&lt;Student&gt;</code> 的集合导航属性。这将使我们能够向班级实体添加多个“学生”实体，从而导致数据库中“学生”和“班级”表之间存在一对多的关系，与约定一的目的相同。</p>
<h3 id="约定三"><a class="header-anchor" href="#约定三">¶</a>约定三</h3>
<p>一对多关系的另一个 EF 约定是在两端都包含导航属性，这也将会时数据表产生一对多关系（约定一 + 约定二）。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class Student &#123;<br>    public int Id &#123; get; set; &#125;<br>    public string Name &#123; get; set; &#125;<br>    &#x2F;&#x2F;引用导航属性<br>    public Grade Grade &#123; get; set; &#125;<br>&#125;<br><br>public class Grade &#123;<br>    public int GradeID &#123; get; set; &#125;<br>    public string GradeName &#123; get; set; &#125;<br>    &#x2F;&#x2F;集合导航属性<br>    public ICollection&lt;Student&gt; Students &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，学生实体包括班级类型的引用导航属性，班级实体类包括集合导航属性 <code>ICollection&lt;Student&gt;</code>，这导致相应的数据库表“学生”和“成绩”之间存在一对多关系，与约定一目的相同。</p>
<h3 id="约定四"><a class="header-anchor" href="#约定四">¶</a>约定四</h3>
<p>使用从属实体中的外键属性在两端完全定义该关系会创建一对多关系。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class Student &#123;<br>    public int Id &#123; get; set; &#125;<br>    public string Name &#123; get; set; &#125;<br><br>    public int GradeId &#123; get; set; &#125;<br>    public Grade Grade &#123; get; set; &#125;<br>&#125;<br><br>public class Grade &#123;<br>    public int GradeId &#123; get; set; &#125;<br>    public string GradeName &#123; get; set; &#125;<br><br>    public ICollection&lt;Student&gt; Students &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>Student</code> 实体包括类型为 <code>int</code> 的外键属性 <code>GradeId</code> 及其引用导航属性 <code>Grade</code>。在另一端，成绩实体还包括一个集合导航属性<code>ICollection&lt;Student&gt;</code>。这将与 <code>Student</code> 表中的 NotNull 外键列建立一对多关系，如下所示：</p>
<p><img src="/images/efcore/20200207214634262.png" alt="图9-3"></p>
<p>如果要将外键 <code>GradeId</code> 设置为可为空，则使用可为 <code>null</code> 的 <code>int</code> 数据类型 (<code>Nullable&lt;int&gt;</code> 或 <code>int?</code>)，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class Student &#123;<br>    public int Id &#123; get; set; &#125;<br>    public string Name &#123; get; set; &#125;<br><br>    public int? GradeId &#123; get; set; &#125; <br>    public Grade Grade &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>这些约定是在相应的数据库表中自动创建一对多关系的约定。如果实体不遵循上述约定，则可以使用 Fluent API 来配置一对多关系。</p>
<h2 id="十、Entity-Framework-Core-一对一关系约定"><a class="header-anchor" href="#十、Entity-Framework-Core-一对一关系约定">¶</a>十、Entity Framework Core 一对一关系约定</h2>
<p>Entity Framework Core 引入了 <strong>默认约定</strong>，该约定自动配置两个实体之间的一对一关系 (EF 6.x或更早版本不支持一对一关系的约定)。<br>
在 EF Core 中，一对一关系在 <strong>两侧都需要参考导航属性</strong>。下列 <code>Student</code> 和 <code>StudentAddress</code> 实体遵循一对一关系的约定:</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class Student &#123;<br>    public int Id &#123; get; set; &#125;<br>    public string Name &#123; get; set; &#125;<br>       <br>    public StudentAddress Address &#123; get; set; &#125;<br>&#125;<br><br>public class StudentAddress &#123;<br>    public int StudentAddressId &#123; get; set; &#125;<br>    public string Address &#123; get; set; &#125;<br>    public string City &#123; get; set; &#125;<br>    public string State &#123; get; set; &#125;<br>    public string Country &#123; get; set; &#125;<br><br>    public int StudentId &#123; get; set; &#125;<br>    public Student Student &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>Student</code> 实体包括类型为 <code>StudentAddress</code> 的引用导航属性，而 <code>StudentAddress</code> 实体包括外键属性 <code>StudentId</code> 及其对应的引用属性 <code>Student</code> 。这将在数据库中的对应表 <code>Student</code> 和 <code>StudentAddresses</code> 中产生一对一的关系，如下所示：</p>
<p><img src="/images/efcore/20200207215111952.png" alt="图10-1"></p>
<p>EF Core 在 <code>StudentAddresses</code> 表的 NotNull 外键列 <code>StudentId</code> 上创建了唯一索引，如上所示。这样可以确保外键列 <code>StudentId</code> 的值在 <code>StudentAddress</code> 表中必须唯一，这是一对一关系所必需的。</p>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>Entity Framework Core 支持唯一约束，但 EF 6 不支持唯一约束，因此 EF Core 包括一对一关系的约定，但不包括 EF6.x。如果实体不遵循约定，则使用 Fluent API 配置一对一关系。</p>
</blockquote>
<h2 id="十一、Entity-Framework-Core-配置"><a class="header-anchor" href="#十一、Entity-Framework-Core-配置">¶</a>十一、Entity Framework Core 配置</h2>
<p>您已在上一章中了解了 EF Core 中的 <strong>默认约定</strong>。很多时候，我们希望自定义实体到表的映射，并且不想遵循默认约定。 EF Core 允许我们配置领域实体类，以自定义 EF 模型到数据库的映射。此编程模式称为 <strong>约定优于配置</strong>。<br>
有两种方法可以在 EF Core 中配置领域实体类 (与 EF 6 中相同)：</p>
<ul>
<li>通过使用数据注释特性 (Data Annotation)</li>
<li>通过使用 Fluent API</li>
</ul>
<h3 id="数据注释特性-Data-Annotation-Attributes"><a class="header-anchor" href="#数据注释特性-Data-Annotation-Attributes">¶</a>数据注释特性 (Data Annotation Attributes)</h3>
<p>数据注释是一种基于特性的简单配置方法，其中可以将不同的.NET特性应用于领域模型类和属性以配置模型。<br>
数据注释属性不专用于 Entity Framework，因为它们在 <a href="http://ASP.NET" target="_blank" rel="noopener">ASP.NET</a> MVC 中也使用。这就是为什么这些属性包含在单独的命名空间 <code>System.ComponentModel.DataAnnotations</code> 中的原因。<br>
下面的示例演示如何将数据注释特性应用于领域实体类和属性以覆盖约定。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">[Table(&quot;StudentInfo&quot;)] &#x2F;&#x2F;定义映射的表名<br>public class Student &#123;<br>    public Student() &#123; &#125;<br><br>    [Key]&#x2F;&#x2F;定义主键<br>    [DatabaseGenerated(DatabaseGeneratedOption.Identity)]  &#x2F;&#x2F; 自增主键。其中 DatabaseGeneratedOption 的有三个属性：Identity：自增长、None：不处理、Computed：表示这一列是计算列。<br>    public int SID &#123; get; set; &#125;<br><br>    [Column(&quot;Name&quot;, TypeName&#x3D;&quot;ntext&quot;)]&#x2F;&#x2F;定义列名及类型<br>    [MaxLength(20)]<br>    public string StudentName &#123; get; set; &#125;<br><br>    [NotMapped] &#x2F;&#x2F;不在数据库中生成列<br>    public int? Age &#123; get; set; &#125;<br><br>    public int StdId &#123; get; set; &#125;<br><br>    [ForeignKey(&quot;StdId&quot;)] &#x2F;&#x2F;定义外键<br>    public virtual Standard Standard &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>数据注释特性在 EF 6 和 EF Core 中相同。有关更多信息，请访问 EF 6 部分中的“数据注释”一章。</p>
<h3 id="Fluent-API"><a class="header-anchor" href="#Fluent-API">¶</a>Fluent API</h3>
<p>配置领域模型类的另一种方法是使用 Entity Framework Fluent API。EF Fluent API 基于 Fluent API 设计模式 (也称为 Fluent 接口)，其中结果通过方法链来表示，下一节我们将介绍。</p>
<h2 id="十二、Entity-Framework-Core-Fluent-API"><a class="header-anchor" href="#十二、Entity-Framework-Core-Fluent-API">¶</a>十二、Entity Framework Core Fluent API</h2>
<p><strong>Entity Framework Core Fluent API 用于配置领域实体类以覆盖约定</strong>。EF Fluent API 基于 Fluent API 设计模式 (也称为 Fluent 接口)，其中结果通过方法链来表示。</p>
<p>在 Entity Framework Core 中，<code>ModelBuilder</code> 类充当 Fluent API。通过使用它，我们可以配置许多不同的东西，因为它提供了比数据注释属性更多的配置选项。<br>
Entity Framework Core Fluent API 配置了模型的以下方面：</p>
<ul>
<li>
<p><strong>模型配置</strong>：将 EF 模型配置为数据库映射。配置默认架构，数据库功能，其他数据注释属性和要从映射中排除的实体。</p>
</li>
<li>
<p><strong>实体配置</strong>：配置实体到表和关系的映射，例如 PrimaryKey、AlternateKey、Index、表名、一对一、一对多、多对多关系等。</p>
</li>
<li>
<p><strong>属性配置</strong>：将属性配置为列映射，例如列名称、默认值、可空性、外键、数据类型、并发列等。</p>
</li>
</ul>
<p>下表列出了每种配置类型的重要方法：</p>
<table>
    <thead>
        <tr>
            <th style="text-align: center">配置</th>
            <th style="text-align: center"><span style="font-wegiht: bold">Fluent API 方法</span></th>
            <th style="text-align: center">用法</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td rowspan="4" style="text-align: center; vertical-align: middle">模型配置</td>
            <td style="text-align: center"><code>HasDbFunction()</code></td>
            <td style="text-align: center">在定位关系数据库时配置数据库功能</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasDefaultSchema()</code></td>
            <td style="text-align: center">指定数据库架构</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasAnnotation()</code></td>
            <td style="text-align: center">在实体上添加或更新数据注释属性</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasSequence()</code></td>
            <td style="text-align: center">定位关系数据库时配置数据库序列</td>
        </tr>
        <tr>
            <td rowspan="8" style="text-align: center; vertical-align: middle">实体配置</td>
            <td style="text-align: center"><code>HasAlternateKey()</code></td>
            <td style="text-align: center">在 EF 模型中为实体配置备用密钥</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasIndex()</code></td>
            <td style="text-align: center">配置指定属性的索引</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasKey()</code></td>
            <td style="text-align: center">将属性或属性列表配置为主键</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasMany()</code></td>
            <td style="text-align: center">配置关系的“很多”部分，其中实体包含一对多或多对多关系的其他类型的引用集合属性</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasOne()</code></td>
            <td style="text-align: center">配置关系的“一部分”，其中实体包含一对一或一对多关系的其他类型的引用属性</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>Ignore()</code></td>
            <td style="text-align: center">配置不应将类或属性映射到表或列</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>OwnsOne()</code></td>
            <td style="text-align: center">配置关系，其中目标实体由该实体拥有。目标实体键值是从它所属的实体传播的</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>ToTable()</code></td>
            <td style="text-align: center">配置实体映射到的数据库表</td>
        </tr>
        <tr>
            <td rowspan="15" style="text-align: center; vertical-align: middle">属性配置</td>
            <td style="text-align: center"><code>HasColumnName()</code></td>
            <td style="text-align: center">在数据库中为属性配置相应的列名称</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasColumnType()</code></td>
            <td style="text-align: center">为属性配置数据库中相应列的数据类型</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasComputedColumnSql()</code></td>
            <td style="text-align: center">配置属性以在关系数据库为目标时映射到数据库中的计算列</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasDefaultValue()</code></td>
            <td style="text-align: center">为目标关系数据库配置属性映射到的列的默认值</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasDefaultValueSql()</code></td>
            <td style="text-align: center">在定位关系数据库时，为属性映射到的列配置默认值表达式</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasField()</code></td>
            <td style="text-align: center">在指定要与属性一起使用的后备字段</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>HasMaxLength()</code></td>
            <td style="text-align: center">配置可以存储在属性中的最大数据长度</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>IsConcurrencyToken()</code></td>
            <td style="text-align: center">将属性配置为用作乐观并发令牌</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>IsRequired()</code></td>
            <td style="text-align: center">配置属性的有效值是必需的还是 <code>null</code> 为有效值</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>IsRowVersion()</code></td>
            <td style="text-align: center">配置要在乐观并发检测中使用的属性</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>IsUnicode()</code></td>
            <td style="text-align: center">配置字符串属性，该属性可以包含或不包含 Unicode 字符</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>ValueGeneratedNever()</code></td>
            <td style="text-align: center">配置保存实体时不能具有生成值的属</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>ValueGeneratedOnAdd()</code></td>
            <td style="text-align: center">配置在保存新实体时属性具有生成的值</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>ValueGeneratedOnAddOrUpdate()</code></td>
            <td style="text-align: center">配置保存新实体或现有实体时属性具有生成的值</td>
        </tr>
        <tr>
            <td style="text-align: center"><code>ValueGeneratedOnUpdate()</code></td>
            <td style="text-align: center">配置在保存现有实体时属性具有生成的值</td>
        </tr>
    </tbody>
</table>
<h3 id="Fluent-API-配置"><a class="header-anchor" href="#Fluent-API-配置">¶</a>Fluent API 配置</h3>
<p>重写 <code>OnModelCreating</code> 方法，并使用 <code>ModelBuilder</code> 类型的参数 <code>modelBuilder</code>来配置领域实体类，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class SchoolDBContext: DbContext  &#123;<br>    public DbSet&lt;Student&gt; Students &#123; get; set; &#125;<br>        <br>    protected override void OnModelCreating(ModelBuilder modelBuilder) &#123;<br>        &#x2F;&#x2F;Write Fluent API configurations here<br>        &#x2F;&#x2F;Property Configurations<br>        modelBuilder.Entity&lt;Student&gt;()<br>                .Property(s &#x3D;&gt; s.StudentId)<br>                .HasColumnName(&quot;Id&quot;)<br>                .HasDefaultValue(0)<br>                .IsRequired();<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>ModelBuilder</code> Fluent API 实例用于通过调用链中的多个方法来配置属性。它配置 <code>Student</code> 实体的 <code>StudentId</code> 属性；它在单个语句而不是多个语句中使用 <code>HasColumnName</code> 配置名称，使用 <code>HasDefaultValue</code> 配置默认值，并使用 <code>IsRequired</code> 方法配置可空性。与多条语句相比，这提高了可读性，并且花费的时间更少，如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">&#x2F;&#x2F;Fluent API method chained calls<br>modelBuilder.Entity&lt;Student&gt;()<br>        .Property(s &#x3D;&gt; s.StudentId)<br>        .HasColumnName(&quot;Id&quot;)<br>        .HasDefaultValue(0)<br>        .IsRequired();<br><br>&#x2F;&#x2F;Separate method calls<br>modelBuilder.Entity&lt;Student&gt;().Property(s &#x3D;&gt; s.StudentId).HasColumnName(&quot;Id&quot;);<br>modelBuilder.Entity&lt;Student&gt;().Property(s &#x3D;&gt; s.StudentId).HasDefaultValue(0);<br>modelBuilder.Entity&lt;Student&gt;().Property(s &#x3D;&gt; s.StudentId).IsRequired();<br></code></pre></div></td></tr></table></figure>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>Fluent API配置的优先级高于数据注释属性。</p>
</blockquote>
<h2 id="十三、Entity-Framework-Core-Fluent-API-配置一对一关系"><a class="header-anchor" href="#十三、Entity-Framework-Core-Fluent-API-配置一对一关系">¶</a>十三、Entity Framework Core Fluent API 配置一对一关系</h2>
<p>通常，您不需要手动配置一对一关系，因为 EF Core 包含一对一关系的约定。但是，如果键或外键属性不遵循约定，则可以使用数据注释属性或 Fluent API 在两个实体之间配置一对一关系。<br>
让我们在以下不遵循外键约定的 <code>Student</code> 和 <code>StudentAddress</code> 实体之间配置一对一关系。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class Student &#123;<br>    public int Id &#123; get; set; &#125;<br>    public string Name &#123; get; set; &#125;<br>       <br>    public StudentAddress Address &#123; get; set; &#125;<br>&#125;<br><br>public class StudentAddress &#123;<br>    public int StudentAddressId &#123; get; set; &#125;<br>    public string Address &#123; get; set; &#125;<br>    public string City &#123; get; set; &#125;<br>    public string State &#123; get; set; &#125;<br>    public string Country &#123; get; set; &#125;<br><br>    public int AddressOfStudentId &#123; get; set; &#125;<br>    public Student Student &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>要在 EF Core 中使用 Fluent API 配置一对一关系，请使用 <code>HasOne</code>、<code>WithOne</code> 和 <code>HasForeignKey</code> 方法，如下所示:</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class SchoolContext : DbContext &#123;<br>    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) &#123;<br>        optionsBuilder.UseSqlServer(&quot;Server&#x3D;.\\SQLEXPRESS;Database&#x3D;EFCore-SchoolDB;Trusted_Connection&#x3D;True&quot;);<br>    &#125;<br><br>    protected override void OnModelCreating(ModelBuilder modelBuilder) &#123;<br>        modelBuilder.Entity&lt;Student&gt;()<br>            .HasOne&lt;StudentAddress&gt;(s &#x3D;&gt; s.Address)<br>            .WithOne(ad &#x3D;&gt; ad.Student)<br>            .HasForeignKey&lt;StudentAddress&gt;(ad &#x3D;&gt; ad.AddressOfStudentId);<br>    &#125;<br><br>    public DbSet&lt;Student&gt; Students &#123; get; set; &#125;<br>    public DbSet&lt;StudentAddress&gt; StudentAddresses &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，以下代码片段配置了一对一关系:</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">modelBuilder.Entity&lt;Student&gt;()<br>    .HasOne&lt;StudentAddress&gt;(s &#x3D;&gt; s.Address)<br>    .WithOne(ad &#x3D;&gt; ad.Student)<br>    .HasForeignKey&lt;StudentAddress&gt;(ad &#x3D;&gt; ad.AddressOfStudentId);<br></code></pre></div></td></tr></table></figure>
<p>让我们逐步分析代码:</p>
<ol>
<li><code>modelBuilder.Entity&lt;Student&gt;()</code> 开始配置 <code>Student</code> 实体。</li>
<li><code>.HasOne&lt;StudentAddress&gt;(s =&gt; s.Address)</code> 方法使用 lambda 表达式指定 <code>Student</code> 实体包括一个 <code>StudentAddress</code> 引用属性。</li>
<li><code>.WithOne(ad =&gt; ad.Student)</code> 配置关系的另一端，<code>StudentAddress</code> 实体。它指定 <code>StudentAddress</code> 实体包括 <code>Student</code> 类型的参考导航属性。</li>
<li><code>.HasForeignKey&lt;StudentAddress&gt;(ad =&gt; ad.AddressOfStudentId)</code> 指定外键属性名称。</li>
</ol>
<p>现在，要将其反映在数据库中，请执行迁移命令，<code>add-migration &lt;名称&gt;</code> 和 <code>update-database</code>。该数据库将包括两个具有一对一关系的表，如下所示：</p>
<p><img src="/images/efcore/20200207221956122.png" alt="图13-1"></p>
<p>下图说明了一对一关系的 Fluent API 配置：</p>
<p><img src="/images/efcore/20200207222010325.png" alt="13-2"></p>
<p>您可以按照以下相同的方式开始使用 <code>StudentAddress</code> 实体进行配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">modelBuilder.Entity&lt;StudentAddress&gt;()<br>    .HasOne&lt;Student&gt;(ad &#x3D;&gt; ad.Student)<br>    .WithOne(s &#x3D;&gt; s.Address)<br>    .HasForeignKey&lt;StudentAddress&gt;(ad &#x3D;&gt; ad.AddressOfStudentId);<br></code></pre></div></td></tr></table></figure>
<p>因此，您可以在 Entity Framework Core 中配置一对一关系。</p>
<h2 id="十四、在-Entity-Framework-Core-Fluent-API-配置多对多关系"><a class="header-anchor" href="#十四、在-Entity-Framework-Core-Fluent-API-配置多对多关系">¶</a>十四、在 Entity Framework Core Fluent API 配置多对多关系</h2>
<p>让我们在以下学生和课程实体之间实现多对多关系，其中一个学生可以报名参加许多课程，并且以同样的方式，许多学生可以加入一门课程。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class Student &#123;<br>    public int StudentId &#123; get; set; &#125;<br>    public string Name &#123; get; set; &#125;<br>&#125;<br><br>public class Course &#123;<br>    public int CourseId &#123; get; set; &#125;<br>    public string CourseName &#123; get; set; &#125;<br>    public string Description &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p><strong>数据库中的多对多关系由联接表表示，联接表包括两个表的外键。同样，这些外键是复合主键。</strong></p>
<p><img src="/images/efcore/20200207222442650.png" alt="图14-1"></p>
<h3 id="约定"><a class="header-anchor" href="#约定">¶</a>约定</h3>
<p><strong>Entity Framework Core 中没有可用于自动配置多对多关系的默认约定</strong>。您必须使用 Fluent API 对其进行配置。</p>
<h3 id="Fluent-API-v2"><a class="header-anchor" href="#Fluent-API-v2">¶</a>Fluent API</h3>
<p>在 Entity Framework 6.x 或更低版本中，EF API 用于为多对多关系创建联接表。我们不需要为联接表创建联接实体 (但是，我们当然可以在 EF 6 中显式创建联接实体)。</p>
<p>在 Entity Framework Core 中，这尚未实现。<strong>我们必须为联接表创建联接实体类</strong>。上述学生和课程实体的加入实体应包括每个实体的外键属性和参考导航属性。</p>
<p>配置多对多关系的步骤如下:</p>
<ol>
<li>定义一个新的加入实体类，该类包括每个实体的外键属性和引用导航属性。</li>
<li>通过在两侧的实体中包括集合导航属性 (在本例中为“学生”和“课程”)，定义其他两个实体与加入实体之间的一对多关系。</li>
<li>使用 Fluent API 将加入实体中的两个外键都配置为组合键。<br>
因此，首先，定义连接实体 <code>StudentCourse</code>，如下所示：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class StudentCourse &#123;<br>    public int StudentId &#123; get; set; &#125;<br>    public Student Student &#123; get; set; &#125;<br><br>    public int CourseId &#123; get; set; &#125;<br>    public Course Course &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>上述加入实体 <code>StudentCourse</code> 分别包括引用导航属性 <code>Student</code> 和 <code>Course</code> 以及它们的外键属性 <code>StudentId</code> 和 <code>CourseId</code> (外键属性遵循约定)。<br>
现在，我们还需要在 <code>Student</code> -&gt; <code>StudentCourse</code> 和 <code>Course</code> -&gt; <code>StudentCourse</code> 实体之间配置两个单独的一对多关系。我们可以通过遵循一对多关系的约定来做到这一点，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Student &#123;<br>    public int StudentId &#123; get; set; &#125;<br>    public string Name &#123; get; set; &#125;<br><br>    public IList&lt;StudentCourse&gt; StudentCourses &#123; get; set; &#125;<br>&#125;<br><br>public class Course<br>&#123;<br>    public int CourseId &#123; get; set; &#125;<br>    public string CourseName &#123; get; set; &#125;<br>    public string Description &#123; get; set; &#125;<br><br>    public IList&lt;StudentCourse&gt; StudentCourses &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>如您在上面所看到的，<code>Student</code> 和 <code>Course</code> 实体现在包括 <code>StudentCourse</code> 类型的集合导航属性。<code>StudentCourse</code> 实体已经包含了 <code>Student</code> 和 <code>Course</code> 的外键属性和导航属性。这使其在 <code>Student</code> 和 <code>StudentCourse</code> 与<code>Course</code> 和 <code>StudentCourse</code> 之间建立了完全定义的一对多关系。<br>
现在，外键必须是联接表中的复合主键。只能使用 Fluent API 进行配置，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class SchoolContext : DbContext &#123;<br>    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) &#123;<br>        optionsBuilder.UseSqlServer(&quot;Server&#x3D;.\\SQLEXPRESS;Database&#x3D;EFCore-SchoolDB;Trusted_Connection&#x3D;True&quot;);<br>    &#125;<br><br>    protected override void OnModelCreating(ModelBuilder modelBuilder) &#123;<br>        modelBuilder.Entity&lt;StudentCourse&gt;().HasKey(sc &#x3D;&gt; new &#123; sc.StudentId, sc.CourseId &#125;);<br>    &#125;<br>    <br>    public DbSet&lt;Student&gt; Students &#123; get; set; &#125;<br>    public DbSet&lt;Course&gt; Courses &#123; get; set; &#125;<br>    public DbSet&lt;StudentCourse&gt; StudentCourses &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的代码中，<code>modelBuilder.Entity&lt;StudentCourse&gt;().HasKey(sc =&gt; new { sc.StudentId, sc.CourseId })</code> 将 <code>StudentId</code> 和<code> CourseId</code> 配置为组合键。<br>
如果实体遵循与加入实体的一对多关系的约定，则可以通过这种方法配置多对多关系。假设外键属性名称不遵循约定 (例如，<code>SID</code> 代替 <code>StudentId</code>，<code>CID</code> 代替 <code>CourseId</code>)，则可以使用 Fluent API 对其进行配置，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">modelBuilder.Entity&lt;StudentCourse&gt;().HasKey(sc &#x3D;&gt; new &#123; sc.SId, sc.CId &#125;);<br><br>modelBuilder.Entity&lt;StudentCourse&gt;()<br>    .HasOne&lt;Student&gt;(sc &#x3D;&gt; sc.Student)<br>    .WithMany(s &#x3D;&gt; s.StudentCourses)<br>    .HasForeignKey(sc &#x3D;&gt; sc.SId);<br><br>modelBuilder.Entity&lt;StudentCourse&gt;()<br>    .HasOne&lt;Course&gt;(sc &#x3D;&gt; sc.Course)<br>    .WithMany(s &#x3D;&gt; s.StudentCourses)<br>    .HasForeignKey(sc &#x3D;&gt; sc.CId);<br></code></pre></div></td></tr></table></figure>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>EF 团队将包含一项功能，将来我们无需为多对多关系创建加入实体。在 GitHub 上跟踪此问题。</p>
</blockquote>
<h2 id="十五、在-Entity-Framework-Core-的断开模式下插入数据"><a class="header-anchor" href="#十五、在-Entity-Framework-Core-的断开模式下插入数据">¶</a>十五、在 Entity Framework Core 的断开模式下插入数据</h2>
<p>在断开连接的方案中保存数据与在连接的方案中保存数据有些不同。在断开连接的情况下，<code>DbContext</code> 不知道断开连接的实体，因为在当前 <code>DbContext</code> 实例的范围之外添加或修改了实体。因此，您需要将断开连接的实体附加到具有适当 <code>EntityState</code> 的上下文，以便对数据库执行 CUD (创建，更新，删除) 操作。<br>
下图说明了断开连接情况下的 CUD 操作：</p>
<p><img src="/images/efcore/20200208105621549.png" alt="图14-1"></p>
<p>根据上图，断开的实体 (<code>DbContext</code> 不会跟踪的实体) 需要使用适当的 <code>EntityState</code> 附加到 <code>DbContext</code>。例如，新实体的已添加状态，已编辑实体的已修改状态和已删除实体的已删除状态，这将在调用 <code>SaveChanges()</code> 方法时在数据库中产生 <code>INSERT</code>，<code>UPDATE</code> 或 <code>DELETE</code> 命令。<br>
为了在断开连接的情况下使用 Entity Framework Core 将记录插入，更新或删除到 <code>DB</code> 表中，必须执行以下步骤：</p>
<ol>
<li>使用适当的 <code>EntityState</code> 将实体附加到 <code>DbContext</code> ，例如添加，修改或删除。</li>
<li>调用 <code>SaveChanges()</code> 方法。</li>
</ol>
<p>下面的示例演示如何使用上述步骤将新记录插入数据库：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">&#x2F;&#x2F; Disconnected entity<br>var std &#x3D; new Student() &#123; Name &#x3D; &quot;Bill&quot; &#125;;<br><br>using (var context &#x3D; new SchoolContext()) &#123;<br>    &#x2F;&#x2F; 1. 使用添加的EntityState将实体附加到上下文<br>    context.Add&lt;Student&gt;(std);<br>    &#x2F;&#x2F; 或以下内容也有效<br>    &#x2F;&#x2F; context.Students.Add(std);<br>    <br>    &#x2F;&#x2F; context.Entry&lt;Student&gt;(std).State &#x3D; EntityState.Added;<br>    &#x2F;&#x2F; context.Attach&lt;Student&gt;(std);<br>                  <br>    &#x2F;&#x2F; 2. 调用SaveChanges将新记录插入Student表<br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>std</code> 是 <code>Student</code> 实体的断开连接的实例。<code>context.Add&lt;Student&gt;()</code> 方法将 <code>Student</code> 实体附加到具有添加状态的上下文。 <code>SaveChanges()</code> 方法将生成并执行以下 <code>INSERT</code> 语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec sp_executesql N&#39;SET NOCOUNT ON;<br>INSERT INTO [Students] ([Name])<br>VALUES (@p0);<br>SELECT [StudentId]<br>FROM [Students]<br>WHERE @@ROWCOUNT &#x3D; 1 AND [StudentId] &#x3D; scope_identity();&#39;,N&#39;@p0 nvarchar(4000), <br>@p1 nvarchar(4000) &#39;,@p0&#x3D;N&#39;Bill&#39;<br>Go<br></code></pre></div></td></tr></table></figure>
<p>EF Core 提供了多种添加状态为 “Added” 的实体的方法。在上面的示例中，<code>context.Students.Add(std);</code>、 <code>context.Entry&lt;Student&gt;(std).State = EntityState.Added;</code> 和 <code>context.Attach&lt;Student&gt;(std);</code> 将导致与上述相同的<code>INSERT</code> 语句。</p>
<p>EF Core 提供了以下 <code>DbContext</code> 和 <code>DbSet</code> 方法，这些方法将断开连接的实体与添加的 <code>EntityState</code> 附加在一起，后者又将在数据库中执行 <code>INSERT</code> 语句。</p>
<table>
<thead>
<tr>
<th style="text-align:center"><strong><code>DbContext</code> 方法</strong></th>
<th style="text-align:center"><strong><code>DbSet</code> 方法</strong></th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>DbContext.Attach</code></td>
<td style="text-align:center"><code>DbSet.Attach</code></td>
<td style="text-align:center">将实体附加到 <code>DbContext</code>。为其 <code>Key</code> 属性具有值的实体设置“不变”状态，为其 <code>Key</code> 属性为空或数据类型的默认值的实体设置“添加”状态</td>
</tr>
<tr>
<td style="text-align:center"><code>DbContext.Add</code></td>
<td style="text-align:center"><code>DbSet.Add</code></td>
<td style="text-align:center"><code>DbContext.Add</code>、<code>DbSet.Add</code> 将具有附加状态的实体附加到 <code>DbContext</code></td>
</tr>
<tr>
<td style="text-align:center"><code>DbContext.AddRange</code></td>
<td style="text-align:center"><code>DbSet.AddRange</code></td>
<td style="text-align:center"><code>DbContext.AddRange</code>、<code>DbSet.AddRange</code> 将实体集合附加到具有添加状态的 <code>DbContext</code></td>
</tr>
<tr>
<td style="text-align:center"><code>DbContext.Entry</code></td>
<td style="text-align:center">-</td>
<td style="text-align:center"><code>DbContext.Entry</code> - 获取指定实体的 <code>EntityEntry</code>，该实体提供对更改跟踪信息和操作的访问</td>
</tr>
<tr>
<td style="text-align:center"><code>DbContext.AddAsync</code></td>
<td style="text-align:center"><code>DbSet.AddAsync</code></td>
<td style="text-align:center"><code>DbContext.AddAsync</code>、<code>DbSet.AddAsync</code> 异步方法，用于将实体附加到具有“已添加”状态的 <code>DbContext</code>上，如果没有，则开始跟踪它。调用 <code>SaveChangesAsync()</code> 时，数据将插入数据库中</td>
</tr>
<tr>
<td style="text-align:center"><code>DbContext.AddRangeAsync</code></td>
<td style="text-align:center"><code>DbSet.AddRangeAsync</code></td>
<td style="text-align:center"><code>DbContext.AddRangeAsync</code>、<code>DbSet.AddRangeAsync</code> 异步方法，用于一次性将多个实体附加到具有添加状态的 <code>DbContext</code> 上，如果没有，则开始跟踪它们。调用 <code>SaveChangesAsync()</code> 时，数据将插入数据库中</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>上面的 <code>DbContext</code> 方法是在 EF Core 中引入的 (它们在 EF 6 或更早版本中不可用)。 <code>DbContext</code> 和 <code>DbSet</code> 方法都执行相同的操作。您使用哪一种取决于您的编码模式和偏好。</p>
</blockquote>
<h3 id="插入关系数据"><a class="header-anchor" href="#插入关系数据">¶</a>插入关系数据</h3>
<p>在上一章中，我们学习了在两个实体之间创建一对一、一对多和多对多关系。Entity Framework API 会插入相关实体中包含的所有关系数据。<br>
使用 <code>DbContext.Add</code> 或 <code>DbSet.Add</code> 方法将相关实体添加到数据库。 <code>Add</code> 方法将实体附加到上下文，并将“已添加”状态设置为 <code>ID</code> (键) 属性为空，空或数据类型默认值的实体图中的所有实体。考虑以下示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var stdAddress &#x3D; new StudentAddress() &#123;<br>    City &#x3D; &quot;SFO&quot;,<br>    State &#x3D; &quot;CA&quot;,<br>    Country &#x3D; &quot;USA&quot;<br>&#125;;<br><br>var std &#x3D; new Student() &#123;<br>    Name &#x3D; &quot;Steve&quot;,<br>    Address &#x3D; stdAddress<br>&#125;;<br>using (var context &#x3D; new SchoolContext()) &#123;<br>    &#x2F;&#x2F; 将实体附加到具有添加状态的 DbContext<br>    context.Add&lt;Student&gt;(std);<br><br>    &#x2F;&#x2F; 调用 SaveChanges 将新记录插入 Student 表<br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>context.Add&lt;Student&gt;(std)</code> 添加了 <code>Student</code> 实体的实例。 EF Core API 通过 <code>Student</code> 的引用导航属性到达 <code>StudentAddress</code> 实例，并将两个实体的 <code>EntityState</code> 标记为 <code>Added</code> ，这将在 <code>SaveChanges()</code> 上构建并执行以下两个 <code>INSERT</code> 命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec sp_executesql N&#39;SET NOCOUNT ON;<br>INSERT INTO [Students] ([Name])<br>VALUES (@p0);<br>SELECT [StudentId]<br>FROM [Students]<br>WHERE @@ROWCOUNT &#x3D; 1 AND [StudentId] &#x3D; scope_identity();&#39;,N&#39;@p0 nvarchar(4000), <br>@p1 nvarchar(4000) &#39;,@p0&#x3D;N&#39;Steve&#39;<br>Go<br><br>exec sp_executesql N&#39;SET NOCOUNT ON;<br>INSERT INTO [StudentAddresses] ([Address], [City], [Country], [State], [StudentId])<br>VALUES (@p5, @p6, @p7, @p8, @p9);<br>SELECT [StudentAddressId]<br>FROM [StudentAddresses]<br>WHERE @@ROWCOUNT &#x3D; 1 AND [StudentAddressId] &#x3D; scope_identity();<br>&#39;,N&#39;@p5 nvarchar(4000),@p6 nvarchar(4000),@p7 nvarchar(4000),@p8 nvarchar(4000),<br>@p9 int&#39;,@p5&#x3D;NULL,@p6&#x3D;N&#39;SFO&#39;,@p7&#x3D;N&#39;USA&#39;,@p8&#x3D;N&#39;CA&#39;,@p9&#x3D;1<br>Go<br></code></pre></div></td></tr></table></figure>
<p>使用 <code>DbContext.AddRange</code> 或 <code>DbSet.AddRange</code> 方法可一次性添加多个实体。您无需多次调用 <code>DbContext.Add</code> 方法。</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>AddRange</code> 方法</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>void AddRange(IEnumerable&lt;Object&gt; entities)</code></td>
<td style="text-align:center"><code>void AddRange(IEnumerable&lt;Object&gt; entities)</code> 将具有相同或不同类型的实体的列表添加到具有“已添加”状态的 <code>DbContext</code> 中</td>
</tr>
<tr>
<td style="text-align:center"><code>void AddRange(param object[] entities)</code></td>
<td style="text-align:center"><code>void AddRange(param object[] entities)</code> 将具有相同或不同类型的实体的数组添加到具有“Added”状态的 <code>DbContext</code> 中</td>
</tr>
<tr>
<td style="text-align:center"><code>void AddRangeAsync(IEnumerable&lt;Object&gt;, CancellationToken)</code></td>
<td style="text-align:center"><code>void AddRangeAsync(IEnumerable&lt;Object&gt;, CancellationToken)</code> 异步方法，用于将相同或不同类型的实体列表添加到具有添加状态的 <code>DbContext</code> 中</td>
</tr>
</tbody>
</table>
<p>以下示例演示了使用 <code>AddRange</code> 添加学生实体对象列表。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var studentList &#x3D; new List&lt;Student&gt;() &#123;<br>    new Student()&#123; Name &#x3D; &quot;Bill&quot; &#125;,<br>    new Student()&#123; Name &#x3D; &quot;Steve&quot; &#125;<br>&#125;;<br><br>using (var context &#x3D; new SchoolContext()) &#123;<br>    context.AddRange(studentList);<br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>上面的示例将在 <code>Student</code> 表中插入两个新记录。<br>
您还可以添加不同类型的实体的列表，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var std1 &#x3D; new Student()&#123; Name &#x3D; &quot;Bill&quot; &#125;;<br><br>var std2 &#x3D; new Student()&#123; Name &#x3D; &quot;Steve&quot; &#125;;<br><br>var computer &#x3D; new Course() &#123; CourseName &#x3D; &quot;Computer Science&quot; &#125;;<br><br>var entityList &#x3D; new List&lt;Object&gt;() &#123;<br>    std1,<br>    std2,<br>    computer<br>&#125;;<br><br>using (var context &#x3D; new SchoolContext()) &#123;                <br>    context.AddRange(entityList);<br><br>    &#x2F;&#x2F; or <br>    &#x2F;&#x2F; context.AddRange(std1, std2, computer);<br><br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>entityList</code> 是 <code>List&lt;Object&gt;</code> 的一种。因此，它可以包含任何类型的实体。<code>AddRange()</code> 方法将所有指定的实体添加到上下文中，<code>SaveChanges()</code> 将一次性构建并执行 <code>INSERT</code> 语句。<br>
EF Core 通过在一次数据库往返中对所有上述实体执行 <code>INSERT</code> 语句来提高性能。上面的示例将在数据库中执行以下语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec sp_executesql N&#39;SET NOCOUNT ON;<br>INSERT INTO [Courses] ([CourseName], [Description])<br>VALUES (@p0, @p1);<br>SELECT [CourseId]<br>FROM [Courses]<br>WHERE @@ROWCOUNT &#x3D; 1 AND [CourseId] &#x3D; scope_identity();<br><br>DECLARE @inserted1 TABLE ([StudentId] int, [_Position] [int]);<br>MERGE [Students] USING (<br>VALUES (@p2, 0),<br>(@p3, 1)) AS i ([Name], _Position) ON 1&#x3D;0<br>WHEN NOT MATCHED THEN<br>INSERT ([Name])<br>VALUES (i.[Name])<br>OUTPUT INSERTED.[StudentId], i._Position<br>INTO @inserted1;<br><br>SELECT [t].[StudentId] FROM [Students] t<br>INNER JOIN @inserted1 i ON ([t].[StudentId] &#x3D; [i].[StudentId])<br>ORDER BY [i].[_Position];<br>&#39;,N&#39;@p0 nvarchar(4000),@p1 nvarchar(4000),@p2 nvarchar(4000),@p3 nvarchar(4000)&#39;,<br>@p0&#x3D;N&#39;Computer Science&#39;,@p1&#x3D;NULL,@p2&#x3D;N&#39;Steve&#39;,@p3&#x3D;N&#39;Bill&#39;<br>Go<br></code></pre></div></td></tr></table></figure>
<h3 id="使用-DbSet-插入数据"><a class="header-anchor" href="#使用-DbSet-插入数据">¶</a>使用 <code>DbSet</code> 插入数据</h3>
<p>如前所述，您可以使用 <code>DbSet</code> 来保存实体的实例，该实例将以与 EF 6.x 相同的方式转换为数据库中的 <code>INSERT</code> / <code>UPDATE</code> / <code>DELETE</code> 命令。<br>
使用 <code>DbSet&lt;TEntity&gt;.Add()</code> 方法附加具有添加状态的实体，或使用 <code>DbSet&lt;TEntity&gt; .AddRange()</code> 方法附加具有添加状态的实体的集合，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var std &#x3D; new Student() &#123;<br>    Name &#x3D; &quot;Bill&quot;<br>&#125;;<br><br>using (var context &#x3D; new SchoolContext()) &#123;<br>    context.Students.Add(std);<br><br>    &#x2F;&#x2F; or<br>    &#x2F;&#x2F; context.Students.Attach(std);<br><br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>context.Students</code> 的类型为 <code>DbSet&lt;Student&gt;</code> 类型。因此，我们只能添加 <code>Student</code> 实体。<code>context.Students.Add(std)</code> 将 <code>Student</code> 实体附加到具有 <code>Added</code> 状态的上下文，当调用 <code>SaveChanges()</code> 方法时，这将导致 <code>INSERT</code> 语句。</p>
<h2 id="十六、Entity-Framework-Core-断开模式下删除数据"><a class="header-anchor" href="#十六、Entity-Framework-Core-断开模式下删除数据">¶</a>十六、Entity Framework Core 断开模式下删除数据</h2>
<p>EF Core API 会为 <code>EntityState</code> 为 <code>Deleted</code> 的实体建立并执行数据库中的 <code>DELETE</code> 语句。在 EF Core 中已连接和已断开连接的场景中删除实体没有什么区别。 EF Core 使得从上下文中删除实体变得容易，而上下文又将使用以下方法删除数据库中的记录。</p>
<table>
<thead>
<tr>
<th style="text-align:center"><strong><code>DbContext</code> 方法</strong></th>
<th style="text-align:center"><strong><code>DbSet</code> 方法</strong></th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>DbContext.Remove</code></td>
<td style="text-align:center"><code>DbSet.Remove</code></td>
<td style="text-align:center">将指定的实体附加到状态为“已删除”的 <code>DbContext</code> 并开始对其进行跟踪</td>
</tr>
<tr>
<td style="text-align:center"><code>DbContext.RemoveRang</code></td>
<td style="text-align:center"><code>DbSet.RemoveRange</code></td>
<td style="text-align:center">将实体的集合或数组附加到具有 <code>Deleted</code> 状态的 <code>DbContext</code> 并开始跟踪它们</td>
</tr>
</tbody>
</table>
<p>以下示例演示了在断开连接的场景中删除实体的不同方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">&#x2F;&#x2F; entity to be deleted<br>var student &#x3D; new Student() &#123;<br>        StudentId &#x3D; 1<br>&#125;;<br><br>using (var context &#x3D; new SchoolContext()) &#123;<br>    context.Remove&lt;Student&gt;(student);<br>   <br>    &#x2F;&#x2F; or the followings are also valid<br>    &#x2F;&#x2F; context.RemoveRange(student);<br>    &#x2F;&#x2F;context.Students.Remove(student);<br>    &#x2F;&#x2F;context.Students.RemoveRange(student);<br>    &#x2F;&#x2F;context.Attach&lt;Student&gt;(student).State &#x3D; EntityState.Deleted;<br>    &#x2F;&#x2F;context.Entry&lt;Student&gt;(student).State &#x3D; EntityState.Deleted;<br>    <br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，使用 <code>Remove()</code> 或 <code>RemoveRange()</code> 方法从上下文中删除了具有有效 <code>StudentId</code> 的 <code>Studnet</code> 实体。数据将从 <code>SaveChanges()</code> 上的数据库中删除。上面的示例在数据库中执行以下 <code>delete</code> 命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec sp_executesql N&#39;SET NOCOUNT ON;<br>DELETE FROM [Students]<br>WHERE [StudentId] &#x3D; @p0;<br>SELECT @@ROWCOUNT;<br>&#39;,N&#39;@p0 int&#39;,@p0&#x3D;1<br>Go<br></code></pre></div></td></tr></table></figure>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>EF Core 中新引入了 <code>DbContext.Remove()</code> 和 <code>DbContext.RemoveRange()</code> 方法，以简化删除操作。</p>
</blockquote>
<h3 id="异常"><a class="header-anchor" href="#异常">¶</a>异常</h3>
<p>如果相应数据库表中不存在 <code>Remove()</code> 或 <code>RemoveRange()</code> 方法中指定实体中的 <code>Key</code> 值，则 EF Core 将引发异常：以下示例将引发异常。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var student &#x3D; new Student() &#123;<br>    StudentId &#x3D; 50<br>&#125;;<br><br>using (var context &#x3D; new SchoolContext()) &#123;<br>    context.Remove&lt;Student&gt;(student);<br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，数据库中不存在 <code>StudentId = 50</code> 的 <code>Student</code>。因此，EF Core 将引发以下 <code>DbUpdateConcurrencyException</code>：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs angelscript">Database operation expected to affect <span class="hljs-number">1</span> row(s) but actually affected <span class="hljs-number">0</span> row(s). Data may have been modified <span class="hljs-keyword">or</span> deleted since entities were loaded.<br>数据库操作预期会影响<span class="hljs-number">1</span>行，但实际上会影响<span class="hljs-number">0</span>行。自加载实体以来，数据可能已被修改或删除。<br></code></pre></div></td></tr></table></figure>
<p>因此，您需要适当地处理以上异常，或者在删除 ID 之前确保数据库中存在具有 ID 的对应数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">var student &#x3D; new Student() &#123;<br>    StudentId &#x3D; 50<br>&#125;;<br><br>using (var context &#x3D; new SchoolContext()) &#123;<br>    try &#123;<br>        context.Remove&lt;Student&gt;(deleteStudent);<br>        context.SaveChanges();<br>    &#125;    <br>    catch (DbUpdateConcurrencyException ex) &#123;<br>        throw new Exception(&quot;数据库中不存在此纪录&quot;);<br>    &#125;<br>    catch (Exception ex) &#123;<br>        throw;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h3 id="删除多条记录"><a class="header-anchor" href="#删除多条记录">¶</a>删除多条记录</h3>
<p>您可以使用 <code>DbContext.RemoveRange()</code> 或 <code>DbSet.RemoveRange()</code> 方法一次性删除多个实体。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">IList&lt;Student&gt; students &#x3D; new List&lt;Student&gt;() &#123;<br>    new Student()&#123; StudentId &#x3D; 1 &#125;,<br>    new Student()&#123; StudentId &#x3D; 2 &#125;,<br>    new Student()&#123; StudentId &#x3D; 3 &#125;,<br>    new Student()&#123; StudentId &#x3D; 4 &#125;<br>&#125;;<br><br>using (var context &#x3D; new SchoolContext()) &#123;<br>    context.RemoveRange(students);<br>    <br>    &#x2F;&#x2F; or<br>    &#x2F;&#x2F; context.Students.RemoveRange(students);<br>    <br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>上面的示例将在单个数据库行程中从数据库中删除 4 条记录。因此，EF Core 改善了性能。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec sp_executesql N&#39;SET NOCOUNT ON;<br>DELETE FROM [Students]<br>WHERE [StudentId] &#x3D; @p0;<br>SELECT @@ROWCOUNT;<br><br><br>DELETE FROM [Students]<br>WHERE [StudentId] &#x3D; @p1;<br>SELECT @@ROWCOUNT;<br><br>DELETE FROM [Students]<br>WHERE [StudentId] &#x3D; @p2;<br>SELECT @@ROWCOUNT;<br><br><br>DELETE FROM [Students]<br>WHERE [StudentId] &#x3D; @p3;<br>SELECT @@ROWCOUNT;<br><br>&#39;,N&#39;@p0 int,@p1 int&#39;,@p0&#x3D;1,@p1&#x3D;2,@p2&#x3D;3,@p3&#x3D;4<br>Go<br></code></pre></div></td></tr></table></figure>
<h3 id="删除关联数据"><a class="header-anchor" href="#删除关联数据">¶</a>删除关联数据</h3>
<p>如果一个实体与其他实体有一对一或一对多的关系，则在删除根实体时删除相关数据取决于如何配置该关系。<br>
例如，考虑“学生”和“年级”实体之间存在一对多关系。特定的 <code>GradeId</code> 将有许多学生记录。如果我们尝试删除数据库中具有相关学生记录的成绩，EF 将抛出参考完整性错误。要解决此问题，您可以使用 Fluent API 定义引用约束操作选项。例如，您可以为该关系配置一个级联删除选项，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">modelBuilder.Entity&lt;Student&gt;()<br>    .HasOne&lt;Grade&gt;(s &#x3D;&gt; s.Grade)<br>    .WithMany(g &#x3D;&gt; g.Students)<br>    .HasForeignKey(s &#x3D;&gt; s.GradeId)<br>    .OnDelete(DeleteBehavior.Cascade);<br></code></pre></div></td></tr></table></figure>
<p>现在，如果您删除成绩实体，那么所有相关的学生记录也将在数据库中删除。<br>
EF Core中还有其他引用约束操作选项，例如 <code>SetNull</code>、<code>ClientSetNull</code>和<code>Restrict</code>。</p>
<h2 id="十七、Entity-Framework-Core-中的-ChangeTracker-变更追踪器"><a class="header-anchor" href="#十七、Entity-Framework-Core-中的-ChangeTracker-变更追踪器">¶</a>十七、Entity Framework Core 中的 <code>ChangeTracker</code> (变更追踪器)</h2>
<p>Entity Framework Core 中的 <code>DbContext</code> 在 <code>Microsoft.EntityFrameworkCore.ChangeTracking</code> 命名空间中包含 <code>ChangeTracker</code> 类，该类负责跟踪使用同一 <code>DbContext</code> 实例检索的每个实体的状态。它不打算直接在您的应用程序代码中使用，因为它可能在将来的版本中更改。但是，您可以使用一些方法进行跟踪。</p>
<p>一旦使用 <code>DbContext</code> 检索了所有实体，Entity Framework Core 中的<code>ChangeTracker</code> 类就会开始跟踪所有实体，直到它们超出其范围。 EF 跟踪应用于所有实体及其属性的所有更改，以便它可以为基础数据源生成并执行适当的 DML 语句。</p>
<p>实体在任何时间点都具有以下状态之一，这些状态由 EF Core 中的枚举 <code>Microsoft.EntityFrameworkCore.EntityState</code> 表示。</p>
<ul>
<li><code>Added</code></li>
<li><code>Modified</code></li>
<li><code>Deleted</code></li>
<li><code>Unchanged</code></li>
<li><code>Detached</code></li>
</ul>
<p>让我们看看如何根据对实体执行的操作自动更改 <code>EntityState</code>：</p>
<h3 id="Unchanged-State-不变的状态"><a class="header-anchor" href="#Unchanged-State-不变的状态">¶</a>Unchanged State (不变的状态)</h3>
<p>首先，使用直接 SQL 查询或 LINQ-to-Entities 查询检索的所有实体都将具有“Unchanged”状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public static void Main() &#123;<br>    using (var context &#x3D; new SchoolContext()) &#123;<br>        &#x2F;&#x2F; retrieve entity <br>        var student &#x3D; context.Students.First();<br>        DisplayStates(context.ChangeTracker.Entries());<br>    &#125;<br>&#125;<br><br>private static void DisplayStates(IEnumerable&lt;EntityEntry&gt; entries) &#123;<br>    foreach (var entry in entries) &#123;<br>        Console.WriteLine($&quot;Entity: &#123;entry.Entity.GetType().Name&#125;,<br>                             State: &#123;entry.State.ToString()&#125; &quot;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy"><span class="hljs-string">Entity:</span> Student, <span class="hljs-string">State:</span> Unchanged<br></code></pre></div></td></tr></table></figure>
<h3 id="Added-State-新增状态"><a class="header-anchor" href="#Added-State-新增状态">¶</a>Added State (新增状态)</h3>
<p>使用 <code>Add()</code> 或 <code>Update()</code> 方法在 <code>DbContext</code> 中添加的所有没有键属性值的新实体都将标记为“Added”。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">using (var context &#x3D; new SchoolContext()) &#123;              <br>    context.Add(new Student() &#123; FirstName &#x3D; &quot;Bill&quot;, LastName &#x3D; &quot;Gates&quot; &#125;);<br>    <br>    DisplayStates(context.ChangeTracker.Entries());<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy"><span class="hljs-string">Entity:</span> Student, <span class="hljs-string">State:</span> Added<br></code></pre></div></td></tr></table></figure>
<h3 id="Modified-State-修改状态"><a class="header-anchor" href="#Modified-State-修改状态">¶</a>Modified State (修改状态)</h3>
<p>如果实体的任何属性的值在 <code>DbContext</code> 的范围内更改，则它将被标记为 <code>Modified</code> 状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">using (var context &#x3D; new SchoolContext()) &#123;<br>    var student &#x3D; context.Students.First();<br>    student.LastName &#x3D; &quot;LastName changed&quot;;<br>              <br>    DisplayStates(context.ChangeTracker.Entries());<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy"><span class="hljs-string">Entity:</span> Student, <span class="hljs-string">State:</span> Modified<br></code></pre></div></td></tr></table></figure>
<h3 id="Deleted-State-删除状态"><a class="header-anchor" href="#Deleted-State-删除状态">¶</a>Deleted State (删除状态)</h3>
<p>如果实体的任何属性的值在 <code>DbContext</code> 的范围内更改，则它将被标记为 <code>Modified</code> 状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">using (var context &#x3D; new SchoolContext()) &#123;<br>    var student &#x3D; context.Students.First();<br>    student.LastName &#x3D; &quot;LastName changed&quot;;<br>              <br>    DisplayStates(context.ChangeTracker.Entries());<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy"><span class="hljs-string">Entity:</span> Student, <span class="hljs-string">State:</span> Modified<br></code></pre></div></td></tr></table></figure>
<h3 id="Deleted-State-删除状态-v2"><a class="header-anchor" href="#Deleted-State-删除状态-v2">¶</a>Deleted State (删除状态)</h3>
<p>如果使用 <code>DbContext.Remove</code> 或 <code>DbSet.Remove</code> 方法从 <code>DbContext</code> 中删除了任何实体，则它将被标记为 <code>Deleted</code> 。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">using (var context &#x3D; new SchoolContext()) &#123;<br>    var student &#x3D; context.Students.First();<br>    context.Students.Remove(student);<br>    <br>    DisplayStates(context.ChangeTracker.Entries());<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy"><span class="hljs-string">Entity:</span> Student, <span class="hljs-string">State:</span> Deleted<br></code></pre></div></td></tr></table></figure>
<h3 id="Detached-State-分离状态"><a class="header-anchor" href="#Detached-State-分离状态">¶</a>Detached State (分离状态)</h3>
<p>在当前 <code>DbContext</code> 实例范围之外创建或检索的所有实体都将处于 <code>Detached</code> 状态。它们也称为断开连接的实体，现有的 <code>DbContext</code> 实例不会对其进行跟踪。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var disconnectedEntity &#x3D; new Student() &#123; StudentId &#x3D; 1, Name &#x3D; &quot;Bill&quot; &#125;;<br><br>using (var context &#x3D; new SchoolContext()) &#123;              <br>    Console.Write(context.Entry(disconnectedEntity).State);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs `">Detached<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>disconnectedEntity</code> 是在 <code>DbContext</code> 实例 (上下文) 的范围之外创建的。因此，对于上下文，它处于 <code>Detached</code> 状态。</p>
<h2 id="十八、Entity-Framework-Core-的影子属性-Shadow-Property"><a class="header-anchor" href="#十八、Entity-Framework-Core-的影子属性-Shadow-Property">¶</a>十八、Entity Framework Core 的影子属性 (Shadow Property)</h2>
<p>Entity Framework Core 引入了一种新的属性类型，称为“影子”属性，该属性在 EF 6.x 中不存在。<br>
<strong>影子属性是未在 .NET 实体类中直接定义的属性</strong>。相反，您可以为实体数据模型中的特定实体类型配置它。可以在上下文类的 <code>OnModelCreating()</code> 方法中配置它们。<br>
下图说明了影子属性：</p>
<p><img src="/images/efcore/20200208111446921.png" alt="图18-1"></p>
<p>如上图所示，影子属性不属于您的实体类。因此，<strong>您无法在访问实体的其他属性时访问它。只能在构建实体数据模型时为实体类型配置影子属性，并且它们也将映射到数据库列</strong>。影子属性的值和状态仅在更改跟踪器中维护。</p>
<p>让我们了解影子属性的实际方面。假设我们需要维护数据库表中每个记录的创建和更新日期。您学习了如何通过在实体类中定义 <code>CreatedDate</code> 和 <code>UpdatedDate</code> 属性来设置 EF Core 中实体的创建和修改日期。在这里，我们将看到如何通过使用影子属性而不在实体类中包含影子属性来实现相同的结果。</p>
<p>考虑以下学生实体类：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">public class Student &#123;<br>    public int StudentID &#123; get; set; &#125;<br>    public string StudentName &#123; get; set; &#125;<br>    public DateTime? DateOfBirth &#123; get; set; &#125;<br>    public decimal Height &#123; get; set; &#125;<br>    public float Weight &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>上面的 <code>Student</code> 类不包含 <code>CreatedDate</code> 和 <code>UpdatedDate</code> 属性来维护创建或更新的时间。我们将它们配置为 <code>Student</code> 实体上的影子属性。</p>
<h3 id="定义影子属性"><a class="header-anchor" href="#定义影子属性">¶</a>定义影子属性</h3>
<p>您可以使用 <code>Property()</code> 方法在 <code>OnModelCreating()</code> 中使用 Fluent API 为实体类型定义影子属性。<br>
以下内容在 <code>Student</code> 实体上配置了两个影子属性 <code>CreatedDate</code> 和 <code>UpdatedDate</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class SchoolContext : DbContext &#123;<br>    public SchoolContext() : base() &#123;<br>    &#125;<br>    <br>    protected override void OnModelCreating(ModelBuilder modelBuilder) &#123;<br>        modelBuilder.Entity&lt;Student&gt;().Property&lt;DateTime&gt;(&quot;CreatedDate&quot;);<br>        modelBuilder.Entity&lt;Student&gt;().Property&lt;DateTime&gt;(&quot;UpdatedDate&quot;);<br>    &#125;<br><br>    public DbSet&lt;Student&gt; Students &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>如您所见，<code>Property()</code> 方法用于配置影子属性。将影子属性的名称指定为字符串，并将类型指定为通用参数。如果在 <code>Property()</code> 方法中指定的名称与现有属性的名称匹配，则 EF Core 将将该现有属性配置为影子属性，而不是引入新的影子属性。</p>
<h3 id="数据库中的影子属性"><a class="header-anchor" href="#数据库中的影子属性">¶</a>数据库中的影子属性</h3>
<p>定义影子属性后，我们需要更新数据库架构，因为影子属性将映射到相应的数据库列。<br>
为此，请使用以下命令添加数据库迁移。</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet ef migrations add addShadowProperty<br>PM&gt; dotnet ef db update<br></code></pre></div></td></tr></table></figure>
<p>现在，<code>Student</code> 表将包括两列，SQL Server 中的 <code>CreatedDate</code> 和 <code>UpdatedDate</code>，如下所示。</p>
<p><img src="/images/efcore/shadow-property-in-db.png" alt="图18-2"></p>
<p>因此，<strong>即使我们没有在 <code>Student</code> 类中包含这些属性并将其配置为影子属性，数据库也将具有相应的列</strong>。</p>
<h3 id="访问影子属性"><a class="header-anchor" href="#访问影子属性">¶</a>访问影子属性</h3>
<p>您可以使用 <code>EntityEntry</code> 的 <code>Property()</code> 方法获取或设置影子属性的值。以下代码访问影子属性的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">using (var context &#x3D; new SchoolContext()) &#123;<br>    var std &#x3D; new Student() &#123; StudentName &#x3D; &quot;Bill&quot;  &#125;;<br>    <br>    &#x2F;&#x2F; sets the value to the shadow property<br>    context.Entry(std).Property(&quot;CreatedDate&quot;).CurrentValue &#x3D; DateTime.Now;<br><br>    &#x2F;&#x2F; gets the value of the shadow property<br>    var createdDate &#x3D; context.Entry(std).Property(&quot;CreatedDate&quot;).CurrentValue; <br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>但是，在我们的方案中，我们想在 <code>SaveChanges()</code> 方法上自动将值设置为这些影子属性，这样就不必在每个实体对象上手动设置它们。因此，请在上下文类中重写<code>SaveChanges()</code> 方法，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public override int SaveChanges() &#123;<br>    var entries &#x3D; ChangeTracker<br>        .Entries()<br>        .Where(e &#x3D;&gt;<br>                e.State &#x3D;&#x3D; EntityState.Added<br>                || e.State &#x3D;&#x3D; EntityState.Modified);<br><br>    foreach (var entityEntry in entries) &#123;<br>        entityEntry.Property(&quot;UpdatedDate&quot;).CurrentValue &#x3D; DateTime.Now;<br><br>        if (entityEntry.State &#x3D;&#x3D; EntityState.Added) &#123;<br>            entityEntry.Property(&quot;CreatedDate&quot;).CurrentValue &#x3D; DateTime.Now;<br>        &#125;<br>    &#125;<br><br>    return base.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>这将自动将值设置为 <code>CreatedDate</code> 和 <code>UpdatedDate</code> 影子属性。<br>
现在，执行以下代码并检查数据库中的记录。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">using (var context &#x3D; new SchoolContext()) &#123;<br>    var std &#x3D; new Student()&#123; StudentName &#x3D; &quot;Bill&quot;  &#125;;<br>    context.Add(std);<br>    context.SaveChanges();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>上面的代码将在 <code>Student</code> 表中插入带有 <code>CreatedDate</code> 和 <code>UpdatedDate</code> 的以下记录。</p>
<p><img src="/images/efcore/db-record.png" alt="图18-3"></p>
<p>因此，通过配置影子属性，我们不必将它们包括在实体类中。</p>
<h3 id="在所有实体上配置阴影属性"><a class="header-anchor" href="#在所有实体上配置阴影属性">¶</a>在所有实体上配置阴影属性</h3>
<p>您可以一次在所有实体上配置影子属性，而不是为所有实体手动配置它们。<br>
例如，我们可以一次在所有实体上配置 <code>CreatedDate</code> 和 <code>UpdatedDate</code>，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">protected override void OnModelCreating(ModelBuilder modelBuilder) &#123;<br>    var allEntities &#x3D; modelBuilder.Model.GetEntityTypes();<br><br>    foreach (var entity in allEntities) &#123;<br>        entity.AddProperty(&quot;CreatedDate&quot;,typeof(DateTime));<br>        entity.AddProperty(&quot;UpdatedDate&quot;,typeof(DateTime));<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<h3 id="何时使用影子属性？"><a class="header-anchor" href="#何时使用影子属性？">¶</a>何时使用影子属性？</h3>
<p>影子属性可以在两种情况下使用：</p>
<ol>
<li>当您不想在映射的实体上公开数据库列时，例如上面讨论的方案。</li>
<li>当您不想公开外键属性而只想使用导航属性来管理关系时。外键属性将是影子属性并映射到数据库列，但不会作为实体的属性公开。(在 EF Core 中，如果您未在实体类中定义外键属性，则它将自动为此生成影子属性。您无需手动配置外键属性。)</li>
</ol>
<h2 id="十九、Entity-Framework-Core-使用断开模式的实体图-Entity-Graph"><a class="header-anchor" href="#十九、Entity-Framework-Core-使用断开模式的实体图-Entity-Graph">¶</a>十九、Entity Framework Core 使用断开模式的实体图 (Entity Graph)</h2>
<p>在这里，您将了解 Entity Framework Core 中断开连接的实体图的根实体和子实体上不同方法的行为。</p>
<p>实体框架核心提供了以下不同方法，<strong>这些方法不仅将实体附加到上下文，而且还更改了断开连接的实体图中每个实体的 <code>EntityState</code></strong>：</p>
<ul>
<li><code>Attach()</code></li>
<li><code>Entry()</code></li>
<li><code>Add()</code></li>
<li><code>Update()</code></li>
<li><code>Remove()</code></li>
</ul>
<h3 id="Attach"><a class="header-anchor" href="#Attach">¶</a><code>Attach()</code></h3>
<p><code>DbContext.Attach()</code> 和 <code>DbSet.Attach()</code> 方法将附加指定的断开连接的实体图并开始对其进行跟踪。它们返回 <code>EntityEntry</code> 的实例，该实例用于分配适当的 <code>EntityState</code>。</p>
<p>下面的示例演示 <code>DbContext.Attach()</code> 方法在图形中每个实体的 <code>EntityState</code> 上的行为。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public static void Main() &#123;<br>    var stud &#x3D; new Student() &#123; &#x2F;&#x2F;Root entity (empty key)<br>        Name &#x3D; &quot;Bill&quot;,<br>        Address &#x3D; new StudentAddress() &#123;  &#x2F;&#x2F;Child entity (with key value)<br>             StudentAddressId &#x3D; 1,<br>            City &#x3D; &quot;Seattle&quot;,<br>            Country &#x3D; &quot;USA&quot;<br>        &#125;,<br>        StudentCourses &#x3D; new List&lt;StudentCourse&gt;() &#123;<br>            new StudentCourse()&#123;  Course &#x3D; new Course()&#123; CourseName &#x3D; &quot;Machine Language&quot; &#125; &#125;,&#x2F;&#x2F;Child entity (empty key)<br>            new StudentCourse()&#123;  Course &#x3D; new Course()&#123;  CourseId &#x3D; 2 &#125; &#125; &#x2F;&#x2F;Child entity (with key value)<br>        &#125;<br>    &#125;;<br><br>    var context &#x3D; new SchoolContext();<br>    context.Attach(stud).State &#x3D; EntityState.Added;  <br><br>    DisplayStates(context.ChangeTracker.Entries());<br>&#125;<br><br>private static void DisplayStates(IEnumerable&lt;EntityEntry&gt; entries) &#123;<br>    foreach (var entry in entries) &#123;<br>        Console.WriteLine($&quot;Entity: &#123;entry.Entity.GetType().Name&#125;,<br>                             State: &#123;entry.State.ToString()&#125; &quot;);<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy"><span class="hljs-string">Entity:</span> Student, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> StudentAddress, <span class="hljs-string">State:</span> Unchanged<br><span class="hljs-string">Entity:</span> StudentCourse, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> Course, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> StudentCourse, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> Course, <span class="hljs-string">State:</span> Unchanged<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>stud</code> 是学生实体图的实例，其中包括对 <code>StudentAddress</code> 和 <code>StudentCourse</code> 实体的引用。<code>context.Attach(stud).State = EntityState.Added</code> 会将图钉实体图附加到上下文，并为其设置 <code>Added</code> 状态。<br>
<code>Attach()</code> 方法将添加的 <code>EntityState</code> 设置为根实体 (在本例中为 <code>Student</code> )，无论其是否包含 <code>Key</code> 值。如果子实体包含键值，则它将被标记为“不变”，否则将被标记为“已添加”。上面示例的输出显示，学生实体具有 <code>Added EntityState</code> ，具有非空键值的子实体具有 <code>Unchanged</code> <code>EntityState</code>，而具有空键值的子实体具有 <code>Added</code> 状态。<br>
下表列出了在为断开连接的实体图设置其他 <code>EntityStat</code> e时，<code>Attach()</code> 方法的行为：</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>Attach()</code></th>
<th style="text-align:center">具有键值的根实体</th>
<th style="text-align:center">具有空值或 CLR 默认值的根实体</th>
<th style="text-align:center">具有键值的子实体</th>
<th style="text-align:center">空实体或 CLR 默认值的子实体</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>context.Attach(entityGraph).State = EntityState.Added</code></td>
<td style="text-align:center"><code>Added</code></td>
<td style="text-align:center"><code>Added</code></td>
<td style="text-align:center"><code>Unchanged</code></td>
<td style="text-align:center"><code>Added</code></td>
</tr>
<tr>
<td style="text-align:center"><code>context.Attach(entityGraph).State = EntityState.Modified</code></td>
<td style="text-align:center"><code>Modified</code></td>
<td style="text-align:center"><code>Exception</code></td>
<td style="text-align:center"><code>Unchanged</code></td>
<td style="text-align:center"><code>Added</code></td>
</tr>
<tr>
<td style="text-align:center"><code>context.Attach(entityGraph).State = EntityState.Deleted</code></td>
<td style="text-align:center"><code>Deleted</code></td>
<td style="text-align:center"><code>Exception</code></td>
<td style="text-align:center"><code>Unchanged</code></td>
<td style="text-align:center"><code>Added</code></td>
</tr>
</tbody>
</table>
<h3 id="Entry"><a class="header-anchor" href="#Entry">¶</a><code>Entry()</code></h3>
<p>与以前的 EF 6.x 相比，<code>DbContext.Entry()</code> 方法在 Entity Framework Core 中的行为有所不同。考虑以下示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var student &#x3D; new Student() &#123; &#x2F;&#x2F;Root entity (empty key)<br>    Name &#x3D; &quot;Bill&quot;,<br>    Address &#x3D; new StudentAddress() &#123; &#x2F;&#x2F;Child entity (with key value)<br>        StudentAddressId &#x3D; 1,<br>        City &#x3D; &quot;Seattle&quot;,<br>        Country &#x3D; &quot;USA&quot;<br>    &#125;,<br>    StudentCourses &#x3D; new List&lt;StudentCourse&gt;() &#123;<br>            new StudentCourse() &#123; Course &#x3D; new Course() &#123; CourseName&#x3D;&quot;Machine Language&quot; &#125; &#125;,&#x2F;&#x2F;Child entity (empty key)<br>            new StudentCourse() &#123; Course &#x3D; new Course() &#123; CourseId&#x3D;2 &#125; &#125; &#x2F;&#x2F;Child entity (with key value)<br>        &#125;<br>&#125;;<br><br>var context &#x3D; new SchoolContext();<br>context.Entry(student).State &#x3D; EntityState.Modified;<br><br>DisplayStates(context.ChangeTracker.Entries());<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy"><span class="hljs-string">Entity:</span> Student, <span class="hljs-string">State:</span> Modified<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>context.Entry(student).State = EntityState.Modified</code> 将实体附加到上下文，并将指定的 <code>EntityState</code> (在本例中为 <code>Modified</code>) 应用于根实体，而不管其是否包含 <code>Key</code> 属性值或不。它会忽略图中的所有子实体，并且不会附加或设置其 <code>EntityState</code>。<br>
下表列出了 <code>DbContext.Entry()</code> 方法的不同行为。</p>
<table>
<thead>
<tr>
<th style="text-align:center">使用 <code>Entry()</code> 设置 <code>EntityState</code></th>
<th style="text-align:center">具有键值的根实体</th>
<th style="text-align:center">具有空值或 CLR 默认值的根实体</th>
<th style="text-align:center">有/没有键值的子实体</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>context.Entry(entityGraph).State = EntityState.Added</code></td>
<td style="text-align:center"><code>Added</code></td>
<td style="text-align:center"><code>Added</code></td>
<td style="text-align:center"><code>Ignored</code></td>
</tr>
<tr>
<td style="text-align:center"><code>context.Entry(entityGraph).State = EntityState.Modified</code></td>
<td style="text-align:center"><code>Modified</code></td>
<td style="text-align:center"><code>Modified</code></td>
<td style="text-align:center"><code>Ignored</code></td>
</tr>
<tr>
<td style="text-align:center"><code>context.Entry(entityGraph).State = EntityState.Deleted</code></td>
<td style="text-align:center"><code>Deleted</code></td>
<td style="text-align:center"><code>Deleted</code></td>
<td style="text-align:center"><code>Ignored</code></td>
</tr>
</tbody>
</table>
<h3 id="Add"><a class="header-anchor" href="#Add">¶</a><code>Add()</code></h3>
<p><code>DbContext.Add</code> 和 <code>DbSet.Add</code> 方法将实体图附加到上下文，并将“Added EntityState”设置为根和子实体，而不管它们是否具有键值。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var student &#x3D; new Student() &#123; &#x2F;&#x2F;Root entity (with key value)<br>    StudentId &#x3D; 1,<br>    Name &#x3D; &quot;Bill&quot;,<br>    Address &#x3D; new StudentAddress() &#123; &#x2F;&#x2F;Child entity (with key value)<br>        StudentAddressId &#x3D; 1,<br>        City &#x3D; &quot;Seattle&quot;,<br>        Country &#x3D; &quot;USA&quot;<br>    &#125;,<br>    StudentCourses &#x3D; new List&lt;StudentCourse&gt;() &#123;<br>            new StudentCourse() &#123; Course &#x3D; new Course() &#123; CourseName&#x3D;&quot;Machine Language&quot; &#125; &#125;,&#x2F;&#x2F;Child entity (empty key)<br>            new StudentCourse() &#123; Course &#x3D; new Course() &#123; CourseId&#x3D;2 &#125; &#125; &#x2F;&#x2F;Child entity (with key value)<br>        &#125;<br>&#125;;<br><br>var context &#x3D; new SchoolContext();<br>context.Students.Add(student);<br><br>DisplayStates(context.ChangeTracker.Entries());<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy"><span class="hljs-string">Entity:</span> Student, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> StudentAddress, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> StudentCourse, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> Course, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> StudentCourse, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> Course, <span class="hljs-string">State:</span> Added<br></code></pre></div></td></tr></table></figure>
<p>下表列出了使用 <code>DbContext.Add</code> 或 <code>DbSet.Add</code> 方法的图形中每个实体的可能 <code>EntityState</code>。</p>
<table>
<thead>
<tr>
<th style="text-align:center">方法</th>
<th style="text-align:center">具有/不具有键值的根实体</th>
<th style="text-align:center">有/没有键值的子实体</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>DbContext.Add(entityGraph)</code> 或 <code>DbSet.Add(entityGraph)</code></td>
<td style="text-align:center"><code>Added</code></td>
<td style="text-align:center"><code>Added</code></td>
</tr>
</tbody>
</table>
<h3 id="Update"><a class="header-anchor" href="#Update">¶</a><code>Update()</code></h3>
<p><code>DbContext.Update</code> (和 <code>DbSet.Update</code>) 方法将实体图附加到上下文，并根据图中是否包含键属性值来设置图中每个实体的 <code>EntityState</code>。考虑以下示例。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var student &#x3D; new Student() &#123; &#x2F;&#x2F;Root entity (with key value)<br>    StudentId &#x3D; 1,<br>    Name &#x3D; &quot;Bill&quot;,<br>    Address &#x3D; new StudentAddress()  &#x2F;&#x2F;Child entity (with key value)<br>    &#123;<br>        StudentAddressId &#x3D; 1,<br>        City &#x3D; &quot;Seattle&quot;,<br>        Country &#x3D; &quot;USA&quot;<br>    &#125;,<br>    StudentCourses &#x3D; new List&lt;StudentCourse&gt;() &#123;<br>        new StudentCourse() &#123; Course &#x3D; new Course() &#123; CourseName&#x3D;&quot;Machine Language&quot; &#125; &#125;,&#x2F;&#x2F;Child entity (empty key)<br>        new StudentCourse() &#123; Course &#x3D; new Course() &#123; CourseId&#x3D;2 &#125; &#125; &#x2F;&#x2F;Child entity (with key value)<br>    &#125;<br>&#125;;<br><br>var context &#x3D; new SchoolContext();<br>context.Update(student);<br><br>DisplayStates(context.ChangeTracker.Entries());<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy"><span class="hljs-string">Entity:</span> Student, <span class="hljs-string">State:</span> Modified<br><span class="hljs-string">Entity:</span> StudentAddress, <span class="hljs-string">State:</span> Modified<br><span class="hljs-string">Entity:</span> StudentCourse, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> Course, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> StudentCourse, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> Course, <span class="hljs-string">State:</span> Modified<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>Update()</code> 方法将 <code>Modified</code> 状态应用于包含非空键属性值的实体，并将 <code>Added</code> 状态应用于包含空或默认 CLR 键值的实体，而不管它们是根实体还是子实体。</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>Update()</code></th>
<th style="text-align:center">具有键值的根实体</th>
<th style="text-align:center">具有空值或 CLR 默认值的根实体</th>
<th style="text-align:center">具有键值的子实体</th>
<th style="text-align:center">空键值的子实体</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>DbContext.Update(entityGraph)</code> 或 <code>DbSet.Update(entityGraph)</code></td>
<td style="text-align:center"><code>Modified</code></td>
<td style="text-align:center"><code>Added</code></td>
<td style="text-align:center"><code>Modified</code></td>
<td style="text-align:center"><code>Added</code></td>
</tr>
</tbody>
</table>
<h3 id="Remove"><a class="header-anchor" href="#Remove">¶</a><code>Remove()</code></h3>
<p><code>DbContext.Remove()</code> 和 <code>DbSet.Remove()</code> 方法将 <code>Deleted</code> <code>EntityState</code> 设置为根实体。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var student &#x3D; new Student() &#123; &#x2F;&#x2F;Root entity (with key value)<br>    StudentId &#x3D; 1,<br>    Name &#x3D; &quot;Bill&quot;,<br>    Address &#x3D; new StudentAddress() &#123; &#x2F;&#x2F;Child entity (with key value)<br>        StudentAddressId &#x3D; 1,<br>        City &#x3D; &quot;Seattle&quot;,<br>        Country &#x3D; &quot;USA&quot;<br>    &#125;,<br>    StudentCourses &#x3D; new List&lt;StudentCourse&gt;() &#123;<br>        new StudentCourse() &#123; Course &#x3D; new Course() &#123; CourseName&#x3D;&quot;Machine Language&quot; &#125; &#125;,&#x2F;&#x2F;Child entity (empty key)<br>        new StudentCourse() &#123; Course &#x3D; new Course() &#123; CourseId&#x3D;2 &#125; &#125; &#x2F;&#x2F;Child entity (with key value)<br>    &#125;<br>&#125;;<br><br>var context &#x3D; new SchoolContext();<br>context.Remove(student);<br><br>DisplayStates(context.ChangeTracker.Entries());<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy"><span class="hljs-string">Entity:</span> Student, <span class="hljs-string">State:</span> Deleted<br><span class="hljs-string">Entity:</span> StudentAddress, <span class="hljs-string">State:</span> Unchanged<br><span class="hljs-string">Entity:</span> StudentCourse, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> Course, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> StudentCourse, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> Course, <span class="hljs-string">State:</span> Unchanged<br></code></pre></div></td></tr></table></figure>
<p>下表列出了每个实体的 <code>EntityState</code> 上 <code>Remove()</code> 方法的行为。</p>
<table>
<thead>
<tr>
<th style="text-align:center"><code>Remove()</code></th>
<th style="text-align:center">具有键值的根实体</th>
<th style="text-align:center">具有空值或 CLR 默认值的根实体</th>
<th style="text-align:center">具有键值的子实体</th>
<th style="text-align:center">空键值的子实体</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>DbContext.Remove(entityGraph)</code> 或 <code>DbSet.Remove(entityGraph)</code></td>
<td style="text-align:center"><code>Deleted</code></td>
<td style="text-align:center"><code>Exception</code></td>
<td style="text-align:center"><code>Unchanged</code></td>
<td style="text-align:center"><code>Added</code></td>
</tr>
</tbody>
</table>
<p>因此，在 EF Core 中使用上述方法时要小心。</p>
<h2 id="二十、Entity-Framework-Core-中的-ChangeTracker-TrackGraph"><a class="header-anchor" href="#二十、Entity-Framework-Core-中的-ChangeTracker-TrackGraph">¶</a>二十、Entity Framework Core 中的 <code>ChangeTracker.TrackGraph()</code></h2>
<p>在这里，您将学习如何跟踪实体图并为图中的每个单个实体设置适当的 <code>EntityState</code>。<br>
Entity Framework Core 中引入了 <code>ChangeTracker.TrackGraph()</code> 方法，以跟踪整个实体图并将自定义实体状态设置为图中的每个实体。<br>
方法签名：<code>public virtual void TrackGraph(object rootEntity, Action&lt;EntityEntryGraphNode&gt; callback)</code><br>
<code>ChangeTracker.TrackGraph()</code> 方法开始跟踪实体以及通过遍历其导航属性可到达的任何实体。为每个发现的实体调用指定的回调，并且必须为每个实体设置适当的 <code>EntityState</code>。回调函数使我们可以实现自定义逻辑来设置适当的状态。如果未设置任何状态，则实体保持未跟踪状态。<br>
下面的示例演示 <code>TrackGraph</code> 方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var student &#x3D; new Student() &#123; &#x2F;&#x2F;Root entity (with key value)<br>    StudentId &#x3D; 1,<br>    Name &#x3D; &quot;Bill&quot;,<br>    Address &#x3D; new StudentAddress() &#123; &#x2F;&#x2F;Child entity (with key value)<br>        StudentAddressId &#x3D; 1,<br>        City &#x3D; &quot;Seattle&quot;,<br>        Country &#x3D; &quot;USA&quot;<br>    &#125;,<br>    StudentCourses &#x3D; new List&lt;StudentCourse&gt;() &#123;<br>        new StudentCourse() &#123; Course &#x3D; new Course() &#123; CourseName&#x3D;&quot;Machine Language&quot; &#125; &#125;,&#x2F;&#x2F;Child entity (empty key)<br>        new StudentCourse() &#123; Course &#x3D; new Course() &#123; CourseId&#x3D;2 &#125; &#125; &#x2F;&#x2F;Child entity (with key value)<br>    &#125;<br>&#125;;<br>var context &#x3D; new SchoolContext();<br>            <br>context.ChangeTracker.TrackGraph(student, e &#x3D;&gt; &#123;<br>                                                if (e.Entry.IsKeySet) &#123;<br>                                                    e.Entry.State &#x3D; EntityState.Unchanged;<br>                                                &#125; else &#123;<br>                                                    e.Entry.State &#x3D; EntityState.Added;<br>                                                &#125;<br>                                            &#125;);<br><br>foreach (var entry in context.ChangeTracker.Entries()) &#123;<br>    Console.WriteLine($&quot;Entity: &#123;entry.Entity.GetType().Name&#125;, <br>                        State: &#123;entry.State.ToString()&#125; &quot;);<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight groovy"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs groovy"><span class="hljs-string">Entity:</span> Student, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> StudentAddress, <span class="hljs-string">State:</span> Unchanged<br><span class="hljs-string">Entity:</span> StudentCourse, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> Course, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> StudentCourse, <span class="hljs-string">State:</span> Added<br><span class="hljs-string">Entity:</span> Course, <span class="hljs-string">State:</span> Unchanged<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>ChangeTracker.TrackGraph()</code> 方法用于为学生实体图中的每个实体设置状态。第一个参数是实体图，第二个参数是设置每个实体状态的函数。我们使用 lambda 表达式为具有有效键值的实体设置了“不变”状态，为具有空键值的实体设置了“添加”状态。当实体具有有效的键属性值时，<code>IsKeySet</code> 变为 <code>true</code>。<br>
因此，我们可以使用 <code>ChangeTracker.TrackGraph()</code> 方法为图中的每个实体设置不同的 <code>EntityState</code>。</p>
<h2 id="二十一、在-Entity-Framework-Core-中执行原生-SQL-查询"><a class="header-anchor" href="#二十一、在-Entity-Framework-Core-中执行原生-SQL-查询">¶</a>二十一、在 Entity Framework Core 中执行原生 SQL 查询</h2>
<p>Entity Framework Core 提供了 <code>DbSet.FromSql()</code> 方法来对基础数据库执行原始 SQL 查询，并将结果作为实体对象获取。<br>
下面的示例演示如何对 MS SQL Server 数据库执行原始 SQL 查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext();<br>var students &#x3D; context.Students<br>                  .FromSql(&quot;Select * from Students where Name &#x3D; &#39;Bill&#39;&quot;)<br>                  .ToList();<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，在 <code>Student</code> 实体集 (<code>DbSet&lt;Student&gt;</code>) 之后使用 <code>FromSql()</code> 方法，因此指定的 SQL 查询必须从 <code>Student</code> 表返回记录，该记录将在 <code>Student</code> 实体中进行转换。 Entity Framework Core 将执行对数据库的指定查询，即在上面的示例中，从 <strong><code>Name ='Bill'</code> 的 <code>Student</code> 中选择</strong>。</p>
<h3 id="Parameterized-Query-参数化查询"><a class="header-anchor" href="#Parameterized-Query-参数化查询">¶</a>Parameterized Query (参数化查询)</h3>
<p><code>FromSql</code>方法允许使用 C# 中的字符串插值语法进行参数化查询，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">string name &#x3D; &quot;Bill&quot;;<br>var context &#x3D; new SchoolContext();<br>var students &#x3D; context.Students<br>                    .FromSql($&quot;Select * from Students where Name &#x3D; &#39;&#123;name&#125;&#39;&quot;)<br>                    .ToList();<br><br>The following is also valid.<br>string name &#x3D; &quot;Bill&quot;;<br>var context &#x3D; new SchoolContext();<br>var students &#x3D; context.Students<br>                    .FromSql(&quot;Select * from Students where Name &#x3D; &#39;&#123;0&#125;&#39;&quot;, name)<br>                    .ToList();<br></code></pre></div></td></tr></table></figure>
<p>上面的示例将对 SQL Server 数据库执行以下 SQL 查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec sp_executesql N&#39;Select * from Students where Name &#x3D; &#39;&#39;@p0&#39;&#39;<br>&#39;,N&#39;@p0 nvarchar(4000)&#39;,@p0&#x3D;N&#39;Bill&#39;<br>Go<br></code></pre></div></td></tr></table></figure>
<h3 id="LINQ-运算符"><a class="header-anchor" href="#LINQ-运算符">¶</a>LINQ 运算符</h3>
<p>您还可以在使用 <code>FromSql</code> 方法的原始查询之后使用 LINQ 运算符。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">string name &#x3D; &quot;Bill&quot;;<br>var context &#x3D; new SchoolContext();<br>var students &#x3D; context.Students<br>                    .FromSql(&quot;Select * from Students where Name &#x3D; &#39;&#123;0&#125;&#39;&quot;, name)<br>                    .OrderBy(s &#x3D;&gt; s.StudentId)<br>                    .ToList();<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，EF Core 通过将 <code>FromSql</code> 方法和 <code>OrderBy</code> 运算符结合在一起执行以下查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec sp_executesql N&#39;SELECT [s].[StudentId], [s].[Name]<br>FROM (<br>    Select * from Students where Name &#x3D; &#39;&#39;@p0&#39;&#39;<br>) AS [s]<br>ORDER BY [s].[StudentId]&#39;,N&#39;@p0 nvarchar(4000)&#39;,@p0&#x3D;N&#39;Bill&#39;<br>Go<br></code></pre></div></td></tr></table></figure>
<h3 id="FromSql-的局限性"><a class="header-anchor" href="#FromSql-的局限性">¶</a><code>FromSql</code> 的局限性</h3>
<p>SQL 查询必须返回与 <code>DbSet&lt;T&gt;</code> 类型相同类型的实体。例如如果在学生之后使用 <code>FromSql</code>，则指定的查询无法返回课程实体。从 <code>FromSql()</code> 方法返回临时类型在待办事项列表中。<br>
SQL 查询必须返回表的所有列。例如 <code>context.Students.FromSql(&quot;select StudentId，LastName from Students).ToList()</code> 将引发异常。<br>
<strong>SQL 查询不能包含 <code>JOIN</code> 查询以获取相关数据。在 <code>FromSql()</code> 方法之后，使用 <code>Include</code> 方法加载相关实体</strong>。</p>
<h2 id="二十二、在-Entity-Framework-Core-中使用存储过程"><a class="header-anchor" href="#二十二、在-Entity-Framework-Core-中使用存储过程">¶</a>二十二、在 Entity Framework Core 中使用存储过程</h2>
<p>在这里，您将学习如何在 Entity Framework Core 中执行数据库存储过程。<br>
EF Core 提供了以下方法来执行存储过程：</p>
<ol>
<li><code>DbSet&lt;TEntity&gt;.FromSql()</code></li>
<li><code>DbContext.Database.ExecuteSqlCommand()</code></li>
</ol>
<p>在 EF Core 2.x 中使用 <code>FromSql</code> 或 <code>ExecuteSqlCommand</code> 方法执行数据库存储过程存在一些限制：</p>
<ul>
<li>结果必须是实体类型。这意味着存储过程必须返回实体对应表的所有列。</li>
<li>结果不能包含相关数据。这意味着存储过程无法执行 <code>JOIN</code> 来表示结果。</li>
<li>插入，更新和删除过程无法与该实体映射，因此 <code>SaveChanges</code> 方法无法为 CUD 操作调用存储过程。</li>
</ul>
<p>在 EF Core 中执行存储过程之前，让我们在 MS SQL Server 中创建存储过程。<br>
如果遵循 database-first 方法，则在本地 SQL Server 数据库中执行以下脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">USE [SchoolDB]<br>GO<br><br>SET ANSI_NULLS ON<br>GO<br><br>SET QUOTED_IDENTIFIER ON<br>GO<br><br>CREATE PROCEDURE [dbo].[GetStudents]<br>            @FirstName varchar(50)<br>        AS<br>        BEGIN<br>            SET NOCOUNT ON;<br>            select * from Students where FirstName like @FirstName +&#39;%&#39;<br>        END<br>GO<br></code></pre></div></td></tr></table></figure>
<p>如果您遵循 code-first 方法，请按照以下步骤操作：</p>
<ol>
<li>
<p>执行以下命令来添加空迁移：</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet ef migrations add<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>在 <code>&lt;DateTime&gt; _sp-GetStudents.cs</code> 中的空迁移类的 <code>Up</code> 方法中编写以下代码：</p>
 <figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public partial class spGetStudents : Migration &#123;<br>    protected override void Up(MigrationBuilder migrationBuilder) &#123;<br>        var sp &#x3D; @&quot;CREATE PROCEDURE [dbo].[GetStudents]<br>                    @FirstName varchar(50)<br>                AS<br>                BEGIN<br>                    SET NOCOUNT ON;<br>                    select * from Students where FirstName like @FirstName +&#39;%&#39;<br>                END&quot;;<br><br>        migrationBuilder.Sql(sp);<br>    &#125;<br><br>    protected override void Down(MigrationBuilder migrationBuilder) &#123;<br>    &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>在控制台中执行以下命令，在数据库中创建以上存储过程：</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet ef db update<br></code></pre></div></td></tr></table></figure>
<p>这将在 SQL Server 数据库中创建 <code>GetStudents</code> 存储过程。</p>
</li>
</ol>
<h3 id="使用-FromSql-执行存储过程"><a class="header-anchor" href="#使用-FromSql-执行存储过程">¶</a>使用 <code>FromSql</code> 执行存储过程</h3>
<p>如上一章所述，<code>DbSet</code> 的 <code>FromSql</code> 方法可用于对基础数据库执行原始 SQL 查询。同样，它可用于执行返回实体数据的存储过程，但有一些限制。<br>
在数据库中，我们可以使用如下INPUT参数值执行GetStudents存储过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">GetStudents &quot;Bill&quot;<br></code></pre></div></td></tr></table></figure>
<p>或</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">exec GetStudents &quot;Bill&quot;<br></code></pre></div></td></tr></table></figure>
<p>您可以按照与上述相同的方式在 EF Core 中使用 <code>FromSql</code> 方法执行 SP，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext(); <br>var students &#x3D; context.Students.FromSql(&quot;GetStudents &#39;Bill&#39;&quot;).ToList();<br></code></pre></div></td></tr></table></figure>
<p>您还可以使用 C# 字符串插值语法传递参数值，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var name &#x3D; &quot;Bill&quot;;<br><br>var context &#x3D; new SchoolContext(); <br>var students &#x3D; context.Students<br>                      .FromSql($&quot;GetStudents &#123;name&#125;&quot;)<br>                      .ToList();<br>&#x2F;&#x2F;or<br>&#x2F;&#x2F;var students &#x3D; context.Students.FromSql($&quot;exec GetStudents &#123;name&#125;&quot;).ToList();<br></code></pre></div></td></tr></table></figure>
<p>使用 <code>SqlParameter</code> 实例指定 <code>in</code> 或 <code>out</code> 参数的值，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext(); <br>var param &#x3D; new SqlParameter(&quot;@FirstName&quot;, &quot;Bill&quot;);<br>&#x2F;&#x2F;or<br>&#x2F;*var param &#x3D; new SqlParameter() &#123;<br>                    ParameterName &#x3D; &quot;@FirstName&quot;,<br>                    SqlDbType &#x3D;  System.Data.SqlDbType.VarChar,<br>                    Direction &#x3D; System.Data.ParameterDirection.Input,<br>                    Size &#x3D; 50,<br>                    Value &#x3D; &quot;Bill&quot;<br>&#125;;*&#x2F;<br><br>var students &#x3D; context.Students.FromSql(&quot;GetStudents @FirstName&quot;, param).ToList();<br></code></pre></div></td></tr></table></figure>
<p>您还可以为第一个参数指定 <code>@p0</code>，为第二个参数指定 <code>@p1</code>，依此类推。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext(); <br>var students &#x3D; context.Students.FromSql(&quot;GetStudents @p0&quot;,&quot;Bill&quot;).ToList();<br></code></pre></div></td></tr></table></figure>
<p>在以上示例中，<code>@p0</code> 用于第一个参数，因为 EF Core 中尚不支持命名参数。</p>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>默认情况下，<code>DbContext</code> 将跟踪结果中的所有实体。如果您多次使用相同的参数执行相同的存储过程，则它将每次执行相同的 SQL 语句，但只会跟踪一个结果集。例如，以下示例将执行 <code>GetStudents</code> 存储过程 3 次，但将仅缓存和跟踪结果的一个副本。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext(); <br>var list1 &#x3D; context.Students.FromSql(&quot;GetStudents &#39;Bill&#39;&quot;).ToList();<br>var list2 &#x3D; context.Students.FromSql(&quot;GetStudents &#39;Bill&#39;&quot;).ToList();<br>var list3 &#x3D; context.Students.FromSql(&quot;GetStudents &#39;Bill&#39;&quot;).ToList();<br></code></pre></div></td></tr></table></figure>
</blockquote>
<h3 id="使用-ExecuteSqlCommand-执行存储过程"><a class="header-anchor" href="#使用-ExecuteSqlCommand-执行存储过程">¶</a>使用 <code>ExecuteSqlCommand()</code> 执行存储过程</h3>
<p><code>ExecuteSqlCommand()</code> 方法用于以字符串形式执行数据库命令。对于受指定命令影响的行数，它返回一个整数。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">var context &#x3D; new SchoolContext();<br>var rowsAffected &#x3D; context.Database.ExecuteSqlCommand(&quot;Update Students set FirstName &#x3D; &#39;Bill&#39; where StudentId &#x3D; 1;&quot;);<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，<code>update</code> 命令在 <code>ExecuteSqlCommand</code> 方法中传递。  <code>rowsAffected</code>  的值将为 <code>1</code>，因为只有 1 行受指定的 <code>update</code> 命令影响。<br>
同样，我们可以执行存储过程来创建，更新和删除命令。考虑以下存储过程，该存储过程将一条记录插入数据库的<code> Student</code> 表中：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs mssql">CREATE PROCEDURE CreateStudent<br>    @FirstName Varchar(50),<br>    @LastName Varchar(50)<br>AS<br>BEGIN<br>    SET NOCOUNT ON;<br>    Insert into Students(<br>           [FirstName]<br>           ,[LastName]<br>           )<br> Values (@FirstName, @LastName)<br>END<br>Go<br></code></pre></div></td></tr></table></figure>
<p>现在，您可以执行上面的存储过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs C#">var context &#x3D; new SchoolContext(); <br>context.Database.ExecuteSqlCommand(&quot;CreateStudents @p0, @p1&quot;, parameters: new[] &#123; &quot;Bill&quot;, &quot;Gates&quot; &#125;);<br></code></pre></div></td></tr></table></figure>
<p>以相同的方式，您可以执行 <code>Update</code> 和 <code>Delete</code> 命令的存储过程。</p>
<h2 id="二十三、Entity-Framework-Core-日志"><a class="header-anchor" href="#二十三、Entity-Framework-Core-日志">¶</a>二十三、Entity Framework Core 日志</h2>
<p>我们经常需要在 EF Core 中记录 SQL 并更改跟踪信息以进行调试。<br>
EF Core 日志记录自动与 .NET Core 的日志记录机制集成。因此，在隐含使用 EF Core 的日志记录之前，了解有关 .NET Core 日志记录的基础知识。<br>
Entity Framework Core 与 .NET Core 日志记录集成在一起，以记录 SQL 并将跟踪信息更改为各种输出目标。首先，安装您选择的日志记录提供程序的 Nuget 程序包，然后将 <code>DbContext</code> 绑定到 <code>ILoggerFactory</code>。<br>
让我们安装日志记录提供程序的NuGet软件包。在这里，我们将在控制台上显示日志，因此从 NuGet 程序包管理器安装 <code>Microsoft.Extensions.Logging.Console NuGet</code> 程序包，或在程序包管理器控制台中执行以下命令：</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet add package Microsoft.Extensions.Logging.Console<br></code></pre></div></td></tr></table></figure>
<p>下图说明了 <code>DbContext</code> 如何与日志记录API和控制台日志记录提供程序一起使用。<br>
<img src="/images/efcore/logging-in-efcore.png" alt="图22-1"></p>
<p>在安装控制台记录器提供程序之后，您需要创建 <code>LoggerFactory</code> 的静态/单个实例，然后将其与 <code>DbContext</code> 绑定，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public class SchoolContext : DbContext &#123;<br>    &#x2F;&#x2F;static LoggerFactory object<br>    public static readonly ILoggerFactory loggerFactory &#x3D; new LoggerFactory(new[] &#123;<br>        new ConsoleLoggerProvider((_, __) &#x3D;&gt; true, true)<br>    &#125;);<br><br>    &#x2F;&#x2F;or<br>    &#x2F;&#x2F; public static readonly ILoggerFactory loggerFactory  &#x3D; new LoggerFactory().AddConsole((_,___) &#x3D;&gt; true);<br>    <br>    public SchoolContext() : base() &#123;<br>    &#125;<br>    <br>    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder) &#123;<br>        optionsBuilder.UseLoggerFactory(loggerFactory)  &#x2F;&#x2F;tie-up DbContext with LoggerFactory object<br>            .EnableSensitiveDataLogging()  <br>            .UseSqlServer(@&quot;Server&#x3D;.\SQLEXPRESS;Database&#x3D;SchoolDB;Trusted_Connection&#x3D;True;&quot;);<br>    &#125;<br><br>    public DbSet&lt;Student&gt; Students &#123; get; set; &#125;<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>在上面的示例中，我们创建了 <code>LoggerFactory</code> 类的对象，并将其分配给 <code>ILoggerFactory</code> 类型的静态变量。然后，我们在 <code>OnConfiguring()</code> 方法的 <code>optionsBuilder.UseLoggerFactory()</code> 方法中传递了此对象。这将使 <code>DbContext</code> 与 <code>loggerFactory</code> 对象共享信息，该对象又将在控制台上显示所有日志记录信息。<br>
默认情况下，EF Core 将不记录敏感数据，例如过滤器参数值。因此，调用 <code>EnableSensitiveDataLogging()</code> 记录敏感数据。</p>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>EF 团队建议在应用程序生存期内，将同一个 logger 工厂对象与 <code>DbContext</code> 类的所有实例一起使用。否则，可能会导致内存泄漏和性能下降。您还可以创建一个单独的工厂类，为您提供 <code>LoggerFactory</code> 类的单例对象，以与 <code>DbContext</code> 一起使用。</p>
</blockquote>
<p>让我们详细了解上面的示例。<br>
首先，我们创建了 <code>LoggerFactory</code> 类的对象，并将其分配给 <code>ILoggerFactory</code> 类型的静态变量，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public static readonly ILoggerFactory loggerFactory &#x3D; new LoggerFactory(<br>    new[] &#123; new ConsoleLoggerProvider ((_, __) &#x3D;&gt; true, true) &#125;<br>);<br></code></pre></div></td></tr></table></figure>
<p><code>LoggerFactory</code> 可以包含一个或多个日志记录提供程序，可用于同时记录到多个介质。<code> LoggerFactory</code> 的构造函数接受一系列不同的记录器提供程序对象作为 <code>new [] {}</code>。我们希望在控制台上显示日志，因此创建控制台记录器提供程序 <code>ConsoleLoggerProvider</code> 的对象。<br>
<code>ConsoleLoggerProvider</code> 有四个构造函数。使用允许 lambda 表达式 (<code>Func &lt;&gt;</code>) 进行日志过滤的方法，并使用 <code>includeScope</code> 布尔值，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">new ConsoleLoggerProvider((_, __) &#x3D;&gt; true, true)<br></code></pre></div></td></tr></table></figure>
<p>在这里，我们不想过滤任何信息，因此 lambda 表达式将始终返回 <code>true (_, __) =&gt; true</code>。</p>
<p>创建 <code>ILoggerFactory</code> 对象之后，使用 <code>DbContextOptionsBuilder</code> 在 <code>OnConfiguring()</code> 方法中将 <code>DbContext</code> 与 <code>ILoggerFactory</code> 绑定在一起。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">optionsBuilder.UseLoggerFactory(loggerFactory)<br></code></pre></div></td></tr></table></figure>
<p>因此，我们将<code>DbContext</code> 与包括控制台记录器提供程序的 <code>LoggerFactory</code> 绑定在一起。现在，每当 <code>DbContext</code> 实例执行任何操作时，我们都可以在控制台上看到所有日志。<br>
考虑以下示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">using (var context &#x3D; new SchoolContext()) &#123;<br>    var std &#x3D; new Student()&#123; StudentName &#x3D; &quot;Steve&quot; &#125;;<br>    context.Add(std);<br>                <br>    context.SaveChanges();<br>    Console.ReadLine();<br>&#125;<br></code></pre></div></td></tr></table></figure>
<p>上面的示例将在控制台上显示以下日志：</p>
<figure class="highlight routeros"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">dbug: Microsoft.EntityFrameworkCore.Infrastructure[100401]<br>An <span class="hljs-string">'IServiceProvider'</span> was created <span class="hljs-keyword">for</span> internal use by Entity Framework.<br>info: Microsoft.EntityFrameworkCore.Infrastructure[100403]<br>Entity Framework Core 2.0.0-rtm-26452 initialized <span class="hljs-string">'SchoolContext'</span> using pr<br>ovider <span class="hljs-string">'Microsoft.EntityFrameworkCore.SqlServer'</span> with options: SensitiveDataLoggingEnabled<br>dbug: Microsoft.EntityFrameworkCore.Database.Connection[200000]<br>Opening<span class="hljs-built_in"> connection </span><span class="hljs-keyword">to</span> database <span class="hljs-string">'SchoolDB'</span> on<span class="hljs-built_in"> server </span><span class="hljs-string">'.\SQLEXPRESS'</span>.<br><br>dbug: Microsoft.EntityFrameworkCore.Database.Connection[200001]<br>Opened<span class="hljs-built_in"> connection </span><span class="hljs-keyword">to</span> database <span class="hljs-string">'SchoolDB'</span> on<span class="hljs-built_in"> server </span><span class="hljs-string">'.\SQLEXPRESS'</span>.<br>dbug: Microsoft.EntityFrameworkCore.Database.Transaction[200200]<br>Beginning transaction with isolation level <span class="hljs-string">'ReadCommitted'</span>.<br>warn: Microsoft.EntityFrameworkCore.Database.Command[100400]<br>Sensitive data<span class="hljs-built_in"> logging </span>is enabled. Log entries <span class="hljs-keyword">and</span> exception messages may<br>include sensitive application data, this mode should only be enabled during development.<br>dbug: Microsoft.EntityFrameworkCore.Database.Command[200100]<br>Executing DbCommand [Parameters=[@<span class="hljs-attribute">p0</span>=<span class="hljs-string">''</span> (DbType = DateTime2), @<span class="hljs-attribute">p1</span>=<span class="hljs-string">''</span> (DbTy<br>pe = Int32), @<span class="hljs-attribute">p2</span>=<span class="hljs-string">'0'</span>, @<span class="hljs-attribute">p3</span>=<span class="hljs-string">''</span> (Size = 8000) (DbType = Binary), @<span class="hljs-attribute">p4</span>=<span class="hljs-string">'Steve'</span> (Size = 4000), @<span class="hljs-attribute">p5</span>=<span class="hljs-string">'0'</span>], <span class="hljs-attribute">CommandType</span>=<span class="hljs-string">'Text'</span>, <span class="hljs-attribute">CommandTimeout</span>=<span class="hljs-string">'30'</span>]<br><span class="hljs-builtin-name">SET</span> NOCOUNT ON;<br>INSERT INTO [Students] ([DateOfBirth], [GradeId], [Height], [Photo], [Stud<br>entName], [Weight])<br>VALUES (@p0, @p1, @p2, @p3, @p4, @p5);<br>SELECT [StudentID]<br><span class="hljs-keyword">FROM</span> [Students]<br>WHERE @@ROWCOUNT = 1 <span class="hljs-keyword">AND</span> [StudentID] = scope_identity();<br>info: Microsoft.EntityFrameworkCore.Database.Command[200101]<br>Executed DbCommand (68ms) [Parameters=[@<span class="hljs-attribute">p0</span>=<span class="hljs-string">''</span> (DbType = DateTime2), @<span class="hljs-attribute">p1</span>=<span class="hljs-string">''</span><br>(DbType = Int32), @<span class="hljs-attribute">p2</span>=<span class="hljs-string">'0'</span>, @<span class="hljs-attribute">p3</span>=<span class="hljs-string">''</span> (Size = 8000) (DbType = Binary), @<span class="hljs-attribute">p4</span>=<span class="hljs-string">'Steve'</span><br>(Size = 4000), @<span class="hljs-attribute">p5</span>=<span class="hljs-string">'0'</span>], <span class="hljs-attribute">CommandType</span>=<span class="hljs-string">'Text'</span>, <span class="hljs-attribute">CommandTimeout</span>=<span class="hljs-string">'30'</span>]<br><span class="hljs-builtin-name">SET</span> NOCOUNT ON;<br>INSERT INTO [Students] ([DateOfBirth], [GradeId], [Height], [Photo], [Stud<br>entName], [Weight])<br>VALUES (@p0, @p1, @p2, @p3, @p4, @p5);<br>SELECT [StudentID]<br><span class="hljs-keyword">FROM</span> [Students]<br>WHERE @@ROWCOUNT = 1 <span class="hljs-keyword">AND</span> [StudentID] = scope_identity();<br>dbug: Microsoft.EntityFrameworkCore.Database.Command[200300]<br>A data reader was disposed.<br>dbug: Microsoft.EntityFrameworkCore.Database.Transaction[200202]<br>Committing transaction.<br>dbug: Microsoft.EntityFrameworkCore.Database.Connection[200002]<br>Closing<span class="hljs-built_in"> connection </span><span class="hljs-keyword">to</span> database <span class="hljs-string">'SchoolDB'</span> on<span class="hljs-built_in"> server </span><span class="hljs-string">'.\SQLEXPRESS'</span>.<br><br>dbug: Microsoft.EntityFrameworkCore.Database.Connection[200003]<br>Closed<span class="hljs-built_in"> connection </span><span class="hljs-keyword">to</span> database <span class="hljs-string">'SchoolDB'</span> on<span class="hljs-built_in"> server </span><span class="hljs-string">'.\SQLEXPRESS'</span>.<br>dbug: Microsoft.EntityFrameworkCore.Database.Transaction[200204]<br>Disposing transaction.、<br></code></pre></div></td></tr></table></figure>
<p>如您所见，它记录了所有信息。</p>
<h3 id="过滤日志"><a class="header-anchor" href="#过滤日志">¶</a>过滤日志</h3>
<p>在上面的示例中，<code>DbContext</code> 在保存实体时记录了所有信息。有时您不想记录所有信息并过滤一些不需要的日志。在 EF Core 中，您可以通过指定记录器类别和日志级别来过滤日志。</p>
<h3 id="日志分类"><a class="header-anchor" href="#日志分类">¶</a>日志分类</h3>
<p>EF Core 2.x 包含 <code>DbLoggerCategory</code> 类，以使用其 <code>Name</code> 属性获取 Entity Framework Core 记录器类别。下表列出了不同的记录器类别。</p>
<table>
<thead>
<tr>
<th style="text-align:center">日志类别类</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>Database.Command</code></td>
<td style="text-align:center">命令执行的记录器类别，包括发送到数据库的SQL。</td>
</tr>
<tr>
<td style="text-align:center"><code>Database.Connection</code></td>
<td style="text-align:center">数据库连接操作的记录器类别。</td>
</tr>
<tr>
<td style="text-align:center"><code>Database.Transaction</code></td>
<td style="text-align:center">数据库事务的记录器类别。</td>
</tr>
<tr>
<td style="text-align:center"><code>Infrastructure</code></td>
<td style="text-align:center">EF 基础结构的其他消息的记录器类别。</td>
</tr>
<tr>
<td style="text-align:center"><code>Migration</code></td>
<td style="text-align:center">迁移的记录器类别。</td>
</tr>
<tr>
<td style="text-align:center"><code>Model</code></td>
<td style="text-align:center">用于模型构建和元数据的记录器类别。</td>
</tr>
<tr>
<td style="text-align:center"><code>Query</code></td>
<td style="text-align:center">查询的记录器类别 (不包括生成的 SQL)。</td>
</tr>
<tr>
<td style="text-align:center"><code>Scaffolding</code></td>
<td style="text-align:center">脚手架和逆向工程的记录仪类别。</td>
</tr>
<tr>
<td style="text-align:center"><code>Update</code></td>
<td style="text-align:center"><code>DbContext.SaveChanges()</code> 消息的记录器类别。</td>
</tr>
</tbody>
</table>
<h3 id="记录-SQL-查询"><a class="header-anchor" href="#记录-SQL-查询">¶</a>记录 SQL 查询</h3>
<p>要仅记录 SQL 查询，请在 <code>ConsoleLoggerProvider</code> 的构造函数的 lambda 表达式中指定 <code>DbLoggerCategory.Database.Command</code> 类别和 <code>LogLevel.Information</code>，如下所示。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public static readonly ILoggerFactory consoleLoggerFactory  <br>            &#x3D; new LoggerFactory(new[] &#123;<br>                  new ConsoleLoggerProvider((category, level) &#x3D;&gt;<br>                    category &#x3D;&#x3D; DbLoggerCategory.Database.Command.Name &amp;&amp;<br>                    level &#x3D;&#x3D; LogLevel.Information, true)<br>                &#125;);<br></code></pre></div></td></tr></table></figure>
<p>或者，默认情况下，只需在 <code>LoggerFactory</code> 上调用 <code>AddConsole()</code> 方法即可记录 SQL 查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs c#">public static readonly ILoggerFactory consoleLoggerFactory<br>         &#x3D; new LoggerFactory().AddConsole();<br></code></pre></div></td></tr></table></figure>
<p>现在，这将记录以下查询信息，这些查询信息使用 <code>DbContext</code> 保存一个实体：</p>
<figure class="highlight autoit"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs autoit">info: Microsoft.EntityFrameworkCore.Database.Command[<span class="hljs-number">200101</span>]<br>Executed DbCommand (<span class="hljs-number">73</span>ms) [Parameters=[<span class="hljs-symbol">@p0</span>=<span class="hljs-string">''</span> (DbType = DateTime2), <span class="hljs-symbol">@p1</span>=<span class="hljs-string">''</span><br>(DbType = Int32), <span class="hljs-symbol">@p2</span>=<span class="hljs-string">'0'</span>, <span class="hljs-symbol">@p3</span>=<span class="hljs-string">''</span> (Size = <span class="hljs-number">8000</span>) (DbType = <span class="hljs-built_in">Binary</span>), <span class="hljs-symbol">@p4</span>=<span class="hljs-string">'Steve'</span><br>(Size = <span class="hljs-number">4000</span>), <span class="hljs-symbol">@p5</span>=<span class="hljs-string">'0'</span>], CommandType=<span class="hljs-string">'Text'</span>, CommandTimeout=<span class="hljs-string">'30'</span>]<br>SET NOCOUNT ON<span class="hljs-comment">;</span><br>INSERT INTO [Students] ([DateOfBirth], [GradeId], [Height], [Photo], [Stud<br>entName], [Weight])<br>VALUES (<span class="hljs-symbol">@p0</span>, <span class="hljs-symbol">@p1</span>, <span class="hljs-symbol">@p2</span>, <span class="hljs-symbol">@p3</span>, <span class="hljs-symbol">@p4</span>, <span class="hljs-symbol">@p5</span>)<span class="hljs-comment">;</span><br><span class="hljs-keyword">SELECT</span> [StudentID]<br>FROM [Students]<br>WHERE @<span class="hljs-symbol">@ROWCOUNT</span> = <span class="hljs-number">1</span> <span class="hljs-literal">AND</span> [StudentID] = scope_identity()<span class="hljs-comment">;</span><br></code></pre></div></td></tr></table></figure>
<h2 id="二十四、Entity-Framework-Core-数据迁移"><a class="header-anchor" href="#二十四、Entity-Framework-Core-数据迁移">¶</a>二十四、Entity Framework Core 数据迁移</h2>
<p>迁移是一种通过保留数据来使数据库架构与 EF Core 模型保持同步的方法。</p>
<p><img src="/images/efcore/20200208203737156.png" alt="图24-1"></p>
<p>如上图所示，EF Core API 从域 (实体) 类构建 EF Core 模型，并且 EF Core 迁移将基于 EF Core 模型创建或更新数据库架构。每当更改域类时，都需要运行迁移以使数据库架构保持最新。<br>
EF Core 迁移是一组命令，您可以在 NuGet 软件包管理器控制台或 dotnet 命令行界面 (CLI) 中执行。<br>
下表列出了 EF Core 中的重要迁移命令。</p>
<table>
<thead>
<tr>
<th style="text-align:center">程序包管理器控制台命令</th>
<th style="text-align:center">dotnet 命令行命令</th>
<th style="text-align:center">使用方法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>add-migration &lt;migration name&gt;</code></td>
<td style="text-align:center"><code>dotnet ef migrations add &lt;migration name&gt;</code></td>
<td style="text-align:center">通过添加迁移快照来创建迁移</td>
</tr>
<tr>
<td style="text-align:center"><code>Remove-migration</code></td>
<td style="text-align:center"><code>dotnet ef migrations remove</code></td>
<td style="text-align:center">删除最后一个迁移快照</td>
</tr>
<tr>
<td style="text-align:center"><code>Update-database</code></td>
<td style="text-align:center"><code>dotnet ef db update</code></td>
<td style="text-align:center">根据上一个迁移快照更新数据库架构</td>
</tr>
<tr>
<td style="text-align:center"><code>Script-migration</code></td>
<td style="text-align:center"><code>dotnet ef migrations script</code></td>
<td style="text-align:center">使用所有迁移快照生成 SQL 脚本</td>
</tr>
</tbody>
</table>
<h3 id="添加迁移-v2"><a class="header-anchor" href="#添加迁移-v2">¶</a>添加迁移</h3>
<p>第一次，您定义了初始领域类。此时，您的应用程序没有数据库可以存储您的域类中的数据。因此，首先，您需要创建一个迁移。</p>
<p>从 Visual Studio 中的工具-&gt; NuGet 软件包管理器-&gt;软件包管理器控制台中打开软件包管理器控制台，然后执行以下命令以添加迁移。</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; <span class="hljs-built_in">add-migration</span> MyFirstMigration<br></code></pre></div></td></tr></table></figure>
<p>如果使用的是 dotnet 命令行界面，请执行以下命令。</p>
<figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet ef migrations add MyFirstMigration<br></code></pre></div></td></tr></table></figure>
<p>在以上命令中，<code>MyFirstMigration</code> 是迁移的名称。这将在项目的“迁移”文件夹中创建三个文件，如下所示。<br>
<img src="/images/efcore/20200208203750920.png" alt="图24-2"></p>
<ol>
<li><code>&lt;timestamp&gt;_&lt;迁移名称&gt;.cs</code>：主迁移文件，其中包含 <code>Up()</code> 和 <code>Down()</code> 方法中的迁移操作。 <code>Up()</code> 方法包括用于创建数据库对象的代码，而<code>Down()</code> 方法包括用于删除数据库对象的代码。</li>
<li><code>&lt;时间戳&gt;_&lt;迁移名称&gt;.Designer.cs</code>：迁移元数据文件，其中包含 EF Core 使用的信息。</li>
<li><code>&lt;contextclassname&gt; ModelSnapshot.cs</code>：当前模型的快照。这用于确定在创建下一个迁移时所做的更改。</li>
</ol>
<p>现在，在创建迁移快照之后，该创建数据库了。</p>
<h3 id="创建或更新数据库"><a class="header-anchor" href="#创建或更新数据库">¶</a>创建或更新数据库</h3>
<p>使用以下命令创建或更新数据库架构。</p>
<ol>
<li>
<p>程序包管理器控制台</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; <span class="hljs-built_in">Update-Database</span><br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>dotnet 命令行</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet ef database update<br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<p><code>Update</code> 命令将基于上下文和域类以及迁移快照创建数据库，这些快照是使用 <code>add-migration</code> 或 <code>add</code> 命令创建的。<br>
如果这是第一次迁移，则还将创建一个名为 <code>__EFMigrationsHistory</code> 的表，该表将存储所有迁移的名称以及何时将它们应用于数据库。</p>
<p><img src="/images/efcore/20200208203805157.png" alt="图24-3"></p>
<h3 id="删除迁移"><a class="header-anchor" href="#删除迁移">¶</a>删除迁移</h3>
<p>如果上一次迁移未应用到数据库，则可以将其删除。使用以下 <code>remove</code> 命令删除上一次创建的迁移文件并还原模型快照。</p>
<ol>
<li>
<p>程序包管理器控制台</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; <span class="hljs-built_in">remove-migration</span><br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>dotnet 命令行</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet ef migrations remove<br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<p>上面的命令将删除上一次迁移，并将模型快照还原为之前的迁移。</p>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>如果已将迁移应用于数据库，则它将引发以下异常：</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs autohotkey">迁移 `&lt;迁移名称&gt;` 已被应用于数据库。还原它，然后再试一次。如果已将迁移应用于其他数据库，请考虑使用新迁移来还原其更改。<br></code></pre></div></td></tr></table></figure>
</blockquote>
<h3 id="还原迁移"><a class="header-anchor" href="#还原迁移">¶</a>还原迁移</h3>
<p>假设您更改了域类，并使用 <code>add-migration</code> 命令创建了名为 <code>MySecondMigration</code> 的第二个迁移，并使用 <code>Update</code> 命令将该迁移应用于数据库。但是，由于某种原因，您想将数据库还原到以前的状态。在这种情况下，请使用 <code>update-database &lt;迁移名称&gt;</code> 命令将数据库还原到指定的先前迁移快照。</p>
<ol>
<li>
<p>程序包管理器控制台</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; <span class="hljs-built_in">Update-database</span> MyFirstMigration<br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>dotnet 命令行</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet ef database update MyFirstMigration<br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<p>上面的命令将基于名为 <code>MyFirstMigration</code> 的迁移还原数据库，并删除应用于名为 <code>MySecondMigration</code> 的第二个迁移的所有更改。这还将从数据库的 <code>__EFMigrationsHistory</code> 表中删除 <code>MySecondMigration</code> 条目。</p>
<blockquote>
<p><strong>注意</strong>：</p>
<hr>
<p>这不会删除与 <code>MySecondMigration</code> 相关的迁移文件。使用 <code>remove</code> 命令将其从项目中删除。</p>
</blockquote>
<h3 id="生成-SQL-脚本"><a class="header-anchor" href="#生成-SQL-脚本">¶</a>生成 SQL 脚本</h3>
<p>使用以下命令为数据库生成 SQL 脚本。</p>
<ol>
<li>
<p>程序包管理器控制台</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; script<span class="hljs-literal">-migration</span><br></code></pre></div></td></tr></table></figure>
</li>
<li>
<p>dotnet 命令行</p>
 <figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; dotnet ef migrations script<br></code></pre></div></td></tr></table></figure>
</li>
</ol>
<p>上面的脚本命令默认将包含所有迁移的脚本。您可以使用 <code>-to</code> 和 <code>-from</code> 选项来指定迁移范围。</p>
<h3 id="程序包管理器控制台命令进行迁移"><a class="header-anchor" href="#程序包管理器控制台命令进行迁移">¶</a>程序包管理器控制台命令进行迁移</h3>
<p>可以使用 Visual Studio 中的程序包管理器控制台执行 Entity Framework Core 中的迁移命令。从 Visual Studio 中的工具-&gt; NuGet软件包管理器-&gt;软件包管理器控制台中打开软件包管理器控制台，以执行以下命令：</p>
<table>
<thead>
<tr>
<th style="text-align:center">程序包管理器控制台</th>
<th style="text-align:center">用法</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><a href="https://www.entityframeworktutorial.net/efcore/pmc-commands-for-ef-core-migration.aspx#get-help" target="_blank" rel="noopener">Get-Help EntityFramework</a></td>
<td style="text-align:center">获取帮助 Entity Framework 显示有关实体框架命令的信息</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://www.entityframeworktutorial.net/efcore/pmc-commands-for-ef-core-migration.aspx#add-migration" target="_blank" rel="noopener">Add-Migration</a></td>
<td style="text-align:center"><code>&lt;迁移名称&gt;</code> 通过添加迁移快照来创建迁移</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://www.entityframeworktutorial.net/efcore/pmc-commands-for-ef-core-migration.aspx#remove-migration" target="_blank" rel="noopener">Remove-Migration</a></td>
<td style="text-align:center">删除最后一个迁移快照</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://www.entityframeworktutorial.net/efcore/pmc-commands-for-ef-core-migration.aspx#update-database" target="_blank" rel="noopener">Update-Database</a></td>
<td style="text-align:center">根据上一个迁移快照更新数据库架构</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://www.entityframeworktutorial.net/efcore/pmc-commands-for-ef-core-migration.aspx#script-migration" target="_blank" rel="noopener">Script-Migration</a></td>
<td style="text-align:center">使用所有迁移快照生成 SQL 脚本</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://www.entityframeworktutorial.net/efcore/pmc-commands-for-ef-core-migration.aspx#scaffold-dbcontext" target="_blank" rel="noopener">Scaffold-DbContext</a></td>
<td style="text-align:center">为指定的数据库生成 <code>DbContext</code> 和实体类型类。这称为逆向工程</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://www.entityframeworktutorial.net/efcore/pmc-commands-for-ef-core-migration.aspx#get-dbcontext" target="_blank" rel="noopener">Get-DbContext</a></td>
<td style="text-align:center">获取有关 <code>DbContext</code> 类型的信息</td>
</tr>
<tr>
<td style="text-align:center"><a href="https://www.entityframeworktutorial.net/efcore/pmc-commands-for-ef-core-migration.aspx#drop-database" target="_blank" rel="noopener">Drop-Database</a></td>
<td style="text-align:center">删除数据库</td>
</tr>
</tbody>
</table>
<h3 id="Get-Help-获取帮助"><a class="header-anchor" href="#Get-Help-获取帮助">¶</a><code>Get-Help</code> 获取帮助</h3>
<figure class="highlight powershell"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs powershell">PM&gt; <span class="hljs-built_in">get-help</span> entityframework<br></code></pre></div></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">                     _/\__<br>               <span class="hljs-comment">---==/    \\</span><br>         ___  ___   |.    \|\<br>        | __|| __|  |  )   \\\<br>        | _| | _|   \_/ |  //|\\<br>        |___||_|       /   \\\/\\<br><br>TOPIC<br>    about_EntityFrameworkCore<br><br>SHORT DESCRIPTION<br>    Provides information about the Entity Framework Core Package Manager Console Tools.<br><br>LONG DESCRIPTION<br>    This topic describes the Entity Framework Core Package Manager Console Tools. <br>    See https://docs.efproject.net <span class="hljs-keyword">for</span> information <span class="hljs-keyword">on</span> Entity Framework Core.<br><br>    The <span class="hljs-keyword">following</span> Entity Framework Core commands are available.<br><br>        Cmdlet                      Description<br>        <span class="hljs-comment">--------------------------  ---------------------------------------------------</span><br>        <span class="hljs-keyword">Add</span>-Migration               Adds a <span class="hljs-built_in">new</span> migration.<br><br>        <span class="hljs-keyword">Drop</span>-<span class="hljs-keyword">Database</span>               Drops the <span class="hljs-keyword">database</span>.<br><br>        <span class="hljs-keyword">Get</span>-DbContext               Gets information about a DbContext <span class="hljs-keyword">type</span>.<br><br>        Remove-Migration            Removes the last migration.<br><br>        Scaffold-DbContext          Scaffolds a DbContext <span class="hljs-keyword">and</span> entity <span class="hljs-keyword">types</span> <span class="hljs-keyword">for</span> a <span class="hljs-keyword">database</span>.<br><br>        Script-Migration            Generates a <span class="hljs-keyword">SQL</span> script <span class="hljs-keyword">from</span> migrations.<br><br>        <span class="hljs-keyword">Update</span>-<span class="hljs-keyword">Database</span>             Updates the <span class="hljs-keyword">database</span> <span class="hljs-keyword">to</span> a specified migration.<br><br>SEE <span class="hljs-keyword">ALSO</span><br>    <span class="hljs-keyword">Add</span>-Migration<br>    <span class="hljs-keyword">Drop</span>-<span class="hljs-keyword">Database</span><br>    <span class="hljs-keyword">Get</span>-DbContext<br>    Remove-Migration<br>    Scaffold-DbContext<br>    Script-Migration<br>    <span class="hljs-keyword">Update</span>-<span class="hljs-keyword">Database</span><br></code></pre></div></td></tr></table></figure>
<h3 id="Add-Migration-添加迁移"><a class="header-anchor" href="#Add-Migration-添加迁移">¶</a><code>Add-Migration</code> 添加迁移</h3>
<figure class="highlight fsharp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs fsharp">NAME<br>    Add-Migration<br>    <br>SYNOPSIS<br>    Adds a <span class="hljs-keyword">new</span> migration.<br>    <br>    <br>SYNTAX<br>    Add-Migration [-Name] &lt;String&gt; [-OutputDir &lt;String&gt;] [-Context &lt;String&gt;] [-Project &lt;String&gt;] <br>                    [-StartupProject &lt;String&gt;] <span class="hljs-meta">[&lt;CommonParameters&gt;]</span><br>    <br>    <br>DESCRIPTION<br>    Adds a <span class="hljs-keyword">new</span> migration.<br><br>REMARKS<br>    To see the examples, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Add</span>-<span class="hljs-title">Migration</span> -<span class="hljs-title">examples</span>".</span><br>    For more information, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Add</span>-<span class="hljs-title">Migration</span> -<span class="hljs-title">detailed</span>".</span><br>    For technical information, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Add</span>-<span class="hljs-title">Migration</span> -<span class="hljs-title">full</span>".</span><br></code></pre></div></td></tr></table></figure>
<h3 id="Remove-Migration-删除迁移"><a class="header-anchor" href="#Remove-Migration-删除迁移">¶</a><code>Remove-Migration</code> 删除迁移</h3>
<figure class="highlight fsharp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs fsharp">NAME<br>    Remove-Migration<br>    <br>SYNOPSIS<br>    Removes the last migration.<br>    <br>SYNTAX<br>    Remove-Migration [-Force] [-Context &lt;String&gt;] [-Project &lt;String&gt;] [-StartupProject &lt;String&gt;] <br>                        <span class="hljs-meta">[&lt;CommonParameters&gt;]</span><br>    <br>DESCRIPTION<br>    Removes the last migration.<br><br>RELATED LINKS<br>    Add-Migration<br>    about_EntityFrameworkCore <br><br>REMARKS<br>    To see the examples, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Remove</span>-<span class="hljs-title">Migration</span> -<span class="hljs-title">examples</span>".</span><br>    For more information, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Remove</span>-<span class="hljs-title">Migration</span> -<span class="hljs-title">detailed</span>".</span><br>    For technical information, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Remove</span>-<span class="hljs-title">Migration</span> -<span class="hljs-title">full</span>".</span><br></code></pre></div></td></tr></table></figure>
<h3 id="Update-Database-更新数据库"><a class="header-anchor" href="#Update-Database-更新数据库">¶</a><code>Update-Database</code> 更新数据库</h3>
<figure class="highlight sql"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sql">NAME<br>    <span class="hljs-keyword">Update</span>-<span class="hljs-keyword">Database</span><br>    <br>SYNOPSIS<br>    Updates the <span class="hljs-keyword">database</span> <span class="hljs-keyword">to</span> a specified migration.<br>    <br>    <br>SYNTAX<br>    <span class="hljs-keyword">Update</span>-<span class="hljs-keyword">Database</span> [[-<span class="hljs-keyword">Migration</span>] &lt;<span class="hljs-keyword">String</span>&gt;] [-<span class="hljs-keyword">Context</span> &lt;<span class="hljs-keyword">String</span>&gt;] [-<span class="hljs-keyword">Project</span> &lt;<span class="hljs-keyword">String</span>&gt;] <br>                        [-StartupProject &lt;<span class="hljs-keyword">String</span>&gt;] [&lt;CommonParameters&gt;]<br>    <br>    <br>DESCRIPTION<br>    Updates the <span class="hljs-keyword">database</span> <span class="hljs-keyword">to</span> a specified migration.<br>    <br><br>RELATED LINKS<br>    Script-<span class="hljs-keyword">Migration</span><br>    about_EntityFrameworkCore <br><br>REMARKS<br>    <span class="hljs-keyword">To</span> see the examples, <span class="hljs-keyword">type</span>: <span class="hljs-string">"get-help Update-Database -examples"</span>.<br>    <span class="hljs-keyword">For</span> more information, <span class="hljs-keyword">type</span>: <span class="hljs-string">"get-help Update-Database -detailed"</span>.<br>    <span class="hljs-keyword">For</span> technical information, <span class="hljs-keyword">type</span>: <span class="hljs-string">"get-help Update-Database -full"</span>.<br></code></pre></div></td></tr></table></figure>
<h3 id="Script-migration-脚本迁移"><a class="header-anchor" href="#Script-migration-脚本迁移">¶</a><code>Script-migration</code> 脚本迁移</h3>
<figure class="highlight fsharp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs fsharp">NAME<br>    Script-Migration<br>    <br>SYNOPSIS<br>    Generates a SQL script from migrations.<br>    <br>    <br>SYNTAX<br>    Script-Migration [-From] &lt;String&gt; [-To] &lt;String&gt; [-Idempotent] [-Output &lt;String&gt;] <br>                        [-Context &lt;String&gt;] [-Project &lt;String&gt;] [-StartupProject &lt;String&gt;] <br>                        <span class="hljs-meta">[&lt;CommonParameters&gt;]</span><br>    <br>    Script-Migration [[-From] &lt;String&gt;] [-Idempotent] [-Output &lt;String&gt;] [-Context &lt;String&gt;] <br>                        [-Project &lt;String&gt;] [-StartupProject &lt;String&gt;] <span class="hljs-meta">[&lt;CommonParameters&gt;]</span><br>    <br>    <br>DESCRIPTION<br>    Generates a SQL script from migrations.<br>    <br><br>RELATED LINKS<br>    Update-Database<br>    about_EntityFrameworkCore <br><br>REMARKS<br>    To see the examples, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Script</span>-<span class="hljs-title">Migration</span> -<span class="hljs-title">examples</span>".</span><br>    For more information, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Script</span>-<span class="hljs-title">Migration</span> -<span class="hljs-title">detailed</span>".</span><br>    For technical information, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Script</span>-<span class="hljs-title">Migration</span> -<span class="hljs-title">full</span>".</span><br></code></pre></div></td></tr></table></figure>
<h3 id="scaffold-dbcontext-支架数据库上下文"><a class="header-anchor" href="#scaffold-dbcontext-支架数据库上下文">¶</a><code>scaffold-dbcontext</code> 支架数据库上下文</h3>
<figure class="highlight prolog"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs prolog"><span class="hljs-symbol">NAME</span><br>    <span class="hljs-symbol">Scaffold</span>-<span class="hljs-symbol">DbContext</span><br>    <br><span class="hljs-symbol">SYNOPSIS</span><br>    <span class="hljs-symbol">Scaffolds</span> a <span class="hljs-symbol">DbContext</span> and entity types for a database.<br>    <br>    <br><span class="hljs-symbol">SYNTAX</span><br>    <span class="hljs-symbol">Scaffold</span>-<span class="hljs-symbol">DbContext</span> [-<span class="hljs-symbol">Connection</span>] &lt;<span class="hljs-symbol">String</span>&gt; [-<span class="hljs-symbol">Provider</span>] &lt;<span class="hljs-symbol">String</span>&gt; [-<span class="hljs-symbol">OutputDir</span> &lt;<span class="hljs-symbol">String</span>&gt;] <br>                        [-<span class="hljs-symbol">Context</span> &lt;<span class="hljs-symbol">String</span>&gt;] [-<span class="hljs-symbol">Schemas</span> &lt;<span class="hljs-symbol">String</span>[]&gt;] [-<span class="hljs-symbol">Tables</span> &lt;<span class="hljs-symbol">String</span>[]&gt;] <br>                        [-<span class="hljs-symbol">DataAnnotations</span>] [-<span class="hljs-symbol">Force</span>] [-<span class="hljs-symbol">Project</span> &lt;<span class="hljs-symbol">String</span>&gt;] [-<span class="hljs-symbol">StartupProject</span> &lt;<span class="hljs-symbol">String</span>&gt;] <br>                        [&lt;<span class="hljs-symbol">CommonParameters</span>&gt;]<br>    <br>    <br><span class="hljs-symbol">DESCRIPTION</span><br>    <span class="hljs-symbol">Scaffolds</span> a <span class="hljs-symbol">DbContext</span> and entity types for a database.<br>    <br><br><span class="hljs-symbol">RELATED</span> <span class="hljs-symbol">LINKS</span><br>    about_EntityFrameworkCore <br><br><span class="hljs-symbol">REMARKS</span><br>    <span class="hljs-symbol">To</span> see the examples, type: <span class="hljs-string">"get-help Scaffold-DbContext -examples"</span>.<br>    <span class="hljs-symbol">For</span> more information, type: <span class="hljs-string">"get-help Scaffold-DbContext -detailed"</span>.<br>    <span class="hljs-symbol">For</span> technical information, type: <span class="hljs-string">"get-help Scaffold-DbContext -full"</span>.<br></code></pre></div></td></tr></table></figure>
<h3 id="Get-DbContext"><a class="header-anchor" href="#Get-DbContext">¶</a><code>Get-DbContext</code></h3>
<figure class="highlight fsharp"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs fsharp">NAME<br>    Get-DbContext<br>    <br>SYNOPSIS<br>    Gets information about a DbContext <span class="hljs-class"><span class="hljs-keyword">type</span>.</span><br>    <br>    <br>SYNTAX<br>    Get-DbContext [-Context &lt;String&gt;] [-Project &lt;String&gt;] [-StartupProject &lt;String&gt;] <br>                    <span class="hljs-meta">[&lt;CommonParameters&gt;]</span><br>    <br>    <br>DESCRIPTION<br>    Gets information about a DbContext <span class="hljs-class"><span class="hljs-keyword">type</span>.</span><br>    <br><br>RELATED LINKS<br>    about_EntityFrameworkCore <br><br>REMARKS<br>    To see the examples, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Get</span>-<span class="hljs-title">DbContext</span> -<span class="hljs-title">examples</span>".</span><br>    For more information, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Get</span>-<span class="hljs-title">DbContext</span> -<span class="hljs-title">detailed</span>".</span><br>    For technical information, <span class="hljs-class"><span class="hljs-keyword">type</span>: "<span class="hljs-title">get</span>-<span class="hljs-title">help</span> <span class="hljs-title">Get</span>-<span class="hljs-title">DbContext</span> -<span class="hljs-title">full</span>".</span><br></code></pre></div></td></tr></table></figure>
<h3 id="Drop-Database-删除数据库"><a class="header-anchor" href="#Drop-Database-删除数据库">¶</a><code>Drop-Database</code> 删除数据库</h3>
<figure class="highlight sql"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs sql">NAME<br>    <span class="hljs-keyword">Drop</span>-<span class="hljs-keyword">Database</span><br>    <br>SYNOPSIS<br>    Drops the database.<br>    <br>    <br>SYNTAX<br>    <span class="hljs-keyword">Drop</span>-<span class="hljs-keyword">Database</span> [-<span class="hljs-keyword">Context</span> &lt;<span class="hljs-keyword">String</span>&gt;] [-<span class="hljs-keyword">Project</span> &lt;<span class="hljs-keyword">String</span>&gt;] [-StartupProject &lt;<span class="hljs-keyword">String</span>&gt;] <br>                    [-WhatIf] [-<span class="hljs-keyword">Confirm</span>] [&lt;CommonParameters&gt;]<br>    <br>    <br>DESCRIPTION<br>    Drops the database.<br>    <br><br>RELATED LINKS<br>    <span class="hljs-keyword">Update</span>-<span class="hljs-keyword">Database</span><br>    about_EntityFrameworkCore <br><br>REMARKS<br>    <span class="hljs-keyword">To</span> see the examples, <span class="hljs-keyword">type</span>: <span class="hljs-string">"get-help Drop-Database -examples"</span>.<br>    <span class="hljs-keyword">For</span> more information, <span class="hljs-keyword">type</span>: <span class="hljs-string">"get-help Drop-Database -detailed"</span>.<br>    <span class="hljs-keyword">For</span> technical information, <span class="hljs-keyword">type</span>: <span class="hljs-string">"get-help Drop-Database -full"</span>.<br></code></pre></div></td></tr></table></figure>
<h3 id="用于迁移的命令行界面命令"><a class="header-anchor" href="#用于迁移的命令行界面命令">¶</a>用于迁移的命令行界面命令</h3>
<p>使用 .NET Core Command List Interface 执行实体框架核心命令。要使用 .NET CLI，请通过编辑 .NET Core 项目的 .csproj 文件，在 <code>&lt;ItemGroup&gt;</code> 节点下添加<code>&lt;DotNetCliToolReference Include=&quot;Microsoft.EntityFrameworkCore.Tools.DotNet&quot; Version =&quot;2.0.0&quot; /&gt;</code>。<br>
打开命令提示符，然后导航到项目的根文件夹，然后输入 <code>dotnet ef --help</code> 列出 EF Core 命令，如下所示：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs livecodeserver">PM&gt; dotnet ef <span class="hljs-comment">--help</span><br>Entity Framework Core .NET Command Line Tools <span class="hljs-number">2.0</span><span class="hljs-number">.0</span>-rtm<span class="hljs-number">-26452</span><br><br>Usage: dotnet ef [options] [<span class="hljs-keyword">command</span>]<br><br>Options:<br>  <span class="hljs-comment">--version        Show version information</span><br>  -h|<span class="hljs-comment">--help        Show help information</span><br>  -v|<span class="hljs-comment">--verbose     Show verbose output.</span><br>  <span class="hljs-comment">--no-color       Don't colorize output.</span><br>  <span class="hljs-comment">--prefix-output  Prefix output with level.</span><br><br>Commands:<br>  database    Commands <span class="hljs-built_in">to</span> manage <span class="hljs-keyword">the</span> database.<br>  dbcontext   Commands <span class="hljs-built_in">to</span> manage DbContext types.<br>  migrations  Commands <span class="hljs-built_in">to</span> manage migrations.<br><br>Use <span class="hljs-string">"dotnet ef [command] --help"</span> <span class="hljs-keyword">for</span> more information about <span class="hljs-keyword">a</span> <span class="hljs-keyword">command</span>.<br></code></pre></div></td></tr></table></figure>
<p>正如您在上面看到的，有三个主要的 EF 命令可用：<code>database</code>，<code>dbcontext</code> 和 <code>migrations</code>。下表列出了所有 EF 命令和子命令。</p>
<table>
    <thead>
        <tr>
            <th style="text-align: center">命令</th>
            <th style="text-align: center">子命令</th>
            <th style="text-align: center">用法</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td rowspan="2" style="text-align: center; vertical-align: middle">
                <code>dotnet ef database</code>
            </td>
            <td style="text-align: center">
                <a href="https://www.entityframeworktutorial.net/efcore/cli-commands-for-ef-core-migration.aspx#database-drop" target="_blank" rel="noopener"><code>drop</code></a>
            </td>
            <td style="text-align: center">删除数据库</td>
        </tr>
        <tr>
            <td style="text-align: center">
                <a href="https://www.entityframeworktutorial.net/efcore/cli-commands-for-ef-core-migration.aspx#database-update" target="_blank" rel="noopener"><code>update</code></a>
            </td>
            <td style="text-align: center">将数据库更新为指定的迁移</td>
        </tr>
        <tr>
            <td rowspan="3" style="text-align: center; vertical-align: middle">
                <code>dotnet ef dbcontext</code>
            </td>
            <td style="text-align: center">
                <a href="https://www.entityframeworktutorial.net/efcore/cli-commands-for-ef-core-migration.aspx#dbcontext-info" target="_blank" rel="noopener"><code>info</code></a>
            </td>
            <td style="text-align: center">获取有关 <code>DbContext</code> 类型的信息</td>
        </tr>
        <tr>
            <td style="text-align: center">
                <a href="https://www.entityframeworktutorial.net/efcore/cli-commands-for-ef-core-migration.aspx#dbcontext-list" target="_blank" rel="noopener"><code>list</code></a>
            </td>
            <td style="text-align: center">列出可用的 <code>DbContext</code> 类型</td>
        </tr>
        <tr>
            <td style="text-align: center">
                <a href="https://www.entityframeworktutorial.net/efcore/cli-commands-for-ef-core-migration.aspx#dbcontext-scaffold" target="_blank" rel="noopener"><code>scaffold</code></a>
            </td>
            <td style="text-align: center">为数据库提供 <code>DbContext</code> 和实体类型</td>
        </tr>
        <tr>
            <td rowspan="4" style="text-align: center; vertical-align: middle">
                <code>dotnet ef migrations</code>
            </td>
            <td style="text-align: center">
                <a href="https://www.entityframeworktutorial.net/efcore/cli-commands-for-ef-core-migration.aspx#migrations-add" target="_blank" rel="noopener"><code>add</code></a>
            </td>
            <td style="text-align: center">添加新的迁移</td>
        </tr>
        <tr>
            <td style="text-align: center">
                <a href="https://www.entityframeworktutorial.net/efcore/cli-commands-for-ef-core-migration.aspx#migrations-list" target="_blank" rel="noopener"><code>list</code></a>
            </td>
            <td style="text-align: center">列出可用的迁移</td>
        </tr>
        <tr>
            <td style="text-align: center">
                <a href="https://www.entityframeworktutorial.net/efcore/cli-commands-for-ef-core-migration.aspx#migrations-remove" target="_blank" rel="noopener"><code>remove</code></a>
            </td>
            <td style="text-align: center">删除上一次迁移</td>
        </tr>
        <tr>
            <td style="text-align: center">
                <a href="https://www.entityframeworktutorial.net/efcore/cli-commands-for-ef-core-migration.aspx#migrations-script" target="_blank" rel="noopener"><code>script</code></a>
            </td>
            <td style="text-align: center">从迁移生成 SQL 脚本</td>
        </tr>
    </tbody>
</table>
<p>让我们看看每个命令的可用选项。</p>
<h3 id="dotnet-ef-database-drop"><a class="header-anchor" href="#dotnet-ef-database-drop">¶</a><code>dotnet ef database drop</code></h3>
<figure class="highlight vhdl"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vhdl">PM&gt; dotnet ef database drop<br>Usage: dotnet ef database drop [options]<br><br>Options:<br>  -f|<span class="hljs-comment">--force                             Don't confirm.</span><br>  <span class="hljs-comment">--dry-run                              Show which database would be dropped, but don't drop it.</span><br>  -c|<span class="hljs-comment">--context &lt;DBCONTEXT&gt;               The DbContext to use.</span><br>  -p|<span class="hljs-comment">--project &lt;PROJECT&gt;                 The project to use.</span><br>  -s|<span class="hljs-comment">--startup-project &lt;PROJECT&gt;         The startup project to use.</span><br>  <span class="hljs-comment">--framework &lt;FRAMEWORK&gt;                The target framework.</span><br>  <span class="hljs-comment">--configuration &lt;CONFIGURATION&gt;        The configuration to use.</span><br>  <span class="hljs-comment">--runtime &lt;RUNTIME_IDENTIFIER&gt;         The runtime to use.</span><br>  <span class="hljs-comment">--msbuildprojectextensionspath &lt;PATH&gt;  The MSBuild project extensions path. Defaults to "obj".</span><br>  <span class="hljs-comment">--no-build                             Don't build the project. Only use this when </span><br>                                         the build <span class="hljs-keyword">is</span> up-<span class="hljs-keyword">to</span>-date.<br></code></pre></div></td></tr></table></figure>
<h3 id="dotnet-ef-database-update"><a class="header-anchor" href="#dotnet-ef-database-update">¶</a><code>dotnet ef database update</code></h3>
<figure class="highlight vhdl"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vhdl">PM&gt; dotnet ef database update<br>Usage: dotnet ef database update [arguments] [options]<br><br>Arguments:<br>  &lt;MIGRATION&gt;  The target migration. <span class="hljs-keyword">If</span> <span class="hljs-string">'0'</span>, <span class="hljs-keyword">all</span> migrations will be reverted. De<br>faults <span class="hljs-keyword">to</span> the last migration.<br><br>Options:<br>  -c|<span class="hljs-comment">--context &lt;DBCONTEXT&gt;               The DbContext to use.</span><br>  -p|<span class="hljs-comment">--project &lt;PROJECT&gt;                 The project to use.</span><br>  -s|<span class="hljs-comment">--startup-project &lt;PROJECT&gt;         The startup project to use.</span><br>  <span class="hljs-comment">--framework &lt;FRAMEWORK&gt;                The target framework.</span><br>  <span class="hljs-comment">--configuration &lt;CONFIGURATION&gt;        The configuration to use.</span><br>  <span class="hljs-comment">--runtime &lt;RUNTIME_IDENTIFIER&gt;         The runtime to use.</span><br>  <span class="hljs-comment">--msbuildprojectextensionspath &lt;PATH&gt;  The MSBuild project extensions path. Defaults to "obj".</span><br>  <span class="hljs-comment">--no-build                             Don't build the project. Only use this when</span><br>                                         the build <span class="hljs-keyword">is</span> up-<span class="hljs-keyword">to</span>-date.<br></code></pre></div></td></tr></table></figure>
<h3 id="dotnet-ef-dbcontext-info"><a class="header-anchor" href="#dotnet-ef-dbcontext-info">¶</a><code>dotnet ef dbcontext info</code></h3>
<figure class="highlight vhdl"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vhdl">PM&gt; dotnet ef dbcontext info<br><br>Usage: dotnet ef dbcontext info [options]<br><br>Options:<br>  <span class="hljs-comment">--json                                 Show JSON output.</span><br>  -c|<span class="hljs-comment">--context &lt;DBCONTEXT&gt;               The DbContext to use.</span><br>  -p|<span class="hljs-comment">--project &lt;PROJECT&gt;                 The project to use.</span><br>  -s|<span class="hljs-comment">--startup-project &lt;PROJECT&gt;         The startup project to use.</span><br>  <span class="hljs-comment">--framework &lt;FRAMEWORK&gt;                The target framework.</span><br>  <span class="hljs-comment">--configuration &lt;CONFIGURATION&gt;        The configuration to use.</span><br>  <span class="hljs-comment">--runtime &lt;RUNTIME_IDENTIFIER&gt;         The runtime to use.</span><br>  <span class="hljs-comment">--msbuildprojectextensionspath &lt;PATH&gt;  The MSBuild project extensions path. Defaults to "obj".</span><br>  <span class="hljs-comment">--no-build                             Don't build the project. Only use this </span><br>                                         <span class="hljs-keyword">when</span> the build <span class="hljs-keyword">is</span> up-<span class="hljs-keyword">to</span>-date.<br></code></pre></div></td></tr></table></figure>
<h3 id="dotnet-ef-dbcontext-scaffold"><a class="header-anchor" href="#dotnet-ef-dbcontext-scaffold">¶</a><code>dotnet ef dbcontext scaffold</code></h3>
<figure class="highlight vhdl"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vhdl">PM&gt; dotnet ef dbcontext scaffold<br><br>Usage: dotnet ef dbcontext scaffold [arguments] [options]<br><br>Arguments:<br>  &lt;CONNECTION&gt;  The connection <span class="hljs-built_in">string</span> <span class="hljs-keyword">to</span> the database.<br>  &lt;PROVIDER&gt;    The provider <span class="hljs-keyword">to</span> <span class="hljs-keyword">use</span>. (E.g. Microsoft.EntityFrameworkCore.SqlServ<br>er)<br><br>Options:<br>  -d|<span class="hljs-comment">--data-annotations                  Use attributes to configure the model (</span><br>where possible). <span class="hljs-keyword">If</span> omitted, only the fluent API <span class="hljs-keyword">is</span> used.<br>  -c|<span class="hljs-comment">--context &lt;NAME&gt;                    The name of the DbContext.</span><br>  -f|<span class="hljs-comment">--force                             Overwrite existing files.</span><br>  -o|<span class="hljs-comment">--output-dir &lt;PATH&gt;                 The directory to put files in. Paths ar</span><br>e relative <span class="hljs-keyword">to</span> the project directory.<br>  <span class="hljs-comment">--schema &lt;SCHEMA_NAME&gt;...              The schemas of tables to generate entit</span><br>y types <span class="hljs-keyword">for</span>.<br>  -t|<span class="hljs-comment">--table &gt;TABLE_NAME&lt;...             The tables to generate entity types for.</span><br>  <span class="hljs-comment">--use-database-names                   Use table and column names directly from the database.</span><br>  <span class="hljs-comment">--json                                 Show JSON output.</span><br>  -p|<span class="hljs-comment">--project &lt;PROJECT&gt;                 The project to use.</span><br>  -s|<span class="hljs-comment">--startup-project &lt;PROJECT&gt;         The startup project to use.</span><br>  <span class="hljs-comment">--framework &lt;FRAMEWORK&gt;                The target framework.</span><br>  <span class="hljs-comment">--configuration &lt;CONFIGURATION&gt;        The configuration to use.</span><br>  <span class="hljs-comment">--runtime &lt;RUNTIME_IDENTIFIER&gt;         The runtime to use.</span><br>  <span class="hljs-comment">--msbuildprojectextensionspath &lt;PATH&gt;  The MSBuild project extensions path. Defaults to "obj".</span><br>  <span class="hljs-comment">--no-build                             Don't build the project. Only use this </span><br>                                         <span class="hljs-keyword">when</span> the build <span class="hljs-keyword">is</span> up-<span class="hljs-keyword">to</span>-date.<br></code></pre></div></td></tr></table></figure>
<h3 id="dotnet-ef-migrations-add"><a class="header-anchor" href="#dotnet-ef-migrations-add">¶</a><code>dotnet ef migrations add</code></h3>
<figure class="highlight vhdl"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vhdl">PM&gt; dotnet ef migrations add<br><br>Usage: dotnet ef migrations add [arguments] [options]<br><br>Arguments:<br>  &lt;NAME&gt;  The name <span class="hljs-keyword">of</span> the migration.<br><br>Options:<br>  -o|<span class="hljs-comment">--output-dir &lt;PATH&gt;                 The directory (and sub-namespace) to us</span><br>e. Paths are relative <span class="hljs-keyword">to</span> the project directory. Defaults <span class="hljs-keyword">to</span> <span class="hljs-string">"Migrations"</span>.<br>  <span class="hljs-comment">--json                                 Show JSON output.</span><br>  -c|<span class="hljs-comment">--context &lt;DBCONTEXT&gt;               The DbContext to use.</span><br>  -p|<span class="hljs-comment">--project &lt;PROJECT&gt;                 The project to use.</span><br>  -s|<span class="hljs-comment">--startup-project &lt;PROJECT&gt;         The startup project to use.</span><br>  <span class="hljs-comment">--framework &lt;FRAMEWORK&gt;                The target framework.</span><br>  <span class="hljs-comment">--configuration &lt;CONFIGURATION&gt;        The configuration to use.</span><br>  <span class="hljs-comment">--runtime &lt;RUNTIME_IDENTIFIER&gt;         The runtime to use.</span><br>  <span class="hljs-comment">--msbuildprojectextensionspath &lt;PATH&gt;  The MSBuild project extensions path. Defaults to "obj".</span><br>  <span class="hljs-comment">--no-build                             Don't build the project. Only use this </span><br>                                         <span class="hljs-keyword">when</span> the build <span class="hljs-keyword">is</span> up-<span class="hljs-keyword">to</span>-date.<br></code></pre></div></td></tr></table></figure>
<h3 id="dotnet-ef-migrations-list"><a class="header-anchor" href="#dotnet-ef-migrations-list">¶</a><code>dotnet ef migrations list</code></h3>
<figure class="highlight vhdl"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vhdl">PM&gt; dotnet ef migrations list<br><br>Usage: dotnet ef migrations list [options]<br><br>Options:<br>  <span class="hljs-comment">--json                                 Show JSON output.</span><br>  -c|<span class="hljs-comment">--context &lt;DBCONTEXT&gt;               The DbContext to use.</span><br>  -p|<span class="hljs-comment">--project &lt;PROJECT&gt;                 The project to use.</span><br>  -s|<span class="hljs-comment">--startup-project &lt;PROJECT&gt;         The startup project to use.</span><br>  <span class="hljs-comment">--framework &lt;FRAMEWORK&gt;                The target framework.</span><br>  <span class="hljs-comment">--configuration &lt;CONFIGURATION&gt;        The configuration to use.</span><br>  <span class="hljs-comment">--runtime &lt;RUNTIME_IDENTIFIER&gt;         The runtime to use.</span><br>  <span class="hljs-comment">--msbuildprojectextensionspath &lt;PATH&gt;  The MSBuild project extensions path. Defaults to "obj".</span><br>  <span class="hljs-comment">--no-build                             Don't build the project. Only use this </span><br>                                         <span class="hljs-keyword">when</span> the build <span class="hljs-keyword">is</span> up-<span class="hljs-keyword">to</span>-date.<br></code></pre></div></td></tr></table></figure>
<h3 id="dotnet-ef-migrations-remove"><a class="header-anchor" href="#dotnet-ef-migrations-remove">¶</a><code>dotnet ef migrations remove</code></h3>
<figure class="highlight vhdl"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vhdl">PM&gt; dotnet ef migrations remove<br><br>Usage: dotnet ef migrations remove [options]<br><br>Options:<br>  -f|<span class="hljs-comment">--force                             Don't check to see if the migration has</span><br> been applied <span class="hljs-keyword">to</span> the database.<br>  <span class="hljs-comment">--json                                 Show JSON output.</span><br>  -c|<span class="hljs-comment">--context &lt;DBCONTEXT&gt;               The DbContext to use.</span><br>  -p|<span class="hljs-comment">--project &lt;PROJECT&gt;                 The project to use.</span><br>  -s|<span class="hljs-comment">--startup-project &lt;PROJECT&gt;         The startup project to use.</span><br>  <span class="hljs-comment">--framework &lt;FRAMEWORK&gt;                The target framework.</span><br>  <span class="hljs-comment">--configuration &lt;CONFIGURATION&gt;        The configuration to use.</span><br>  <span class="hljs-comment">--runtime &lt;RUNTIME_IDENTIFIER&gt;         The runtime to use.</span><br>  <span class="hljs-comment">--msbuildprojectextensionspath &lt;PATH&gt;  The MSBuild project extensions path. Defaults to "obj".</span><br>  <span class="hljs-comment">--no-build                             Don't build the project. Only use this </span><br>                                         <span class="hljs-keyword">when</span> the build <span class="hljs-keyword">is</span> up-<span class="hljs-keyword">to</span>-date.<br></code></pre></div></td></tr></table></figure>
<h3 id="dotnet-ef-migrations-script"><a class="header-anchor" href="#dotnet-ef-migrations-script">¶</a><code>dotnet ef migrations script</code></h3>
<figure class="highlight routeros"><table><tr><td class="gutter hljs hljs hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs routeros">PM&gt; dotnet ef migrations script<br><br>Usage: dotnet ef migrations<span class="hljs-built_in"> script </span>[arguments] [options]<br><br>Arguments:<br>  &lt;<span class="hljs-keyword">FROM</span>&gt;  The starting migration. Defaults <span class="hljs-keyword">to</span> <span class="hljs-string">'0'</span> (the initial database).<br>  &lt;<span class="hljs-keyword">TO</span>&gt;    The ending migration. Defaults <span class="hljs-keyword">to</span> the last migration.<br><br>Options:<br>  -o|--output &lt;FILE&gt;                     The file <span class="hljs-keyword">to</span> write the result <span class="hljs-keyword">to</span>.<br>  -i|--idempotent                        Generate a<span class="hljs-built_in"> script </span>that can be used on a<br> database at any migration.<br>  -c|--context &lt;DBCONTEXT&gt;               The DbContext <span class="hljs-keyword">to</span> use.<br>  -p|--project &lt;PROJECT&gt;                 The project <span class="hljs-keyword">to</span> use.<br>  -s|--startup-project &lt;PROJECT&gt;         The startup project <span class="hljs-keyword">to</span> use.<br>  --framework &lt;FRAMEWORK&gt;                The target framework.<br>  --configuration &lt;CONFIGURATION&gt;        The configuration <span class="hljs-keyword">to</span> use.<br>  --runtime &lt;RUNTIME_IDENTIFIER&gt;         The runtime <span class="hljs-keyword">to</span> use.<br>  --msbuildprojectextensionspath &lt;PATH&gt;  The MSBuild project extensions path. Defaults <span class="hljs-keyword">to</span> <span class="hljs-string">"obj"</span>.<br>  --no-build                             Don<span class="hljs-string">'t build the project. Only use this </span><br><span class="hljs-string">                                         when the build is up-to-date.</span><br></code></pre></div></td></tr></table></figure>
            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E7%AC%94%E8%AE%B0/">笔记</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/C/">C#</a>
                    
                      <a class="hover-with-bg" href="/tags/NET-Core/">.NET Core</a>
                    
                      <a class="hover-with-bg" href="/tags/ORM/">ORM</a>
                    
                      <a class="hover-with-bg" href="/tags/%E6%95%99%E7%A8%8B/">教程</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/07/15/Ubuntu-%E4%B8%8B-138a0090%E3%80%81138a0097-%E5%92%8C-06cb009a-%E6%8C%87%E7%BA%B9%E8%AF%86%E5%88%AB%E5%99%A8%E9%A9%B1%E5%8A%A8%E5%8F%8A%E6%8C%87%E7%BA%B9%E8%AE%A4%E8%AF%81/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Ubuntu 下 138a:0090、138a:0097 和 06cb:009a 指纹识别器驱动及指纹认证</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/03/21/C++-Primer-%E7%AC%AC%E4%BA%94%E7%89%88%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%88%E4%B8%89%EF%BC%89/">
                        <span class="hidden-mobile">《C++ Primer （第五版）》学习笔记 -- 之三</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    Fluid.utils.waitElementVisible('vcomments', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "TMgxzCpM2zFnsClsMHJY2LLc-gzGzoHsz",
          app_key: "1kPLieLtoBQWf0w6iNxLqkMV",
          placeholder: "说点什么....",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: true,
          recordIP: true,
          serverURLs: "",
        });
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the
    <a href="https://valine.js.org" target="_blank" rel="nofollow noopener noopener">comments powered by Valine.</a>
  </noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     Powered by <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> &nbsp;and&nbsp; <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?a9b0666290f750544a1900dff36c0349";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-127726236-2', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
